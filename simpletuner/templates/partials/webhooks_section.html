<!-- Discord Webhooks Section for Publishing Tab -->
{# Use raw_config since webhook_config field is registered under "basic" tab, not "publishing" #}
{% set initial_webhooks = raw_config.get("webhook_config") or raw_config.get("--webhook_config") or [] %}
<div x-data="webhookManager.init()" x-init="initialize()" class="webhook-manager"
     data-initial-webhooks='{{ initial_webhooks | tojson | safe }}'>
    <!-- Hidden field for storing webhook config -->
    <input type="hidden" name="--webhook_config" :value="JSON.stringify(webhooks)">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <label class="form-label mb-0">
            <i class="fas fa-plug me-1"></i>Training Webhooks
        </label>
        <button type="button"
                class="btn btn-sm btn-outline-secondary"
                @click="openModal()"
                title="Create an inline webhook for this session only">
            <i class="fas fa-plus me-1"></i>Inline
        </button>
    </div>

    <!-- Active webhooks for this session -->
    <div x-show="webhooks.length > 0" class="mb-3">
        <div class="small text-muted mb-2">Active for this training:</div>
        <div class="d-flex flex-wrap gap-2">
            <template x-for="(webhook, index) in webhooks" :key="index">
                <div class="badge bg-success d-flex align-items-center gap-2 py-2 px-3">
                    <i class="fas fa-plug"></i>
                    <span x-text="webhook.name || (webhook.webhook_type === 'discord' ? 'Discord' : 'Custom')"></span>
                    <button type="button"
                            class="btn-close btn-close-white ms-1"
                            style="font-size: 0.6rem;"
                            @click="removeWebhook(index)"
                            title="Remove from session"></button>
                </div>
            </template>
        </div>
    </div>

    <!-- Available webhook configs from library -->
    <div class="mb-3">
        <div class="small text-muted mb-2">
            Available webhook configs:
            <button type="button" class="btn btn-link btn-sm p-0 ms-1" @click="refreshLibrary()" title="Refresh">
                <i class="fas fa-sync-alt" :class="{ 'fa-spin': loadingLibrary }"></i>
            </button>
        </div>

        <!-- Loading state -->
        <div x-show="loadingLibrary" class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary"></div>
        </div>

        <!-- Empty state -->
        <div x-show="!loadingLibrary && libraryWebhooks.length === 0" class="alert alert-info small mb-0">
            <i class="fas fa-info-circle me-2"></i>
            No webhook configs found. Create one on the <strong>Environments</strong> page or use the "Inline" button above.
        </div>

        <!-- Library webhook cards -->
        <div x-show="!loadingLibrary && libraryWebhooks.length > 0" class="row row-cols-1 row-cols-md-2 g-2">
            <template x-for="config in libraryWebhooks" :key="config.name">
                <div class="col">
                    <div class="card h-100" :class="{ 'border-success': isWebhookActive(config.name) }">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1 min-width-0">
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <strong class="text-truncate" x-text="config.name"></strong>
                                        <span class="badge"
                                              :class="config.webhook_type === 'discord' ? 'bg-indigo' : 'bg-secondary'"
                                              style="font-size: 0.65rem;"
                                              x-text="config.webhook_type === 'discord' ? 'Discord' : 'Custom'"></span>
                                    </div>
                                    <div x-show="config.log_level" class="small text-muted">
                                        Level: <span x-text="config.log_level"></span>
                                    </div>
                                </div>
                                <div class="btn-group btn-group-sm ms-2">
                                    <button type="button"
                                            class="btn"
                                            :class="isWebhookActive(config.name) ? 'btn-success' : 'btn-outline-success'"
                                            @click="toggleWebhook(config)"
                                            :title="isWebhookActive(config.name) ? 'Remove from session' : 'Add to session'">
                                        <i class="fas" :class="isWebhookActive(config.name) ? 'fa-check' : 'fa-plus'"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-primary"
                                            @click="testLibraryWebhook(config.name)"
                                            title="Test webhook">
                                        <i class="fas fa-plug"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Unsaved changes warning -->
    <div x-show="isDirty" x-cloak class="alert alert-warning mb-0 small">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Changes are not applied until you click <strong>Save</strong> in the header.
    </div>

    <!-- Inline Webhook Editor Modal -->
    <div class="modal fade"
         :class="{ 'show d-block': modalOpen }"
         x-show="modalOpen"
         x-cloak
         tabindex="-1"
         @click.self="closeModal()"
         style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plug me-2"></i>
                        <span x-text="editingIndex !== null ? 'Edit Inline Webhook' : 'New Inline Webhook'"></span>
                    </h5>
                    <button type="button" class="btn-close" @click="closeModal()"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Inline webhooks are only for this training session. To create reusable webhooks, use the <strong>Environments</strong> page.
                    </div>

                    <!-- Webhook Type -->
                    <div class="mb-3">
                        <label class="form-label">Webhook Type <span class="text-danger">*</span></label>
                        <select x-model="editWebhook.webhook_type" class="form-select">
                            <option value="discord">Discord</option>
                            <option value="raw">Custom (Raw JSON)</option>
                        </select>
                    </div>

                    <!-- Webhook URL (Discord) -->
                    <div class="mb-3" x-show="editWebhook.webhook_type === 'discord'">
                        <label class="form-label">Discord Webhook URL <span class="text-danger">*</span></label>
                        <input type="password"
                               x-model="editWebhook.webhook_url"
                               class="form-control font-monospace"
                               placeholder="https://discord.com/api/webhooks/...">
                        <div class="form-text">
                            <i class="fas fa-lock me-1"></i>
                            Server Settings &rarr; Integrations &rarr; Webhooks
                        </div>
                    </div>

                    <!-- Callback URL (Raw) -->
                    <div class="mb-3" x-show="editWebhook.webhook_type === 'raw'">
                        <label class="form-label">Callback URL <span class="text-danger">*</span></label>
                        <input type="password"
                               x-model="editWebhook.callback_url"
                               class="form-control font-monospace"
                               placeholder="https://example.com/callback">
                    </div>

                    <!-- Message Prefix (Discord only) -->
                    <div class="mb-3" x-show="editWebhook.webhook_type === 'discord'">
                        <label class="form-label">Message Prefix</label>
                        <input type="text"
                               x-model="editWebhook.message_prefix"
                               class="form-control"
                               placeholder="My Training">
                    </div>

                    <!-- Log Level -->
                    <div class="mb-3">
                        <label class="form-label">Minimum Log Level</label>
                        <select x-model="editWebhook.log_level" class="form-select">
                            <option value="debug">Debug (All)</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" @click="saveWebhook()">
                        <i class="fas fa-plus me-1"></i>Add
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.webhook-manager .bg-indigo {
    background-color: #6366f1 !important;
}
.webhook-manager .min-width-0 {
    min-width: 0;
}
.webhook-manager [x-cloak] {
    display: none !important;
}
</style>
