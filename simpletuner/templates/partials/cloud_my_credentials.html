<!-- My Credentials Section -->
<div class="cloud-card mb-3" x-data="myCredentialsComponent()">
    <div class="cloud-card-header py-2 d-flex justify-content-between align-items-center"
         @click="toggleExpanded()"
         style="cursor: pointer;">
        <h6 class="mb-0">
            <i class="fas fa-key me-2"></i>My API Credentials
            <span class="badge bg-secondary ms-2" x-show="credentials.length > 0" x-text="credentials.length"></span>
        </h6>
        <i class="fas" :class="expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
    </div>
    <div class="cloud-card-body py-2" x-show="expanded" x-transition x-cloak>
        <!-- Loading state -->
        <template x-if="loading">
            <div class="text-center py-3">
                <i class="fas fa-spinner fa-spin me-2"></i>Loading...
            </div>
        </template>

        <template x-if="!loading">
            <div>
                <!-- Credentials list -->
                <template x-if="credentials.length > 0">
                    <div class="mb-3">
                        <template x-for="cred in credentials" :key="cred.provider + ':' + cred.credential_name">
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary"
                                 style="border-bottom-style: dashed !important;">
                                <div>
                                    <span class="badge bg-info me-2" x-text="cred.provider"></span>
                                    <code class="small" x-text="cred.credential_name"></code>
                                    <template x-if="cred.last_used_at">
                                        <span class="text-muted small ms-2">
                                            used <span x-text="formatRelativeTime(cred.last_used_at)"></span>
                                        </span>
                                    </template>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success btn-sm"
                                            @click="validateCredential(cred)"
                                            :disabled="cred.validating"
                                            title="Validate">
                                        <i class="fas" :class="cred.validating ? 'fa-spinner fa-spin' : 'fa-check-circle'"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm"
                                            @click="deleteCredential(cred)"
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>

                <template x-if="credentials.length === 0">
                    <div class="text-muted small py-2 mb-3">
                        <i class="fas fa-info-circle me-1"></i>No credentials stored
                    </div>
                </template>

                <!-- Add new credential form -->
                <div class="border-top border-secondary pt-3">
                    <h6 class="small text-muted mb-2">Add Credential</h6>
                    <div class="row g-2">
                        <div class="col-4">
                            <select class="form-select form-select-sm bg-dark text-light border-secondary"
                                    x-model="newCredential.provider">
                                <option value="">Provider...</option>
                                <option value="replicate">Replicate</option>
                                <option value="huggingface">HuggingFace</option>
                                <option value="wandb">Weights & Biases</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <input type="text"
                                   class="form-control form-control-sm bg-dark text-light border-secondary"
                                   placeholder="Name (e.g., api_token)"
                                   x-model="newCredential.name">
                        </div>
                        <div class="col-4">
                            <input type="password"
                                   class="form-control form-control-sm bg-dark text-light border-secondary"
                                   placeholder="Value"
                                   x-model="newCredential.value">
                        </div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-primary"
                                @click="addCredential()"
                                :disabled="saving || !newCredential.provider || !newCredential.name || !newCredential.value">
                            <i class="fas" :class="saving ? 'fa-spinner fa-spin' : 'fa-plus'"></i>
                            <span class="ms-1">Add</span>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
function myCredentialsComponent() {
    return {
        expanded: false,
        loading: false,
        saving: false,
        credentials: [],
        newCredential: {
            provider: '',
            name: '',
            value: '',
        },

        toggleExpanded() {
            this.expanded = !this.expanded;
            if (this.expanded && this.credentials.length === 0) {
                this.loadCredentials();
            }
        },

        async loadCredentials() {
            this.loading = true;
            try {
                const response = await fetch('/api/users/me/credentials');
                if (response.ok) {
                    const data = await response.json();
                    this.credentials = (data.credentials || []).map(c => ({
                        ...c,
                        validating: false,
                    }));
                }
            } catch (error) {
                console.error('Failed to load credentials:', error);
            } finally {
                this.loading = false;
            }
        },

        async addCredential() {
            if (!this.newCredential.provider || !this.newCredential.name || !this.newCredential.value) return;

            this.saving = true;
            try {
                const response = await fetch('/api/users/me/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: this.newCredential.provider,
                        credential_name: this.newCredential.name,
                        credential_value: this.newCredential.value,
                    }),
                });

                if (response.ok) {
                    if (window.showToast) window.showToast('Credential added', 'success');
                    this.newCredential = { provider: '', name: '', value: '' };
                    await this.loadCredentials();
                } else {
                    const data = await response.json();
                    if (window.showToast) window.showToast(data.detail || 'Failed to add credential', 'error');
                }
            } catch (error) {
                console.error('Failed to add credential:', error);
                if (window.showToast) window.showToast('Failed to add credential', 'error');
            } finally {
                this.saving = false;
            }
        },

        async validateCredential(cred) {
            cred.validating = true;
            try {
                const response = await fetch('/api/users/me/credentials/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: cred.provider,
                        credential_name: cred.credential_name,
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        if (window.showToast) window.showToast('Credential is valid', 'success');
                    } else {
                        if (window.showToast) window.showToast(data.message || 'Credential is invalid', 'error');
                    }
                } else {
                    if (window.showToast) window.showToast('Validation failed', 'error');
                }
            } catch (error) {
                console.error('Failed to validate credential:', error);
                if (window.showToast) window.showToast('Validation failed', 'error');
            } finally {
                cred.validating = false;
            }
        },

        async deleteCredential(cred) {
            if (!confirm(`Delete credential "${cred.credential_name}" for ${cred.provider}?`)) return;

            try {
                const response = await fetch(
                    `/api/users/me/credentials/${encodeURIComponent(cred.provider)}/${encodeURIComponent(cred.credential_name)}`,
                    { method: 'DELETE' }
                );

                if (response.ok) {
                    if (window.showToast) window.showToast('Credential deleted', 'success');
                    await this.loadCredentials();
                } else {
                    const data = await response.json();
                    if (window.showToast) window.showToast(data.detail || 'Failed to delete', 'error');
                }
            } catch (error) {
                console.error('Failed to delete credential:', error);
                if (window.showToast) window.showToast('Failed to delete credential', 'error');
            }
        },

        formatRelativeTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 30) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        },
    };
}
</script>
