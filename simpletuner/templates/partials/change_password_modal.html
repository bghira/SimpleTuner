<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true"
     x-data="{
         currentPassword: '',
         newPassword: '',
         confirmPassword: '',
         saving: false,
         error: '',
         success: false,

         init() {
             const modal = document.getElementById('changePasswordModal');
             modal.addEventListener('show.bs.modal', () => this.reset());
             modal.addEventListener('hidden.bs.modal', () => this.reset());
         },

         reset() {
             this.currentPassword = '';
             this.newPassword = '';
             this.confirmPassword = '';
             this.saving = false;
             this.error = '';
             this.success = false;
         },

         validate() {
             if (!this.currentPassword) {
                 this.error = 'Current password is required';
                 return false;
             }
             if (!this.newPassword) {
                 this.error = 'New password is required';
                 return false;
             }
             if (this.newPassword.length < 8) {
                 this.error = 'New password must be at least 8 characters';
                 return false;
             }
             if (this.newPassword !== this.confirmPassword) {
                 this.error = 'Passwords do not match';
                 return false;
             }
             if (this.currentPassword === this.newPassword) {
                 this.error = 'New password must be different from current password';
                 return false;
             }
             return true;
         },

         async changePassword() {
             this.error = '';
             this.success = false;

             if (!this.validate()) {
                 return;
             }

             this.saving = true;

             try {
                 const csrfToken = document.querySelector('meta[name=\"csrf-token\"]')?.content;
                 const response = await fetch('/api/users/me/password', {
                     method: 'PUT',
                     headers: {
                         'Content-Type': 'application/json',
                         ...(csrfToken && { 'X-CSRF-Token': csrfToken })
                     },
                     credentials: 'include',
                     body: JSON.stringify({
                         current_password: this.currentPassword,
                         new_password: this.newPassword
                     })
                 });

                 if (!response.ok) {
                     const data = await response.json();
                     throw new Error(data.detail || 'Failed to change password');
                 }

                 this.success = true;
                 this.currentPassword = '';
                 this.newPassword = '';
                 this.confirmPassword = '';

                 if (window.showToast) {
                     window.showToast('Password changed successfully', 'success');
                 }

                 // Close modal after short delay
                 setTimeout(() => {
                     bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'))?.hide();
                 }, 1500);

             } catch (err) {
                 this.error = err.message;
             } finally {
                 this.saving = false;
             }
         }
     }"
     x-init="init()">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="changePasswordModalLabel">
                    <i class="fas fa-lock me-2"></i>Change Password
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Success Message -->
                <div x-show="success" x-cloak class="alert alert-success py-2">
                    <i class="fas fa-check-circle me-2"></i>Password changed successfully!
                </div>

                <!-- Password Form -->
                <form @submit.prevent="changePassword()" x-show="!success">
                    <!-- Current Password -->
                    <div class="mb-3">
                        <label class="form-label text-muted small">Current Password</label>
                        <input type="password" class="form-control form-control-sm"
                               x-model="currentPassword"
                               placeholder="Enter current password"
                               required
                               autocomplete="current-password">
                    </div>

                    <!-- New Password -->
                    <div class="mb-3">
                        <label class="form-label text-muted small">New Password</label>
                        <input type="password" class="form-control form-control-sm"
                               x-model="newPassword"
                               placeholder="Enter new password"
                               minlength="8"
                               required
                               autocomplete="new-password">
                        <small class="text-muted">Minimum 8 characters</small>
                    </div>

                    <!-- Confirm Password -->
                    <div class="mb-3">
                        <label class="form-label text-muted small">Confirm New Password</label>
                        <input type="password" class="form-control form-control-sm"
                               x-model="confirmPassword"
                               placeholder="Confirm new password"
                               required
                               autocomplete="new-password">
                    </div>

                    <!-- Error Message -->
                    <div x-show="error" x-cloak class="alert alert-danger py-2" x-text="error"></div>

                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary" :disabled="saving">
                            <i class="fas" :class="saving ? 'fa-spinner fa-spin' : 'fa-save'"></i>
                            <span class="ms-1" x-text="saving ? 'Changing Password...' : 'Change Password'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
