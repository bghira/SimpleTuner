<!-- partials/cloud_pre_submit_modal.html - Pre-submit wizard modal -->
<div class="modal fade cloud-submit-modal"
     :class="{ 'show d-block': preSubmitModal.open }"
     tabindex="-1"
     x-show="preSubmitModal.open"
     @keydown.escape="closePreSubmitModal()">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-fullscreen-sm-down">
        <div class="modal-content bg-dark">
            <!-- Header -->
            <div class="modal-header border-secondary py-2">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    <span x-text="quickSubmitMode ? 'Quick Submit' : 'Submit to Cloud'"></span>
                </h5>
                <!-- Step indicator (wizard mode only) -->
                <div class="wizard-steps me-2" x-show="!preSubmitModal.loading && !quickSubmitMode">
                    <div class="d-flex align-items-center gap-1">
                        <span class="wizard-step" :class="{ 'active': preSubmitModal.wizardStep === 1, 'completed': preSubmitModal.wizardStep > 1 }">1</span>
                        <span class="wizard-step-line"></span>
                        <span class="wizard-step" :class="{ 'active': preSubmitModal.wizardStep === 2, 'completed': preSubmitModal.wizardStep > 2 }" x-show="wizardRequiresUpload">2</span>
                        <span class="wizard-step-line" x-show="wizardRequiresUpload"></span>
                        <span class="wizard-step" :class="{ 'active': wizardIsFinalStep(preSubmitModal.wizardStep) }" x-text="wizardTotalSteps"></span>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" style="padding: 0.75rem;" @click="closePreSubmitModal()"></button>
            </div>

            <div class="modal-body p-3 p-sm-4">
                <!-- Loading state -->
                <template x-if="preSubmitModal.loading">
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-3 text-muted">Preparing submission...</p>
                    </div>
                </template>

                <template x-if="!preSubmitModal.loading">
                    <div>
                        <!-- ============================================ -->
                        <!-- QUICK SUBMIT MODE (power users)              -->
                        <!-- ============================================ -->
                        <template x-if="quickSubmitMode">
                            <div class="quick-submit-view">
                                <!-- Run Name -->
                                <div class="mb-4">
                                    <label class="form-label">
                                        <i class="fas fa-tag me-1 text-info"></i>Run Name
                                    </label>
                                    <input type="text"
                                           class="form-control form-control-lg bg-dark text-light border-secondary"
                                           placeholder="e.g., my-lora-v1"
                                           x-model="preSubmitModal.trackerRunName"
                                           @input.stop
                                           @change.stop>
                                </div>

                                <!-- Summary row -->
                                <div class="quick-submit-summary p-3 rounded mb-4" style="background: rgba(129, 140, 248, 0.1); border: 1px solid rgba(129, 140, 248, 0.2);">
                                    <div class="row g-3 text-center">
                                        <div class="col">
                                            <div class="text-muted small mb-1">Cost</div>
                                            <div class="fw-bold text-info" x-text="wizardCostDisplay"></div>
                                        </div>
                                        <div class="col">
                                            <div class="text-muted small mb-1">Hardware</div>
                                            <div class="small fw-medium" x-text="wizardHardwareCostDisplay"></div>
                                        </div>
                                        <div class="col" x-show="wizardRequiresUpload">
                                            <div class="text-muted small mb-1">Upload</div>
                                            <div class="small fw-medium">
                                                <span x-text="preSubmitModal.dataUploadPreview?.total_files || 0"></span> files
                                            </div>
                                            <div class="small text-muted">
                                                <span x-text="formatBytes((preSubmitModal.dataUploadPreview?.total_size_mb || 0) * 1024 * 1024)"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Data consent (if needed) -->
                                <template x-if="wizardRequiresUpload && preSubmitModal.dataConsent === 'ask'">
                                    <div class="form-check mb-4">
                                        <input type="checkbox"
                                               class="form-check-input"
                                               id="quickDataConsent"
                                               x-model="preSubmitModal.dataConsentConfirmed"
                                               @change.stop>
                                        <label class="form-check-label" for="quickDataConsent">
                                            I confirm uploading <span x-text="preSubmitModal.dataUploadPreview?.total_files || 0"></span> files
                                            (<span x-text="formatBytes((preSubmitModal.dataUploadPreview?.total_size_mb || 0) * 1024 * 1024)"></span>)
                                        </label>
                                    </div>
                                </template>

                                <!-- Denied state -->
                                <template x-if="wizardUploadDenied">
                                    <div class="alert alert-danger mb-4">
                                        <i class="fas fa-ban me-2"></i>
                                        Uploads disabled in settings.
                                        <a href="#" @click.prevent="window.UIHelpers?.navigateToTabAndClose('ui-settings', () => closePreSubmitModal())" class="alert-link">Change</a>
                                    </div>
                                </template>

                                <!-- Resume limitation notice (quick mode) -->
                                <div class="alert alert-warning py-2 px-3 mb-0" style="background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-info-circle text-warning me-2 mt-1" style="font-size: 0.9rem;"></i>
                                        <div class="small">
                                            <strong>Note:</strong> Resuming interrupted jobs is a planned feature.
                                            Save checkpoints more frequently and allow extra training time as a safeguard.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- ============================================ -->
                        <!-- WIZARD MODE (default for all users)          -->
                        <!-- ============================================ -->
                        <template x-if="!quickSubmitMode">
                            <div class="wizard-view">
                                <!-- STEP 1: Name Your Job -->
                                <div class="wizard-panel" x-show="preSubmitModal.wizardStep === 1" x-transition>
                                    <div class="text-center mb-4">
                                        <div class="wizard-icon mb-3">
                                            <i class="fas fa-tag fa-2x text-info"></i>
                                        </div>
                                        <h4 class="mb-1">Name Your Training Job</h4>
                                        <p class="text-muted mb-0">This identifies the job in your history</p>
                                    </div>

                                    <div class="row justify-content-center">
                                        <div class="col-12 col-md-8">
                                            <input type="text"
                                                   class="form-control form-control-lg bg-dark text-light border-secondary text-center"
                                                   placeholder="e.g., my-lora-v1"
                                                   x-model="preSubmitModal.trackerRunName"
                                                   @input.stop
                                                   @change.stop>

                                            <!-- Cost preview -->
                                            <div class="wizard-cost-preview mt-4 p-3 rounded" style="background: rgba(129, 140, 248, 0.08);">
                                                <div class="row text-center">
                                                    <div class="col">
                                                        <div class="text-muted small">Estimated Cost</div>
                                                        <div class="fs-4 fw-bold text-info" x-text="wizardCostDisplay"></div>
                                                    </div>
                                                    <div class="col">
                                                        <div class="text-muted small">Hardware</div>
                                                        <div class="fs-6 fw-medium" x-text="wizardHardwareCostDisplay"></div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Config selector (if available) -->
                                            <template x-if="availableConfigs.length > 0">
                                                <div class="mt-4">
                                                    <label class="form-label small text-muted">Configuration</label>
                                                    <select class="form-select bg-dark text-light border-secondary"
                                                            x-model="selectedConfigName"
                                                            @change.stop>
                                                        <option :value="null">Current (unsaved)</option>
                                                        <template x-for="cfg in availableConfigs" :key="cfg.name">
                                                            <option :value="cfg.name" x-text="cfg.name"></option>
                                                        </template>
                                                    </select>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <!-- STEP 2: Data Upload Consent (conditional) -->
                                <div class="wizard-panel"
                                     x-show="wizardIsDataStep(preSubmitModal.wizardStep)"
                                     x-transition>
                                    <div class="text-center mb-4">
                                        <div class="wizard-icon mb-3">
                                            <i class="fas fa-cloud-upload-alt fa-2x" :class="preSubmitModal.dataConsent === 'deny' ? 'text-danger' : 'text-warning'"></i>
                                        </div>
                                        <h4 class="mb-1">Data Upload Required</h4>
                                        <p class="text-muted mb-0">
                                            <span x-text="preSubmitModal.dataUploadPreview?.total_files || 0"></span> files
                                            (<span x-text="formatBytes((preSubmitModal.dataUploadPreview?.total_size_mb || 0) * 1024 * 1024)"></span>)
                                            will be uploaded
                                        </p>
                                    </div>

                                    <div class="row justify-content-center">
                                        <div class="col-12 col-md-8">
                                            <!-- Dataset list -->
                                            <div class="wizard-dataset-list mb-4 p-3 rounded" style="background: rgba(0,0,0,0.2); max-height: 200px; overflow-y: auto;">
                                                <template x-for="ds in (preSubmitModal.dataUploadPreview?.datasets || [])" :key="ds.id">
                                                    <div class="d-flex justify-content-between align-items-center py-2 px-2 mb-1 rounded" style="background: rgba(255,255,255,0.05);">
                                                        <div class="flex-grow-1 min-width-0">
                                                            <code class="text-info d-block text-truncate" style="font-size: 0.85rem;" x-text="ds.id"></code>
                                                            <small class="text-muted text-truncate d-block" x-text="ds.instance_data_dir"></small>
                                                            <small class="text-muted d-block" x-text="formatBytes((ds.total_size_mb || 0) * 1024 * 1024)"></small>
                                                        </div>
                                                        <span class="badge bg-secondary ms-2" x-text="ds.file_count + ' files'"></span>
                                                    </div>
                                                </template>
                                            </div>

                                            <!-- Consent checkbox -->
                                            <template x-if="preSubmitModal.dataConsent === 'ask'">
                                                <div class="form-check form-check-lg text-center">
                                                    <input type="checkbox"
                                                           class="form-check-input me-2"
                                                           id="wizardDataConsent"
                                                           x-model="preSubmitModal.dataConsentConfirmed"
                                                           style="width: 1.25rem; height: 1.25rem;"
                                                           @change.stop>
                                                    <label class="form-check-label" for="wizardDataConsent">
                                                        I confirm uploading this data to the cloud
                                                    </label>
                                                </div>
                                            </template>

                                            <!-- Denied state -->
                                            <template x-if="preSubmitModal.dataConsent === 'deny'">
                                                <div class="alert alert-danger text-center">
                                                    <i class="fas fa-ban me-2"></i>
                                                    Uploads are disabled in settings.
                                                    <a href="#" @click.prevent="window.UIHelpers?.navigateToTabAndClose('ui-settings', () => closePreSubmitModal())" class="alert-link">Change settings</a>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <!-- STEP 3 (or 2 if no upload): Ready to Submit -->
                                <div class="wizard-panel"
                                     x-show="wizardIsFinalStep(preSubmitModal.wizardStep)"
                                     x-transition>
                                    <div class="text-center mb-4">
                                        <div class="wizard-icon mb-3">
                                            <i class="fas fa-rocket fa-2x text-success"></i>
                                        </div>
                                        <h4 class="mb-1">Ready to Submit</h4>
                                        <p class="text-muted mb-0">Review your job details</p>
                                    </div>

                                    <div class="row justify-content-center">
                                        <div class="col-12 col-md-8">
                                            <!-- Summary card -->
                                            <div class="wizard-review-card p-4 rounded mb-4" style="background: rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.2);">
                                                <div class="row g-3 text-center">
                                                    <div class="col-12">
                                                        <div class="text-muted small">Run Name</div>
                                                        <div class="fs-5 fw-bold" x-text="preSubmitModal.trackerRunName || '(unnamed)'"></div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-muted small">Est. Cost</div>
                                                        <div class="fw-bold text-info" x-text="wizardCostDisplay"></div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="text-muted small">Data</div>
                                                        <template x-if="wizardRequiresUpload">
                                                            <div class="text-info">
                                                                <i class="fas fa-check me-1"></i>
                                                                <span x-text="preSubmitModal.dataUploadPreview?.total_files || 0"></span> files
                                                                <div class="small text-muted mt-1" x-text="formatBytes((preSubmitModal.dataUploadPreview?.total_size_mb || 0) * 1024 * 1024)"></div>
                                                            </div>
                                                        </template>
                                                        <template x-if="!wizardRequiresUpload">
                                                            <div class="text-success">
                                                                <i class="fas fa-check me-1"></i>Ready
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Quota Impact Warning -->
                                            <template x-if="preSubmitModal.quotaImpact && preSubmitModal.quotaImpact.impacts && preSubmitModal.quotaImpact.impacts.length > 0">
                                                <div class="mb-3">
                                                    <template x-for="impact in preSubmitModal.quotaImpact.impacts" :key="impact.quota_type">
                                                        <div class="alert py-2 px-3 mb-2"
                                                             :class="{
                                                                 'alert-danger': impact.would_exceed && impact.action === 'block',
                                                                 'alert-warning': impact.would_exceed && impact.action !== 'block',
                                                                 'alert-info': !impact.would_exceed
                                                             }"
                                                             :style="impact.would_exceed && impact.action === 'block'
                                                                 ? 'background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);'
                                                                 : impact.would_exceed
                                                                     ? 'background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);'
                                                                     : 'background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);'">
                                                            <div class="d-flex align-items-center">
                                                                <i class="fas me-2"
                                                                   :class="{
                                                                       'fa-ban text-danger': impact.would_exceed && impact.action === 'block',
                                                                       'fa-exclamation-triangle text-warning': impact.would_exceed && impact.action !== 'block',
                                                                       'fa-chart-line text-info': !impact.would_exceed
                                                                   }"></i>
                                                                <div class="flex-grow-1">
                                                                    <div class="small fw-medium" x-text="impact.quota_type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())"></div>
                                                                    <div class="d-flex align-items-center gap-2 mt-1">
                                                                        <div class="progress flex-grow-1" style="height: 6px;">
                                                                            <div class="progress-bar"
                                                                                 :class="{
                                                                                     'bg-danger': impact.projected_percent >= 100,
                                                                                     'bg-warning': impact.projected_percent >= 80 && impact.projected_percent < 100,
                                                                                     'bg-success': impact.projected_percent < 80
                                                                                 }"
                                                                                 :style="'width: ' + Math.min(impact.projected_percent, 100) + '%'">
                                                                            </div>
                                                                        </div>
                                                                        <span class="small text-muted" x-text="impact.projected_percent.toFixed(0) + '%'"></span>
                                                                    </div>
                                                                    <div class="small text-muted mt-1">
                                                                        <span x-text="'$' + impact.current.toFixed(2)"></span> â†’
                                                                        <span x-text="'$' + impact.projected.toFixed(2)"></span>
                                                                        / <span x-text="'$' + impact.limit.toFixed(2)"></span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>

                                            <!-- Webhook connectivity check -->
                                            <template x-if="webhookUrl">
                                                <div class="mb-3">
                                                    <!-- Testing state -->
                                                    <template x-if="preSubmitModal.webhookCheck.testing">
                                                        <div class="alert alert-info py-2 px-3 mb-0" style="background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                                                            <div class="d-flex align-items-center">
                                                                <i class="fas fa-spinner fa-spin me-2"></i>
                                                                <span class="small">Checking webhook reachability...</span>
                                                            </div>
                                                        </div>
                                                    </template>

                                                    <!-- Success state -->
                                                    <template x-if="preSubmitModal.webhookCheck.tested && preSubmitModal.webhookCheck.success && !preSubmitModal.webhookCheck.testing">
                                                        <div class="alert alert-success py-2 px-3 mb-0" style="background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3);">
                                                            <div class="d-flex align-items-center">
                                                                <i class="fas fa-check-circle me-2"></i>
                                                                <span class="small">Webhook is reachable</span>
                                                            </div>
                                                        </div>
                                                    </template>

                                                    <!-- Failed state (not skipped) -->
                                                    <template x-if="preSubmitModal.webhookCheck.tested && !preSubmitModal.webhookCheck.success && !preSubmitModal.webhookCheck.skipped && !preSubmitModal.webhookCheck.testing">
                                                        <div class="alert alert-danger py-2 px-3 mb-0" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
                                                            <div class="d-flex align-items-start">
                                                                <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                                                                <div class="flex-grow-1">
                                                                    <div class="small mb-1">
                                                                        <strong>Webhook unreachable:</strong>
                                                                        <span x-text="preSubmitModal.webhookCheck.error || 'Connection failed'"></span>
                                                                    </div>
                                                                    <div class="d-flex gap-2">
                                                                        <button type="button" class="btn btn-sm btn-outline-light" @click="retryWebhookCheck()">
                                                                            <i class="fas fa-redo me-1"></i>Retry
                                                                        </button>
                                                                        <button type="button" class="btn btn-sm btn-outline-warning" @click="skipWebhookCheck()">
                                                                            Submit Anyway
                                                                        </button>
                                                                    </div>
                                                                    <div class="small text-muted mt-1">
                                                                        Without a reachable webhook, you'll rely on polling for status updates.
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </template>

                                                    <!-- Skipped state -->
                                                    <template x-if="preSubmitModal.webhookCheck.skipped && !preSubmitModal.webhookCheck.success && !preSubmitModal.webhookCheck.testing">
                                                        <div class="alert alert-secondary py-2 px-3 mb-0" style="background: rgba(156, 163, 175, 0.1); border-color: rgba(156, 163, 175, 0.3);">
                                                            <div class="d-flex align-items-center">
                                                                <i class="fas fa-info-circle me-2"></i>
                                                                <span class="small">Webhook check skipped (status updates via polling)</span>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>

                                            <!-- Resume limitation notice -->
                                            <div class="alert alert-warning py-2 px-3 mb-3" style="background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);">
                                                <div class="d-flex align-items-start">
                                                    <i class="fas fa-info-circle text-warning me-2 mt-1" style="font-size: 0.9rem;"></i>
                                                    <div class="small">
                                                        <strong>Note:</strong> Resuming interrupted jobs is a planned feature.
                                                        Save checkpoints more frequently and allow extra training time as a safeguard.
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Optional: Git snapshot (collapsed) -->
                                            <template x-if="preSubmitModal.repoPresent">
                                                <details class="mb-3">
                                                    <summary class="small text-muted" style="cursor: pointer;">
                                                        <i class="fas fa-code-branch me-1"></i>Create Git Snapshot (optional)
                                                    </summary>
                                                    <div class="mt-2">
                                                        <input type="text"
                                                               class="form-control bg-dark text-light border-secondary"
                                                               placeholder="Snapshot name (leave blank to skip)"
                                                               x-model="preSubmitModal.snapshotName"
                                                               @input.stop
                                                               @change.stop>
                                                    </div>
                                                </details>
                                            </template>

                                            <!-- Optional: Review config (collapsed) -->
                                            <details class="mb-3">
                                                <summary class="small text-muted" style="cursor: pointer;">
                                                    <i class="fas fa-code me-1"></i>Review Config JSON
                                                </summary>
                                                <div class="mt-2">
                                                    <pre class="bg-dark border border-secondary rounded p-2 mb-0"
                                                         style="font-size: 0.7rem; max-height: 150px; overflow: auto;"
                                                         x-text="JSON.stringify(preSubmitModal.configPreview, null, 2)"></pre>
                                                </div>
                                            </details>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>

            <!-- Footer -->
            <div class="modal-footer border-secondary py-2">
                <div class="d-flex w-100 gap-2 align-items-center">
                    <!-- Quick submit mode toggle (left side) -->
                    <div class="form-check form-switch me-auto d-none d-sm-block" x-show="!preSubmitModal.loading">
                        <input type="checkbox"
                               class="form-check-input"
                               id="quickSubmitToggle"
                               x-model="quickSubmitMode"
                               @change.stop="saveQuickSubmitMode(quickSubmitMode); preSubmitModal.wizardStep = 1;">
                        <label class="form-check-label small text-muted" for="quickSubmitToggle">Quick mode</label>
                    </div>

                    <!-- Quick mode: simple Cancel/Submit -->
                    <template x-if="quickSubmitMode">
                        <div class="d-flex gap-2 flex-grow-1 flex-sm-grow-0">
                            <button type="button" class="btn btn-secondary flex-grow-1 flex-sm-grow-0" @click="closePreSubmitModal()">Cancel</button>
                            <button type="button"
                                    class="btn btn-primary flex-grow-1 flex-sm-grow-0"
                                    :disabled="!wizardCanSubmit"
                                    @click="submitCloudJob()">
                                <i class="fas me-1" :class="submitting ? 'fa-spinner fa-spin' : 'fa-rocket'"></i>
                                <span x-text="submitting ? 'Submitting...' : 'Submit'"></span>
                            </button>
                        </div>
                    </template>

                    <!-- Wizard mode: Back/Next/Submit navigation -->
                    <template x-if="!quickSubmitMode">
                        <div class="d-flex gap-2 flex-grow-1 flex-sm-grow-0">
                            <!-- Back button (not on step 1) -->
                            <button type="button"
                                    class="btn btn-outline-secondary flex-grow-1 flex-sm-grow-0"
                                    x-show="preSubmitModal.wizardStep > 1"
                                    @click="preSubmitModal.wizardStep--">
                                <i class="fas fa-chevron-left me-1 d-sm-none"></i>Back
                            </button>

                            <!-- Cancel on step 1 -->
                            <button type="button"
                                    class="btn btn-outline-secondary flex-grow-1 flex-sm-grow-0"
                                    x-show="preSubmitModal.wizardStep === 1"
                                    @click="closePreSubmitModal(); preSubmitModal.wizardStep = 1;">
                                Cancel
                            </button>

                            <!-- Next button (not on last step) -->
                            <button type="button"
                                    class="btn btn-primary flex-grow-1 flex-sm-grow-0"
                                    x-show="!wizardIsFinalStep(preSubmitModal.wizardStep)"
                                    :disabled="wizardIsDataStep(preSubmitModal.wizardStep) && wizardDataConsentBlocked"
                                    @click="preSubmitModal.wizardStep++">
                                Continue<i class="fas fa-chevron-right ms-1"></i>
                            </button>

                            <!-- Submit button (on last step) -->
                            <button type="button"
                                    class="btn btn-success flex-grow-1 flex-sm-grow-0"
                                    x-show="wizardIsFinalStep(preSubmitModal.wizardStep)"
                                    :disabled="!wizardCanSubmit"
                                    @click="submitCloudJob()">
                                <i class="fas me-1" :class="submitting ? 'fa-spinner fa-spin' : 'fa-rocket'"></i>
                                <span x-text="submitting ? 'Submitting...' : 'Submit Job'"></span>
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop fade show" x-show="preSubmitModal.open" @click="closePreSubmitModal()"></div>
