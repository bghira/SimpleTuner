<!-- Dataloader Configuration Section -->
<script>
(() => {
const CONDITIONING_GENERATOR_TYPES = [
    { value: 'canny', label: 'Canny Edges', description: 'Detect edge maps using the Canny operator.' },
    { value: 'edges', label: 'Edges (OpenCV)', description: 'Generic edge detector (alias for Canny).' },
    { value: 'hed', label: 'HED Edge Detector', description: 'Holistically-Nested Edge Detection network.' },
    { value: 'lineart', label: 'Line Art', description: 'Line art extraction tuned for anime/illustrations.' },
    { value: 'lineart_coarse', label: 'Line Art (Coarse)', description: 'Coarse line art extraction variant.' },
    { value: 'scribble', label: 'Scribble', description: 'Generates scribble-style outlines.' },
    { value: 'depth', label: 'Depth (Automatic)', description: 'Depth map using default depth estimator (alias for MiDaS).' },
    { value: 'depth_midas', label: 'Depth (MiDaS)', description: 'Depth estimation using MiDaS.' },
    { value: 'depth_leres', label: 'Depth (LeReS)', description: 'Depth estimation tuned for outdoor scenes.' },
    { value: 'normal_map', label: 'Normal Map', description: 'Surface normals derived from depth.' },
    { value: 'random_masks', label: 'Random Masks', description: 'Randomly generated masks for inpainting.' },
    { value: 'binary_mask', label: 'Binary Mask', description: 'Binary mask generation for inpainting workflows.' },
    { value: 'inpainting', label: 'Inpainting Mask', description: 'Alias for random mask based generators.' },
    { value: 'jpeg_artifacts', label: 'JPEG Artifacts', description: 'Generates degraded JPEG control inputs.' },
    { value: 'superresolution', label: 'Super Resolution', description: 'Reconstructs high-res conditioning frames.' },
    { value: 'content_shuffle', label: 'Content Shuffle', description: 'Shuffles image content for texture variations.' },
    { value: 'tile', label: 'Tile / Texture', description: 'Tile-friendly control inputs for seamless textures.' },
    { value: 'rembg', label: 'Foreground Mask (Rembg)', description: 'Foreground/background segmentation using Rembg.' },
    { value: '__custom__', label: 'Other (enter manually)', description: 'Specify a custom generator id.' },
];

const SKIP_DISCOVERY_OPTIONS = [
    {
        value: 'text',
        label: 'Skip text embeds',
        hint: 'Skips discovering new captions or generating updated text embeddings.'
    },
    {
        value: 'vae',
        label: 'Skip VAE cache',
        hint: 'Prevents VAE cache refreshes for new or updated images.'
    },
    {
        value: 'aspect',
        label: 'Skip aspect buckets',
        hint: 'Avoids recalculating aspect buckets; only safe when image dimensions are unchanged.'
    },
    {
        value: 'metadata',
        label: 'Skip metadata discovery',
        hint: 'Disables general file discovery. Use only when the dataset contents are frozen.'
    }
];

window.CONDITIONING_GENERATOR_TYPES = window.CONDITIONING_GENERATOR_TYPES || CONDITIONING_GENERATOR_TYPES;

function dataloaderSectionComponent() {
    return {
    storeReady: false,
    _storeReadyHandled: false,
    dangerMode: false,
    _trainerCache: null,
    _captionFilterCache: null,
    _captionFilterCacheTime: 0,

    init() {
        window.dataloaderSectionComponentInstance = this;
        if (window.__pendingGeneratorSync) {
            this.syncGeneratorSelectionsForAll();
            delete window.__pendingGeneratorSync;
        }
        this.dangerMode = this.computeDangerModeEnabled();

        if (!this._dangerModeHandler) {
            this._dangerModeHandler = (event) => {
                if (event && typeof event.detail?.enabled !== 'undefined') {
                    this.dangerMode = !!event.detail.enabled;
                } else {
                    this.dangerMode = this.computeDangerModeEnabled();
                }
            };
            window.addEventListener('trainer-danger-mode-changed', this._dangerModeHandler);
        }

        if (Alpine.store('trainer')) {
            this.onStoreReady();
        }
    },

    onStoreReady() {
        if (this._storeReadyHandled) {
            return;
        }
        this._storeReadyHandled = true;
        this.storeReady = true;
        if (Array.isArray(this.datasets)) {
            this.datasets.forEach((dataset) => this.ensureDatasetRuntimeState(dataset));
        }
        this.ensureCaptionFiltersLoaded();
        this.syncCaptionFilterSelections();
        this.syncGeneratorSelectionsForAll();
        this.dangerMode = this.computeDangerModeEnabled();
    },

    get trainer() {
        if (!this._trainerCache) {
            this._trainerCache = Alpine.store('trainer') || {};
        }
        return this._trainerCache;
    },
    get dataLoaderMode() {
        return this.trainer.dataLoaderMode || 'builder';
    },
    get datasets() {
        return this.trainer.datasets || [];
    },
    get datasetsLoading() {
        return this.trainer.datasetsLoading || false;
    },
    get dataLoaderJson() {
        return this.trainer.dataLoaderJson || '';
    },
    set dataLoaderJson(value) {
        const trainer = Alpine.store('trainer');
        if (trainer) {
            trainer.dataLoaderJson = value;
            this.markAsUnsaved();
        }
    },
    get hasUnsavedChanges() {
        return this.trainer.hasUnsavedChanges || false;
    },
    get modelContext() {
        const trainer = Alpine.store('trainer');
        if (!trainer) {
            return {};
        }
        return trainer.modelContext || (typeof trainer.defaultModelContext === 'function' ? trainer.defaultModelContext() : {});
    },
    get conditioningFeaturesActive() {
        const context = this.modelContext || {};
        return Boolean(context.controlnetEnabled || context.requiresConditioningDataset);
    },
    get conditioningSupported() {
        return this.conditioningFeaturesActive;
    },
    get conditioningRequired() {
        return Boolean(this.modelContext.requiresConditioningDataset);
    },
    get isVideoModel() {
        const context = this.modelContext || {};
        return Boolean(context.isVideoModel || context.supportsVideo);
    },
    get conditioningDatasetType() {
        return this.modelContext.conditioningDatasetType || 'conditioning';
    },
    get availableGeneratorTypes() {
        return CONDITIONING_GENERATOR_TYPES;
    },
    get captionFilterOptions() {
        const now = Date.now();
        if (this._captionFilterCache && (now - this._captionFilterCacheTime) < 1000) {
            return this._captionFilterCache;
        }

        const trainer = Alpine.store('trainer');
        if (!trainer || !Array.isArray(trainer.captionFilters)) {
            this._captionFilterCache = [];
            this._captionFilterCacheTime = now;
            return [];
        }

        this._captionFilterCache = trainer.captionFilters.map((filter) => {
            if (!filter) {
                return { value: '', label: '', description: '' };
            }
            const value = filter.path || filter.name || '';
            return {
                value,
                name: filter.name || value,
                label: filter.label || filter.name || value,
                description: filter.description || ''
            };
        }).filter((option) => option.value);
        this._captionFilterCacheTime = now;
        return this._captionFilterCache;
    },
    ensureCaptionFiltersLoaded() {
        const trainer = Alpine.store('trainer');
        if (trainer && typeof trainer.loadCaptionFilters === 'function') {
            trainer.loadCaptionFilters();
        }
    },
    ensureDatasetRuntimeState(dataset) {
        if (!dataset || typeof dataset !== 'object') {
            return;
        }
        if (dataset._connectionStatus === undefined) {
            dataset._connectionStatus = null;
        }
        if (dataset._connectionMessage === undefined) {
            dataset._connectionMessage = '';
        }
        if (dataset._connectionDetails === undefined) {
            dataset._connectionDetails = null;
        }
        if (dataset._connectionTesting === undefined) {
            dataset._connectionTesting = false;
        }
        if (dataset._awsEndpointVisible === undefined) {
            dataset._awsEndpointVisible = false;
        }
        if (dataset._awsAccessVisible === undefined) {
            dataset._awsAccessVisible = false;
        }
        if (dataset._awsSecretVisible === undefined) {
            dataset._awsSecretVisible = false;
        }
        if (!Array.isArray(dataset._skipDiscovery)) {
            dataset._skipDiscovery = this.parseSkipDiscovery(dataset.skip_file_discovery);
        }
        // Initialize text_embeds and image_embeds to empty string if undefined or null
        // This ensures x-model bindings work correctly in select dropdowns
        if (dataset.text_embeds === undefined || dataset.text_embeds === null) {
            dataset.text_embeds = '';
        }
        if (dataset.image_embeds === undefined || dataset.image_embeds === null) {
            dataset.image_embeds = '';
        }
        if (!Array.isArray(dataset.conditioning)) {
            if (dataset.conditioning && typeof dataset.conditioning === 'object') {
                dataset.conditioning = [dataset.conditioning];
            } else {
                dataset.conditioning = [];
            }
        }
        if (dataset._showAdvanced === undefined) {
            dataset._showAdvanced = false;
        }
        if (dataset._showConditioning === undefined) {
            dataset._showConditioning = true;
        }
    },
    syncCaptionFilterSelections() {
        if (!Array.isArray(this.datasets)) {
            return;
        }
        const trainer = Alpine.store('trainer');
        const filters = trainer && Array.isArray(trainer.captionFilters) ? trainer.captionFilters : [];
        const canonicalMap = new Map();
        filters.forEach((filter) => {
            if (!filter) {
                return;
            }
            const canonical = filter.path || filter.name || '';
            if (!canonical) {
                return;
            }
            canonicalMap.set(canonical, canonical);
            if (filter.name && filter.name !== canonical) {
                canonicalMap.set(filter.name, canonical);
            }
        });
        this.datasets.forEach((dataset) => {
            if (!dataset) {
                return;
            }
            this.ensureDatasetRuntimeState(dataset);
            if (dataset.dataset_type === 'text_embeds') {
                const current = typeof dataset.caption_filter_list === 'string' ? dataset.caption_filter_list.trim() : '';
                if (!current) {
                    dataset._selectedCaptionFilter = '';
                    return;
                }
                const resolved = trainer && typeof trainer.resolveCaptionFilterValue === 'function'
                    ? trainer.resolveCaptionFilterValue(current)
                    : current;
                const canonical = canonicalMap.get(resolved) || canonicalMap.get(current);
                if (canonical) {
                    dataset.caption_filter_list = canonical;
                    dataset._selectedCaptionFilter = canonical;
                } else {
                    dataset._selectedCaptionFilter = '__custom__';
                }
            } else {
                dataset._selectedCaptionFilter = '';
            }
        });
    },
    syncGeneratorSelectionsForAll() {
        if (!Array.isArray(this.datasets)) {
            return;
        }
        this.datasets.forEach((dataset) => {
            this.ensureDatasetRuntimeState(dataset);
            this.syncGeneratorSelections(dataset);
        });
    },
    supportsConnectionTest(dataset) {
        if (!dataset) {
            return false;
        }
        const type = dataset.type || '';
        const datasetType = dataset.dataset_type || '';
        if (['aws', 'csv', 'huggingface'].includes(type)) {
            return true;
        }
        if (datasetType === 'image_embeds') {
            return true;
        }
        return false;
    },
    touchConnectionField(dataset) {
        if (!dataset) {
            return;
        }
        this.ensureDatasetRuntimeState(dataset);
        dataset._connectionStatus = null;
        dataset._connectionMessage = '';
        dataset._connectionDetails = null;
        this.markAsUnsaved();
    },
    async testDatasetConnection(dataset) {
        const trainer = Alpine.store('trainer');
        if (!dataset || !trainer || typeof trainer.prepareDatasetsForSave !== 'function') {
            window.showToast('Dataset builder not ready for connection test.', 'error');
            return;
        }

        this.ensureDatasetRuntimeState(dataset);
        dataset._connectionTesting = true;
        dataset._connectionStatus = null;
        dataset._connectionMessage = '';
        dataset._connectionDetails = null;

        try {
            const sanitized = trainer.prepareDatasetsForSave([dataset]);
            if (!Array.isArray(sanitized) || !sanitized[0]) {
                throw new Error('Unable to prepare dataset payload.');
            }
            const payload = {
                dataset: sanitized[0],
                configs_dir: trainer.defaults?.configs_dir || null,
            };
            const response = await fetch('/api/datasets/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                const message = error?.detail?.message || error?.detail || response.statusText || 'Connection test failed.';
                throw new Error(message);
            }
            const result = await response.json();
            dataset._connectionStatus = 'success';
            dataset._connectionMessage = result.message || 'Connection successful.';
            dataset._connectionDetails = result.details || null;
            window.showToast(dataset._connectionMessage, 'success');
        } catch (error) {
            console.error('Dataset connection test failed:', error);
            dataset._connectionStatus = 'error';
            dataset._connectionMessage = error?.message || 'Connection test failed.';
            dataset._connectionDetails = null;
            window.showToast(dataset._connectionMessage, 'error');
        } finally {
            dataset._connectionTesting = false;
        }
    },
    syncGeneratorSelections(dataset) {
        if (!dataset) {
            return;
        }
        this.ensureDatasetRuntimeState(dataset);
        if (!Array.isArray(dataset.conditioning)) {
            dataset.conditioning = [];
        }
        dataset.conditioning.forEach((generator, index) => {
            if (!generator) {
                dataset.conditioning[index] = {};
                generator = dataset.conditioning[index];
            }
            const type = typeof generator.type === 'string' ? generator.type.trim() : '';
            if (this.isKnownGeneratorType(type)) {
                generator._selectedType = type;
                generator._customType = '';
            } else if (type) {
                generator._selectedType = '__custom__';
                generator._customType = type;
            } else {
                generator._selectedType = '';
                generator._customType = '';
            }
        });
    },
    datasetOptionsForType(dataset, type) {
        const trainer = Alpine.store('trainer');
        if (!trainer || !Array.isArray(trainer.datasets)) {
            return [];
        }
        return trainer.datasets
            .filter((entry) => entry && entry.id && entry.dataset_type === type && entry.id !== dataset?.id)
            .map((entry) => ({
                id: entry.id,
                label: `${entry.id}${entry.dataset_type ? ` (${entry.dataset_type})` : ''}`
            }));
    },
    renderDatasetOptions(dataset, type, emptyLabel) {
        const options = this.datasetOptionsForType(dataset, type);
        let html = `<option value="">${emptyLabel}</option>`;
        options.forEach(option => {
            html += `<option value="${this.escapeHtml(option.id)}">${this.escapeHtml(option.label)}</option>`;
        });
        return html;
    },
    escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    },
    getGeneratorOption(value) {
        return CONDITIONING_GENERATOR_TYPES.find((option) => option.value === value) || null;
    },
    getGeneratorDescription(value) {
        const option = this.getGeneratorOption(value);
        return option ? option.description || '' : '';
    },
    isKnownGeneratorType(value) {
        if (!value) {
            return false;
        }
        return CONDITIONING_GENERATOR_TYPES.some((option) => option.value === value && option.value !== '__custom__');
    },
    onGeneratorTypeSelect(generator) {
        if (!generator) {
            return;
        }
        const trainer = Alpine.store('trainer');
        if (generator._selectedType === '__custom__') {
            if (!generator._customType) {
                generator.type = '';
            } else {
                generator.type = generator._customType.trim();
            }
        } else {
            generator.type = generator._selectedType || '';
            generator._customType = '';
        }
        if (trainer && typeof trainer.markDatasetsDirty === 'function') {
            trainer.markDatasetsDirty();
        }
    },
    onGeneratorTypeManual(generator) {
        if (!generator) {
            return;
        }
        const trainer = Alpine.store('trainer');
        const value = generator._customType ? generator._customType.trim() : '';
        generator._customType = value;
        generator.type = value;
        generator._selectedType = '__custom__';
        if (trainer && typeof trainer.markDatasetsDirty === 'function') {
            trainer.markDatasetsDirty();
        }
    },
    conditioningOptions(dataset) {
        const trainer = Alpine.store('trainer');
        if (!trainer || !dataset) {
            return [];
        }
        const options = trainer.getConditioningDatasetIds ? trainer.getConditioningDatasetIds(dataset.id) : [];
        const current = Array.isArray(dataset.conditioning_data) ? dataset.conditioning_data : [];
        if (!this.conditioningSupported && dataset.dataset_type !== 'conditioning') {
            return [...new Set(current)];
        }
        return [...new Set([...options, ...current])];
    },
    datasetSafeId(dataset) {
        if (!dataset || !dataset.id) {
            return 'dataset';
        }
        return dataset.id.toString().replace(/[^a-zA-Z0-9_-]/g, '-');
    },
    shouldShowConditioningSection(dataset) {
        if (!dataset) {
            return false;
        }
        const type = dataset.dataset_type;
        const hasLinks = Array.isArray(dataset.conditioning_data) && dataset.conditioning_data.length > 0;
        const hasGenerators = Array.isArray(dataset.conditioning) && dataset.conditioning.length > 0;
        const featuresActive = this.conditioningSupported;

        if (!featuresActive && type !== 'conditioning' && !hasLinks && !hasGenerators) {
            return false;
        }

        if (type === 'conditioning') {
            return true;
        }

        if (type === 'image' || type === 'video') {
            return featuresActive || hasLinks || hasGenerators;
        }

        return hasLinks || hasGenerators;
    },
    onConditioningDataChange(dataset, event) {
        const trainer = Alpine.store('trainer');
        if (event && event.target && event.target.options) {
            const selected = Array.from(event.target.options)
                .filter((option) => option.selected)
                .map((option) => option.value)
                .filter((value) => typeof value === 'string' && value.trim() !== '')
                .map((value) => value.trim());
            dataset.conditioning_data = selected;
        }
        if (trainer && typeof trainer.markDatasetsDirty === 'function') {
            trainer.markDatasetsDirty();
        }
    },
    addConditioningGenerator(dataset) {
        const trainer = Alpine.store('trainer');
        if (!trainer || typeof trainer.addConditioningGenerator !== 'function') {
            window.showToast('Conditioning tools not ready. Please wait and try again.', 'error');
            return;
        }
        trainer.addConditioningGenerator(dataset);
        this.syncGeneratorSelections(dataset);
    },
    removeConditioningGenerator(dataset, generator) {
        const trainer = Alpine.store('trainer');
        if (!trainer || typeof trainer.removeConditioningGenerator !== 'function') {
            window.showToast('Conditioning tools not ready. Please wait and try again.', 'error');
            return;
        }
        const key = generator?._uiKey || generator?.id;
        trainer.removeConditioningGenerator(dataset, key);
    },
    onGeneratorTypeChange(generator) {
        const trainer = Alpine.store('trainer');
        if (trainer && typeof trainer.markDatasetsDirty === 'function') {
            trainer.markDatasetsDirty();
        }
    },
    onGeneratorParamsBlur(generator) {
        const trainer = Alpine.store('trainer');
        if (trainer && typeof trainer.updateConditioningParams === 'function') {
            trainer.updateConditioningParams(generator, generator._paramsText || '{}');
        }
    },
    onGeneratorCaptionsModeChange(generator) {
        const trainer = Alpine.store('trainer');
        if (trainer && typeof trainer.setConditioningCaptionsMode === 'function') {
            trainer.setConditioningCaptionsMode(generator, generator._captionsMode || 'inherit');
        }
    },
    onGeneratorCaptionsInput(generator) {
        const trainer = Alpine.store('trainer');
        if (trainer && typeof trainer.updateConditioningCaptionsValue === 'function') {
            trainer.updateConditioningCaptionsValue(generator, generator._captionsValue || '');
        }
    },

    // Direct method calls with error handling
    async saveDatasets() {
        const trainer = Alpine.store('trainer');
        if (!trainer) {
            window.showToast('Dataset builder not ready. Please wait and try again.', 'error');
            return;
        }

        try {
            // Direct save without going through the trainer's dialog system
            const payloadDatasets = trainer.prepareDatasetsForSave();
            if (trainer.datasetValidationErrors && Object.keys(trainer.datasetValidationErrors).length > 0) {
                window.showToast('Resolve dataset validation errors before saving.', 'error');
                return;
            }
            const response = await fetch('/api/datasets/plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    datasets: payloadDatasets,
                    createBackup: false
                })
            });

            if (response.ok) {
                trainer.hasUnsavedChanges = false;
                trainer.datasetValidationErrors = {};
                const result = await response.json();
                let message = 'Dataset configuration saved';
                if (result.backupPath) {
                    message += ` (backup: ${result.backupPath})`;
                }
                window.showToast(message, 'success');
                trainer.refreshDatasetsJson();
            } else {
                const error = await response.json();
                if (error.detail && error.detail.validations) {
                    // Map validation errors to field-specific errors
                    const fieldErrors = {};
                    const errorMessages = [];
                    error.detail.validations.forEach(validation => {
                        if (validation.field && validation.field.includes('.')) {
                            fieldErrors[validation.field] = validation.message;
                            // Extract dataset ID and field name for display
                            const parts = validation.field.split('.');
                            const datasetId = parts[0];
                            const fieldName = parts.slice(1).join('.');
                            errorMessages.push(`${datasetId}: ${validation.message}`);
                        }
                    });
                    trainer.datasetValidationErrors = fieldErrors;

                    // Show detailed error messages
                    if (errorMessages.length > 0) {
                        const errorList = errorMessages.map(msg => `• ${msg}`).join('<br>');
                        const errorHtml = `<div style="text-align: left;"><strong>Validation errors:</strong><br>${errorList}</div>`;
                        window.showToast(errorHtml, 'error', 8000);
                    } else {
                        window.showToast('Failed to save: validation errors', 'error');
                    }
                } else {
                    window.showToast(`Failed to save: ${error.detail || 'Unknown error'}`, 'error');
                }
            }
        } catch (error) {
            console.error('Error saving datasets:', error);
            window.showToast('Failed to save dataset configuration', 'error');
        }
    },

    onAddDatasetClick(type) {
        if (type === 'video' && !this.isVideoModel) {
            const confirmed = window.confirm('This model is not marked as video-capable. Add a video dataset anyway?');
            if (!confirmed) {
                return;
            }
        }
        this.addDataset(type);
    },

    addDataset(type) {
        const trainer = Alpine.store('trainer');
        if (!trainer || !trainer.addDataset) {
            window.showToast('Dataset builder not ready. Please wait and try again.', 'error');
            return;
        }
        trainer.addDataset(type);
    },

    removeDataset(datasetId) {
        const trainer = Alpine.store('trainer');
        if (!trainer || !trainer.removeDataset) {
            window.showToast('Cannot remove dataset. Please wait and try again.', 'error');
            return;
        }
        trainer.removeDataset(datasetId);
    },

    duplicateDataset(datasetId) {
        const trainer = Alpine.store('trainer');
        if (!trainer || !trainer.duplicateDataset) {
            window.showToast('Cannot duplicate dataset. Please wait and try again.', 'error');
            return;
        }
        trainer.duplicateDataset(datasetId);
    },

    switchDataLoaderMode(mode) {
        const trainer = Alpine.store('trainer');
        if (!trainer || !trainer.switchDataLoaderMode) {
            window.showToast('Cannot switch mode. Please wait and try again.', 'error');
            return;
        }
        trainer.switchDataLoaderMode(mode);
    },

    loadPreset(presetName) {
        const trainer = Alpine.store('trainer');
        if (!trainer || !trainer.loadPreset) {
            window.showToast('Cannot load preset. Please wait and try again.', 'error');
            return;
        }
        trainer.loadPreset(presetName);
    },

    hasFieldError(datasetId, fieldName) {
        const trainer = Alpine.store('trainer');
        return trainer && trainer.hasFieldError ? trainer.hasFieldError(datasetId, fieldName) : false;
    },

    getFieldError(datasetId, fieldName) {
        const trainer = Alpine.store('trainer');
        return trainer && trainer.getFieldError ? trainer.getFieldError(datasetId, fieldName) : '';
    },

    getDatasetTypeIcon(type) {
        const trainer = Alpine.store('trainer');
        return trainer && trainer.getDatasetTypeIcon ? trainer.getDatasetTypeIcon(type) : '';
    },

    async saveJsonDatasets() {
        const trainer = Alpine.store('trainer');
        if (!trainer) {
            window.showToast('Dataset builder not ready. Please wait and try again.', 'error');
            return;
        }

        try {
            // Parse the JSON
            const parsedDatasets = JSON.parse(this.dataLoaderJson);

            // Update trainer datasets
            trainer.datasets = parsedDatasets;

            // Save using the direct method
            await this.saveDatasets();
        } catch (e) {
            window.showToast('Invalid JSON format. Please fix the JSON and try again.', 'error');
        }
    },
    onCaptionFilterSelect(dataset) {
        if (!dataset) {
            return;
        }
        const trainer = Alpine.store('trainer');
        if (dataset._selectedCaptionFilter === '__custom__') {
            // Leave existing path/value as-is for manual entry
        } else if (!dataset._selectedCaptionFilter) {
            dataset.caption_filter_list = '';
        } else {
            dataset.caption_filter_list = dataset._selectedCaptionFilter;
        }
        if (trainer && typeof trainer.markDatasetsDirty === 'function') {
            trainer.markDatasetsDirty();
        }
    },
    onStorageBackendChange(dataset) {
        if (!dataset) {
            return;
        }
        const previousStrategy = dataset.caption_strategy;
        const previousBackend = dataset.metadata_backend;

        if (dataset.type === 'csv') {
            if (!previousStrategy || previousStrategy === 'textfile') {
                dataset.caption_strategy = 'csv';
            }
        } else if (dataset.type === 'huggingface') {
            if (!previousStrategy || previousStrategy === 'textfile') {
                dataset.caption_strategy = 'huggingface';
            }
            if (!previousBackend || previousBackend === '' || previousBackend === 'discovery') {
                dataset.metadata_backend = 'huggingface';
            }
        }

        this.markAsUnsaved();
    },
    computeDangerModeEnabled() {
        const toggle = document.getElementById('i_know_what_i_am_doing');
        if (toggle) {
            return toggle.checked;
        }
        const trainer = Alpine.store('trainer');
        if (trainer && typeof trainer.isDangerModeEnabled === 'function') {
            try {
                return !!trainer.isDangerModeEnabled();
            } catch (error) {
                console.debug('Danger mode probe failed', error);
            }
        }
        return false;
    },
    skipDiscoveryOptions() {
        return SKIP_DISCOVERY_OPTIONS;
    },
    hasSkipDiscovery(dataset, option) {
        if (!dataset || !option) {
            return false;
        }
        const tokens = Array.isArray(dataset._skipDiscovery)
            ? dataset._skipDiscovery
            : this.parseSkipDiscovery(dataset.skip_file_discovery);
        return tokens.includes(option);
    },
    setSkipDiscovery(dataset, option, enabled) {
        if (!dataset || !option) {
            return;
        }
        const normalized = option.trim();
        let tokens = Array.isArray(dataset._skipDiscovery)
            ? [...dataset._skipDiscovery]
            : this.parseSkipDiscovery(dataset.skip_file_discovery);
        tokens = tokens.filter((token) => token !== normalized);
        if (enabled) {
            tokens.push(normalized);
        }
        dataset._skipDiscovery = tokens;
        this.updateSkipDiscoveryString(dataset);
        this.markAsUnsaved();
    },
    updateSkipDiscoveryString(dataset) {
        if (!dataset) {
            return;
        }
        const tokens = Array.isArray(dataset._skipDiscovery)
            ? dataset._skipDiscovery
            : this.parseSkipDiscovery(dataset.skip_file_discovery);
        const unique = Array.from(new Set(tokens.map((token) => token.trim()).filter((token) => token.length > 0)));
        dataset._skipDiscovery = unique;
        dataset.skip_file_discovery = unique.join(' ');
    },
    parseSkipDiscovery(value) {
        if (Array.isArray(value)) {
            return value.map((token) => (typeof token === 'string' ? token.trim() : String(token || '')).trim())
                .filter((token) => token.length > 0);
        }
        if (typeof value !== 'string') {
            return [];
        }
        return value.split(/[,\s]+/)
            .map((token) => token.trim())
            .filter((token) => token.length > 0);
    },
    dangerModeEnabled() {
        return !!this.dangerMode;
    },

    markAsUnsaved() {
        if (!this._markAsUnsavedDebounce) {
            this._markAsUnsavedDebounce = requestAnimationFrame(() => {
                const trainer = Alpine.store('trainer');
                if (trainer) {
                    if (typeof trainer.markDatasetsDirty === 'function') {
                        trainer.markDatasetsDirty();
                    } else {
                        trainer.hasUnsavedChanges = true;
                    }
                }
                this._markAsUnsavedDebounce = null;
            });
        }
    }
    }
}
window.dataloaderSectionComponent = dataloaderSectionComponent;
})();
</script>
<div id="dataloaderSection" data-builder="alpine" x-data="dataloaderSectionComponent()"
     x-init="(() => {
        init();

        const notifyStoreReady = () => {
            onStoreReady();
            $el.dispatchEvent(new CustomEvent('store-ready'));
        };

        if (Alpine.store('trainer')) {
            notifyStoreReady();
        }

        // Check periodically if the store becomes available
        const checkStore = setInterval(() => {
            if (Alpine.store('trainer')) {
                clearInterval(checkStore);
                notifyStoreReady();
            }
        }, 100);
        // Stop checking after 5 seconds
        setTimeout(() => clearInterval(checkStore), 5000);

        // Listen for environment changes
        const handleEnvironmentChange = async (event) => {
            console.log('Environment changed to:', event.detail.environment);
            const trainer = Alpine.store('trainer');
            if (trainer && trainer.loadDatasetsAfterEnvironmentChange) {
                // Reload datasets for the new environment
                await trainer.loadDatasetsAfterEnvironmentChange();
            }
        };

        window.addEventListener('environment-changed', handleEnvironmentChange);

        const handleCaptionFiltersUpdated = () => {
            syncCaptionFilterSelections();
        };
        window.addEventListener('caption-filters-updated', handleCaptionFiltersUpdated);

        // Listen for config-saved events to reload dataset builder
        const handleConfigSaved = async () => {
            console.log('Config saved, reloading dataset builder');
            const trainer = Alpine.store('trainer');
            if (trainer && trainer.loadDatasetsAfterEnvironmentChange) {
                await trainer.loadDatasetsAfterEnvironmentChange();
            }
        };
        window.addEventListener('config-saved', handleConfigSaved);

        // Clean up event listener when component is destroyed
        $el.addEventListener('x-destroy', () => {
            window.removeEventListener('environment-changed', handleEnvironmentChange);
            window.removeEventListener('caption-filters-updated', handleCaptionFiltersUpdated);
            window.removeEventListener('config-saved', handleConfigSaved);
            if (this._dangerModeHandler) {
                window.removeEventListener('trainer-danger-mode-changed', this._dangerModeHandler);
                delete this._dangerModeHandler;
            }
            if (window.dataloaderSectionComponentInstance === this) {
                delete window.dataloaderSectionComponentInstance;
            }
        });
     })()">

    <!-- Loading State -->
    <div x-show="!storeReady" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading dataset builder...</span>
        </div>
        <p class="mt-3 text-muted">Initializing dataset builder...</p>
    </div>

    <!-- Main Content (shown when store is ready) -->
    <div x-show="storeReady">
        <!-- Mode Switcher -->
        <div class="mode-switcher mb-3">
            <button type="button" class="btn"
                    :class="{ 'active': dataLoaderMode === 'builder' }"
                    @click="switchDataLoaderMode('builder')"
                    :disabled="!storeReady">
                <i class="fas fa-tools"></i> Builder Mode
            </button>
            <button type="button" class="btn"
                    :class="{ 'active': dataLoaderMode === 'json' }"
                    @click="switchDataLoaderMode('json')"
                    :disabled="!storeReady">
                <i class="fas fa-code"></i> JSON Mode
            </button>
        </div>

    <!-- Builder Mode -->
    <template x-if="dataLoaderMode === 'builder'">
    <div>
        <!-- Presets -->
        <div class="preset-container mb-4">
            <h6 class="subsection-title">Quick Start Presets</h6>
            <div class="preset-grid">
                <button type="button" class="preset-btn" data-preset="simple-local" @click="loadPreset('simple-local')" :disabled="!storeReady">
                    <div class="preset-name">Simple Local</div>
                    <div class="preset-description">Basic local image training setup</div>
                </button>
                <button type="button" class="preset-btn" data-preset="aws-with-local-cache" @click="loadPreset('aws-with-local-cache')" :disabled="!storeReady">
                    <div class="preset-name">AWS with Local Cache</div>
                    <div class="preset-description">Cloud storage with fast local caching</div>
                </button>
                <button type="button" class="preset-btn" data-preset="video-training"
                        @click="loadPreset('video-training')"
                        :disabled="!storeReady || !isVideoModel"
                        :title="isVideoModel ? 'Load video training preset' : 'Video training is only available for video models'">
                    <div class="preset-name">Video Training</div>
                    <div class="preset-description">Configuration for video model training</div>
                </button>
                <button type="button" class="preset-btn" data-preset="controlnet-training" @click="loadPreset('controlnet-training')"
                        :disabled="!storeReady || !conditioningSupported"
                        :title="conditioningSupported ? 'Load control-focused preset' : 'Active model does not support conditioning features'">
                    <div class="preset-name">ControlNet Training</div>
                    <div class="preset-description">Setup with conditioning generation</div>
                </button>
            </div>
        </div>

        <!-- Add Dataset Buttons -->
        <div class="mb-4" x-show="!datasetsLoading">
            <h6 class="subsection-title">Add Dataset Manually</h6>
            <p class="text-muted small mb-3">Configure individual datasets with custom settings. For guided setup, use the Dataset Wizard above.</p>
            <div class="add-dataset-container">
                <button type="button" class="add-dataset-btn" @click="addDataset('image')">
                    <i class="fas fa-plus"></i> 🖼️ Add Image Dataset
                </button>
                <button type="button" class="add-dataset-btn"
                        @click="onAddDatasetClick('video')"
                        :disabled="!storeReady"
                        :title="isVideoModel ? 'Add a video dataset' : 'Add a video dataset (advanced users only)'">
                    <i class="fas fa-plus"></i> 🎬 Add Video Dataset
                </button>
                <button type="button" class="add-dataset-btn" @click="addDataset('text_embeds')">
                    <i class="fas fa-plus"></i> 💾 Add Text Embeds
                </button>
                <button type="button" class="add-dataset-btn" @click="addDataset('image_embeds')">
                    <i class="fas fa-plus"></i> 💾 Add Image Embeds
                </button>
                <button type="button" class="add-dataset-btn"
                        @click="addDataset('conditioning')"
                        :disabled="!conditioningSupported"
                        :title="conditioningSupported ? 'Add a conditioning dataset' : 'No supported model features for conditioning'">
                    <i class="fas fa-plus"></i> 🎨 Add Conditioning
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div x-show="datasetsLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading datasets...</span>
            </div>
            <p class="mt-2 text-muted">Loading dataset configuration...</p>
        </div>

        <!-- Dataset List -->
        <div class="dataset-list" x-show="!datasetsLoading">
            <template x-for="dataset in datasets" :key="dataset.id">
                <div class="dataset-card mb-3" x-bind:data-dataset-id="dataset.id">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">
                            <span x-text="getDatasetTypeIcon(dataset.dataset_type)"></span>
                            <span x-text="dataset.id"></span>
                        </h6>
                        <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
                            <div class="form-check form-check-inline mb-0">
                                <input class="form-check-input"
                                       type="checkbox"
                                       :id="`dataset-disabled-${datasetSafeId(dataset)}`"
                                       x-model="dataset.disabled"
                                       @change="markAsUnsaved()">
                                <label class="form-check-label small" :for="`dataset-disabled-${datasetSafeId(dataset)}`">
                                    Disable dataset
                                </label>
                            </div>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <div class="btn-group" role="group" aria-label="Dataset actions">
                                    <button type="button"
                                            class="btn btn-sm dataset-connection-btn"
                                            :class="{
                                                'btn-outline-primary': !dataset._connectionStatus || dataset._connectionStatus === 'pending',
                                                'btn-outline-success': dataset._connectionStatus === 'success',
                                                'btn-outline-danger': dataset._connectionStatus === 'error'
                                            }"
                                            :title="dataset._connectionStatus === 'success'
                                                ? (dataset._connectionMessage || 'Connection succeeded. Click to test again.')
                                                : dataset._connectionStatus === 'error'
                                                    ? (dataset._connectionMessage || 'Connection failed. Click to retry.')
                                                    : 'Test backend connectivity'"
                                            :aria-label="dataset._connectionStatus === 'success'
                                                ? 'Connection succeeded. Click to test again.'
                                                : dataset._connectionStatus === 'error'
                                                    ? 'Connection failed. Click to retry.'
                                                    : 'Test backend connectivity'"
                                            @click="testDatasetConnection(dataset)"
                                            :disabled="dataset._connectionTesting || !supportsConnectionTest(dataset)">
                                        <span x-show="dataset._connectionTesting" x-cloak>
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </span>
                                        <span x-show="!dataset._connectionTesting && dataset._connectionStatus === 'success'" x-cloak>
                                            <i class="fas fa-check-square text-success"></i>
                                        </span>
                                        <span x-show="!dataset._connectionTesting && dataset._connectionStatus === 'error'" x-cloak>
                                            <i class="fas fa-exclamation-triangle text-warning"></i>
                                        </span>
                                        <span x-show="!dataset._connectionTesting && (!dataset._connectionStatus || dataset._connectionStatus === 'pending')" x-cloak>
                                            <i class="far fa-square"></i>
                                        </span>
                                    </button>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary"
                                            title="Duplicate dataset"
                                            aria-label="Duplicate dataset"
                                            @click="duplicateDataset(dataset.id)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger"
                                            title="Remove dataset"
                                            aria-label="Remove dataset"
                                            @click="removeDataset(dataset.id)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dataset-section">
                        <div class="dataset-section-header">Basic Settings</div>
                        <div class="dataset-section-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Type <span class="text-danger">*</span></label>
                            <select class="form-control form-control-sm"
                                    x-model="dataset.dataset_type"
                                    @change="markAsUnsaved()"
                                    :class="{'is-invalid': hasFieldError(dataset.id, 'dataset_type')}">
                                <option value="">Select type...</option>
                                <option value="image">🖼️ Image</option>
                                <option value="video">🎬 Video</option>
                                <option value="conditioning"
                                        :disabled="!conditioningSupported && dataset.dataset_type !== 'conditioning'">
                                    🎨 Conditioning
                                </option>
                                <option value="text_embeds">💾 Text Embeds</option>
                                <option value="image_embeds">💾 Image Embeds</option>
                            </select>
                            <div class="invalid-feedback"
                                 x-show="hasFieldError(dataset.id, 'dataset_type')"
                                 x-text="getFieldError(dataset.id, 'dataset_type')">
                            </div>
                        </div>
                    </div>
                    <div class="dataset-subgroup"
                         x-show="dataset.dataset_type !== 'text_embeds' && dataset.dataset_type !== 'image_embeds'">
                        <div class="dataset-subgroup-title">Sizing</div>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Resolution</label>
                                    <input type="number"
                                           class="form-control form-control-sm"
                                           min="0"
                                           step="1"
                                           x-model.number.lazy="dataset.resolution"
                                           @input="markAsUnsaved()"
                                           placeholder="1024">
                                    <div class="form-text"
                                         x-text="dataset.resolution_type === 'pixel_area'
                                            ? 'Shorter edge (squared for area)'
                                            : 'Shorter edge in pixels'
                                         ">
                                        Shorter edge (squared for area)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Resolution Type</label>
                                    <select class="form-select form-select-sm"
                                            x-model="dataset.resolution_type"
                                            @change="markAsUnsaved()">
                                        <option value="pixel">Pixels (shorter edge)</option>
                                        <option value="pixel_area">Pixel area (megapixels)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Min Size</label>
                                    <input type="number" class="form-control form-control-sm"
                                           x-model.number.lazy="dataset.minimum_image_size"
                                           min="0"
                                           step="1"
                                           @input="markAsUnsaved()"
                                           placeholder="0 (disabled)">
                                    <div class="form-text">
                                        Skip smaller images
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Max Size</label>
                                    <input type="number" class="form-control form-control-sm"
                                           x-model.number.lazy="dataset.maximum_image_size"
                                           min="0"
                                           step="1"
                                           @input="markAsUnsaved()"
                                           placeholder="0 (disabled)">
                                    <div class="form-text">
                                        Downsample larger images to the target size
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 mt-3">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Downsample Target</label>
                                    <input type="number" class="form-control form-control-sm"
                                           x-model.number.lazy="dataset.target_downsample_size"
                                           min="0"
                                           step="1"
                                           @input="markAsUnsaved()"
                                           placeholder="Auto">
                                    <div class="form-text">
                                        Target size used when downsampling larger images
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dataset-subgroup"
                         x-show="dataset.dataset_type !== 'text_embeds' && dataset.dataset_type !== 'image_embeds'">
                        <div class="dataset-subgroup-title">Cropping</div>
                        <div class="row g-3 align-items-end">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           :id="`dataset-crop-${datasetSafeId(dataset)}`"
                                           x-model="dataset.crop"
                                           @change="markAsUnsaved()">
                                    <label class="form-check-label" :for="`dataset-crop-${datasetSafeId(dataset)}`">Enable image cropping</label>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3 mt-3" x-show="dataset.crop" x-cloak>
                            <div class="col-md-6">
                                <label class="form-label">Crop Style</label>
                                <select class="form-select form-select-sm"
                                        x-model="dataset.crop_style"
                                        @change="markAsUnsaved()">
                                    <option value="center">Center</option>
                                    <option value="corner">Corner</option>
                                    <option value="face">Face Detection</option>
                                    <option value="random">Random</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Crop Aspect</label>
                                <select class="form-select form-select-sm"
                                        x-model="dataset.crop_aspect"
                                        @change="markAsUnsaved()">
                                    <option value="square">Square</option>
                                    <option value="preserve">Preserve original</option>
                                    <option value="closest">Closest bucket</option>
                                    <option value="random">Weighted buckets</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mt-2" x-show="dataset.crop" x-cloak>
                            <div class="col-12">
                                <label class="form-label">Crop Aspect Buckets</label>
                                <input type="text" class="form-control form-control-sm"
                                       x-model="dataset._cropAspectBucketsText"
                                       @input="markAsUnsaved()"
                                       :disabled="!['closest', 'random'].includes(dataset.crop_aspect)"
                                       placeholder="0.75, 1.0, 1.33">
                                <div class="form-text"
                                     x-text="['closest', 'random'].includes(dataset.crop_aspect)
                                        ? 'Comma separated list of aspect ratios used for bucket selection.'
                                        : 'Select &quot;Closest bucket&quot; or &quot;Weighted buckets&quot; to enable custom aspect buckets.'">
                                    Comma separated list of aspect ratios used for bucket selection.
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                    <div class="dataset-section">
                        <div class="dataset-section-header">Storage</div>
                        <div class="dataset-section-body">
                            <div class="dataset-subgroup">
                                <div class="dataset-subgroup-title">Backend Configuration</div>
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Storage Backend</label>
                                        <select class="form-select form-select-sm"
                                                x-model="dataset.type"
                                                @change="onStorageBackendChange(dataset)">
                                            <option value="local">Local filesystem</option>
                                            <option value="aws">AWS S3 / compatible</option>
                                            <option value="csv">CSV URL list</option>
                                            <option value="huggingface">Hugging Face dataset</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="dataset-subgroup mt-3"
                                 x-show="(dataset.type === 'local' && dataset.dataset_type !== 'image_embeds') || dataset.dataset_type === 'image' || dataset.dataset_type === 'video'">
                                <div class="dataset-subgroup-title">Storage Paths</div>
                                <div class="row g-3">
                                    <div class="col-md-6"
                                         x-show="dataset.type === 'local' && dataset.dataset_type !== 'text_embeds' && dataset.dataset_type !== 'image_embeds'">
                                        <label class="form-label">Instance Data Directory</label>
                                        <input type="text" class="form-control form-control-sm"
                                               x-model.lazy="dataset.instance_data_dir"
                                               @input="markAsUnsaved()"
                                               placeholder="/path/to/data">
                                        <div class="form-text">Path to your training images or videos.</div>
                                    </div>
                                    <div class="col-md-6"
                                         x-show="dataset.dataset_type !== 'text_embeds' && dataset.dataset_type !== 'image_embeds'">
                                        <label class="form-label">VAE Cache Directory</label>
                                        <input type="text" class="form-control form-control-sm"
                                               x-model.lazy="dataset.cache_dir_vae"
                                               @input="markAsUnsaved()"
                                               placeholder="/path/to/cache/vae">
                                        <div class="form-text">Where VAE-encoded latents are cached.</div>
                                    </div>
                                    <div class="col-md-6"
                                         x-show="dataset.type === 'local' && dataset.dataset_type === 'text_embeds'">
                                        <label class="form-label">Text Embed Cache</label>
                                        <input type="text" class="form-control form-control-sm"
                                               x-model.lazy="dataset.cache_dir"
                                               @input="markAsUnsaved()"
                                               placeholder="/path/to/cache">
                                        <div class="form-text">Location to store or reuse prompt embeddings.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="storage-config mt-3">
                                <template x-if="dataset.type === 'aws'">
                                <div class="dataset-subgroup">
                                    <div class="dataset-subgroup-title">Bucket Settings</div>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Bucket Name</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.aws_bucket_name"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="my-training-bucket">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Object Prefix</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.aws_data_prefix"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="datasets/run-name">
                                            <div class="form-text">Optional object prefix within the bucket (acts like a folder).</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Region</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.aws_region_name"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="us-east-1">
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-md-4">
                                            <label class="form-label">Endpoint URL</label>
                                            <div class="input-group input-group-sm">
                                                <input :type="dataset._awsEndpointVisible ? 'text' : 'password'"
                                                       class="form-control"
                                                       x-model="dataset.aws_endpoint_url"
                                                       @input="touchConnectionField(dataset)"
                                                       placeholder="https://s3.amazonaws.com"
                                                       autocomplete="off">
                                                <button class="btn btn-outline-secondary"
                                                        type="button"
                                                        @click="dataset._awsEndpointVisible = !dataset._awsEndpointVisible"
                                                        :title="dataset._awsEndpointVisible ? 'Hide value' : 'Show value'">
                                                    <i class="fas" :class="dataset._awsEndpointVisible ? 'fa-eye-slash' : 'fa-eye'"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Access Key ID</label>
                                            <div class="input-group input-group-sm">
                                                <input :type="dataset._awsAccessVisible ? 'text' : 'password'"
                                                       class="form-control"
                                                       x-model="dataset.aws_access_key_id"
                                                       @input="touchConnectionField(dataset)"
                                                       autocomplete="off">
                                                <button class="btn btn-outline-secondary"
                                                        type="button"
                                                        @click="dataset._awsAccessVisible = !dataset._awsAccessVisible"
                                                        :title="dataset._awsAccessVisible ? 'Hide value' : 'Show value'">
                                                    <i class="fas" :class="dataset._awsAccessVisible ? 'fa-eye-slash' : 'fa-eye'"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Secret Access Key</label>
                                            <div class="input-group input-group-sm">
                                                <input :type="dataset._awsSecretVisible ? 'text' : 'password'"
                                                       class="form-control"
                                                       x-model="dataset.aws_secret_access_key"
                                                       @input="touchConnectionField(dataset)"
                                                       autocomplete="off">
                                                <button class="btn btn-outline-secondary"
                                                        type="button"
                                                        @click="dataset._awsSecretVisible = !dataset._awsSecretVisible"
                                                        :title="dataset._awsSecretVisible ? 'Hide value' : 'Show value'">
                                                    <i class="fas" :class="dataset._awsSecretVisible ? 'fa-eye-slash' : 'fa-eye'"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </template>
                                <template x-if="dataset.type === 'csv'">
                                <div class="dataset-subgroup">
                                    <div class="dataset-subgroup-title">CSV Configuration</div>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">CSV File</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.csv_file"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="/path/to/urls.csv">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Caption Column</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.csv_caption_column"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="caption">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Cache Directory</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.csv_cache_dir"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="/path/to/cache">
                                        </div>
                                    </div>
                                </div>
                                </template>
                                <template x-if="dataset.type === 'huggingface'">
                                <div class="dataset-subgroup">
                                    <div class="dataset-subgroup-title">Hugging Face Settings</div>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Dataset Name</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.dataset_name"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="username/dataset">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Dataset Config</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.dataset_config"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="default">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Split</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.split"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="train">
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Revision</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.revision"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="main">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Image Column</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.image_column"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="image">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Caption Column</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.caption_column"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="text">
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-3">
                                        <div class="col-md-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       :id="`dataset-streaming-${datasetSafeId(dataset)}`"
                                                       x-model="dataset.streaming"
                                                       @change="touchConnectionField(dataset)">
                                                <label class="form-check-label" :for="`dataset-streaming-${datasetSafeId(dataset)}`">
                                                    Enable streaming
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label">Auth Token</label>
                                            <input type="password" class="form-control form-control-sm"
                                                   x-model="dataset.auth_token"
                                                   @input="touchConnectionField(dataset)"
                                                   placeholder="hf_...">
                                            <div class="form-text">Optional token for private datasets.</div>
                                        </div>
                                    </div>
                                </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div class="dataset-section"
                         x-show="!['text_embeds','image_embeds'].includes(dataset.dataset_type)"
                         x-cloak>
                        <div class="dataset-section-header">Captions &amp; Metadata</div>
                        <div class="dataset-section-body">
                            <div class="dataset-subgroup">
                                <div class="dataset-subgroup-title">Caption &amp; Metadata Strategy</div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Caption Strategy</label>
                                        <select class="form-select form-select-sm"
                                                x-model="dataset.caption_strategy"
                                                @change="markAsUnsaved()">
                                            <option value="textfile">Text files (.txt)</option>
                                            <option value="csv">CSV</option>
                                            <option value="parquet">Parquet</option>
                                            <option value="jsonl">JSON Lines</option>
                                            <option value="instanceprompt">Instance prompt only</option>
                                            <option value="">Use dataset default</option>
                                        </select>
                                        <div class="form-text">How captions are stored and loaded.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Metadata Backend</label>
                                        <select class="form-select form-select-sm"
                                                x-model="dataset.metadata_backend"
                                                @change="markAsUnsaved()">
                                            <option value="">Auto discover (default)</option>
                                            <option value="discovery">Discovery scan</option>
                                            <option value="json">JSON manifest</option>
                                            <option value="parquet">Parquet index</option>
                                            <option value="csv">CSV index</option>
                                            <option value="huggingface">Hugging Face dataset</option>
                                        </select>
                                        <div class="form-text">How file metadata is indexed and accessed.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="dataset-subgroup mt-3"
                                 x-show="dataset.dataset_type !== 'text_embeds' && dataset.dataset_type !== 'image_embeds'">
                                <div class="dataset-subgroup-title">Trigger Words</div>
                                <div x-effect="if (dataset.caption_strategy === 'instanceprompt' && dataset.prepend_instance_prompt) { dataset.prepend_instance_prompt = false; markAsUnsaved(); }"></div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Instance Prompt</label>
                                        <textarea class="form-control form-control-sm"
                                                  rows="2"
                                                  x-model="dataset.instance_prompt"
                                                  @input="markAsUnsaved()"
                                                  :placeholder="dataset.caption_strategy === 'instanceprompt' ? 'Prompt content applied to every sample' : 'Optional prompt prepended when enabled'"
                                                  :disabled="dataset.caption_strategy !== 'instanceprompt' && !dataset.prepend_instance_prompt"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mt-3">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   :id="`dataset-prepend-${datasetSafeId(dataset)}`"
                                                   x-model="dataset.prepend_instance_prompt"
                                                   @change="markAsUnsaved()"
                                                   :disabled="dataset.caption_strategy === 'instanceprompt'">
                                            <label class="form-check-label" :for="`dataset-prepend-${datasetSafeId(dataset)}`">
                                                Prepend instance prompt to captions
                                            </label>
                                        </div>
                                        <p class="form-text" x-show="dataset.caption_strategy !== 'instanceprompt'">
                                            Enable to inject the instance prompt ahead of each caption when captions are present.
                                        </p>
                                        <p class="form-text" x-show="dataset.caption_strategy === 'instanceprompt'">
                                            Instance prompt mode always uses this text without additional captions.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="dataset-subgroup mt-3"
                                 x-show="dataset.caption_strategy === 'parquet' || dataset.metadata_backend === 'parquet'">
                                <div class="dataset-subgroup-title">Parquet Details</div>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Parquet Path</label>
                                        <input type="text" class="form-control form-control-sm"
                                               x-model="dataset.parquet.path"
                                               @input="markAsUnsaved()"
                                               placeholder="/path/to/file.parquet">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Filename Column</label>
                                        <input type="text" class="form-control form-control-sm"
                                               x-model="dataset.parquet.filename_column"
                                               @input="markAsUnsaved()"
                                               placeholder="id">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Caption Column</label>
                                        <input type="text" class="form-control form-control-sm"
                                               x-model="dataset.parquet.caption_column"
                                               @input="markAsUnsaved()"
                                               placeholder="caption">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Fallback Caption Column</label>
                                        <input type="text" class="form-control form-control-sm"
                                               x-model="dataset.parquet.fallback_caption_column"
                                               @input="markAsUnsaved()"
                                               placeholder="tags">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Width Column</label>
                                        <input type="text" class="form-control form-control-sm"
                                               x-model="dataset.parquet.width_column"
                                               @input="markAsUnsaved()"
                                               placeholder="width">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Height Column</label>
                                        <input type="text" class="form-control form-control-sm"
                                               x-model="dataset.parquet.height_column"
                                               @input="markAsUnsaved()"
                                               placeholder="height">
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   :id="`dataset-parquet-ext-${datasetSafeId(dataset)}`"
                                                   x-model="dataset.parquet.identifier_includes_extension"
                                                   @change="markAsUnsaved()">
                                            <label class="form-check-label" :for="`dataset-parquet-ext-${datasetSafeId(dataset)}`">
                                                Identifier includes extension
                                            </label>
                                            <div class="form-text">Assumes filenames already include their extension (recommended).</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dataset-section dataset-section-advanced dataset-section-collapsible"
                         :class="{'is-open': dataset._showAdvanced}">
                        <div class="dataset-section-header d-flex align-items-center justify-content-between advanced-section">
                            <div class="d-flex align-items-center">
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary advanced-toggle me-2"
                                        @click="dataset._showAdvanced = !dataset._showAdvanced"
                                        :aria-expanded="dataset._showAdvanced ? 'true' : 'false'">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                <span>Advanced Options</span>
                            </div>
                            <span class="badge bg-secondary">Advanced</span>
                        </div>
                        <div class="dataset-section-body advanced-options"
                             x-show="dataset._showAdvanced"
                             x-transition
                             x-cloak>
                            <div class="dataset-subgroup"
                                 x-show="!['text_embeds','image_embeds'].includes(dataset.dataset_type)">
                                <div class="dataset-subgroup-title">Sampling &amp; Repeats</div>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label d-flex align-items-center gap-2">Repeats
                                            <i class="fas fa-info-circle text-muted"
                                               tabindex="0"
                                               title="SimpleTuner treats 0 repeats as a single pass. Set to 1 to run two passes, and so on."
                                               aria-label="SimpleTuner treats 0 repeats as a single pass. Set to 1 to run two passes, and so on."></i>
                                        </label>
                                        <input type="number" class="form-control form-control-sm"
                                               min="0"
                                               step="1"
                                               x-model.number.lazy="dataset.repeats"
                                               @input="markAsUnsaved()"
                                               placeholder="0">
                                        <div class="form-text">Set to 0 for a single pass. Each repeat adds another sweep through the dataset.</div>
                                    </div>
                                    <div class="col-md-4"
                                         :class="{'danger-mode-locked': !dangerModeEnabled()}">
                                        <label class="form-label">Probability</label>
                                        <input type="number" class="form-control form-control-sm"
                                               min="0"
                                               max="1"
                                               step="0.05"
                                               x-model.number.lazy="dataset.probability"
                                               :disabled="!dangerModeEnabled()"
                                               @input="markAsUnsaved()"
                                               placeholder="1.0">
                                        <div class="form-text" x-show="dangerModeEnabled()">Relative sampling weight when mixing datasets.</div>
                                        <div class="form-text text-warning danger-mode-hint" x-show="!dangerModeEnabled()">
                                            Enable "I Know What I'm Doing" in Advanced settings to adjust probability.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="dataset-subgroup" x-show="dataset.dataset_type === 'text_embeds' || dataset.dataset_type === 'image_embeds'">
                                <div class="dataset-subgroup-title">Embed Options</div>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Write Batch Size</label>
                                        <input type="number" class="form-control form-control-sm"
                                               min="1"
                                               step="1"
                                               x-model.number.lazy="dataset.write_batch_size"
                                               @input="markAsUnsaved()"
                                               placeholder="128">
                                        <div class="form-text">Controls embed cache flush size.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="dataset-subgroup mt-3"
                                 x-show="!['text_embeds','image_embeds'].includes(dataset.dataset_type)">
                                <div class="dataset-subgroup-title">Aspect Ratio Limits</div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Min Aspect Ratio</label>
                                        <input type="number" class="form-control form-control-sm"
                                               min="0"
                                               step="0.01"
                                               x-model.number.lazy="dataset.minimum_aspect_ratio"
                                               @input="markAsUnsaved()"
                                               placeholder="0.5">
                                        <div class="form-text">Skip images with aspect ratio below this value.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Max Aspect Ratio</label>
                                        <input type="number" class="form-control form-control-sm"
                                               min="0"
                                               step="0.01"
                                               x-model.number.lazy="dataset.maximum_aspect_ratio"
                                               @input="markAsUnsaved()"
                                               placeholder="3.0">
                                        <div class="form-text">Skip images with aspect ratio above this value.</div>
                                    </div>
                                </div>
                            </div>
                        <div class="dataset-subgroup mt-3"
                             x-show="dataset.dataset_type === 'image' || dataset.dataset_type === 'video'">
                            <div class="dataset-subgroup-title">Discovery Overrides</div>
                            <div class="row">
                                <template x-for="option in skipDiscoveryOptions()" :key="option.value">
                                    <div class="col-md-3">
                                        <div class="checkbox-item">
                                            <div class="form-check">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       :id="`dataset-skip-${option.value}-${datasetSafeId(dataset)}`"
                                                       :checked="hasSkipDiscovery(dataset, option.value)"
                                                       @change="setSkipDiscovery(dataset, option.value, $event.target.checked)">
                                                <div class="checkbox-content">
                                                    <label class="form-check-label"
                                                           :for="`dataset-skip-${option.value}-${datasetSafeId(dataset)}`"
                                                           x-text="option.label"></label>
                                                    <div class="form-text" x-text="option.hint"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div class="form-text text-warning mt-3">Disable discovery only after embeds and caches are fully generated.</div>
                        </div>
                            <div class="dataset-subgroup mt-3" x-show="dataset.dataset_type === 'text_embeds'">
                                <div class="dataset-subgroup-title">Caption Filtering</div>
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label class="form-label">Caption Filter List</label>
                                        <select class="form-select form-select-sm"
                                                x-model="dataset._selectedCaptionFilter"
                                                @change="onCaptionFilterSelect(dataset)">
                                            <option value="">None</option>
                                            <template x-for="filter in captionFilterOptions" :key="filter.value">
                                                <option :value="filter.value"
                                                        :title="filter.description"
                                                        x-text="filter.label"></option>
                                            </template>
                                            <option value="__custom__">Custom path / inline list…</option>
                                        </select>
                                        <div class="mt-2" x-show="dataset._selectedCaptionFilter === '__custom__'">
                                            <input type="text" class="form-control form-control-sm"
                                                   x-model="dataset.caption_filter_list"
                                                   @input="markAsUnsaved()"
                                                   placeholder="/path/to/filter.txt or JSON literal">
                                            <div class="form-text">Provide a path or inline JSON/line list to apply custom filtering.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="dataset-subgroup mt-3"
                                 x-show="dataset.dataset_type === 'image' || dataset.dataset_type === 'video'">
                                <div class="dataset-subgroup-title">Embed Dataset Links</div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Text Embeds Dataset</label>
                                        <select class="form-select form-select-sm"
                                                x-model="dataset.text_embeds"
                                                @change="markAsUnsaved()">
                                            <option value="">Use default text embed backend</option>
                                            <template x-for="option in datasetOptionsForType(dataset, 'text_embeds')">
                                                <option :value="option.id" x-text="option.label" :selected="dataset.text_embeds === option.id"></option>
                                            </template>
                                        </select>
                                        <div class="invalid-feedback d-block"
                                             x-show="hasFieldError(dataset.id, 'text_embeds')"
                                             x-text="getFieldError(dataset.id, 'text_embeds')"></div>
                                        <div class="form-text">
                                            Leaving this empty keeps caption embeds with this dataset using its cache directory.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Image Embeds Dataset</label>
                                        <select class="form-select form-select-sm"
                                                x-model="dataset.image_embeds"
                                                @change="markAsUnsaved()">
                                            <option value="">None</option>
                                            <template x-for="option in datasetOptionsForType(dataset, 'image_embeds')">
                                                <option :value="option.id" x-text="option.label" :selected="dataset.image_embeds === option.id"></option>
                                            </template>
                                        </select>
                                        <div class="invalid-feedback d-block"
                                             x-show="hasFieldError(dataset.id, 'image_embeds')"
                                             x-text="getFieldError(dataset.id, 'image_embeds')"></div>
                                        <div class="form-text">
                                            None keeps image embeds in this dataset&#39;s storage backend; selecting another dataset reuses that dataset&#39;s embed cache location.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="dataset-subgroup mt-3">
                                <div class="dataset-subgroup-title">Cache &amp; Processing Options</div>
                                <div class="checkbox-group-row">
                                    <div class="row">
                                        <div class="col-md-4"
                                             x-show="!['text_embeds','image_embeds'].includes(dataset.dataset_type)">
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           :id="`dataset-hash-${datasetSafeId(dataset)}`"
                                                           x-model="dataset.hash_filenames"
                                                           @change="markAsUnsaved()">
                                                    <div class="checkbox-content">
                                                        <label class="form-check-label" :for="`dataset-hash-${datasetSafeId(dataset)}`">
                                                            Hash cached filenames
                                                        </label>
                                                        <div class="form-text">
                                                            Creates shorter, hashed names for VAE cache files to avoid filesystem path length limits.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4"
                                             x-show="dataset.dataset_type !== 'image_embeds'">
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           :id="`dataset-cache-${datasetSafeId(dataset)}`"
                                                           x-model="dataset.preserve_data_backend_cache"
                                                           @change="markAsUnsaved()">
                                                    <div class="checkbox-content">
                                                        <label class="form-check-label" :for="`dataset-cache-${datasetSafeId(dataset)}`">
                                                            Preserve backend cache
                                                        </label>
                                                        <div class="form-text">
                                                            Keeps the file list cache between epochs. Essential for large datasets on AWS S3 or slow storage.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4"
                                             x-show="!['text_embeds','image_embeds'].includes(dataset.dataset_type)">
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           :id="`dataset-regularisation-${datasetSafeId(dataset)}`"
                                                           x-model="dataset.is_regularisation_data"
                                                           @change="markAsUnsaved()">
                                                    <div class="checkbox-content">
                                                        <label class="form-check-label" :for="`dataset-regularisation-${datasetSafeId(dataset)}`">
                                                            Regularisation data
                                                        </label>
                                                        <div class="form-text">
                                                            Uses the base model's predictions on this dataset to prevent the model from drifting outside the intended class token. Requires another non-regularisation image/video dataset.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <template x-if="dataset.dataset_type === 'video'">
                        <div class="dataset-section video-settings">
                            <div class="dataset-section-header">Video Settings</div>
                            <div class="dataset-section-body">
                                <div class="dataset-subgroup">
                                    <div class="dataset-subgroup-title">Frame Configuration</div>
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Frames per Clip</label>
                                            <input type="number"
                                                   class="form-control form-control-sm"
                                                   min="1"
                                                   x-model.number.lazy="dataset.video.num_frames"
                                                   @input="markAsUnsaved()"
                                                   placeholder="125">
                                            <div class="form-text">Target frame count extracted from each video.</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Min Frames</label>
                                            <input type="number"
                                                   class="form-control form-control-sm"
                                                   min="1"
                                                   x-model.number.lazy="dataset.video.min_frames"
                                                   @input="markAsUnsaved()"
                                                   placeholder="125">
                                            <div class="form-text">Excludes videos with fewer frames than this.</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Max Frames</label>
                                            <input type="number"
                                                   class="form-control form-control-sm"
                                                   min="1"
                                                   x-model.number.lazy="dataset.video.max_frames"
                                                   @input="markAsUnsaved()"
                                                   placeholder="250">
                                            <div class="form-text">Excludes videos with more frames than this. 0 = no limit.</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="dataset-subgroup mt-3">
                                    <div class="dataset-subgroup-title">Video Processing</div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="checkbox-item">
                                                <div class="form-check">
                                                    <input class="form-check-input"
                                                           type="checkbox"
                                                           :id="`video-i2v-${datasetSafeId(dataset)}`"
                                                           x-model="dataset.video.is_i2v"
                                                           @change="markAsUnsaved()">
                                                    <div class="checkbox-content">
                                                        <label class="form-check-label" :for="`video-i2v-${datasetSafeId(dataset)}`">
                                                            Enable I2V augmentation
                                                        </label>
                                                        <div class="form-text">
                                                            Enables image-to-video augmentation mode for training.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                    <template x-if="shouldShowConditioningSection(dataset)">
                        <div class="dataset-section conditioning-section dataset-section-collapsible"
                             :class="{'is-open': dataset._showConditioning}">
                            <div class="dataset-section-header d-flex align-items-center justify-content-between advanced-section">
                                <div class="d-flex align-items-center">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary advanced-toggle me-2"
                                            @click="dataset._showConditioning = !dataset._showConditioning"
                                            :aria-expanded="dataset._showConditioning ? 'true' : 'false'">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                    <span>Conditioning</span>
                                </div>
                                <span class="badge bg-secondary" x-text="conditioningDatasetType"></span>
                            </div>
                            <div class="dataset-section-body"
                                 x-show="dataset._showConditioning"
                                 x-transition
                                 x-cloak>
                                <div class="dataset-subgroup conditioning-links">
                                    <div class="dataset-subgroup-title">Conditioning Datasets</div>
                                    <p class="text-muted small mb-2">
                                        Link existing <code x-text="conditioningDatasetType"></code> datasets to feed control inputs during training.
                                    </p>
                                    <template x-if="conditioningOptions(dataset).length === 0">
                                        <div class="alert alert-secondary py-2 px-3 mb-2">
                                            Create a <code x-text="conditioningDatasetType"></code> dataset to enable linking.
                                        </div>
                                    </template>
                                    <select class="form-select form-select-sm"
                                            multiple
                                            x-model="dataset.conditioning_data"
                                            @change="onConditioningDataChange(dataset, $event)">
                                        <template x-for="option in conditioningOptions(dataset)" :key="option">
                                            <option :value="option" x-text="option"></option>
                                        </template>
                                    </select>
                                    <div class="form-text">Hold <kbd>⌘</kbd>/<kbd>Ctrl</kbd> to select multiple entries.</div>
                                    <div class="invalid-feedback d-block"
                                         x-show="hasFieldError(dataset.id, 'conditioning_data')"
                                         x-text="getFieldError(dataset.id, 'conditioning_data')"></div>
                                </div>

                                <div class="dataset-subgroup conditioning-generators">
                                    <div class="dataset-subgroup-header d-flex align-items-center justify-content-between">
                                        <div class="dataset-subgroup-title mb-0">Conditioning Generators</div>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary"
                                                @click="addConditioningGenerator(dataset)"
                                                :disabled="!conditioningSupported"
                                                title="Automatically derive control inputs from source data">
                                            <i class="fas fa-plus"></i>
                                            Add Generator
                                        </button>
                                    </div>
                                    <template x-if="conditioningRequired && (!Array.isArray(dataset.conditioning) || dataset.conditioning.length === 0)">
                                        <div class="alert alert-warning py-2 px-3 mb-2">
                                            Active model requires conditioning. Link a dataset above or add a generator.
                                        </div>
                                    </template>
                                    <template x-for="(generator, genIndex) in dataset.conditioning" :key="generator._uiKey || genIndex">
                                        <div class="card conditioning-generator mb-2">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div class="me-3 flex-grow-1">
                                                        <div class="mb-3">
                                                            <label class="form-label">Generator Type</label>
                                                            <select class="form-select form-select-sm"
                                                                    x-model="generator._selectedType"
                                                                    @change="onGeneratorTypeSelect(generator)"
                                                                    :disabled="!conditioningSupported">
                                                                <option value="">Select generator...</option>
                                                            <template x-for="option in availableGeneratorTypes" :key="option.value">
                                                                <option :value="option.value"
                                                                        :selected="option.value === generator._selectedType"
                                                                        :title="option.description"
                                                                        x-text="option.label"></option>
                                                            </template>
                                                        </select>
                                                            <div class="form-text text-muted"
                                                                 x-show="generator._selectedType && generator._selectedType !== '__custom__'"
                                                                 x-text="getGeneratorDescription(generator._selectedType)"></div>
                                                            <div class="mt-2" x-show="generator._selectedType === '__custom__'">
                                                                <input type="text"
                                                                       class="form-control form-control-sm"
                                                                       x-model="generator._customType"
                                                                       @input="onGeneratorTypeManual(generator)"
                                                                       placeholder="Enter generator id (e.g. my_custom_generator)">
                                                                <div class="form-text">Provide the exact generator identifier expected by your pipeline.</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-danger"
                                                            @click="removeConditioningGenerator(dataset, generator)"
                                                            title="Remove generator">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label mb-1">Parameters (JSON)</label>
                                                    <textarea class="form-control form-control-sm font-monospace"
                                                              rows="4"
                                                              x-model="generator._paramsText"
                                                              @blur="onGeneratorParamsBlur(generator)"
                                                              :class="{'is-invalid': generator._paramsParseError}"></textarea>
                                                    <div class="invalid-feedback" x-show="generator._paramsParseError" x-text="generator._paramsParseError"></div>
                                                </div>

                                                <div>
                                                    <label class="form-label mb-1">Captions</label>
                                                    <select class="form-select form-select-sm"
                                                            x-model="generator._captionsMode"
                                                            @change="onGeneratorCaptionsModeChange(generator)">
                                                        <option value="inherit">Inherit from dataset</option>
                                                        <option value="none">Disable captions</option>
                                                        <option value="single">Single prompt</option>
                                                        <option value="list">Prompt list</option>
                                                    </select>
                                                    <div class="mt-2" x-show="generator._captionsMode === 'single'">
                                                        <input type="text"
                                                               class="form-control form-control-sm"
                                                               x-model="generator._captionsValue"
                                                               @input="onGeneratorCaptionsInput(generator)"
                                                               placeholder="eg. outline sketch">
                                                    </div>
                                                    <div class="mt-2" x-show="generator._captionsMode === 'list'">
                                                        <textarea class="form-control form-control-sm"
                                                                  rows="3"
                                                                  x-model="generator._captionsValue"
                                                                  @input="onGeneratorCaptionsInput(generator)"
                                                                  placeholder="One caption per line"></textarea>
                                                        <div class="form-text">Provide one caption per line.</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    <div class="text-muted small" x-show="!dataset.conditioning || dataset.conditioning.length === 0">
                                        No conditioning generators configured.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
            <div x-show="datasets.length === 0" class="text-center text-muted py-4">
                <i class="fas fa-database mb-2" style="font-size: 2rem;"></i>
                <p>No datasets configured. Add a dataset to get started.</p>
            </div>
        </div>

        <!-- Save Buttons -->
        <div class="mt-3 d-flex gap-2">
            <button type="button" class="btn"
                    :class="{'btn-warning': hasUnsavedChanges, 'btn-primary': !hasUnsavedChanges}"
                    @click="saveDatasets()">
                <i class="fas fa-save"></i>
                <span x-text="hasUnsavedChanges ? 'Save Dataset Configuration (unsaved changes)' : 'Save Dataset Configuration'"></span>
                <span x-show="hasUnsavedChanges" class="badge bg-danger ms-2">
                    <i class="fas fa-exclamation-circle"></i> Unsaved
                </span>
            </button>
            <button type="button" class="btn btn-outline-secondary"
                    @click="if (Alpine.store('trainer')) { Alpine.store('trainer').showSaveDialog = true; }"
                    title="Save with backup option">
                <i class="fas fa-cog"></i> Save Options
            </button>
        </div>
    </div>
    </template>

    <!-- JSON Mode -->
    <template x-if="dataLoaderMode === 'json'">
    <div>
        <div class="json-editor-container">
            <div class="json-actions">
                <button type="button" class="btn btn-secondary" @click="if (trainer.dataLoaderJson) { trainer.dataLoaderJson = JSON.stringify(JSON.parse(trainer.dataLoaderJson), null, 2) }">
                    <i class="fas fa-magic"></i> Format
                </button>
                <button type="button" class="btn btn-primary" @click="switchDataLoaderMode('builder')">
                    <i class="fas fa-file-import"></i> Import to Builder
                </button>
                <button type="button" class="btn"
                        :class="{'btn-warning': hasUnsavedChanges, 'btn-success': !hasUnsavedChanges}"
                        @click="saveJsonDatasets()">
                    <i class="fas fa-save"></i>
                    <span x-text="hasUnsavedChanges ? 'Apply & Save JSON (unsaved changes)' : 'Apply & Save JSON'"></span>
                    <span x-show="hasUnsavedChanges" class="badge bg-danger ms-2">
                        <i class="fas fa-exclamation-circle"></i> Unsaved
                    </span>
                </button>
            </div>
            <div class="form-group">
                <textarea
                    class="form-control json-editor"
                    x-model="dataLoaderJson"
                    @input="markAsUnsaved()"
                    rows="20"
                    placeholder='[
  {
    "id": "training-images",
    "type": "local",
    "dataset_type": "image",
    "instance_data_dir": "/path/to/images",
    "resolution": 1024,
    "resolution_type": "pixel_area",
    "caption_strategy": "textfile",
    "cache_dir_vae": "cache/vae",
    "repeats": 0
  }
]'></textarea>
            </div>
        </div>
    </div>
    </template>
    </div><!-- End of main content wrapper -->

</div>
