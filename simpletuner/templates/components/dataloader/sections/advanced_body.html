<!-- Caching Options Body (for modal) -->
<div class="modal-section-body">
    <!-- Embed Dataset Links -->
    <div class="section-group" x-show="(editingDataset.dataset_type === 'image' || editingDataset.dataset_type === 'video') && matchesParamFilter('embed', 'link', 'text', 'image', 'dataset', 'conditioning')">
        <h6 class="modal-section-title">Embed Dataset Links</h6>
        <div class="row g-2">
            <div class="col-md-6">
                <label class="form-label small">Text Embeds Dataset <a x-show="showDocLinks" href="{{ docs_url('DATALOADER.md#text_embeds') }}" target="_blank" class="text-muted" title="Documentation"><sup><i class="fas fa-external-link-alt fa-xs"></i></sup></a></label>
                <select class="form-select form-select-sm"
                        x-model="editingDataset.text_embeds"
                        @change="markAsUnsaved()">
                    <option value="">Use default</option>
                    <template x-for="option in datasetOptionsForType(editingDataset, 'text_embeds')">
                        <option :value="option.id" x-text="option.label"></option>
                    </template>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label small">Image Embeds Dataset <a x-show="showDocLinks" href="{{ docs_url('DATALOADER.md#image_embeds') }}" target="_blank" class="text-muted" title="Documentation"><sup><i class="fas fa-external-link-alt fa-xs"></i></sup></a></label>
                <select class="form-select form-select-sm"
                        x-model="editingDataset.image_embeds"
                        @change="markAsUnsaved()">
                    <option value="">None</option>
                    <template x-for="option in datasetOptionsForType(editingDataset, 'image_embeds')">
                        <option :value="option.id" x-text="option.label"></option>
                    </template>
                </select>
            </div>
            <!-- Conditioning Image Embeds (for I2V models) -->
            <div class="col-md-6" x-show="requiresConditioningImageEmbeds && ['image', 'video', 'conditioning'].includes(editingDataset.dataset_type)">
                <label class="form-label small">Conditioning Image Embeds <a x-show="showDocLinks" href="{{ docs_url('DATALOADER.md#conditioning_image_embeds') }}" target="_blank" class="text-muted" title="Documentation"><sup><i class="fas fa-external-link-alt fa-xs"></i></sup></a></label>
                <select class="form-select form-select-sm"
                        x-model="editingDataset.conditioning_image_embeds"
                        @change="markAsUnsaved()">
                    <option value="">Auto-generate</option>
                    <template x-for="option in datasetOptionsForType(editingDataset, 'conditioning_image_embeds')">
                        <option :value="option.id" x-text="option.label"></option>
                    </template>
                </select>
                <div class="form-text small">For I2V models (Wan 2.1/2.2, Qwen Edit)</div>
            </div>
            <div class="col-md-6" x-show="editingDataset.conditioning_image_embeds && requiresConditioningImageEmbeds">
                <label class="form-label small">Conditioning Embed Cache Dir <a x-show="showDocLinks" href="{{ docs_url('DATALOADER.md#cache_dir_conditioning_image_embeds') }}" target="_blank" class="text-muted" title="Documentation"><sup><i class="fas fa-external-link-alt fa-xs"></i></sup></a></label>
                <input type="text"
                       class="form-control form-control-sm"
                       x-model.lazy="editingDataset.cache_dir_conditioning_image_embeds"
                       @input="markAsUnsaved()"
                       placeholder="Auto (cache/conditioning_image_embeds/{id})">
            </div>
        </div>
    </div>

    <!-- Cache & Processing Options -->
    <div class="section-group" x-show="matchesParamFilter('cache', 'processing', 'hash', 'filename', 'preserve', 'backend')">
        <h6 class="modal-section-title">Cache & Processing</h6>
        <div class="row g-2">
            <div class="col-md-6" x-show="editingDataset.dataset_type !== 'image_embeds'">
                <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           :id="'preserve-cache-' + editingDataset.id"
                           x-model="editingDataset.preserve_data_backend_cache"
                           @change="markAsUnsaved()">
                    <label class="form-check-label small" :for="'preserve-cache-' + editingDataset.id">
                        Preserve backend cache <a x-show="showDocLinks" href="{{ docs_url('DATALOADER.md#preserve_data_backend_cache') }}" target="_blank" class="text-muted" title="Documentation"><sup><i class="fas fa-external-link-alt fa-xs"></i></sup></a>
                    </label>
                </div>
                <div class="form-text small text-muted ps-4">
                    Keep data backend cache between runs
                </div>
            </div>
        </div>
    </div>

    <!-- Metadata Refresh -->
    <div class="section-group" x-show="!['text_embeds','image_embeds'].includes(editingDataset.dataset_type) && matchesParamFilter('metadata', 'update', 'interval', 'refresh')">
        <h6 class="modal-section-title">Metadata Refresh</h6>
        <div class="row g-2">
            <div class="col-md-6">
                <label class="form-label small">Update Interval (seconds) <a x-show="showDocLinks" href="{{ docs_url('DATALOADER.md#metadata_update_interval') }}" target="_blank" class="text-muted" title="Documentation"><sup><i class="fas fa-external-link-alt fa-xs"></i></sup></a></label>
                <input type="number"
                       class="form-control form-control-sm"
                       min="0"
                       step="1"
                       x-model.number.lazy="editingDataset.metadata_update_interval"
                       @input="markAsUnsaved()"
                       placeholder="Use global setting">
                <div class="form-text small">How often to refresh dataset metadata during training</div>
            </div>
        </div>
    </div>

    <!-- VAE Cache Behavior -->
    <div class="section-group" x-show="!['text_embeds','image_embeds','audio'].includes(editingDataset.dataset_type) && matchesParamFilter('vae', 'cache', 'epoch', 'clear', 'random', 'crop')">
        <h6 class="modal-section-title">VAE Cache Behavior</h6>
        <div class="form-check">
            <input class="form-check-input"
                   type="checkbox"
                   :id="'vae-cache-clear-' + editingDataset.id"
                   x-model="editingDataset.vae_cache_clear_each_epoch"
                   @change="markAsUnsaved()">
            <label class="form-check-label small" :for="'vae-cache-clear-' + editingDataset.id">
                Clear VAE cache each epoch <a x-show="showDocLinks" href="{{ docs_url('DATALOADER.md#vae_cache_clear_each_epoch') }}" target="_blank" class="text-muted" title="Documentation"><sup><i class="fas fa-external-link-alt fa-xs"></i></sup></a>
            </label>
        </div>
        <div class="form-text small text-muted ps-4">
            Enable for random crop/aspect training to regenerate latents per epoch.
        </div>
    </div>

    <!-- Skip File Discovery -->
    <div class="section-group" x-show="!['text_embeds','image_embeds'].includes(editingDataset.dataset_type) && matchesParamFilter('skip', 'discovery', 'scan', 'vae', 'text', 'metadata', 'aspect')">
        <h6 class="modal-section-title">Skip File Discovery <a x-show="showDocLinks" href="{{ docs_url('DATALOADER.md#skip_file_discovery') }}" target="_blank" class="text-muted" title="Documentation"><sup><i class="fas fa-external-link-alt fa-xs"></i></sup></a></h6>
        <div class="row g-2">
            <template x-for="option in skipDiscoveryOptions()" :key="option.value">
                <div class="col-md-6 mb-2">
                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               :id="'skip-' + option.value + '-' + editingDataset.id"
                               :checked="hasSkipDiscovery(editingDataset, option.value)"
                               @change="setSkipDiscovery(editingDataset, option.value, $event.target.checked)">
                        <label class="form-check-label small" :for="'skip-' + option.value + '-' + editingDataset.id"
                               x-text="option.label"></label>
                    </div>
                    <div class="form-text small text-muted ps-4" x-text="option.hint"></div>
                </div>
            </template>
        </div>
    </div>

    <!-- Destructive Options -->
    <div class="section-group" x-show="!['text_embeds','image_embeds','audio'].includes(editingDataset.dataset_type) && matchesParamFilter('delete', 'unwanted', 'problematic', 'remove', 'cleanup')">
        <h6 class="modal-section-title text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Destructive Options</h6>
        <div class="form-check mb-2">
            <input class="form-check-input"
                   type="checkbox"
                   :id="'delete-unwanted-' + editingDataset.id"
                   x-model="editingDataset.delete_unwanted_images"
                   @change="markAsUnsaved()">
            <label class="form-check-label small" :for="'delete-unwanted-' + editingDataset.id">
                Delete unwanted images <a x-show="showDocLinks" href="{{ docs_url('DATALOADER.md#delete_unwanted_images') }}" target="_blank" class="text-muted" title="Documentation"><sup><i class="fas fa-external-link-alt fa-xs"></i></sup></a>
            </label>
        </div>
        <div class="form-text small text-warning ps-4 mb-2">
            <i class="fas fa-exclamation-triangle me-1"></i>Permanently deletes images that fail size or aspect ratio filters
        </div>
        <div class="form-check">
            <input class="form-check-input"
                   type="checkbox"
                   :id="'delete-problematic-' + editingDataset.id"
                   x-model="editingDataset.delete_problematic_images"
                   @change="markAsUnsaved()">
            <label class="form-check-label small" :for="'delete-problematic-' + editingDataset.id">
                Delete problematic images <a x-show="showDocLinks" href="{{ docs_url('DATALOADER.md#delete_problematic_images') }}" target="_blank" class="text-muted" title="Documentation"><sup><i class="fas fa-external-link-alt fa-xs"></i></sup></a>
            </label>
        </div>
        <div class="form-text small text-warning ps-4">
            <i class="fas fa-exclamation-triangle me-1"></i>Permanently deletes images that fail VAE encoding (corrupted files)
        </div>
    </div>
</div>
