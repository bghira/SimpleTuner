<!-- Generic Form Tab Template for HTMX -->
<!-- Used by Basic, Model, Training, and Advanced tabs -->
{% from 'partials/hero_cta.html' import hero_cta %}
<!-- CSS auto cache-busted by autoCacheBustCSS() on HTMX load -->
<link rel="stylesheet" href="/static/css/form-sections.css" id="css-form-sections-form">
{% if tab_name == 'publishing' %}
<link rel="stylesheet" href="/static/css/hero-cta.css" id="css-hero-cta-publishing">
{% elif tab_name == 'hardware' %}
<link rel="stylesheet" href="/static/css/hero-cta.css" id="css-hero-cta-hardware">
{% elif tab_name == 'model' %}
<link rel="stylesheet" href="/static/css/hero-cta.css" id="css-hero-cta-model">
<link rel="stylesheet" href="/static/css/model-ez-mode.css" id="css-model-ez-mode">
{% endif %}

{% if prompt_libraries is defined %}
<script>
window.__promptLibraries = {{ (prompt_libraries or []) | tojson | safe }};
</script>
{% endif %}

{% if tab_name == 'publishing' %}
<script>
// Publishing tab hero CTA state
if (!window.publishingHeroCTA) {
    window.publishingHeroCTA = function() {
        return {
            ...window.HintMixin.createMultiHint({
                useApi: false,
                storageKey: 'st_publishing_hints',
                hintKeys: ['hero']
            }),
            showHeroCTA() { return this.hints.hero; },
            dismissHeroCTA() { this.dismissHint('hero'); },
            restoreHeroCTA() { this.showHint('hero'); },
            init() { this.loadHints(); }
        };
    };
}
</script>
{% elif tab_name == 'hardware' %}
<script>
// Hardware tab hero CTA state
if (!window.hardwareHeroCTA) {
    window.hardwareHeroCTA = function() {
        return {
            ...window.HintMixin.createMultiHint({
                useApi: false,
                storageKey: 'st_hardware_hints',
                hintKeys: ['hero']
            }),
            showHeroCTA() { return this.hints.hero; },
            dismissHeroCTA() { this.dismissHint('hero'); },
            restoreHeroCTA() { this.showHint('hero'); },
            init() { this.loadHints(); }
        };
    };
}
</script>
{% elif tab_name == 'model' %}
<script>
// Model EZ Mode Component - inline for HTMX swaps
(function() {
    'use strict';

    function modelEzModeComponent() {
        return {
            loading: true,
            error: null,
            modelFamilies: [],
            modelFlavours: [],
            model_family: '',
            model_flavour: '',
            model_type: 'lora',
            lora_rank: 16,
            vae_enable_tiling: false,
            vae_enable_slicing: false,
            vae_batch_size: 4,
            gradient_checkpointing: true,
            ramtorch: false,
            musubi_blocks_to_swap: 0,
            use_ema: false,
            base_model_precision: 'no_change',
            text_encoder_1_precision: 'no_change',

            hints: { ez_mode: true },
            _cleanupFns: [],

            showEzMode() {
                // Use reactive property for Alpine to track changes
                return this.hints.ez_mode;
            },

            dismissEzMode() {
                this.hints.ez_mode = false;
                try {
                    const stored = JSON.parse(localStorage.getItem('st_model_hints') || '{}');
                    stored.ez_mode = false;
                    localStorage.setItem('st_model_hints', JSON.stringify(stored));
                } catch (e) { }
            },

            restoreEzMode() {
                this.hints.ez_mode = true;
                try {
                    const stored = JSON.parse(localStorage.getItem('st_model_hints') || '{}');
                    stored.ez_mode = true;
                    localStorage.setItem('st_model_hints', JSON.stringify(stored));
                } catch (e) { }
            },

            async init() {
                // Load persisted state
                try {
                    const stored = JSON.parse(localStorage.getItem('st_model_hints') || '{}');
                    this.hints.ez_mode = stored.ez_mode !== false;
                } catch (e) { }

                await this.loadModelFamilies();

                // Wait for trainer store to be ready before syncing
                await this.waitForTrainerStore();
                this.syncFromForm();
                this.setupFormWatchers();
                this.loading = false;
            },

            async waitForTrainerStore() {
                // Wait up to 2 seconds for trainer store to have config
                for (let i = 0; i < 20; i++) {
                    const store = window.Alpine?.store?.('trainer');
                    if (store?.activeEnvironmentConfig && Object.keys(store.activeEnvironmentConfig).length > 0) {
                        return;
                    }
                    await new Promise(r => setTimeout(r, 100));
                }
            },

            destroy() {
                this._cleanupFns.forEach(fn => fn());
                this._cleanupFns = [];
            },

            async loadModelFamilies() {
                try {
                    const response = await fetch('/api/models/wizard');
                    if (!response.ok) throw new Error('Failed to load model families');
                    const data = await response.json();
                    this.modelFamilies = (data.models || []).map(m => ({
                        value: m.family,
                        label: m.name
                    }));
                } catch (err) {
                    console.error('[EZ MODE] Failed to load model families:', err);
                    this.error = 'Failed to load model families';
                }
            },

            async loadModelFlavours(family) {
                if (!family) { this.modelFlavours = []; return; }
                try {
                    const response = await fetch(`/api/models/${encodeURIComponent(family)}/flavours`);
                    if (response.ok) {
                        const data = await response.json();
                        this.modelFlavours = data.flavours || [];
                    } else { this.modelFlavours = []; }
                } catch (err) {
                    console.error('[EZ MODE] Failed to load flavours:', err);
                    this.modelFlavours = [];
                }
            },

            syncFromForm() {
                const fields = [
                    'model_family', 'model_flavour', 'model_type', 'lora_rank',
                    'vae_enable_tiling', 'vae_enable_slicing', 'vae_batch_size',
                    'gradient_checkpointing', 'ramtorch', 'musubi_blocks_to_swap', 'use_ema',
                    'base_model_precision', 'text_encoder_1_precision'
                ];

                const trainerStore = window.Alpine?.store?.('trainer');
                if (trainerStore?.activeEnvironmentConfig) {
                    const config = trainerStore.activeEnvironmentConfig;
                    for (const fieldName of fields) {
                        const prefixedKey = `--${fieldName}`;
                        const value = config[prefixedKey] ?? config[fieldName];
                        if (value !== undefined && value !== null) {
                            if (typeof value === 'boolean') {
                                this[fieldName] = value;
                            } else if (typeof value === 'number') {
                                this[fieldName] = value;
                            } else if (typeof value === 'string') {
                                if (value === 'true' || value === 'false') {
                                    this[fieldName] = value === 'true';
                                } else {
                                    this[fieldName] = value;
                                }
                            }
                        }
                    }
                }

                for (const fieldName of fields) {
                    const el = document.getElementById(fieldName) || document.querySelector(`[name="${fieldName}"]`);
                    if (el) {
                        if (el.type === 'checkbox') {
                            this[fieldName] = el.checked;
                        } else if (el.type === 'number' || el.type === 'range') {
                            this[fieldName] = parseFloat(el.value) || 0;
                        } else {
                            this[fieldName] = el.value || '';
                        }
                    }
                }

                if (this.model_family) this.loadModelFlavours(this.model_family);
            },

            setupFormWatchers() {
                const fields = [
                    'model_family', 'model_flavour', 'model_type', 'lora_rank',
                    'vae_enable_tiling', 'vae_enable_slicing', 'vae_batch_size',
                    'gradient_checkpointing', 'ramtorch', 'musubi_blocks_to_swap', 'use_ema',
                    'base_model_precision', 'text_encoder_1_precision'
                ];

                for (const fieldName of fields) {
                    const el = document.getElementById(fieldName) || document.querySelector(`[name="${fieldName}"]`);
                    if (el) {
                        const handler = () => {
                            if (el.type === 'checkbox') {
                                this[fieldName] = el.checked;
                            } else if (el.type === 'number' || el.type === 'range') {
                                this[fieldName] = parseFloat(el.value) || 0;
                            } else {
                                this[fieldName] = el.value || '';
                            }
                            if (fieldName === 'model_family') this.loadModelFlavours(el.value);
                        };
                        el.addEventListener('change', handler);
                        el.addEventListener('input', handler);
                        this._cleanupFns.push(() => {
                            el.removeEventListener('change', handler);
                            el.removeEventListener('input', handler);
                        });
                    }
                }
            },

            updateFormField(fieldName, value) {
                const el = document.getElementById(fieldName) || document.querySelector(`[name="${fieldName}"]`);
                if (el) {
                    if (el.type === 'checkbox') { el.checked = Boolean(value); }
                    else { el.value = value; }
                    el.dispatchEvent(new Event('change', { bubbles: true }));
                    el.dispatchEvent(new Event('input', { bubbles: true }));
                }

                const trainerStore = window.Alpine?.store?.('trainer');
                if (trainerStore) {
                    const canonicalKey = `--${fieldName}`;
                    if (typeof trainerStore.updateConfigValue === 'function') {
                        trainerStore.updateConfigValue(canonicalKey, value);
                    } else if (trainerStore.activeEnvironmentConfig) {
                        trainerStore.activeEnvironmentConfig[canonicalKey] = value;
                    }
                    if (typeof trainerStore.markFormDirty === 'function') {
                        trainerStore.markFormDirty();
                    }
                }
            },

            onModelFamilyChange(value) {
                this.model_family = value;
                this.model_flavour = '';
                this.updateFormField('model_family', value);
                this.loadModelFlavours(value);
            },
            onModelFlavourChange(value) { this.model_flavour = value; this.updateFormField('model_flavour', value); },
            onModelTypeChange(value) { this.model_type = value; this.updateFormField('model_type', value); },
            onLoraRankChange(value) { const v = parseInt(value) || 16; this.lora_rank = v; this.updateFormField('lora_rank', v); },
            onVaeTilingChange(c) { this.vae_enable_tiling = c; this.updateFormField('vae_enable_tiling', c); },
            onVaeSlicingChange(c) { this.vae_enable_slicing = c; this.updateFormField('vae_enable_slicing', c); },
            onVaeBatchSizeChange(v) { const n = parseInt(v) || 4; this.vae_batch_size = n; this.updateFormField('vae_batch_size', n); },
            onGradientCheckpointingChange(c) { this.gradient_checkpointing = c; this.updateFormField('gradient_checkpointing', c); },
            onRamtorchChange(c) {
                this.ramtorch = c; this.updateFormField('ramtorch', c);
                if (c && this.musubi_blocks_to_swap > 0) {
                    this.musubi_blocks_to_swap = 0; this.updateFormField('musubi_blocks_to_swap', 0);
                }
            },
            onMusubiBlocksChange(v) {
                const n = parseInt(v) || 0; this.musubi_blocks_to_swap = n; this.updateFormField('musubi_blocks_to_swap', n);
                if (n > 0 && this.ramtorch) { this.ramtorch = false; this.updateFormField('ramtorch', false); }
            },
            onUseEmaChange(c) { this.use_ema = c; this.updateFormField('use_ema', c); },
            onBaseModelPrecisionChange(v) { this.base_model_precision = v; this.updateFormField('base_model_precision', v); },
            onTextEncoderPrecisionChange(v) { this.text_encoder_1_precision = v; this.updateFormField('text_encoder_1_precision', v); },

            openMemoryPresets() { window.openMemoryPresetsModal?.(); },

            get isLoraMode() { return this.model_type === 'lora'; },
            get hasModelFamily() { return Boolean(this.model_family); }
        };
    }

    // Register with Alpine
    if (window.Alpine) {
        window.Alpine.data('modelEzModeComponent', modelEzModeComponent);
    } else {
        document.addEventListener('alpine:init', () => {
            window.Alpine.data('modelEzModeComponent', modelEzModeComponent);
        });
    }
})();
</script>
{% endif %}

<div class="tab-fragment"
     id="{{ tab_name }}-tab-content"
     data-tab-name="{{ tab_name }}"
     data-danger-mode="{{ 'true' if danger_mode_enabled | default(false) else 'false' }}"
     {% if tab_name == 'publishing' %}x-data="publishingHeroCTA()" x-init="init()"{% elif tab_name == 'hardware' %}x-data="hardwareHeroCTA()" x-init="init()"{% elif tab_name == 'model' %}x-data="modelEzModeComponent()" x-init="init()"{% endif %}>

    {% if tab_name == 'publishing' %}
    <!-- Hero CTA - Introduction to publishing -->
    {% call hero_cta(
        theme='green',
        icon_class='fa-cloud-upload-alt',
        icon_shape='rounded',
        title='Publishing to HuggingFace Hub',
        description='Configure automatic uploads of your trained models and checkpoints to the HuggingFace Hub. This allows you to share your work, version your models, and make them accessible to others.',
        features=[
            {'icon': 'fa-key', 'color': 'text-warning', 'label': 'Authentication'},
            {'icon': 'fa-code-branch', 'color': 'text-info', 'label': 'Repository Config'},
            {'icon': 'fa-upload', 'color': 'text-success', 'label': 'Auto-Upload'},
        ],
        show_condition='showHeroCTA()',
        dismiss_method='dismissHeroCTA()',
        cta_primary={'label': 'Dismiss', 'icon': 'fa-check', 'action': 'dismissHeroCTA()'},
        tip_text='You can upload checkpoints manually from the <strong>Checkpoints</strong> tab, or enable automatic uploads here.'
    ) %}
    <div class="hero-details mt-4">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="hero-detail-card">
                    <h6><i class="fas fa-key text-warning me-2"></i>Authentication</h6>
                    <p class="small text-muted mb-0">
                        Connect your HuggingFace account using an access token. Tokens are stored securely
                        in your local HuggingFace cache (~/.cache/huggingface/token).
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="hero-detail-card">
                    <h6><i class="fas fa-code-branch text-info me-2"></i>Repository Settings</h6>
                    <p class="small text-muted mb-0">
                        Configure your Hub repository ID, visibility (public/private), and whether to
                        push checkpoints automatically during training.
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="hero-detail-card">
                    <h6><i class="fas fa-upload text-success me-2"></i>Automatic Uploads</h6>
                    <p class="small text-muted mb-0">
                        Enable "Push to Hub" to automatically upload checkpoints as they're saved.
                        Great for long training runs where you want continuous backups.
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endcall %}

    <div x-show="!showHeroCTA()" x-cloak>
    {% elif tab_name == 'hardware' %}
    <!-- Hero CTA - Introduction to hardware settings -->
    {% call hero_cta(
        theme='purple',
        icon_class='fa-microchip',
        icon_shape='rounded',
        title='Hardware & Distributed Training',
        description='Configure multi-GPU training, distributed computing, and system resource settings. Most users can leave these at their defaults â€” SimpleTuner auto-detects your hardware.',
        features=[
            {'icon': 'fa-project-diagram', 'color': 'text-info', 'label': 'Multi-GPU'},
            {'icon': 'fa-server', 'color': 'text-warning', 'label': 'Multi-Node'},
            {'icon': 'fa-cogs', 'color': 'text-success', 'label': 'Worker Threads'},
        ],
        show_condition='showHeroCTA()',
        dismiss_method='dismissHeroCTA()',
        cta_primary={'label': 'Dismiss', 'icon': 'fa-check', 'action': 'dismissHeroCTA()'},
        tip_text='For single-GPU training, you typically don\'t need to change anything here. These settings become important for multi-GPU or multi-machine setups.'
    ) %}
    <div class="hero-details mt-4">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="hero-detail-card">
                    <h6><i class="fas fa-project-diagram text-info me-2"></i>Multi-GPU (FSDP/DeepSpeed)</h6>
                    <p class="small text-muted mb-0">
                        Enable Fully Sharded Data Parallel (FSDP) or DeepSpeed to split your model across
                        multiple GPUs, reducing memory per device and enabling larger batch sizes.
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="hero-detail-card">
                    <h6><i class="fas fa-server text-warning me-2"></i>Multi-Node Training</h6>
                    <p class="small text-muted mb-0">
                        Scale beyond a single machine. <strong>Note:</strong> Multi-node via WebUI is experimental â€”
                        for production use, follow
                        <a href="https://github.com/bghira/SimpleTuner/blob/main/documentation/DISTRIBUTED.md" target="_blank" rel="noopener">DISTRIBUTED.md <i class="fas fa-external-link-alt fa-xs"></i></a>
                        and use the command-line approach.
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="hero-detail-card">
                    <h6><i class="fas fa-cogs text-success me-2"></i>Worker & Thread Settings</h6>
                    <p class="small text-muted mb-0">
                        Tune the number of data loading workers and PyTorch threads to optimize
                        CPU utilization during preprocessing and training.
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endcall %}

    <div x-show="!showHeroCTA()" x-cloak>
    {% elif tab_name == 'model' %}
    <!-- Model EZ Mode Hero -->
    <div x-show="showEzMode()" x-cloak class="model-ez-mode-hero mb-4"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="hero-cta hero-cta--purple" data-theme="purple" data-icon-shape="rounded">
            <button type="button" class="hero-dismiss-btn" @click="dismissEzMode()" title="Dismiss">
                <i class="fas fa-times"></i>
            </button>

            <div class="hero-content text-start">
                <div class="d-flex align-items-start gap-3 mb-3">
                    <div class="hero-icon hero-icon--rounded flex-shrink-0">
                        <i class="fas fa-cube"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h2 class="hero-title mb-2">Model Configuration â€” EZ Mode</h2>
                        <p class="hero-description mb-0">
                            Configure the essential model settings quickly. For advanced options, dismiss this panel to access the full form.
                        </p>
                    </div>
                </div>

            <!-- Loading state -->
            <div x-show="loading" class="text-center py-4">
                <div class="spinner-border text-light spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <!-- EZ Mode Form -->
            <div x-show="!loading" class="ez-mode-form mt-4">
                <!-- Row 1: Model Selection -->
                <div class="ez-mode-section">
                    <h6 class="ez-mode-section-title"><i class="fas fa-sitemap me-2"></i>Model Selection</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Model Family</label>
                            <select class="form-select form-select-sm"
                                    x-model="model_family"
                                    @change="onModelFamilyChange($event.target.value)">
                                <option value="">Select a family...</option>
                                <template x-for="fam in modelFamilies" :key="fam.value">
                                    <option :value="fam.value" x-text="fam.label" :selected="fam.value === model_family"></option>
                                </template>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Model Variant</label>
                            <select class="form-select form-select-sm"
                                    x-model="model_flavour"
                                    @change="onModelFlavourChange($event.target.value)"
                                    :disabled="modelFlavours.length === 0">
                                <option value="">Select a variant...</option>
                                <template x-for="flav in modelFlavours" :key="flav">
                                    <option :value="flav" x-text="flav" :selected="flav === model_flavour"></option>
                                </template>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Training Type</label>
                            <select class="form-select form-select-sm"
                                    x-model="model_type"
                                    @change="onModelTypeChange($event.target.value)">
                                <option value="lora">LoRA (Recommended)</option>
                                <option value="full">Full Model</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Row 2: LoRA Config (conditional) + VAE Options -->
                <div class="ez-mode-section">
                    <h6 class="ez-mode-section-title"><i class="fas fa-sliders-h me-2"></i>Training Options</h6>
                    <div class="row g-3">
                        <!-- LoRA Rank (only for LoRA) -->
                        <div class="col-md-3" x-show="isLoraMode" x-cloak>
                            <label class="form-label">LoRA Rank</label>
                            <input type="number" class="form-control form-control-sm"
                                   x-model.number="lora_rank"
                                   @change="onLoraRankChange($event.target.value)"
                                   min="1" max="256" step="1">
                            <div class="form-text">4-32 for style, 64-128 for concepts</div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">VAE Batch Size</label>
                            <input type="number" class="form-control form-control-sm"
                                   x-model.number="vae_batch_size"
                                   @change="onVaeBatchSizeChange($event.target.value)"
                                   min="1" max="32">
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="ez_vae_tiling"
                                       x-model="vae_enable_tiling"
                                       @change="onVaeTilingChange($event.target.checked)">
                                <label class="form-check-label" for="ez_vae_tiling">VAE Tiling</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="ez_vae_slicing"
                                       x-model="vae_enable_slicing"
                                       @change="onVaeSlicingChange($event.target.checked)">
                                <label class="form-check-label" for="ez_vae_slicing">VAE Slicing</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Row 3: Memory Optimization -->
                <div class="ez-mode-section">
                    <h6 class="ez-mode-section-title"><i class="fas fa-memory me-2"></i>Memory Optimization</h6>
                    <div class="row g-3 align-items-center">
                        <div class="col-md-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="ez_grad_ckpt"
                                       x-model="gradient_checkpointing"
                                       @change="onGradientCheckpointingChange($event.target.checked)">
                                <label class="form-check-label" for="ez_grad_ckpt">Gradient Checkpointing</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="ez_ramtorch"
                                       x-model="ramtorch"
                                       @change="onRamtorchChange($event.target.checked)">
                                <label class="form-check-label" for="ez_ramtorch">RamTorch</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label mb-1">Block Swap</label>
                            <input type="number" class="form-control form-control-sm"
                                   x-model.number="musubi_blocks_to_swap"
                                   @change="onMusubiBlocksChange($event.target.value)"
                                   min="0" max="100">
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-sm btn-outline-light w-100"
                                    @click="openMemoryPresets()">
                                <i class="fas fa-magic me-1"></i>Memory Presets
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Row 4: Quantization (LoRA only) + EMA -->
                <div class="ez-mode-section" x-show="isLoraMode" x-cloak>
                    <h6 class="ez-mode-section-title"><i class="fas fa-compress-arrows-alt me-2"></i>Quantization</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Base Model Precision</label>
                            <select class="form-select form-select-sm"
                                    x-model="base_model_precision"
                                    @change="onBaseModelPrecisionChange($event.target.value)">
                                <option value="no_change">No Change</option>
                                <option value="int8-quanto">INT8 (Quanto)</option>
                                <option value="int4-quanto">INT4 (Quanto)</option>
                                <option value="int8-torchao">INT8 (TorchAO)</option>
                                <option value="nf4-bnb">NF4 (BitsAndBytes)</option>
                                <option value="int8-sdnq">INT8 (SDNQ)</option>
                                <option value="uint8-sdnq">UINT8 (SDNQ)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Text Encoder Precision</label>
                            <select class="form-select form-select-sm"
                                    x-model="text_encoder_1_precision"
                                    @change="onTextEncoderPrecisionChange($event.target.value)">
                                <option value="no_change">No Change</option>
                                <option value="int8-quanto">INT8 (Quanto)</option>
                                <option value="int4-quanto">INT4 (Quanto)</option>
                                <option value="int8-torchao">INT8 (TorchAO)</option>
                                <option value="nf4-bnb">NF4 (BitsAndBytes)</option>
                                <option value="int8-sdnq">INT8 (SDNQ)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="ez_use_ema"
                                       x-model="use_ema"
                                       @change="onUseEmaChange($event.target.checked)">
                                <label class="form-check-label" for="ez_use_ema">Use EMA</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Full Model: EMA toggle -->
                <div class="ez-mode-section" x-show="!isLoraMode" x-cloak>
                    <h6 class="ez-mode-section-title"><i class="fas fa-chart-line me-2"></i>Training Enhancements</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="ez_use_ema_full"
                                       x-model="use_ema"
                                       @change="onUseEmaChange($event.target.checked)">
                                <label class="form-check-label" for="ez_use_ema_full">Use EMA (Exponential Moving Average)</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Footer -->
                <div class="ez-mode-footer mt-4 d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>
                        For advanced options like LoRA targets, FSDP, and more, dismiss EZ Mode.
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-light" @click="dismissEzMode()">
                        <i class="fas fa-cog me-1"></i>Show Full Form
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="!showEzMode()" x-cloak>
    {% endif %}

    <!-- Tab Header -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-start">
            <div>
                <h5 class="mb-0">
                    <i class="{{ tab_config.icon if tab_config else 'fas fa-cog' }}"></i>
                    {{ tab_config.title if tab_config else tab_name|title }} Configuration
                </h5>
                {% if tab_config and tab_config.description %}
                <p class="text-muted mb-0">{{ tab_config.description }}</p>
                {% endif %}
            </div>
            <div class="btn-group btn-group-sm" role="group">
                {% if tab_name in ('publishing', 'hardware') %}
                <button type="button"
                        class="btn btn-outline-secondary"
                        x-show="!showHeroCTA()"
                        x-cloak
                        @click="restoreHeroCTA()"
                        title="Show introduction"
                        aria-label="Show introduction">
                    <i class="fas fa-question-circle"></i><span class="btn-text"> Help</span>
                </button>
                {% elif tab_name == 'model' %}
                <button type="button"
                        class="btn btn-outline-secondary"
                        x-show="!showEzMode()"
                        x-cloak
                        @click="restoreEzMode()"
                        title="Show EZ Mode"
                        aria-label="Show EZ Mode">
                    <i class="fas fa-magic"></i><span class="btn-text"> EZ Mode</span>
                </button>
                {% endif %}
                <button type="button" class="btn btn-outline-secondary" id="collapse-all-{{ tab_name }}" title="Collapse all sections" aria-label="Collapse all sections">
                    <i class="fas fa-compress-alt"></i><span class="btn-text"> Collapse All</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="expand-all-{{ tab_name }}" title="Expand all sections" aria-label="Expand all sections">
                    <i class="fas fa-expand-alt"></i><span class="btn-text"> Expand All</span>
                </button>
            </div>
        </div>

        <div class="card-body">
            <!-- Validation Results Area -->
            <div id="validation-results-{{ tab_name }}" class="mb-3"></div>

            <!-- Form Fields Container -->
            <div class="tab-fields" data-tab-form="{{ tab_name }}">
                <input type="hidden" name="__active_tab__" value="{{ tab_name }}">
                {% set disabled_args = fields
                    | selectattr('disabled')
                    | map(attribute='arg_name')
                    | reject('equalto', None)
                    | list %}
                {% if disabled_args %}
                <input type="hidden" name="__disabled_fields__" value="{{ disabled_args|unique|join(',') }}">
                {% endif %}

                <!-- Render sections if available -->
                {% if sections %}
                    {% for section in sections %}
                    {% set section_fields = fields | selectattr('section_id', 'equalto', section.id) | list %}
                    {% set has_parent = section_fields[0].get('parent_section') if section_fields else false %}

                    {% if not has_parent %}
                        <!-- Main section -->
                        <div class="form-section mb-4"
                             id="section-{{ section.id }}"
                             data-section-type="{% if section.get('advanced') %}advanced{% else %}main{% endif %}">
                            <h6 class="section-title {% if section.get('advanced') %}advanced-section{% endif %}">
                                <!-- Collapse toggle for main sections (not advanced subsections) -->
                                <button type="button" class="btn btn-sm btn-outline-secondary section-toggle me-2"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#content-{{ section.id }}"
                                        aria-expanded="true">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                {% if section.icon %}<i class="{{ section.icon }}"></i>{% endif %}
                                {{ section.title }}
                                {% if section.get('advanced') %}
                                <span class="badge bg-secondary ms-2">Advanced</span>
                                {% endif %}
                            </h6>
                            {% if section.description %}
                            <p class="text-muted small">{{ section.description }}</p>
                            {% endif %}
                            {% if tab_name == 'validation' and section.id == 'prompt_management' %}
                            <div class="prompt-overlay" id="prompt-management-disabled-overlay">
                                <div class="prompt-overlay-content">
                                    <i class="fas fa-ban"></i>
                                    <div>
                                        <strong>Prompt controls disabled.</strong>
                                        <div>
                                            Dataset caption driven validation is active; prompts are managed automatically for this model.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {% if section.get('template') %}
                                <!-- Custom template for this section -->
                                <div class="row collapse show" id="content-{{ section.id }}">
                                    {% include section.template %}
                                </div>
                            {% elif section_fields %}
                                <!-- Group fields by subsection -->
                                {% set subsections = {} %}
                                {% for field in section_fields %}
                                    {% set subsection_name = field.get('subsection', 'general') %}
                                    {% if subsection_name not in subsections %}
                                        {% set _ = subsections.update({subsection_name: []}) %}
                                    {% endif %}
                                    {% set _ = subsections[subsection_name].append(field) %}
                                {% endfor %}

                                <div class="row collapse show" id="content-{{ section.id }}">
                                    {% for subsection_name, subsection_fields in subsections.items() %}
                                        {% if subsections|length > 1 and subsection_name != 'general' %}
                                            <!-- Subsection header -->
                                            <div class="col-12">
                                                <h6 class="subsection-title">
                                                    {{ subsection_name | title | replace('_', ' ') }}
                                                </h6>
                                            </div>
                                        {% endif %}

                                        <!-- Render fields in this subsection -->
                                        {% for field in subsection_fields %}
                                            {% include 'partials/form_field_htmx.html' %}
                                        {% endfor %}

                                        {% if not loop.last and subsections|length > 1 %}
                                            <div class="col-12 mb-3">
                                                <hr class="subsection-divider">
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% elif section.empty_message %}
                                <div class="empty-section-message mt-3 mb-0" role="status">
                                    <i class="fas fa-info-circle me-2"></i>{{ section.empty_message }}
                                </div>
                            {% endif %}

                            <!-- Render nested advanced subsections at the bottom of this parent section -->
                            {% for subsection in sections %}
                            {% set subsection_fields = fields | selectattr('section_id', 'equalto', subsection.id) | list %}
                            {% set subsection_parent = subsection_fields[0].get('parent_section') if subsection_fields else false %}

                            {% if subsection_parent == section.id %}
                                <!-- Nested advanced subsection -->
                                <div class="mt-4 pt-3 border-top border-secondary-subtle">
                                    <h6 class="subsection-title advanced-section">
                                        <button type="button" class="btn btn-sm btn-outline-secondary advanced-toggle me-2"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#advanced-content-{{ subsection.id }}"
                                                aria-expanded="false">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                        {% if subsection.icon %}<i class="{{ subsection.icon }}"></i>{% endif %}
                                        {{ subsection.title }}
                                        <span class="badge bg-secondary ms-2">Advanced</span>
                                    </h6>
                                    {% if subsection.description %}
                                    <p class="text-muted small">{{ subsection.description }}</p>
                                    {% endif %}

                                    {% if subsection.get('template') %}
                                        <!-- Custom template for this subsection -->
                                        <div class="row collapse" id="advanced-content-{{ subsection.id }}">
                                            {% include subsection.template %}
                                        </div>
                                    {% elif subsection_fields %}
                                        <div class="row collapse" id="advanced-content-{{ subsection.id }}">
                                            {% for field in subsection_fields %}
                                                {% include 'partials/form_field_htmx.html' %}
                                            {% endfor %}
                                        </div>
                                    {% elif subsection.empty_message %}
                                        <div class="empty-section-message mt-3 mb-0" role="status">
                                            <i class="fas fa-info-circle me-2"></i>{{ subsection.empty_message }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% endfor %}

                    <!-- Fields without sections -->
                    {% set unsectioned_fields = fields | selectattr('section_id', 'undefined') | list %}
                    {% if unsectioned_fields %}
                    <div class="row">
                        {% for field in unsectioned_fields %}
                            {% include 'partials/form_field_htmx.html' %}
                        {% endfor %}
                    </div>
                    {% endif %}
                {% else %}
                    <!-- No sections, render all fields -->
                    <div class="row">
                        {% for field in fields %}
                            {% include 'partials/form_field_htmx.html' %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="alert alert-info d-flex mt-4" role="alert">
                <i class="fas fa-save me-2"></i>
                <span>Changes are not applied until you click ðŸ’¾ Save in the header.</span>
            </div>
        </div>

        <!-- Tab Footer with Actions -->
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    <i class="fas fa-info-circle"></i>
                    Use Reset to restore the defaults for this tab.
                </div>
                <div>
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            hx-get="/api/config/reset/{{ tab_name }}"
                            hx-confirm="Are you sure you want to reset {{ tab_name }} configuration to defaults?"
                            hx-target="#{{ tab_name }}-tab-content"
                            hx-swap="outerHTML">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if tab_name in ('publishing', 'hardware', 'model') %}
    </div>
    <!-- End hero content wrapper -->
    {% endif %}

</div>

<script>
(function() {
    'use strict';

    const tabName = '{{ tab_name }}';

    function setupSectionCollapse() {
        const collapseAllBtn = document.getElementById('collapse-all-' + tabName);
        const expandAllBtn = document.getElementById('expand-all-' + tabName);
        const tabContent = document.getElementById(tabName + '-tab-content');

        if (!collapseAllBtn || !expandAllBtn || !tabContent) return;

        // Get all main section collapses (not advanced subsections)
        const getSectionCollapses = () => {
            return Array.from(tabContent.querySelectorAll('[id^="content-"]')).filter(el => {
                // Exclude advanced subsections
                return !el.id.startsWith('advanced-content-');
            });
        };

        // Save collapsed state to server (debounced)
        let saveTimeout = null;
        const saveCollapsedState = () => {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                try {
                    const sections = getSectionCollapses();
                    const collapsedState = {};

                    sections.forEach(section => {
                        const sectionId = section.id.replace('content-', '');
                        collapsedState[sectionId] = !section.classList.contains('show');
                    });

                    console.log('[FormTab] Saving collapsed state:', collapsedState);

                    await fetch('/api/webui/ui-state/collapsed-sections/' + tabName, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sections: collapsedState })
                    });
                } catch (error) {
                    console.error('[FormTab] Failed to save collapsed state:', error);
                }
            }, 50);
        };

        // Load saved collapsed state from server
        const loadCollapsedState = async () => {
            try {
                const response = await fetch('/api/webui/ui-state/collapsed-sections/' + tabName);
                if (response.ok) {
                    const collapsedState = await response.json();
                    console.log('[FormTab] Loaded collapsed state:', collapsedState);

                    // Temporarily disable form dirty tracking while we manipulate sections
                    if (window.Alpine && Alpine.store('trainer')) {
                        Alpine.store('trainer')._skipNextClean = true;
                    }

                    // Apply saved state to sections without animation
                    const sections = getSectionCollapses();
                    sections.forEach(section => {
                        const sectionId = section.id.replace('content-', '');
                        const isCollapsed = collapsedState[sectionId];

                        if (isCollapsed !== undefined) {
                            if (isCollapsed) {
                                // Remove 'show' class immediately (no animation)
                                section.classList.remove('show');
                                section.classList.remove('collapsing');

                                // Update the toggle button icon
                                const toggle = tabContent.querySelector(`[data-bs-target="#${section.id}"]`);
                                if (toggle) {
                                    const icon = toggle.querySelector('i');
                                    if (icon) {
                                        icon.classList.remove('fa-chevron-down');
                                        icon.classList.add('fa-chevron-right');
                                    }
                                    toggle.setAttribute('aria-expanded', 'false');
                                }
                            } else {
                                // Ensure 'show' class is present (already expanded by default)
                                section.classList.add('show');
                            }
                        }
                    });

                    // Re-enable form dirty tracking
                    if (window.Alpine && Alpine.store('trainer')) {
                        Alpine.store('trainer')._skipNextClean = false;
                    }
                }
            } catch (error) {
                console.error('[FormTab] Failed to load collapsed state:', error);
            }
        };

        // Collapse all sections
        collapseAllBtn.addEventListener('click', function() {
            const sections = getSectionCollapses();
            let completedCount = 0;
            const totalSections = sections.length;

            if (totalSections === 0) {
                saveCollapsedState();
                return;
            }

            sections.forEach(section => {
                const bsCollapse = bootstrap.Collapse.getInstance(section) || new bootstrap.Collapse(section, { toggle: false });

                // Listen for the collapse animation to complete
                const onHidden = () => {
                    completedCount++;
                    if (completedCount === totalSections) {
                        // All sections have finished collapsing
                        saveCollapsedState();
                    }
                    section.removeEventListener('hidden.bs.collapse', onHidden);
                };

                section.addEventListener('hidden.bs.collapse', onHidden);
                bsCollapse.hide();
            });
        });

        // Expand all sections
        expandAllBtn.addEventListener('click', function() {
            const sections = getSectionCollapses();
            let completedCount = 0;
            const totalSections = sections.length;

            if (totalSections === 0) {
                saveCollapsedState();
                return;
            }

            sections.forEach(section => {
                const bsCollapse = bootstrap.Collapse.getInstance(section) || new bootstrap.Collapse(section, { toggle: false });

                // Listen for the expand animation to complete
                const onShown = () => {
                    completedCount++;
                    if (completedCount === totalSections) {
                        // All sections have finished expanding
                        saveCollapsedState();
                    }
                    section.removeEventListener('shown.bs.collapse', onShown);
                };

                section.addEventListener('shown.bs.collapse', onShown);
                bsCollapse.show();
            });
        });

        // Update chevron icons and save state when sections collapse/expand
        const sectionToggles = tabContent.querySelectorAll('.section-toggle');
        sectionToggles.forEach(toggle => {
            const targetId = toggle.getAttribute('data-bs-target');
            const targetEl = document.querySelector(targetId);

            if (targetEl) {
                // Update icon at the START of animation (for immediate visual feedback)
                targetEl.addEventListener('show.bs.collapse', function() {
                    const icon = toggle.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-down');
                    }
                    toggle.setAttribute('aria-expanded', 'true');
                });

                targetEl.addEventListener('hide.bs.collapse', function() {
                    const icon = toggle.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-right');
                    }
                    toggle.setAttribute('aria-expanded', 'false');
                });

                // Save state at the END of animation (when DOM is updated)
                targetEl.addEventListener('shown.bs.collapse', function() {
                    saveCollapsedState();
                });

                targetEl.addEventListener('hidden.bs.collapse', function() {
                    saveCollapsedState();
                });
            }
        });

        // Load saved state on initialization
        loadCollapsedState();
    }

    function initializeConditionalFields() {
        const tabContent = document.getElementById(tabName + '-tab-content');
        if (!tabContent) return;
        const conditionalFields = tabContent.querySelectorAll('.conditional-field');
        conditionalFields.forEach(field => {
            const condition = field.dataset.conditionalOn;
            if (condition) {
                updateFieldVisibility(field, condition);

                // Listen for changes on the controlling field
                const controlField = tabContent.querySelector(`[name="${condition}"]`);
                if (controlField) {
                    controlField.addEventListener('change', () => {
                        updateFieldVisibility(field, condition);
                    });
                }
            }
        });
    }

    function updateFieldVisibility(field, condition) {
        const tabContent = document.getElementById(tabName + '-tab-content');
        if (!tabContent) return;
        const controlField = tabContent.querySelector(`[name="${condition}"]`);
        if (controlField) {
            const isActive = controlField.type === 'checkbox'
                ? controlField.checked
                : Boolean(controlField.value);

            field.classList.toggle('active', isActive);
            field.querySelectorAll('input, select, textarea').forEach(input => {
                input.disabled = !isActive;
            });
        }
    }

    function initializeTooltips() {
        if (typeof bootstrap !== 'undefined') {
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        }
    }

    function initializePromptManagementGuard() {
        if (tabName !== 'validation') {
            return;
        }

        if (window.__promptManagementGuardCleanup) {
            try {
                window.__promptManagementGuardCleanup();
            } catch (err) {
                console.debug('Prompt management guard cleanup failed', err);
            }
            delete window.__promptManagementGuardCleanup;
        }

        const promptSectionId = 'section-prompt_management';
        const promptContentId = 'content-prompt_management';
        const normalizeBoolean = (value) => {
            if (value === null || value === undefined) {
                return false;
            }
            if (typeof value === 'boolean') {
                return value;
            }
            if (typeof value === 'number') {
                return value !== 0;
            }
            if (typeof value === 'string') {
                const normalized = value.trim().toLowerCase();
                if (!normalized) {
                    return false;
                }
                if (['true', '1', 'yes', 'on'].includes(normalized)) {
                    return true;
                }
                if (['false', '0', 'no', 'off'].includes(normalized)) {
                    return false;
                }
            }
            return Boolean(value);
        };
        const toggleState = (context) => {
            const disabled = Boolean(
                context
                && (
                    normalizeBoolean(context.requiresValidationI2VSamples)
                    || normalizeBoolean(context.strictI2VActive)
                ),
            );
            const section = document.getElementById(promptSectionId);
            const content = document.getElementById(promptContentId);

            if (section) {
                section.classList.toggle('prompt-management-disabled', disabled);
            }

            if (!content) {
                return;
            }

            const controls = content.querySelectorAll('input, textarea, select, button');
            controls.forEach((element) => {
                if (!Object.prototype.hasOwnProperty.call(element.dataset, 'promptGuardOriginalDisabled')) {
                    element.dataset.promptGuardOriginalDisabled = element.disabled ? 'true' : 'false';
                }
                if (disabled) {
                    element.disabled = true;
                } else {
                    element.disabled = element.dataset.promptGuardOriginalDisabled === 'true';
                }
            });
        };

        const handler = (event) => toggleState(event ? event.detail : null);
        window.addEventListener('trainer-model-context-updated', handler);
        window.__promptManagementGuardCleanup = () => window.removeEventListener('trainer-model-context-updated', handler);

        try {
            const trainerStore = window.Alpine && Alpine.store ? Alpine.store('trainer') : null;
            if (trainerStore && trainerStore.modelContext) {
                toggleState(trainerStore.modelContext);
            }
        } catch (err) {
            console.debug('Prompt management guard init failed', err);
        }
    }

    function initializeValidationAdapterGuards() {
        if (tabName !== 'validation') {
            return;
        }

        const tabContent = document.getElementById(tabName + '-tab-content');
        if (!tabContent) return;

        const pathField = tabContent.querySelector('[name="validation_adapter_path"]');
        const configField = tabContent.querySelector('[name="validation_adapter_config"]');
        const singleFieldSelectors = [
            '[data-field-name="validation_adapter_name"]',
            '[data-field-name="validation_adapter_strength"]',
            '[data-field-name="validation_adapter_mode"]',
        ];

        if (!pathField && !configField) {
            return;
        }

        const applyDisabledState = (elements, disabled) => {
            elements.forEach((input) => {
                if (!input.dataset.adapterGuardOriginalDisabled) {
                    input.dataset.adapterGuardOriginalDisabled = input.disabled ? 'true' : 'false';
                }
                if (disabled) {
                    input.disabled = true;
                } else {
                    input.disabled = input.dataset.adapterGuardOriginalDisabled === 'true';
                }
            });
        };

        const toggleGuardState = () => {
            const pathHasValue = Boolean(pathField && pathField.value && pathField.value.trim().length > 0);
            const configHasValue = Boolean(configField && configField.value && configField.value.trim().length > 0);

            if (pathField) {
                pathField.disabled = configHasValue;
            }

            if (configField) {
                configField.disabled = pathHasValue;
            }

            singleFieldSelectors.forEach((selector) => {
                const container = tabContent.querySelector(selector);
                if (!container) {
                    return;
                }
                const inputs = container.querySelectorAll('input, select, textarea');
                applyDisabledState(inputs, configHasValue);
                container.classList.toggle('field-disabled', configHasValue);
            });
        };

        const registerHandler = (element) => {
            if (!element) return;
            element.addEventListener('input', toggleGuardState);
            element.addEventListener('change', toggleGuardState);
        };

        registerHandler(pathField);
        registerHandler(configField);
        toggleGuardState();
    }

    function initTab() {
        console.log('[FormTab] Initializing tab:', tabName);
        setupSectionCollapse();
        initializeConditionalFields();
        initializeTooltips();
        initializePromptManagementGuard();
        initializeValidationAdapterGuards();
    }

    // Initialize immediately (for direct page loads)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTab);
    } else {
        // DOM already loaded, run immediately
        initTab();
    }

    // Re-initialize after HTMX swaps (for tab switching)
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === tabName + '-tab-content') {
            console.log('[FormTab] Re-initializing after HTMX swap:', tabName);
            // Small delay to ensure DOM is ready
            setTimeout(initTab, 50);
        }
    });
})();

// Handle validation results
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.xhr.status === 200) {
        const changedField = evt.detail.triggeringEvent?.target;
        if (changedField && changedField.classList.contains('form-control')) {
            changedField.classList.add('field-valid');
            setTimeout(() => {
                changedField.classList.remove('field-valid');
            }, 2000);
        }
    }
});
</script>
