<!-- Generic Form Tab Template for HTMX -->
<!-- Used by Basic, Model, Training, and Advanced tabs -->
<div class="tab-fragment"
     id="{{ tab_name }}-tab-content"
     data-tab-name="{{ tab_name }}"
     data-danger-mode="{{ 'true' if danger_mode_enabled | default(false) else 'false' }}">

    <!-- Tab Header -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="{{ tab_config.icon if tab_config else 'fas fa-cog' }}"></i>
                {{ tab_config.title if tab_config else tab_name|title }} Configuration
            </h5>
            {% if tab_config and tab_config.description %}
            <p class="text-muted mb-0">{{ tab_config.description }}</p>
            {% endif %}
        </div>

        <div class="card-body">
            <!-- Validation Results Area -->
            <div id="validation-results-{{ tab_name }}" class="mb-3"></div>

            <!-- Form Fields Container -->
            <div class="tab-fields" data-tab-form="{{ tab_name }}">
                <input type="hidden" name="__active_tab__" value="{{ tab_name }}">

                <!-- Render sections if available -->
                {% if sections %}
                    {% for section in sections %}
                    <div class="form-section mb-4" id="section-{{ section.id }}">
                        <h6 class="section-title">
                            {% if section.icon %}<i class="{{ section.icon }}"></i>{% endif %}
                            {{ section.title }}
                        </h6>
                        {% if section.description %}
                        <p class="text-muted small">{{ section.description }}</p>
                        {% endif %}

                        {% set section_fields = fields | selectattr('section_id', 'equalto', section.id) | list %}
                        {% if section_fields %}
                            <div class="row">
                                {% for field in section_fields %}
                                    {% include 'partials/form_field_htmx.html' %}
                                {% endfor %}
                            </div>
                        {% else %}
                            {% if section.empty_message %}
                                <div class="empty-section-message mt-3 mb-0" role="status">
                                    <i class="fas fa-info-circle me-2"></i>{{ section.empty_message }}
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endfor %}

                    <!-- Fields without sections -->
                    {% set unsectioned_fields = fields | selectattr('section_id', 'undefined') | list %}
                    {% if unsectioned_fields %}
                    <div class="row">
                        {% for field in unsectioned_fields %}
                            {% include 'partials/form_field_htmx.html' %}
                        {% endfor %}
                    </div>
                    {% endif %}
                {% else %}
                    <!-- No sections, render all fields -->
                    <div class="row">
                        {% for field in fields %}
                            {% include 'partials/form_field_htmx.html' %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="alert alert-info d-flex align-items-center mt-4" role="alert">
                <i class="fas fa-save me-2"></i>
                <span>Changes are not applied until you click ðŸ’¾ Save in the header.</span>
            </div>
        </div>

        <!-- Tab Footer with Actions -->
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    <i class="fas fa-info-circle"></i>
                    Use Reset to restore the defaults for this tab.
                </div>
                <div>
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            hx-get="/api/config/reset/{{ tab_name }}"
                            hx-confirm="Are you sure you want to reset {{ tab_name }} configuration to defaults?"
                            hx-target="#{{ tab_name }}-tab-content"
                            hx-swap="outerHTML">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Form section styling */
.tab-fragment {
    animation: fadeIn 0.3s ease-in-out;
}

.form-section {
    padding: 1rem;
    background-color: rgba(255, 255, 255, 0.02);
    border-radius: 0.375rem;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.empty-section-message {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    background-color: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(148, 163, 184, 0.35);
    color: #cbd5f5;
    font-size: 0.875rem;
    backdrop-filter: blur(6px);
}

.section-title {
    color: #e2e8f0;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* Field-specific overrides based on tab */
#basic-tab-content .form-section:first-child {
    background-color: rgba(102, 126, 234, 0.05);
    border-color: rgba(102, 126, 234, 0.2);
}

#model-tab-content .form-section:first-child {
    background-color: rgba(139, 92, 246, 0.05);
    border-color: rgba(139, 92, 246, 0.2);
}

#training-tab-content .form-section:first-child {
    background-color: rgba(236, 72, 153, 0.05);
    border-color: rgba(236, 72, 153, 0.2);
}

#advanced-tab-content .form-section:first-child {
    background-color: rgba(245, 158, 11, 0.05);
    border-color: rgba(245, 158, 11, 0.2);
}

/* Auto-save indicator */
.htmx-request .htmx-indicator {
    opacity: 1;
    transition: opacity 0.3s ease-in;
}

/* Field hover effects */
.form-control:hover:not(:focus) {
    border-color: rgba(255, 255, 255, 0.1);
}

/* Conditional field styling */
.conditional-field {
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.conditional-field.active {
    opacity: 1;
}

/* Validation feedback inline */
.field-valid {
    border-color: #22c55e !important;
}

.field-invalid {
    border-color: #ef4444 !important;
}

.field-optional .form-control {
    opacity: 0.85;
}

.field-optional .form-control::placeholder {
    font-style: italic;
}
</style>

<script>
// Tab-specific initialization
document.addEventListener('DOMContentLoaded', function() {
    const tabName = '{{ tab_name }}';

    // Initialize conditional fields
    initializeConditionalFields();

    // Initialize tooltips if Bootstrap is available
    if (typeof bootstrap !== 'undefined') {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }

    // Handle field dependencies
    function initializeConditionalFields() {
        const conditionalFields = document.querySelectorAll('.conditional-field');
        conditionalFields.forEach(field => {
            const condition = field.dataset.conditionalOn;
            if (condition) {
                updateFieldVisibility(field, condition);

                // Listen for changes on the controlling field
                const controlField = document.querySelector(`[name="${condition}"]`);
                if (controlField) {
                    controlField.addEventListener('change', () => {
                        updateFieldVisibility(field, condition);
                    });
                }
            }
        });
    }

    function updateFieldVisibility(field, condition) {
        const controlField = document.querySelector(`[name="${condition}"]`);
        if (controlField) {
            const isActive = controlField.type === 'checkbox'
                ? controlField.checked
                : Boolean(controlField.value);

            field.classList.toggle('active', isActive);
            field.querySelectorAll('input, select, textarea').forEach(input => {
                input.disabled = !isActive;
            });
        }
    }
});

// HTMX event handlers
document.body.addEventListener('htmx:afterSwap', function(evt) {
    // Reinitialize any dynamic content after HTMX swap
    if (evt.detail.target.id && evt.detail.target.id.includes('-tab-content')) {
        // Tab content was reloaded
        console.log('Tab content reloaded:', evt.detail.target.id);
    }
});

// Handle validation results
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.xhr.status === 200) {
        const changedField = evt.detail.triggeringEvent?.target;
        if (changedField && changedField.classList.contains('form-control')) {
            changedField.classList.add('field-valid');
            setTimeout(() => {
                changedField.classList.remove('field-valid');
            }, 2000);
        }
    }
});
</script>
