<!-- Generic Form Tab Template for HTMX -->
<!-- Used by Basic, Model, Training, and Advanced tabs -->
<link rel="stylesheet" href="/static/css/form-sections.css">

<div class="tab-fragment"
     id="{{ tab_name }}-tab-content"
     data-tab-name="{{ tab_name }}"
     data-danger-mode="{{ 'true' if danger_mode_enabled | default(false) else 'false' }}">

    <!-- Tab Header -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="{{ tab_config.icon if tab_config else 'fas fa-cog' }}"></i>
                {{ tab_config.title if tab_config else tab_name|title }} Configuration
            </h5>
            {% if tab_config and tab_config.description %}
            <p class="text-muted mb-0">{{ tab_config.description }}</p>
            {% endif %}
        </div>

        <div class="card-body">
            <!-- Validation Results Area -->
            <div id="validation-results-{{ tab_name }}" class="mb-3"></div>

            <!-- Form Fields Container -->
            <div class="tab-fields" data-tab-form="{{ tab_name }}">
                <input type="hidden" name="__active_tab__" value="{{ tab_name }}">

                <!-- Render sections if available -->
                {% if sections %}
                    {% for section in sections %}
                    <div class="form-section mb-4" id="section-{{ section.id }}">
                        <h6 class="section-title {% if section.get('advanced') %}advanced-section{% endif %}">
                            {% if section.get('advanced') %}
                            <button type="button" class="btn btn-sm btn-outline-secondary advanced-toggle me-2"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#advanced-content-{{ section.id }}"
                                    aria-expanded="false">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            {% endif %}
                            {% if section.icon %}<i class="{{ section.icon }}"></i>{% endif %}
                            {{ section.title }}
                            {% if section.get('advanced') %}
                            <span class="badge bg-secondary ms-2">Advanced</span>
                            {% endif %}
                        </h6>
                        {% if section.description %}
                        <p class="text-muted small">{{ section.description }}</p>
                        {% endif %}

                        {% set section_fields = fields | selectattr('section_id', 'equalto', section.id) | list %}
                        {% if section.get('template') %}
                            <!-- Custom template for this section -->
                            <div class="row {% if section.get('advanced') %}collapse{% endif %}"
                                 {% if section.get('advanced') %}id="advanced-content-{{ section.id }}"{% endif %}>
                                {% include section.template %}
                            </div>
                        {% elif section_fields %}
                            <div class="row {% if section.get('advanced') %}collapse{% endif %}"
                                 {% if section.get('advanced') %}id="advanced-content-{{ section.id }}"{% endif %}>
                                {% for field in section_fields %}
                                    {% include 'partials/form_field_htmx.html' %}
                                {% endfor %}
                            </div>
                        {% elif section.empty_message %}
                            <div class="empty-section-message mt-3 mb-0" role="status">
                                <i class="fas fa-info-circle me-2"></i>{{ section.empty_message }}
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <!-- Fields without sections -->
                    {% set unsectioned_fields = fields | selectattr('section_id', 'undefined') | list %}
                    {% if unsectioned_fields %}
                    <div class="row">
                        {% for field in unsectioned_fields %}
                            {% include 'partials/form_field_htmx.html' %}
                        {% endfor %}
                    </div>
                    {% endif %}
                {% else %}
                    <!-- No sections, render all fields -->
                    <div class="row">
                        {% for field in fields %}
                            {% include 'partials/form_field_htmx.html' %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="alert alert-info d-flex align-items-center mt-4" role="alert">
                <i class="fas fa-save me-2"></i>
                <span>Changes are not applied until you click ðŸ’¾ Save in the header.</span>
            </div>
        </div>

        <!-- Tab Footer with Actions -->
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    <i class="fas fa-info-circle"></i>
                    Use Reset to restore the defaults for this tab.
                </div>
                <div>
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            hx-get="/api/config/reset/{{ tab_name }}"
                            hx-confirm="Are you sure you want to reset {{ tab_name }} configuration to defaults?"
                            hx-target="#{{ tab_name }}-tab-content"
                            hx-swap="outerHTML">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tab-specific initialization
document.addEventListener('DOMContentLoaded', function() {
    const tabName = '{{ tab_name }}';

    // Initialize conditional fields
    initializeConditionalFields();

    // Initialize tooltips if Bootstrap is available
    if (typeof bootstrap !== 'undefined') {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }

    // Handle field dependencies
    function initializeConditionalFields() {
        const conditionalFields = document.querySelectorAll('.conditional-field');
        conditionalFields.forEach(field => {
            const condition = field.dataset.conditionalOn;
            if (condition) {
                updateFieldVisibility(field, condition);

                // Listen for changes on the controlling field
                const controlField = document.querySelector(`[name="${condition}"]`);
                if (controlField) {
                    controlField.addEventListener('change', () => {
                        updateFieldVisibility(field, condition);
                    });
                }
            }
        });
    }

    function updateFieldVisibility(field, condition) {
        const controlField = document.querySelector(`[name="${condition}"]`);
        if (controlField) {
            const isActive = controlField.type === 'checkbox'
                ? controlField.checked
                : Boolean(controlField.value);

            field.classList.toggle('active', isActive);
            field.querySelectorAll('input, select, textarea').forEach(input => {
                input.disabled = !isActive;
            });
        }
    }
});

// HTMX event handlers
document.body.addEventListener('htmx:afterSwap', function(evt) {
    // Reinitialize any dynamic content after HTMX swap
    if (evt.detail.target.id && evt.detail.target.id.includes('-tab-content')) {
        // Tab content was reloaded
        console.log('Tab content reloaded:', evt.detail.target.id);
    }
});

// Handle validation results
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.xhr.status === 200) {
        const changedField = evt.detail.triggeringEvent?.target;
        if (changedField && changedField.classList.contains('form-control')) {
            changedField.classList.add('field-valid');
            setTimeout(() => {
                changedField.classList.remove('field-valid');
            }, 2000);
        }
    }
});
</script>

<style>
/* Advanced section styles */
.advanced-section {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.advanced-toggle {
    transition: transform 0.2s ease;
}

.advanced-toggle[aria-expanded="true"] i {
    transform: rotate(90deg);
}

.advanced-section .badge {
    font-size: 0.7em;
    font-weight: 500;
}

.collapse {
    transition: all 0.3s ease;
}

/* Add subtle border to advanced sections */
.form-section:has(.advanced-section) {
    border-left: 3px solid rgba(108, 117, 125, 0.3);
    padding-left: 1rem;
    margin-left: 0.5rem;
}

.form-section:has(.advanced-section):hover {
    border-left-color: rgba(108, 117, 125, 0.6);
}
</style>
