<!-- templates/base_htmx.html - Enhanced base template with HTMX + Alpine.js -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% set asset_version = (webui_defaults.get('asset_version') if webui_defaults is defined else None) or '20241206' %}
    {% if csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    {% endif %}
    <title>{% block title %}SimpleTuner Training Studio{% endblock %}</title>

    <!-- Critical CSS (inline for performance) -->
    <!-- Cache busting: use server-side timestamp when available, fallback to client-side -->
    {% set _cache_ts = cache_timestamp if cache_timestamp is defined else '' %}
    <script>
    var cssTimestamp = '{{ _cache_ts }}' || String(Date.now());
    window.CACHE_TIMESTAMP = cssTimestamp;

    // Cache bust a single CSS element by ID (legacy API, still works)
    window.cacheBustCSS = function(elementId, cssPath) {
        var el = document.getElementById(elementId);
        if (el) {
            // If no path provided, extract from existing href
            var path = cssPath || el.href.split('?')[0];
            el.href = path + '?v=' + cssTimestamp;
        }
    };

    // Auto cache-bust all CSS links with id starting with "css-"
    window.autoCacheBustCSS = function(root) {
        root = root || document;
        var links = root.querySelectorAll('link[rel="stylesheet"][id^="css-"]');
        links.forEach(function(link) {
            if (!link.dataset.cacheBusted) {
                var path = link.href.split('?')[0];
                link.href = path + '?v=' + cssTimestamp;
                link.dataset.cacheBusted = 'true';
            }
        });
    };

    // Run auto cache-bust after HTMX content swaps
    document.addEventListener('htmx:afterSwap', function(e) {
        window.autoCacheBustCSS(e.detail.target);
    });
    document.addEventListener('htmx:afterSettle', function(e) {
        window.autoCacheBustCSS(e.detail.target);
    });
    </script>
    <!-- Global WebUI defaults -->
    {% set show_docs_default = webui_defaults.show_documentation_links if webui_defaults is defined and webui_defaults.show_documentation_links is defined else true %}
    <script>
    window.webuiDefaults = {
        show_documentation_links: {{ 'true' if show_docs_default else 'false' }}
    };
    function updateDocLinkVisibility() {
        var show = window.webuiDefaults.show_documentation_links;
        document.querySelectorAll('.doc-link').forEach(function(el) {
            el.style.display = show ? '' : 'none';
        });
    }
    window.addEventListener('webui-defaults-updated', function(event) {
        var payload = event && event.detail && (event.detail.resolved_defaults || event.detail.defaults);
        if (payload && typeof payload.show_documentation_links !== 'undefined') {
            window.webuiDefaults.show_documentation_links = Boolean(payload.show_documentation_links);
            updateDocLinkVisibility();
        }
    });
    document.addEventListener('DOMContentLoaded', updateDocLinkVisibility);
    document.addEventListener('htmx:afterSwap', updateDocLinkVisibility);
    document.addEventListener('htmx:afterSettle', updateDocLinkVisibility);
    </script>
    <style>.doc-link { display: {{ 'inline' if show_docs_default else 'none' }}; }</style>
    <link href="/static/css/critical.css" rel="stylesheet" id="css-critical">
    <script>document.getElementById('css-critical').href = '/static/css/critical.css?t=' + cssTimestamp;</script>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- External CSS (preconnect for performance) -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- External CSS (loaded asynchronously) -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">

    <!-- Local CSS (loaded directly to avoid preload warnings) -->
    <link href="/static/css/base.css" rel="stylesheet" id="css-base">
    <script>document.getElementById('css-base').href = '/static/css/base.css?t=' + cssTimestamp;</script>
    <link href="/static/css/trainer.css" rel="stylesheet" id="css-trainer">
    <script>document.getElementById('css-trainer').href = '/static/css/trainer.css?t=' + cssTimestamp;</script>
    <link href="/static/css/browser-compat.css" rel="stylesheet" id="css-browser-compat">
    <script>document.getElementById('css-browser-compat').href = '/static/css/browser-compat.css?t=' + cssTimestamp;</script>
    <link href="/static/css/dataset-card.css" rel="stylesheet" id="css-dataset-card">
    <script>document.getElementById('css-dataset-card').href = '/static/css/dataset-card.css?t=' + cssTimestamp;</script>
    <link href="/static/css/hero-cta.css" rel="stylesheet" id="css-hero-cta">
    <script>document.getElementById('css-hero-cta').href = '/static/css/hero-cta.css?t=' + cssTimestamp;</script>

    <!-- Fallback for browsers without JS -->
    <noscript>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
    </noscript>

    <!-- CSS loading helper for external resources -->
    <script>
        // Helper for CSS preloading
        !function(r){"use strict";r.loadCSS||(r.loadCSS=function(){});var o=loadCSS.relpreload={};if(o.support=function(){var e;try{e=r.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),o.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},o.poly=function(){if(!o.support())for(var t=r.document.getElementsByTagName("link"),e=0;e<t.length;e++){var a=t[e];"preload"!==a.rel||"style"!==a.getAttribute("as")||a.getAttribute("data-loadcss")||(a.setAttribute("data-loadcss",!0),o.bindMediaToggle(a))}},!o.support()){o.poly();var t=r.setInterval(o.poly,500);r.addEventListener?r.addEventListener("load",function(){o.poly(),r.clearInterval(t)}):r.attachEvent&&r.attachEvent("onload",function(){o.poly(),r.clearInterval(t)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:r.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
    </script>

    <!-- JavaScript Polyfills for Browser Compatibility -->
    <script src="/static/js/polyfills.js?v={{ asset_version }}"></script>

    <!-- UI Sound effects module -->
    <script src="/static/js/modules/sounds.js?v={{ asset_version }}"></script>
    <script>
        // Initialize SoundManager with user preferences
        document.addEventListener('DOMContentLoaded', function() {
            if (window.SoundManager) {
                window.SoundManager.init({
                    sounds_enabled: {{ (defaults.sounds_enabled | default(true)) | tojson }},
                    sounds_volume: {{ defaults.sounds_volume | default(50) | int }},
                    sounds_success_enabled: {{ (defaults.sounds_success_enabled | default(true)) | tojson }},
                    sounds_error_enabled: {{ (defaults.sounds_error_enabled | default(true)) | tojson }},
                    sounds_warning_enabled: {{ (defaults.sounds_warning_enabled | default(true)) | tojson }},
                    sounds_info_enabled: {{ (defaults.sounds_info_enabled | default(true)) | tojson }},
                    sounds_retro_hover_enabled: {{ (defaults.sounds_retro_hover_enabled | default(false)) | tojson }},
                });
            }
        });
        // Listen for settings updates
        window.addEventListener('webui-defaults-updated', function(e) {
            if (window.SoundManager && e.detail) {
                const d = e.detail.resolved_defaults || e.detail.defaults || {};
                window.SoundManager.updateSettings(d);
            }
        });
    </script>

    <!-- Debouncing utility for performance -->
    <script src="/static/js/debounce.js?v={{ asset_version }}" defer></script>

    <!-- Lazy loading for heavy components -->
    <script src="/static/js/lazy-load.js?v={{ asset_version }}" defer></script>

    <!-- HTMX for dynamic HTML updates -->
    <script src="https://unpkg.com/htmx.org@2.0.8/dist/htmx.min.js"></script>

    <!-- Server configuration detection -->
    <script src="/static/js/server-config.js?v={{ asset_version }}"></script>

    <!-- Shared API helper -->
    <script src="/static/js/utils/api.js?v={{ asset_version }}"></script>
    <!-- Shared UI helpers (badges, icons, formatters) -->
    <script src="/static/js/utils/ui-helpers.js?v={{ asset_version }}"></script>
    <!-- Hint dismissal mixin (API and localStorage patterns) -->
    <script src="/static/js/utils/hint-mixin.js?v={{ asset_version }}"></script>

    <!-- Dataset wizard component (needs to load before Alpine) -->
    <script src="/static/js/dataset-wizard.js?v={{ asset_version }}"></script>

    <!-- Training wizard component (needs to load before Alpine) -->
    <script src="/static/js/training-wizard.js?v={{ asset_version }}"></script>
    <!-- Shared create environment form component -->
    <script src="/static/js/create-environment-form.js?v={{ asset_version }}"></script>
    <!-- DeepSpeed builder lazy loader -->
    <script src="/static/js/deepspeed-builder-loader.js?v={{ asset_version }}"></script>
    <!-- DeepSpeed builder (registers Alpine component before initialization) -->
    <script src="/static/js/deepspeed-builder.js?v={{ asset_version }}"></script>
    <!-- Memory presets modal (registers Alpine component) -->
    <script src="/static/js/memory-presets.js?v={{ asset_version }}"></script>

    <!-- Cloud dashboard state modules (must load first) -->
    <script src="/static/js/modules/cloud/state/setup-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/provider-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/jobs-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/metrics-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/publishing-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/system-status-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/queue-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/upload-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/ui-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/modals-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/connection-state.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/state/index.js?v={{ asset_version }}"></script>
    <!-- Cloud dashboard method modules -->
    <script src="/static/js/modules/cloud/providers.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/jobs.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/job-submission.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/job-logs.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/metrics.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/system-status.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/queue.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/admin-modal.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/onboarding.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/utilities.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/job-notifications.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/cloud/s3_config.js?v={{ asset_version }}"></script>
    <!-- Cloud dashboard main component -->
    <script src="/static/js/modules/cloud/index.js?v={{ asset_version }}"></script>
    <!-- Admin panel modules (must load before main component) -->
    <script src="/static/js/modules/admin/hints.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/users.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/levels.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/rules.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/quotas.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/approvals.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/auth-providers.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/orgs-teams.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/audit.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/credentials.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/enterprise-onboarding.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/notifications.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/registration.js?v={{ asset_version }}"></script>
    <script src="/static/js/modules/admin/index.js?v={{ asset_version }}"></script>
    <!-- Audit log component (registers Alpine component) -->
    <script src="/static/js/audit_component.js?v={{ asset_version }}"></script>
    <!-- Metrics component (registers Alpine component) -->
    <script src="/static/js/metrics_component.js?v={{ asset_version }}"></script>
    <!-- Notifications component (registers Alpine component) -->
    <script src="/static/js/notifications_component.js?v={{ asset_version }}"></script>
    <!-- Organizations component (registers Alpine component) -->
    <script src="/static/js/orgs_component.js?v={{ asset_version }}"></script>
    <!-- User profile component (registers Alpine component) -->
    <script src="/static/js/user_profile_component.js?v={{ asset_version }}"></script>

    <!-- Alpine.js for reactive UI components -->
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom HTMX/Alpine styles -->
    <style>
        /* Dark theme overrides for Bootstrap */
        body,
        .modal-content {
            background-color: var(--dark-bg) !important;
            color: var(--text-primary) !important;
        }

        /* Fix form labels and text for dark theme */
        .form-label,
        label {
            color: var(--text-secondary) !important;
            font-weight: 500;
        }

        .form-control,
        .form-select {
            background-color: var(--card-bg) !important;
            border: 1px solid var(--glass-border) !important;
            color: var(--text-primary) !important;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: var(--card-bg-elevated) !important;
            border-color: var(--accent-purple) !important;
            box-shadow: 0 0 0 3px var(--focus-ring-color) !important;
            color: var(--text-primary) !important;
        }

        .form-control::placeholder {
            color: var(--text-soft) !important;
        }

        .form-text,
        .text-muted {
            color: var(--text-muted) !important;
        }

        .card-title,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: var(--text-primary) !important;
        }

        /* Loading indicator for HTMX requests */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 300ms ease-in;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .htmx-request.htmx-indicator {
            opacity: 1;
        }

        /* Alpine.js transitions */
        [x-cloak] {
            display: none !important;
        }

        /* Form validation styling */
        .field-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .field-success {
            border-color: #198754 !important;
            box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25) !important;
        }


        /* Connection status indicator */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .connection-status.connected {
            background-color: var(--connection-bg-connected);
            color: var(--text-primary);
        }

        .connection-status.disconnected {
            background-color: var(--connection-bg-disconnected);
            color: var(--text-primary);
        }

        .connection-status.reconnecting {
            background-color: var(--connection-bg-reconnecting);
            color: var(--text-primary);
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 60px;
            right: 20px;
            z-index: 1060;
            max-width: 350px;
        }

        .toast {
            margin-bottom: 10px;
            background-color: var(--toast-bg);
            border: 1px solid var(--toast-border);
            color: var(--text-primary);
        }

        .toast.success {
            border-left: 4px solid var(--toast-success);
        }

        .toast.error {
            border-left: 4px solid var(--toast-error);
        }

        .toast.warning {
            border-left: 4px solid var(--toast-warning);
        }

        .toast.info {
            border-left: 4px solid var(--toast-info);
        }

        .toast-header {
            background-color: transparent;
            border-bottom: 1px solid var(--toast-border);
            padding: 0.5rem 0.75rem;
        }
    </style>

    <!-- Training Wizard Styles -->
    <link href="/static/css/training-wizard.css" rel="stylesheet" id="css-training-wizard">
    <script>document.getElementById('css-training-wizard').href = '/static/css/training-wizard.css?t=' + cssTimestamp;</script>

    {% block extra_css %}{% endblock %}
</head>

<body data-theme="{{ webui_theme|default('dark') }}">
    <script>
        (function() {
            const THEME_CLASSES = ['dark-theme', 'tron-theme'];

            window.applyTheme = function(theme) {
                const themeName = (theme || 'dark').toLowerCase();
                const body = document.body;
                if (!body) {
                    return;
                }

                body.dataset.theme = themeName;
                document.documentElement.setAttribute('data-theme', themeName);

                THEME_CLASSES.forEach(cls => body.classList.remove(cls));

                if (themeName === 'tron') {
                    body.classList.add('tron-theme');
                }

                if (!body.classList.contains('dark-theme')) {
                    body.classList.add('dark-theme');
                }

                document.documentElement.style.backgroundColor = '#0a0a0a';
                document.body.style.backgroundColor = '#0a0a0a';
            };

            const initialTheme = document.body.dataset.theme || '{{ webui_theme|default("dark") }}';
            window.applyTheme(initialTheme);
        })();

        // Prepare for style loading signals

        // Mark styles as loaded when all CSS files are ready
        var loadedStyles = 0;
        var totalStyles = 6; // 2 external (bootstrap, fontawesome) + 4 local (base, trainer, browser-compat, dataset-card)

        function checkStylesLoaded() {
            loadedStyles++;
            if (loadedStyles >= totalStyles) {
                document.body.classList.add('styles-loaded');
            }
        }

        // Monitor stylesheets
        document.addEventListener('DOMContentLoaded', function() {
            // Monitor external preloaded stylesheets
            var preloadLinks = document.querySelectorAll('link[rel="preload"][as="style"]');
            preloadLinks.forEach(function(link) {
                if (link.sheet) {
                    checkStylesLoaded();
                } else {
                    link.addEventListener('load', checkStylesLoaded);
                }
            });

            // Monitor local stylesheets (loaded directly)
            var localLinks = document.querySelectorAll('link[rel="stylesheet"][id^="css-"]');
            localLinks.forEach(function(link) {
                if (link.sheet) {
                    checkStylesLoaded();
                } else {
                    link.addEventListener('load', checkStylesLoaded);
                }
            });
        });
    </script>

    <!-- Connection Status Indicator (hidden by default, shown inline in topbar) -->

    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container">
        <!-- Toasts will be dynamically inserted here -->
    </div>

    <!-- Main Content -->
    {% block body %}{% endblock %}

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

    <!-- HTMX Configuration -->
    <script>
        // Configure HTMX defaults
        htmx.config.defaultSwapStyle = 'outerHTML';
        htmx.config.defaultSwapDelay = 100;
        htmx.config.defaultSettleDelay = 100;

        // Global error handler
        document.body.addEventListener('htmx:responseError', function(evt) {
            console.error('HTMX Error:', evt.detail);
            showToast('Network error occurred', 'error');
        });

        // Global success handler
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.xhr.status >= 200 && evt.detail.xhr.status < 300) {
                // Check for success messages in response headers
                const successMsg = evt.detail.xhr.getResponseHeader('X-Success-Message');
                if (successMsg) {
                    showToast(successMsg, 'success');
                }
            }
        });

        // Toast notification function
        window.showToast = function(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();

            const iconMap = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast ${type} show`;
            toast.innerHTML = `
                <div class="toast-header">
                    <i class="${iconMap[type]} me-2"></i>
                    <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => removeToast(toastId), duration);
            }
        }

        function removeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.remove();
            }
        }

        // Connection monitoring - single source of truth for connection status
        // Updates Alpine store first, then dispatches event for non-Alpine components
        function updateConnectionStatus(status, message) {
            // Update Alpine store (source of truth for badge)
            const store = window.Alpine && typeof window.Alpine.store === 'function'
                ? window.Alpine.store('trainer')
                : null;
            if (store) {
                store.connectionStatus = status;
                store.connectionMessage = message || '';
            }
            // Broadcast status updates so other components can react (e.g., shutdown button)
            try {
                window.dispatchEvent(new CustomEvent('trainer-connection-status', {
                    detail: { status, message: message || '' }
                }));
            } catch (error) {
                console.warn('Failed to dispatch trainer-connection-status event', error);
            }
        }

        // Server-Sent Events for real-time updates using SSE Manager
        function initializeEventStream() {
            // Load SSE Manager script first if not already loaded
            if (typeof window.SSEManager === 'undefined') {
                var script = document.createElement('script');
                script.src = '/static/js/sse-manager.js?t=' + Date.now();
                script.onload = function() {
                    setupSSE();
                };
                document.head.appendChild(script);
            } else {
                setupSSE();
            }
        }

        function setupSSE() {
            // Initialize SSE Manager
            window.sseManager = window.SSEManager.init({
                url: '/api/events',
                maxRetries: 10,
                baseRetryDelay: 1000,
                maxRetryDelay: 30000
            });

            // Note: training_progress events are handled by training_events_sse.html
            // which properly extracts and normalizes metrics before dispatching
            // training-progress custom events. Do NOT dispatch here to avoid
            // overwriting properly processed data with raw SSE payloads.

            window.sseManager.addEventListener('validation_complete', function(data) {
                showToast('Validation completed', 'success');
            });

            window.sseManager.addEventListener('error', function(data) {
                showToast(data.message || 'An error occurred', 'error');
            });

            window.sseManager.addEventListener('notification', function(data) {
                // Don't show toasts for callback notifications
                // These are already displayed in the events dock and progress card
                // Errors are handled separately via the 'error' event listener
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventStream();
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
