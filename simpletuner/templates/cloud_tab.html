<!-- templates/cloud_tab.html - Cloud Training Dashboard -->
<!-- CSS auto cache-busted by autoCacheBustCSS() on HTMX load -->
<link rel="stylesheet" href="/static/css/form-sections.css" id="css-form-sections-cloud">
<link rel="stylesheet" href="/static/css/cloud.css" id="css-cloud">
<link rel="stylesheet" href="/static/css/cloud-onboarding.css" id="css-cloud-onboarding">

{% set cloud_ctx = cloud_settings | default({}) %}

<div class="tab-fragment"
     id="cloud-tab-content"
     data-tab-name="cloud"
     x-data='cloudDashboardComponent({{ cloud_ctx | tojson | safe }})'
     x-init="init()"
     @beforeunload.window="destroy()">

    <!-- Loading state while checking setup status -->
    <div class="text-center py-5" x-show="setupState?.loading" x-cloak>
        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
        <p class="text-muted mt-2">Loading...</p>
    </div>

    <!-- First-Run Setup Wizard (shown when no admin exists) -->
    {% include 'partials/cloud_first_run_setup.html' %}

    <!-- Normal UI (hidden during first-run setup) -->
    <div x-show="setupState && !setupState.needsSetup && !setupState.loading" x-cloak>

    <!-- Provider Tabs -->
    {% include 'partials/cloud_provider_tabs.html' %}

    <!-- Hero CTA for first-time users (shown when provider not configured) -->
    {% include 'partials/cloud_hero_cta.html' %}

    <!-- Onboarding Flow (shown after provider configured, before onboarding complete) -->
    {% include 'partials/cloud_onboarding_flow.html' %}

    <!-- Connected Provider Dashboard (shown when active provider is configured AND onboarding complete) -->
    <div class="cloud-dashboard"
         x-show="isActiveProviderConfigured() && onboardingComplete"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-cloak>

        <!-- Action Bar (primary action prominence) -->
        {% include 'partials/cloud_action_bar.html' %}

        <!-- Queue Panel (collapsible) -->
        {% include 'partials/cloud_queue_panel.html' %}

        <!-- Hints (dismissible) -->
        <div class="cloud-hints-container">
            {% include 'partials/cloud_dataloader_hint.html' %}
            {% include 'partials/cloud_git_hint.html' %}
        </div>

        <!-- Main Content Area: Job List + Details -->
        <div class="cloud-main-content">
            <div class="row g-3">
                <!-- Job List (primary, larger) -->
                <div class="col-lg-7 col-xl-8">
                    <div class="cloud-job-list-panel">
                        {% include 'partials/cloud_job_list.html' %}
                    </div>
                </div>

                <!-- Job Details Panel (contextual) -->
                <div class="col-lg-5 col-xl-4">
                    <div class="cloud-job-details-panel">
                        <!-- Empty state when no job selected -->
                        <div class="cloud-card job-details-empty" x-show="!selectedJob">
                            <div class="cloud-card-body text-center py-4">
                                <div class="empty-icon mb-3">
                                    <i class="fas fa-hand-pointer"></i>
                                </div>
                                <p class="text-muted small mb-0">Select a job to view details</p>
                            </div>
                        </div>
                        <!-- Job details when selected -->
                        <div class="cloud-job-details-inline" x-show="selectedJob">
                            {% include 'partials/cloud_job_details.html' %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Bar (condensed, at bottom) -->
        {% include 'partials/cloud_stats_bar.html' %}
    </div>

    <!-- Settings Panel (slide-out) -->
    <div class="cloud-settings-panel"
         :class="{ 'open': showSettingsPanel }"
         x-show="showSettingsPanel"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="transform translate-x-full"
         x-transition:enter-end="transform translate-x-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="transform translate-x-0"
         x-transition:leave-end="transform translate-x-full"
         x-cloak>
        <div class="settings-panel-header">
            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Settings</h5>
            <button type="button" class="btn-close btn-close-white" @click="showSettingsPanel = false"></button>
        </div>
        <div class="settings-panel-body">
            <!-- API Key Section -->
            {% include 'partials/cloud_api_key_section.html' %}

            <!-- My Credentials (self-service) -->
            {% include 'partials/cloud_my_credentials.html' %}

            <!-- Publishing Status -->
            <div class="cloud-card mb-3">
                <div class="cloud-card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-upload me-2"></i>Publishing</h6>
                </div>
                <div class="cloud-card-body py-2">
                    <template x-if="publishingStatus.push_to_hub">
                        <div class="small">
                            <i class="fas fa-check-circle text-success me-1"></i>
                            HuggingFace Hub configured
                        </div>
                    </template>
                    <template x-if="!publishingStatus.push_to_hub">
                        <div class="small text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Configure in Publishing tab
                        </div>
                    </template>
                </div>
            </div>

            <!-- Webhook Config -->
            {% include 'partials/cloud_webhook_config.html' %}

            <!-- Local Outputs (shown when webhook is configured) -->
            <div class="cloud-card mb-3" x-show="publishingStatus.local_upload_available" x-cloak>
                <div class="cloud-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-download me-2"></i>Local Outputs</h6>
                        <span class="badge bg-success" style="font-size: 0.65rem;">Active</span>
                    </div>
                </div>
                <div class="cloud-card-body">
                    <p class="small text-muted mb-2" style="font-size: 0.75rem;">
                        Trained models will upload directly to this machine via S3-compatible endpoint.
                    </p>
                    <div class="mb-2">
                        <label class="small text-muted mb-1 d-block" style="font-size: 0.7rem;">Endpoint URL</label>
                        <code class="d-block small px-2 py-1 rounded" style="background: rgba(0,0,0,0.2); word-break: break-all; font-size: 0.7rem;"
                              x-text="webhookUrl.replace(/\/$/, '') + '/api/cloud/storage'"></code>
                    </div>
                    <div>
                        <label class="small text-muted mb-1 d-block" style="font-size: 0.7rem;">Output Directory</label>
                        <code class="d-block small px-2 py-1 rounded" style="background: rgba(0,0,0,0.2); font-size: 0.7rem;"
                              x-text="publishingStatus.local_upload_dir || '~/.simpletuner/cloud_outputs'"></code>
                    </div>
                </div>
            </div>

            <!-- Cost Limit Config -->
            {% include 'partials/cloud_cost_limit_config.html' %}

            <!-- Advanced Config (Admin only) -->
            {% include 'partials/cloud_advanced_config.html' %}

            <!-- Hardware Selection -->
            <div class="cloud-card mb-3">
                <div class="cloud-card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-server me-2"></i>Hardware</h6>
                </div>
                <div class="cloud-card-body py-2">
                    <template x-for="provider in providers.filter(p => p.id === activeProvider)" :key="provider.id">
                        <div class="small">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">GPU</span>
                                <span class="text-info" x-text="provider.hardware || 'N/A'"></span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Cost</span>
                                <span x-text="provider.cost_per_hour ? ('$' + provider.cost_per_hour.toFixed(2) + '/hr') : 'N/A'"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Onboarding & UI Reset -->
            <div class="cloud-card mb-3">
                <div class="cloud-card-header py-2">
                    <h6 class="mb-0"><i class="fas fa-redo me-2"></i>Reset</h6>
                </div>
                <div class="cloud-card-body py-2">
                    <p class="small text-muted mb-2" style="font-size: 0.75rem;">
                        Re-show dismissed hints and the onboarding flow.
                    </p>
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                @click="restoreHints(); if(window.showToast) window.showToast('Hints restored', 'success');"
                                title="Show dismissed hints again">
                            <i class="fas fa-lightbulb me-1"></i>Restore Hints
                        </button>
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                @click="resetOnboarding(); if(window.showToast) window.showToast('Onboarding reset', 'success');"
                                title="Restart the onboarding flow">
                            <i class="fas fa-graduation-cap me-1"></i>Restart Onboarding
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="cloud-settings-backdrop"
         x-show="showSettingsPanel"
         x-cloak
         @click="showSettingsPanel = false"></div>

    <!-- Mobile: Job Details Bottom Sheet -->
    <div class="cloud-job-details-sheet"
         :class="{ 'open': selectedJob, 'dragging': sheetDragging }"
         :style="sheetTransformStyle"
         x-cloak
         @touchstart="handleSheetTouchStart($event)"
         @touchmove="handleSheetTouchMove($event)"
         @touchend="handleSheetTouchEnd()">
        <div class="sheet-handle"></div>
        {% include 'partials/cloud_job_details.html' %}
    </div>
    <div class="cloud-sheet-backdrop"
         x-show="selectedJob"
         x-cloak
         @click="selectedJob = null"></div>

    </div><!-- End of normal UI wrapper (hidden during first-run setup) -->

    <!-- Upload Progress (floating, shown when active) -->
    {% include 'partials/cloud_upload_progress.html' %}

    <!-- Logs Modal -->
    <div class="cloud-logs-modal">
        {% include 'partials/cloud_job_logs_modal.html' %}
    </div>

    <!-- Pre-Submit Modal -->
    <div class="cloud-pre-submit-modal">
        {% include 'partials/cloud_pre_submit_modal.html' %}
    </div>

    <!-- S3 Configuration Modal -->
    {% include 'partials/cloud_s3_config_modal.html' %}
</div>
