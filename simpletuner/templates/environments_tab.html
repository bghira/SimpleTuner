<!-- templates/environments_tab.html - Configuration management tab -->
<link rel="stylesheet" href="/static/css/form-sections.css" id="css-form-sections-environments">
<script>document.getElementById('css-form-sections-environments').href = '/static/css/form-sections.css?t=' + Date.now();</script>
<script>
const localSanitizeConfigName = (window.sanitizeConfigName
    ? window.sanitizeConfigName
    : (name) => {
        if (typeof name !== 'string') {
            return name;
        }
        const trimmed = name.trim();
        return trimmed.toLowerCase().endsWith('.json') ? trimmed.slice(0, -5) : trimmed;
    });

const localSanitizeConfigEntry = (window.sanitizeConfigEntry
    ? window.sanitizeConfigEntry
    : (entry) => {
        if (!entry || typeof entry !== 'object') {
            return entry;
        }
        const clone = { ...entry };
        if (clone.name) {
            clone.name = localSanitizeConfigName(clone.name);
        }
        return clone;
    });

function environmentsTabComponent() {
    return {
         configs: [],
         templates: [],
         selectedConfigs: [],
         searchTerm: '',
         activePanel: 'configs',
         captionFilterSearch: '',
         filterEditor: {
             open: false,
             mode: 'create',
             name: '',
             originalName: '',
             label: '',
             description: '',
             entriesText: '',
             testInput: '',
             testResult: null,
             testing: false,
         },
         viewMode: localStorage.getItem('environmentsViewMode') || 'cards',
         configType: 'model',  // 'model', 'dataloader', 'webhook', or 'lycoris'
         createEnvironmentModal: false,
         dataloaderConfigs: [],
         expandedEnvironments: {},
        dataloaderModal: {
            open: false,
            environment: '',
            path: '',
            loading: false
        },
        lycorisEditor: {
            open: false,
            loading: false,
            selectedEnvironment: null
        },
        lycorisConfig: {
            algo: 'lora',
            multiplier: 1.0,
            linear_dim: 64,
            linear_alpha: 32,
            factor: null,
            block_size: null,
            apply_preset: {
                target_module: ['Attention'],
                module_algo_map: {}
            }
        },
        targetModules: {
            attention: true,
            feedforward: false
        },
        algorithmDefaults: {
            lora: { linear_dim: 64, linear_alpha: 32 },
            loha: { linear_dim: 32, linear_alpha: 16 },
            lokr: { linear_dim: 10000, linear_alpha: 1, factor: 12 },
            full: { linear_dim: 1024, linear_alpha: 512 },
            ia3: { linear_dim: null, linear_alpha: null },
            dylora: { linear_dim: 128, linear_alpha: 64, block_size: 1 },
            'diag-oft': { linear_dim: 64 },
            boft: { linear_dim: 64 }
        },

        hasDataloader(config) {
            if (!config) {
                return false;
            }
            const candidateKeys = [
                'dataloader_path',
                'data_backend_config',
                '--data_backend_config',
                'dataloader_config',
                '--dataloader_config',
            ];
            for (const key of candidateKeys) {
                const value = config[key];
                if (typeof value === 'string' && value.trim() !== '') {
                    return true;
                }
            }
            return Boolean(config.has_dataloader);
        },
        get captionFilters() {
            const trainer = Alpine.store('trainer');
            return (trainer && Array.isArray(trainer.captionFilters)) ? trainer.captionFilters : [];
        },
        filteredCaptionFilters() {
            if (!this.captionFilterSearch) {
                return this.captionFilters;
            }
            const needle = this.captionFilterSearch.toLowerCase();
            return this.captionFilters.filter((filter) => {
                const label = (filter.label || filter.name || '').toLowerCase();
                const description = (filter.description || '').toLowerCase();
                return label.includes(needle) || description.includes(needle);
            });
        },
        ensureCaptionFiltersLoaded(force = false) {
            const trainer = Alpine.store('trainer');
            if (trainer && typeof trainer.loadCaptionFilters === 'function') {
                return trainer.loadCaptionFilters(force);
            }
            return Promise.resolve([]);
        },
        switchPanel(panel) {
            if (this.activePanel === panel) {
                return;
            }
            this.activePanel = panel;
            if (panel === 'configs') {
                this.switchConfigType(this.configType);
            } else if (panel === 'filters') {
                this.ensureCaptionFiltersLoaded();
            }
        },
        resetFilterEditor() {
            this.filterEditor = {
                open: false,
                mode: 'create',
                name: '',
                originalName: '',
                label: '',
                description: '',
                entriesText: '',
                testInput: '',
                testResult: null,
                testing: false,
            };
        },
        openFilterEditor(filter = null) {
            if (filter) {
                this.filterEditor = {
                    open: true,
                    mode: 'edit',
                    name: filter.name || '',
                    originalName: filter.name || '',
                    label: filter.label || '',
                    description: filter.description || '',
                    entriesText: Array.isArray(filter.entries) ? filter.entries.join('\n') : '',
                    testInput: '',
                    testResult: null,
                    testing: false,
                };
            } else {
                this.resetFilterEditor();
                this.filterEditor.open = true;
            }
        },
        duplicateCaptionFilter(filter) {
            if (!filter) {
                return;
            }
            this.filterEditor = {
                open: true,
                mode: 'create',
                name: `${filter.name || 'filter'}-copy`,
                originalName: '',
                label: filter.label ? `${filter.label} (copy)` : '',
                description: filter.description || '',
                entriesText: Array.isArray(filter.entries) ? filter.entries.join('\n') : '',
                testInput: '',
                testResult: null,
                testing: false,
            };
        },
        closeFilterEditor() {
            this.resetFilterEditor();
        },
        async saveCaptionFilter() {
            const name = (this.filterEditor.name || '').trim();
            if (!name) {
                window.showToast('Filter name is required.', 'warning');
                return;
            }
            const entries = (this.filterEditor.entriesText || '')
                .split(/\r?\n/)
                .map((line) => line.trim())
                .filter((line) => line !== '');

            const payload = {
                name,
                label: (this.filterEditor.label || '').trim() || null,
                description: (this.filterEditor.description || '').trim() || null,
                entries,
            };

            try {
                const endpoint = this.filterEditor.mode === 'edit'
                    ? `/api/caption-filters/${encodeURIComponent(this.filterEditor.originalName)}`
                    : '/api/caption-filters';
                const method = this.filterEditor.mode === 'edit' ? 'PUT' : 'POST';
                const response = await fetch(endpoint, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Failed to save caption filter');
                }
                window.showToast(`Caption filter ${this.filterEditor.mode === 'edit' ? 'updated' : 'created'}`, 'success');
                this.closeFilterEditor();
                await this.ensureCaptionFiltersLoaded(true);
            } catch (error) {
                console.error('Failed to save caption filter:', error);
                window.showToast(error.message || 'Failed to save caption filter', 'error');
            }
        },
        async deleteCaptionFilter(name) {
            if (!name) {
                return;
            }
            if (!confirm(`Delete caption filter "${name}"?`)) {
                return;
            }
            try {
                const response = await fetch(`/api/caption-filters/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Failed to delete caption filter');
                }
                window.showToast('Caption filter deleted', 'success');
                await this.ensureCaptionFiltersLoaded(true);
            } catch (error) {
                console.error('Failed to delete caption filter:', error);
                window.showToast(error.message || 'Failed to delete caption filter', 'error');
            }
        },
        async testCaptionFilter() {
            const entries = (this.filterEditor.entriesText || '')
                .split(/\r?\n/)
                .map((line) => line.trim())
                .filter((line) => line !== '');
            const sample = (this.filterEditor.testInput || '').toString();
            if (!entries.length) {
                window.showToast('Add at least one filter entry before testing.', 'warning');
                return;
            }
            if (!sample) {
                window.showToast('Provide a sample caption to test.', 'warning');
                return;
            }
            this.filterEditor.testing = true;
            this.filterEditor.testResult = null;
            try {
                const response = await fetch('/api/caption-filters/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        entries,
                        sample
                    })
                });
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Failed to test caption filter');
                }
                const result = await response.json();
                this.filterEditor.testResult = result.output || '';
            } catch (error) {
                console.error('Failed to test caption filter:', error);
                window.showToast(error.message || 'Failed to test caption filter', 'error');
                this.filterEditor.testResult = null;
            } finally {
                this.filterEditor.testing = false;
            }
        },

        setViewMode(mode) {
            this.viewMode = mode;
            localStorage.setItem('environmentsViewMode', mode);
        },

        async switchConfigType(type) {
            this.configType = type;
            this.selectedConfigs = [];
            await this.loadConfigs();
            if (type === 'model') {
                await this.loadTemplates();
            } else {
                this.templates = [];  // Clear templates for non-model types
            }
        },

        normalizeConfigNameForType(name) {
            if (name === undefined || name === null) {
                return '';
            }
            // Always use the same normalization as the backend - strip .json extension
            return localSanitizeConfigName(String(name).trim());
        },

        normalizeConfigEntry(entry) {
            if (this.configType === 'model') {
                return localSanitizeConfigEntry(entry);
            }
            return entry;
        },

        async openCreateEnvironmentModal() {
            this.createEnvironmentModal = true;
            this.$nextTick(async () => {
                const formEl = this.$refs.createEnvironmentForm;
                const component = formEl && formEl.__x ? formEl.__x.$data : null;
                if (component && typeof component.prepareForDisplay === 'function') {
                    await component.prepareForDisplay();
                }
            });
        },

        closeCreateEnvironmentModal() {
            this.createEnvironmentModal = false;
            const formEl = this.$refs.createEnvironmentForm;
            const component = formEl && formEl.__x ? formEl.__x.$data : null;
            if (component && typeof component.resetForm === 'function') {
                component.resetForm();
            }
        },

        async handleEnvironmentCreated(detail) {
            const payload = detail?.payload || null;
            const environment = detail?.environment || null;
            this.closeCreateEnvironmentModal();
            await this.loadConfigs();
            const dataloaderStore = Alpine.store('dataloaderConfigs');
            if (dataloaderStore) {
                await dataloaderStore.load(true);
            }
            this.dataloaderConfigs = [];
            const trainerStore = Alpine.store('trainer');
            if (trainerStore) {
                if (typeof trainerStore.loadEnvironmentConfigs === 'function') {
                    await trainerStore.loadEnvironmentConfigs();
                }

                if (environment && Array.isArray(trainerStore.environments)) {
                    const exists = trainerStore.environments.some(
                        (entry) => entry && entry.name === environment.name
                    );
                    if (!exists) {
                        trainerStore.environments.push(environment);
                    }
                }

                let switched = false;
                if (environment && typeof trainerStore.switchEnvironment === 'function') {
                    try {
                        await trainerStore.switchEnvironment(environment.name);
                        switched = true;
                    } catch (error) {
                        console.error('Failed to switch to new environment automatically:', error);
                    }
                }

                if (!switched && typeof trainerStore.updateConfigSelectors === 'function') {
                    await trainerStore.updateConfigSelectors();
                }
            }
            await this.announceConfigChange(
                {
                    source: 'environment-create',
                    name: payload && payload.name
                        ? payload.name
                        : (environment && environment.name ? environment.name : null),
                    environment: environment,
                },
                { skipTrainerRefresh: true }
            );
        },

        openCreateDataloaderModal(environmentName) {
            this.dataloaderModal.environment = environmentName;
            this.dataloaderModal.path = `${environmentName}/multidatabackend.json`;
            this.dataloaderModal.open = true;
        },

        closeCreateDataloaderModal() {
            this.dataloaderModal.open = false;
            this.dataloaderModal.loading = false;
        },

        async createEnvironmentDataloader() {
            if (!this.dataloaderModal.environment) {
                window.showToast('Environment name missing', 'warning');
                return;
            }
            this.dataloaderModal.loading = true;
            const payload = {
                path: this.dataloaderModal.path || null
            };
            try {
                const response = await fetch(`/api/configs/${this.dataloaderModal.environment}/dataloader`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                this.closeCreateDataloaderModal();
                // Force reload shared dataloader store
                const dataloaderStore = Alpine.store('dataloaderConfigs');
                if (dataloaderStore) {
                    await dataloaderStore.load(true);
                }
                if (this.configType === 'dataloader') {
                    await this.loadConfigs();
                } else {
                    this.dataloaderConfigs = [];
                }
                window.showToast('Dataloader configuration created', 'success');
            } else {
                const error = await response.json().catch(() => ({}));
                window.showToast(error.detail || 'Failed to create dataloader', 'error');
                }
            } catch (error) {
                console.error('Failed to create dataloader:', error);
                window.showToast('Failed to create dataloader', 'error');
            } finally {
                this.dataloaderModal.loading = false;
            }
        },

        async loadConfigs() {
            try {
                const response = await fetch(`/api/configs/?config_type=${this.configType}`);
                const data = await response.json();
                const configs = Array.isArray(data.configs)
                    ? data.configs.map((entry) => this.normalizeConfigEntry(entry))
                    : [];
                this.configs = configs;

                // Load all dataloader configs if we're viewing model configs
                if (this.configType === 'model') {
                    await this.loadAllDataloaderConfigs();
                }
            } catch (error) {
                console.error('Failed to load configs:', error);
            }
        },

        async loadAllDataloaderConfigs() {
            const store = Alpine.store('dataloaderConfigs');
            if (store) {
                await store.load();
            }
        },

        async announceConfigChange(detail = {}, { skipTrainerRefresh = false } = {}) {
            const eventDetail = {
                source: `${this.configType}-manager`,
                configType: this.configType,
                ...detail,
            };

            if (this.configType === 'model' && !skipTrainerRefresh) {
                const trainerStore = Alpine.store('trainer');
                if (trainerStore) {
                    try {
                        if (typeof trainerStore.loadEnvironmentConfigs === 'function') {
                            await trainerStore.loadEnvironmentConfigs();
                        } else if (typeof trainerStore.updateConfigSelectors === 'function') {
                            await trainerStore.updateConfigSelectors();
                        }
                    } catch (error) {
                        console.error('Failed to refresh trainer configs after update:', error);
                    }
                }
            }

            window.dispatchEvent(new CustomEvent('configs-updated', { detail: eventDetail }));
        },

        get allDataloaderConfigs() {
            const store = Alpine.store('dataloaderConfigs');
            return store ? store.configs : [];
        },

        toggleEnvironmentExpansion(configName) {
            const key = this.normalizeConfigNameForType(configName);
            this.expandedEnvironments[key] = !this.expandedEnvironments[key];
        },

        isEnvironmentExpanded(configName) {
            const key = this.normalizeConfigNameForType(configName);
            return Boolean(this.expandedEnvironments[key]);
        },

        getDataloadersForEnvironment(config) {
            if (!config) return [];
            const dataBackendPath = config.data_backend_config || config['--data_backend_config'] || config.dataloader_path;
            if (!dataBackendPath) return [];

            // Find matching dataloaders by path
            return this.allDataloaderConfigs.filter(dl => {
                const dlPath = dl.path || '';
                return dlPath === dataBackendPath || dlPath.includes(dataBackendPath) || dataBackendPath.includes(dlPath);
            });
        },

        async copyDataloaderJSON(dataloaderPath) {
            try {
                const response = await fetch(`/api/configs/dataloader/content?path=${encodeURIComponent(dataloaderPath)}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch dataloader content');
                }
                const data = await response.json();
                const jsonString = JSON.stringify(data, null, 2);
                await navigator.clipboard.writeText(jsonString);
                window.showToast('JSON copied to clipboard', 'success');
            } catch (error) {
                console.error('Failed to copy dataloader JSON:', error);
                window.showToast('Failed to copy JSON: ' + error.message, 'error');
            }
        },

        async deleteDataloader(dataloaderPath, dataloaderName) {
            if (!confirm(`Delete dataloader configuration "${dataloaderName}"?\n\nWarning: Any environments referencing this configuration will need to be updated.`)) {
                return;
            }
            try {
                const response = await fetch(`/api/configs/dataloader?path=${encodeURIComponent(dataloaderPath)}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const error = await response.json().catch(() => ({}));
                    throw new Error(error.detail || 'Failed to delete dataloader');
                }
                window.showToast('Dataloader configuration deleted', 'success');

                // Reload shared store
                const store = Alpine.store('dataloaderConfigs');
                if (store) {
                    await store.load(true);
                }
                await this.loadConfigs();
            } catch (error) {
                console.error('Failed to delete dataloader:', error);
                window.showToast('Failed to delete dataloader: ' + error.message, 'error');
            }
        },

         async loadTemplates() {
             try {
                 const response = await fetch('/api/configs/templates');
                 const data = await response.json();
                 this.templates = data.templates || [];
             } catch (error) {
                 console.error('Failed to load templates:', error);
             }
         },

         filteredConfigs() {
             if (!this.configs || !Array.isArray(this.configs)) return [];
             if (!this.searchTerm) return this.configs;
             return this.configs.filter(config =>
                 config.name && config.name.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                 (config.description && config.description.toLowerCase().includes(this.searchTerm.toLowerCase()))
             );
         },

        toggleSelection(configName) {
            const sanitized = this.normalizeConfigNameForType(configName);
            const index = this.selectedConfigs.indexOf(sanitized);
            if (index > -1) {
                this.selectedConfigs.splice(index, 1);
            } else {
                this.selectedConfigs.push(sanitized);
            }
        },

        isSelected(configName) {
            const sanitized = this.normalizeConfigNameForType(configName);
            return this.selectedConfigs.includes(sanitized);
        },

        async deleteConfig(name) {
            const sanitized = this.normalizeConfigNameForType(name);
            if (!confirm('Are you sure you want to delete ' + sanitized + '?')) {
                return;
            }

            try {
                const response = await fetch('/api/configs/' + encodeURIComponent(sanitized) + '?config_type=' + this.configType, {
                    method: 'DELETE'
                });

                if (response.ok) {
                     await this.loadConfigs();
                     window.showToast('Deleted configuration: ' + name, 'success');
                     await this.announceConfigChange({
                         source: 'environment-delete',
                         name: sanitized,
                     });
                 } else {
                     const error = await response.json();
                     // Show more specific error for active config
                     let errorMsg = error.detail || 'Failed to delete configuration';
                     if (error.detail && error.detail.includes('active configuration')) {
                         errorMsg = 'Cannot delete the active configuration. Please activate a different configuration first.';
                     }
                     window.showToast(errorMsg, 'error');
                 }
             } catch (error) {
                 console.error('Failed to delete config:', error);
                 window.showToast('Failed to delete configuration', 'error');
             }
         },

         async deleteSelected() {
             if (this.selectedConfigs.length === 0) {
                 window.showToast('No configurations selected', 'warning');
                 return;
             }

             if (!confirm('Delete ' + this.selectedConfigs.length + ' selected configurations?')) {
                 return;
             }

             for (const name of this.selectedConfigs) {
                 await this.deleteConfig(name);
             }

             this.selectedConfigs = [];
         },

        async duplicateConfig(name) {
            const sourceName = this.normalizeConfigNameForType(name);
            let newName = prompt('Enter name for duplicate of ' + sourceName);
            if (!newName) return;
            const targetName = this.normalizeConfigNameForType(newName);
            if (!targetName) {
                window.showToast('Name is required', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/configs/' + encodeURIComponent(sourceName) + '/copy?config_type=' + this.configType, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target_name: targetName
                    })
                });

                if (response.ok) {
                    await this.loadConfigs();
                    window.showToast('Created duplicate: ' + targetName, 'success');
                    await this.announceConfigChange({
                        source: 'environment-duplicate',
                        name: targetName,
                    });
                }
            } catch (error) {
                console.error('Failed to duplicate config:', error);
                window.showToast('Failed to duplicate configuration', 'error');
            }
        },

        async renameConfig(name) {
            const sourceName = this.normalizeConfigNameForType(name);
            let newName = prompt('Rename ' + sourceName + ' to:');
            if (!newName) return;
            const targetName = this.normalizeConfigNameForType(newName);
            if (!targetName || targetName === sourceName) return;

            try {
                const response = await fetch('/api/configs/' + encodeURIComponent(sourceName) + '/rename?config_type=' + this.configType, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        new_name: targetName
                    })
                });

                if (response.ok) {
                    await this.loadConfigs();
                    window.showToast('Renamed to ' + targetName, 'success');
                    await this.announceConfigChange({
                        source: 'environment-rename',
                        name: targetName,
                        previousName: sourceName,
                    });
                }
            } catch (error) {
                console.error('Failed to rename config:', error);
                window.showToast('Failed to rename configuration', 'error');
            }
        },

        async exportConfig(name) {
            const resolvedName = this.normalizeConfigNameForType(name);
            try {
                const response = await fetch('/api/configs/' + encodeURIComponent(resolvedName) + '/export?config_type=' + this.configType + '&include_metadata=false');
                const data = await response.json();

                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = resolvedName + '_config.json';
                a.click();
                URL.revokeObjectURL(url);

                window.showToast('Exported configuration: ' + resolvedName, 'success');
            } catch (error) {
                console.error('Failed to export config:', error);
                window.showToast('Failed to export configuration', 'error');
            }
        },

        async createFromTemplate(templateName) {
            let configName = prompt('Enter name for new configuration from template: ' + templateName);
            if (!configName) return;
            const normalizedName = this.normalizeConfigNameForType(configName);
            if (!normalizedName) {
                window.showToast('Name is required', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/configs/from-template?config_type=' + this.configType, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        template_name: templateName,
                        config_name: normalizedName
                    })
                });

                if (response.ok) {
                    await this.loadConfigs();
                    window.showToast('Created configuration from template: ' + normalizedName, 'success');
                    await this.announceConfigChange({
                        source: 'environment-from-template',
                        name: normalizedName,
                    });
                }
            } catch (error) {
                console.error('Failed to create from template:', error);
                window.showToast('Failed to create from template', 'error');
            }
        },

        async importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const config = JSON.parse(text);

                const promptName = prompt('Enter name for imported configuration: ' + file.name.replace('.json', ''));
                if (!promptName) return;
                const name = this.normalizeConfigNameForType(promptName);
                if (!name) {
                    window.showToast('Name is required', 'warning');
                    return;
                }

                const response = await fetch('/api/configs/import?config_type=' + this.configType, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         name: name,
                         data: JSON.parse(text)
                     })
                 });

                if (response.ok) {
                    await this.loadConfigs();
                    window.showToast('Imported configuration: ' + name, 'success');
                    await this.announceConfigChange({
                        source: 'environment-import',
                        name: name,
                    });
                }
             } catch (error) {
                 console.error('Failed to import config:', error);
                 window.showToast('Failed to import configuration', 'error');
             }
         },

        openLycorisEditor(config) {
            if (!config) return;
            this.lycorisEditor.selectedEnvironment = this.normalizeConfigNameForType(config.name);
            this.lycorisEditor.open = true;
            this.loadLycorisConfig(this.lycorisEditor.selectedEnvironment);
        },

        closeLycorisEditor() {
            this.lycorisEditor.open = false;
            this.lycorisEditor.loading = false;
            this.lycorisEditor.selectedEnvironment = null;
        },

        async loadLycorisConfig(envId) {
            if (!envId) return;
            const sanitizedId = this.normalizeConfigNameForType(envId);
            this.lycorisEditor.selectedEnvironment = sanitizedId;
            this.lycorisEditor.loading = true;
            try {
                const response = await fetch(`/api/configs/environments/${encodeURIComponent(sanitizedId)}/lycoris`);
                if (response.ok) {
                    const data = await response.json();
                     if (data.config) {
                         this.lycorisConfig = {
                             algo: data.config.algo || 'lora',
                             multiplier: data.config.multiplier || 1.0,
                             linear_dim: data.config.linear_dim || 64,
                             linear_alpha: data.config.linear_alpha || 32,
                             factor: data.config.factor || null,
                             block_size: data.config.block_size || null,
                             apply_preset: data.config.apply_preset || {
                                 target_module: ['Attention'],
                                 module_algo_map: {}
                             }
                         };
                         const targetModules = data.config.apply_preset?.target_module || ['Attention'];
                         this.targetModules = {
                             attention: targetModules.includes('Attention'),
                             feedforward: targetModules.includes('FeedForward')
                         };
                     }
                 } else {
                     this.lycorisConfig = {
                         algo: 'lora',
                         multiplier: 1.0,
                         linear_dim: 64,
                         linear_alpha: 32,
                         factor: null,
                         block_size: null,
                         apply_preset: {
                             target_module: ['Attention'],
                             module_algo_map: {}
                         }
                     };
                     this.targetModules = {
                         attention: true,
                         feedforward: false
                     };
                 }
             } catch (error) {
                 console.error('Failed to load LyCORIS config:', error);
                 window.showToast('Failed to load LyCORIS configuration', 'error');
             } finally {
                 this.lycorisEditor.loading = false;
             }
         },

         updateAlgorithmDefaults() {
             const algo = this.lycorisConfig.algo;
             const defaults = this.algorithmDefaults[algo];
             if (defaults) {
                 if (defaults.linear_dim !== undefined) {
                     this.lycorisConfig.linear_dim = defaults.linear_dim;
                 }
                 if (defaults.linear_alpha !== undefined) {
                     this.lycorisConfig.linear_alpha = defaults.linear_alpha;
                 }
                 if (algo === 'lokr') {
                     this.lycorisConfig.factor = defaults.factor || 12;
                 } else {
                     this.lycorisConfig.factor = null;
                 }
                 if (algo === 'dylora') {
                     this.lycorisConfig.block_size = defaults.block_size || 1;
                 } else {
                     this.lycorisConfig.block_size = null;
                 }
             }
         },

         validateLycorisConfig() {
             if (!this.lycorisConfig.algo) {
                 window.showToast('Algorithm is required', 'warning');
                 return false;
             }
             if (this.lycorisConfig.multiplier === null || this.lycorisConfig.multiplier === undefined) {
                 window.showToast('Multiplier is required', 'warning');
                 return false;
             }
             const requiresDim = ['lora', 'loha', 'lokr', 'full', 'dylora', 'diag-oft', 'boft'].includes(this.lycorisConfig.algo);
             if (requiresDim && (this.lycorisConfig.linear_dim === null || this.lycorisConfig.linear_dim === undefined)) {
                 window.showToast('Linear dimension is required for this algorithm', 'warning');
                 return false;
             }
             return true;
         },

         buildTargetModulesConfig() {
             const targetModules = [];
             if (this.targetModules.attention) {
                 targetModules.push('Attention');
             }
             if (this.targetModules.feedforward) {
                 targetModules.push('FeedForward');
             }
             this.lycorisConfig.apply_preset.target_module = targetModules;
         },

        async saveLycorisConfig() {
            if (!this.validateLycorisConfig()) {
                return;
            }
            if (!this.lycorisEditor.selectedEnvironment) {
                window.showToast('No environment selected', 'warning');
                return;
            }
            this.buildTargetModulesConfig();
            this.lycorisEditor.loading = true;
            try {
                const payload = {
                    algo: this.lycorisConfig.algo,
                    multiplier: this.lycorisConfig.multiplier,
                    linear_dim: this.lycorisConfig.linear_dim,
                    linear_alpha: this.lycorisConfig.linear_alpha,
                    factor: this.lycorisConfig.factor,
                    block_size: this.lycorisConfig.block_size,
                    apply_preset: this.lycorisConfig.apply_preset
                };
                const environmentId = this.normalizeConfigNameForType(this.lycorisEditor.selectedEnvironment);
                this.lycorisEditor.selectedEnvironment = environmentId;
                const response = await fetch(`/api/configs/environments/${encodeURIComponent(environmentId)}/lycoris`, {
                     method: 'PUT',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify(payload)
                 });
                 if (response.ok) {
                     window.showToast('LyCORIS configuration saved', 'success');
                     this.closeLycorisEditor();
                     await this.loadConfigs();
                 } else {
                     const error = await response.json().catch(() => ({}));
                     window.showToast(error.detail || 'Failed to save LyCORIS configuration', 'error');
                 }
             } catch (error) {
                 console.error('Failed to save LyCORIS config:', error);
                 window.showToast('Failed to save LyCORIS configuration', 'error');
             } finally {
                 this.lycorisEditor.loading = false;
             }
         },

         getLycorisConfigJSON() {
             this.buildTargetModulesConfig();
             return JSON.stringify(this.lycorisConfig, null, 2);
         }
    }
}
</script>

<div class="tab-fragment"
     id="environments-tab-content"
     data-tab-name="environments"
     x-data="environmentsTabComponent()"
     x-init="loadConfigs(); loadTemplates()">

    <!-- Main Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-1"><i class="fas fa-folder-open me-2"></i>Configuration Environments</h5>
            <p class="text-muted mb-3">Manage training configurations and caption filters</p>

            <!-- Panel Switcher -->
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm"
                            :class="activePanel === 'configs' ? 'btn-primary' : 'btn-outline-secondary'"
                            @click="switchPanel('configs')">
                        <i class="fas fa-folder"></i> Configurations
                    </button>
                    <button type="button" class="btn btn-sm"
                            :class="activePanel === 'filters' ? 'btn-primary' : 'btn-outline-secondary'"
                            @click="switchPanel('filters')">
                        <i class="fas fa-filter"></i> Caption Filters
                    </button>
                </div>
                <div x-show="activePanel === 'filters'">
                    <button type="button" class="btn btn-sm btn-success" @click="openFilterEditor()">
                        <i class="fas fa-plus"></i> New Filter
                    </button>
                </div>
            </div>
        </div>

        <div class="card-body">
    <div x-show="activePanel === 'configs'">
    <!-- Config Type Tabs -->
    <div class="btn-group mb-3" role="group">
        <button type="button" class="btn"
                :class="configType === 'model' ? 'btn-primary' : 'btn-outline-secondary'"
                @click="switchConfigType('model')">
            <i class="fas fa-cog"></i> Model Configs
        </button>
        <button type="button" class="btn"
                :class="configType === 'dataloader' ? 'btn-primary' : 'btn-outline-secondary'"
                @click="switchConfigType('dataloader')">
            <i class="fas fa-database"></i> Dataloader Configs
        </button>
        <button type="button" class="btn"
                :class="configType === 'webhook' ? 'btn-primary' : 'btn-outline-secondary'"
                @click="switchConfigType('webhook')">
            <i class="fas fa-webhook"></i> Webhook Configs
        </button>
        <button type="button" class="btn"
                :class="configType === 'lycoris' ? 'btn-primary' : 'btn-outline-secondary'"
                @click="switchConfigType('lycoris')">
            <i class="fas fa-brain"></i> LyCORIS Configs
        </button>
    </div>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5><i class="fas fa-folder-open"></i> Configuration Environments</h5>

        <div class="d-flex align-items-center gap-3">
            <!-- Search -->
            <div class="input-group input-group-sm" style="width: 250px;">
                <input type="text"
                       class="form-control"
                       placeholder="Search configurations..."
                       x-model="searchTerm">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
            </div>

            <!-- View Mode -->
            <div class="btn-group btn-group-sm">
                <button type="button"
                        class="btn"
                        :class="viewMode === 'cards' ? 'btn-primary' : 'btn-outline-secondary'"
                        @click="setViewMode('cards')">
                    <i class="fas fa-th-large"></i>
                </button>
                <button type="button"
                        class="btn"
                        :class="viewMode === 'list' ? 'btn-primary' : 'btn-outline-secondary'"
                        @click="setViewMode('list')">
                    <i class="fas fa-list"></i>
                </button>
            </div>

            <!-- Actions -->
            <button type="button"
                    class="btn btn-sm btn-success"
                    x-show="configType === 'model'"
                    @click="openCreateEnvironmentModal()">
                <i class="fas fa-plus"></i> Create Environment
            </button>
            <button type="button"
                    class="btn btn-sm btn-primary"
                    onclick="document.getElementById('import-file').click()">
                <i class="fas fa-upload"></i> Import
            </button>
            <input type="file"
                   id="import-file"
                   style="display: none;"
                   accept=".json"
                   @change="importConfig($event)">

            <button type="button"
                    class="btn btn-sm btn-danger"
                    @click="deleteSelected()"
                    :disabled="selectedConfigs.length === 0">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
        </div>
    </div>

    <!-- Templates Section -->
    <div class="mb-4" x-show="configType === 'model' && templates.length > 0">
        <h6 class="text-muted mb-3">
            <i class="fas fa-magic"></i> Quick Start Templates
        </h6>
        <div class="row g-3">
            <template x-for="template in templates" :key="template.name">
                <div class="col-md-3">
                    <div class="card template-card">
                        <div class="card-body p-3">
                            <h6 class="card-title" x-text="template.name"></h6>
                            <p class="card-text small text-muted" x-text="template.description"></p>
                            <button class="btn btn-sm btn-outline-primary w-100"
                                    @click="createFromTemplate(template.name)">
                                <i class="fas fa-plus"></i> Use Template
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Configurations Grid/List -->
    <div class="configurations-container">
        <div class="alert alert-info d-flex align-items-start gap-2 small" x-show="configType === 'model'" x-cloak>
            <i class="fas fa-info-circle mt-1"></i>
            <span>
                The <strong>Default</strong> environment is optionally merged with the active environment when training begins.<br />
                You can enable or disable this from <strong>Basic Config → Project Settings → "Merge active environment defaults"</strong>.
            </span>
        </div>
        <!-- Cards View -->
        <div x-show="viewMode === 'cards'" class="row g-3">
            <template x-for="config in filteredConfigs()" :key="config.name">
                <div class="col-md-4">
                    <div class="card config-card"
                         :class="{'selected': isSelected(config.name)}">
                        <div class="card-body">
                            <!-- Selection checkbox -->
                            <div class="form-check position-absolute top-0 end-0 m-2">
                                <input type="checkbox"
                                       class="form-check-input"
                                       :checked="isSelected(config.name)"
                                       @change="toggleSelection(config.name)">
                            </div>

                            <h6 class="card-title">
                                <i class="fas fa-file-alt text-primary"></i>
                                <span x-text="config.name"></span>
                            </h6>

                            <p class="card-text small text-muted" x-text="config.description || 'No description'"></p>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <small class="text-muted">
                                    <template x-if="configType === 'model'">
                                        <span>
                                            <span x-text="config.model_type === 'lora' ? (config.lora_type === 'lycoris' ? 'LyCORIS' : 'LoRA') : (config.model_type ? config.model_type.toUpperCase() : 'UNKNOWN')"></span> •
                                            <span x-text="config.model_family || '-'"></span>
                                            <span x-show="config.model_flavour" class="text-muted small">
                                                (<span x-text="config.model_flavour"></span>)
                                            </span>
                                        </span>
                                    </template>
                                    <template x-if="configType === 'dataloader'">
                                        <span>
                                            <i class="fas fa-database"></i>
                                            <span x-text="config.dataset_count || 0"></span> datasets
                                        </span>
                                    </template>
                                    <template x-if="configType === 'webhook'">
                                        <span>
                                            <i class="fas fa-webhook"></i>
                                            <span x-text="config.webhook_type || 'Unknown'"></span> webhook
                                        </span>
                                    </template>
                                    <template x-if="configType === 'lycoris'">
                                        <span>
                                            <i class="fas fa-brain"></i>
                                            Algorithm: <span x-text="config.algo || 'Unknown'"></span>
                                        </span>
                                    </template>
                                </small>
                                <small class="text-muted" x-text="new Date(config.modified_at).toLocaleDateString()"></small>
                            </div>

                            <div class="btn-group btn-group-sm w-100">
                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        x-show="configType === 'model' && !hasDataloader(config)"
                                        @click="openCreateDataloaderModal(config.name)"
                                        title="Create Dataloader">
                                    <i class="fas fa-database"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        x-show="configType === 'model' && config.lora_type === 'lycoris'"
                                        @click="openLycorisEditor(config)"
                                        title="Edit LyCORIS Config">
                                    <i class="fas fa-brain"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        @click="renameConfig(config.name)"
                                        title="Rename">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        @click="duplicateConfig(config.name)"
                                        title="Duplicate">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        @click="exportConfig(config.name)"
                                        title="Export">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-danger"
                                        @click="deleteConfig(config.name)"
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>

                            <!-- Expandable Dataloader Configs Section -->
                            <div x-show="configType === 'model' && hasDataloader(config)" class="mt-3 dataloader-configs">
                                <button type="button"
                                        class="btn btn-sm btn-outline-info w-100 dataloader-configs__toggle"
                                        @click="toggleEnvironmentExpansion(config.name)">
                                    <i class="fas"
                                       :class="isEnvironmentExpanded(config.name) ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                    <span x-text="isEnvironmentExpanded(config.name) ? 'Hide' : 'Show'"></span>
                                    Dataloader Configs
                                    <span class="badge bg-secondary ms-1 dataloader-configs__badge" x-text="getDataloadersForEnvironment(config).length"></span>
                                </button>

                                <div x-show="isEnvironmentExpanded(config.name)" x-cloak class="mt-2">
                                    <template x-if="getDataloadersForEnvironment(config).length === 0">
                                        <div class="alert alert-sm alert-warning mb-0">
                                            No dataloader configurations found for this environment.
                                        </div>
                                    </template>
                                    <template x-if="getDataloadersForEnvironment(config).length > 0">
                                        <div class="list-group list-group-flush dataloader-configs__list">
                                            <template x-for="dataloader in getDataloadersForEnvironment(config)" :key="dataloader.path">
                                                <div class="list-group-item bg-dark-subtle dataloader-configs__item">
                                                    <div class="dataloader-configs__meta">
                                                        <div class="d-flex align-items-center gap-2 w-100 dataloader-configs__header">
                                                            <div class="d-flex align-items-center gap-2 flex-grow-1 dataloader-configs__title">
                                                                <i class="fas fa-database text-info dataloader-configs__icon"></i>
                                                                <strong class="dataloader-configs__name" x-text="dataloader.name"></strong>
                                                            </div>
                                                            <span class="badge bg-secondary dataloader-configs__dataset-count" x-text="`${dataloader.dataset_count || 0} datasets`"></span>
                                                        </div>
                                                        <small class="text-muted d-block mt-1 dataloader-configs__path"
                                                               x-text="(dataloader.path || '').split('/').join('/\u200b')"></small>
                                                    </div>
                                                    <div class="btn-group btn-group-sm dataloader-configs__actions">
                                                        <button type="button"
                                                                class="btn btn-outline-light dataloader-configs__action-btn"
                                                                @click="copyDataloaderJSON(dataloader.path)"
                                                                title="Copy JSON">
                                                            <i class="fas fa-copy"></i>
                                                        </button>
                                                        <button type="button"
                                                                class="btn btn-outline-danger dataloader-configs__action-btn"
                                                                @click="deleteDataloader(dataloader.path, dataloader.name)"
                                                                title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- List View -->
        <div x-show="viewMode === 'list'">
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th width="30">
                            <input type="checkbox"
                                   class="form-check-input"
                                   @change="selectedConfigs = $event.target.checked ? configs.map(c => c.name) : []">
                        </th>
                        <th>Name</th>
                        <th>Description</th>
                        <th x-show="configType === 'model'">Type</th>
                        <th x-text="configType === 'model' ? 'Model' : configType === 'dataloader' ? 'Datasets' : configType === 'webhook' ? 'Webhook Type' : 'Algorithm'"></th>
                        <th>Modified</th>
                        <th width="150">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="config in filteredConfigs()" :key="config.name">
                        <tr :class="{'table-active': isSelected(config.name)}">
                            <td>
                                <input type="checkbox"
                                       class="form-check-input"
                                       :checked="isSelected(config.name)"
                                       @change="toggleSelection(config.name)">
                            </td>
                            <td>
                                <i class="fas fa-file-alt text-primary me-2"></i>
                                <span x-text="config.name"></span>
                            </td>
                            <td x-text="config.description || '-'"></td>
                            <td x-show="configType === 'model'">
                                <span x-text="config.model_type === 'lora' ? (config.lora_type === 'lycoris' ? 'LyCORIS' : 'LoRA') : (config.model_type ? config.model_type.toUpperCase() : '-')"></span>
                            </td>
                            <td>
                                <template x-if="configType === 'model'">
                                    <span>
                                        <span x-text="config.model_family || '-'"></span>
                                        <span x-show="config.model_flavour" class="text-muted small">
                                            (<span x-text="config.model_flavour"></span>)
                                        </span>
                                    </span>
                                </template>
                                <template x-if="configType === 'dataloader'">
                                    <span>
                                        <span x-text="config.dataset_count || 0"></span> datasets
                                    </span>
                                </template>
                                <template x-if="configType === 'webhook'">
                                    <span>
                                        <span x-text="config.webhook_type || 'Unknown'"></span> webhook
                                    </span>
                                </template>
                                <template x-if="configType === 'lycoris'">
                                    <span>
                                        Algorithm: <span x-text="config.algo || 'Unknown'"></span>
                                    </span>
                                </template>
                            </td>
                            <td x-text="new Date(config.modified_at).toLocaleDateString()"></td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button"
                                            class="btn btn-outline-secondary"
                                            x-show="configType === 'model' && !hasDataloader(config)"
                                            @click="openCreateDataloaderModal(config.name)"
                                            title="Create Dataloader">
                                        <i class="fas fa-database"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-primary"
                                            x-show="configType === 'model' && config.lora_type === 'lycoris'"
                                            @click="openLycorisEditor(config)"
                                            title="Edit LyCORIS Config">
                                        <i class="fas fa-brain"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-secondary"
                                            @click="renameConfig(config.name)"
                                            title="Rename">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-secondary"
                                            @click="duplicateConfig(config.name)"
                                            title="Duplicate">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-secondary"
                                            @click="exportConfig(config.name)"
                                            title="Export">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-danger"
                                            @click="deleteConfig(config.name)"
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div x-show="filteredConfigs().length === 0" class="text-center py-5">
            <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No configurations found</h5>
            <p class="text-muted">Create your first configuration or import an existing one.</p>
        </div>
    </div>

    <div x-show="activePanel === 'filters'" class="caption-filters-panel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="input-group input-group-sm" style="max-width: 320px;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text"
                       class="form-control"
                       placeholder="Search filters..."
                       x-model="captionFilterSearch">
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" @click="ensureCaptionFiltersLoaded(true)">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>

        <template x-if="filteredCaptionFilters().length === 0">
            <div class="alert alert-info">
                No caption filters defined yet. Create one to reuse filtering rules across datasets.
            </div>
        </template>

        <div class="row g-3" x-show="filteredCaptionFilters().length > 0">
            <template x-for="filter in filteredCaptionFilters()" :key="filter.name">
                <div class="col-md-6">
                    <div class="card caption-filter-card h-100">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="card-title mb-1" x-text="filter.label || filter.name"></h6>
                                    <small class="text-muted" x-text="filter.name"></small>
                                </div>
                                <span class="badge bg-secondary" x-text="`${(filter.entries || []).length} rule(s)`"></span>
                            </div>
                            <p class="card-text flex-grow-1" x-text="filter.description || 'No description provided.'"></p>
                            <div class="card-text">
                                <strong>Preview:</strong>
                                <template x-if="(filter.entries || []).length === 0">
                                    <span class="text-muted">No rules</span>
                                </template>
                                <ul class="mb-2" x-show="(filter.entries || []).length > 0">
                                    <template x-for="entry in (filter.entries || []).slice(0, 3)" :key="entry">
                                        <li><code x-text="entry"></code></li>
                                    </template>
                                    <li x-show="(filter.entries || []).length > 3" class="text-muted">…</li>
                                </ul>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-auto">
                                <button type="button" class="btn btn-sm btn-outline-primary"
                                        @click="openFilterEditor(filter)">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary"
                                        @click="duplicateCaptionFilter(filter)">
                                    <i class="fas fa-clone"></i> Duplicate
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                        @click="deleteCaptionFilter(filter.name)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        </div><!-- /card-body -->
    </div><!-- /card -->

        <!-- Caption Filter Editor Modal -->
        <div x-cloak x-show="filterEditor.open" class="modal-backdrop" @keydown.escape.window="closeFilterEditor()" x-transition.opacity>
            <div class="modal-dialog modal-lg" @click.stop>
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-filter"></i>
                        <span x-text="filterEditor.mode === 'edit' ? 'Edit Caption Filter' : 'New Caption Filter'"></span>
                    </h5>
                    <button type="button" class="btn-close" aria-label="Close" @click="closeFilterEditor()"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" x-model="filterEditor.name"
                                   :readonly="filterEditor.mode === 'edit'">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Display Label <span class="text-muted">(optional)</span></label>
                            <input type="text" class="form-control" x-model="filterEditor.label">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" rows="2" x-model="filterEditor.description"
                                      placeholder="Explain when to use this filter list"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Filter Rules</label>
                            <textarea class="form-control font-monospace" rows="6"
                                      x-model="filterEditor.entriesText"
                                      placeholder="One rule per line. Supports plain strings, regex, or sed-style replacements."></textarea>
                            <div class="form-text">
                                Examples: <code>arafed</code>, <code>^remove this prefix</code>, <code>s/find/replace/</code>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Test Sample</label>
                            <div class="input-group">
                                <input type="text" class="form-control" x-model="filterEditor.testInput"
                                       placeholder="Paste a caption to preview the filter output">
                                <button class="btn btn-outline-primary" type="button"
                                        @click="testCaptionFilter()" :disabled="filterEditor.testing">
                                    <span x-show="!filterEditor.testing"><i class="fas fa-vial"></i> Test</span>
                                    <span x-show="filterEditor.testing"><i class="fas fa-spinner fa-spin"></i></span>
                                </button>
                            </div>
                            <div class="mt-2" x-show="filterEditor.testResult !== null">
                                <label class="form-label">Result</label>
                                <div class="card bg-dark-subtle">
                                    <div class="card-body">
                                        <code x-text="filterEditor.testResult"></code>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" @click="closeFilterEditor()">Cancel</button>
                    <button type="button" class="btn btn-primary" @click="saveCaptionFilter()">
                        <i class="fas fa-save"></i>
                        <span x-text="filterEditor.mode === 'edit' ? 'Save Changes' : 'Create Filter'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Environment Modal -->
    <div x-cloak x-show="createEnvironmentModal" class="modal-backdrop" @keydown.escape.window="closeCreateEnvironmentModal()" x-transition.opacity>
        <div class="modal-dialog" @click.stop>
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Create Environment</h5>
                <button type="button" class="btn-close" aria-label="Close" @click="closeCreateEnvironmentModal()"></button>
            </div>
            <div x-data="createEnvironmentFormComponent({ autoLoad: false })"
                 x-ref="createEnvironmentForm"
                 @environment-created="handleEnvironmentCreated($event.detail)"
                 @environment-form-cancel="closeCreateEnvironmentModal()">
                <form @submit.prevent="submit">
                    <div class="modal-body">
                        <template x-if="loadingInitialData">
                            <div class="alert alert-info d-flex align-items-center gap-2">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Loading model families and examples...</span>
                            </div>
                        </template>
                        <div :class="loadingInitialData ? 'opacity-50 pointer-events-none' : ''">
                            {% include "partials/create_environment_form_fields.html" %}
                        </div>
                        <template x-if="error">
                            <div class="alert alert-danger mt-3 mb-0 py-2 px-3" x-text="error"></div>
                        </template>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" @click="$dispatch('environment-form-cancel')"
                                :disabled="submitting">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" :disabled="submitting || loadingInitialData">
                            <span x-show="!submitting"><i class="fas fa-check"></i> Create</span>
                            <span x-show="submitting"><i class="fas fa-spinner fa-spin"></i> Creating...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Dataloader Modal -->
    <div x-cloak x-show="dataloaderModal.open" class="modal-backdrop" @keydown.escape.window="closeCreateDataloaderModal()" x-transition.opacity>
        <div class="modal-dialog" @click.stop>
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-database"></i> Create Dataloader</h5>
                <button type="button" class="btn-close" aria-label="Close" @click="closeCreateDataloaderModal()"></button>
            </div>
            <form @submit.prevent="createEnvironmentDataloader()">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Environment</label>
                        <input type="text" class="form-control" :value="dataloaderModal.environment" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dataloader Path</label>
                        <input type="text"
                               class="form-control"
                               :value="dataloaderModal.path"
                               @input="dataloaderModal.path = $event.target.value">
                        <small class="text-muted">Relative to configs directory. Leave empty to use the default location.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" @click="closeCreateDataloaderModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" :disabled="dataloaderModal.loading">
                        <span x-show="!dataloaderModal.loading"><i class="fas fa-check"></i> Create</span>
                        <span x-show="dataloaderModal.loading"><i class="fas fa-spinner fa-spin"></i> Creating...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- LyCORIS Editor Modal -->
    <div x-cloak x-show="lycorisEditor.open" class="modal-backdrop" @keydown.escape.window="closeLycorisEditor()" x-transition.opacity>
        <div class="modal-dialog modal-lg" @click.stop>
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-brain"></i>
                    LyCORIS Configuration Editor
                    <span x-show="lycorisEditor.selectedEnvironment" class="text-muted small ms-2">
                        (<span x-text="lycorisEditor.selectedEnvironment"></span>)
                    </span>
                </h5>
                <button type="button" class="btn-close" aria-label="Close" @click="closeLycorisEditor()"></button>
            </div>
            <form @submit.prevent="saveLycorisConfig()">
                <div class="modal-body">
                    <div x-show="lycorisEditor.loading" class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                        <p class="mt-2 text-muted">Loading configuration...</p>
                    </div>

                    <div x-show="!lycorisEditor.loading">
                        <!-- Algorithm Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Algorithm</label>
                            <select class="form-select" x-model="lycorisConfig.algo" @change="updateAlgorithmDefaults()">
                                <option value="lora">LoRA - Low-Rank Adaptation</option>
                                <option value="loha">LoHa - Low-Rank Hadamard Product</option>
                                <option value="lokr">LoKr - Low-Rank Kronecker Product</option>
                                <option value="full">Full - Full Fine-tuning</option>
                                <option value="ia3">IA3 - Infused Adapter by Inhibiting and Amplifying Inner Activations</option>
                                <option value="dylora">DyLoRA - Dynamic Low-Rank Adaptation</option>
                                <option value="diag-oft">Diag-OFT - Diagonal Orthogonal Finetuning</option>
                                <option value="boft">BOFT - Butterfly Orthogonal Finetuning</option>
                            </select>
                            <small class="form-text text-muted">Choose the LyCORIS algorithm variant</small>
                        </div>

                        <!-- Core Parameters -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">Core Parameters</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Multiplier</label>
                                        <input type="number" class="form-control" x-model.number="lycorisConfig.multiplier"
                                               step="0.1" min="0" required>
                                        <small class="form-text text-muted">Weight scaling factor</small>
                                    </div>
                                    <div class="col-md-4" x-show="lycorisConfig.algo !== 'ia3'">
                                        <label class="form-label">Linear Dimension</label>
                                        <input type="number" class="form-control" x-model.number="lycorisConfig.linear_dim"
                                               min="1" :required="lycorisConfig.algo !== 'ia3'">
                                        <small class="form-text text-muted">Rank/dimension size</small>
                                    </div>
                                    <div class="col-md-4" x-show="['lora', 'loha', 'lokr', 'dylora'].includes(lycorisConfig.algo)">
                                        <label class="form-label">Linear Alpha</label>
                                        <input type="number" class="form-control" x-model.number="lycorisConfig.linear_alpha"
                                               min="0">
                                        <small class="form-text text-muted">Scaling alpha value</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Algorithm-Specific Parameters -->
                        <div class="card mb-4" x-show="lycorisConfig.algo === 'lokr' || lycorisConfig.algo === 'dylora'">
                            <div class="card-header">
                                <h6 class="mb-0">Algorithm-Specific Parameters</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6" x-show="lycorisConfig.algo === 'lokr'">
                                        <label class="form-label">Factor</label>
                                        <input type="number" class="form-control" x-model.number="lycorisConfig.factor"
                                               min="1">
                                        <small class="form-text text-muted">Kronecker product factorization factor</small>
                                    </div>
                                    <div class="col-md-6" x-show="lycorisConfig.algo === 'dylora'">
                                        <label class="form-label">Block Size</label>
                                        <input type="number" class="form-control" x-model.number="lycorisConfig.block_size"
                                               min="1">
                                        <small class="form-text text-muted">Dynamic block size for DyLoRA</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-cog"></i> Advanced Settings
                                </h6>
                            </div>
                            <div class="card-body">
                                <label class="form-label fw-bold">Target Modules</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="targetAttention"
                                           x-model="targetModules.attention">
                                    <label class="form-check-label" for="targetAttention">
                                        Attention Modules
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="targetFeedForward"
                                           x-model="targetModules.feedforward">
                                    <label class="form-check-label" for="targetFeedForward">
                                        FeedForward Modules
                                    </label>
                                </div>
                                <div class="alert alert-warning mt-3 small" x-show="targetModules.feedforward">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Warning:</strong> Applying LyCORIS to FeedForward modules may cause NaN losses on SDXL models.
                                    Use with caution and monitor training closely.
                                </div>
                            </div>
                        </div>

                        <!-- JSON Preview -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-code"></i> Configuration Preview
                                </h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control font-monospace small" rows="8" readonly
                                          :value="getLycorisConfigJSON()"
                                          style="background-color: rgba(0,0,0,0.2);"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" @click="closeLycorisEditor()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" :disabled="lycorisEditor.loading">
                        <span x-show="!lycorisEditor.loading"><i class="fas fa-save"></i> Save Configuration</span>
                        <span x-show="lycorisEditor.loading"><i class="fas fa-spinner fa-spin"></i> Saving...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Environments tab inherits card styling from trainer-core.css */

.config-card {
    /* Background and border now inherited from unified theme */
    transition: all 0.3s ease;
}

.config-card.selected {
    border-color: #38bdf8;
    background: rgba(56, 189, 248, 0.1);
}

.template-card {
    background: rgba(102, 126, 234, 0.1);
    border: 1px solid rgba(102, 126, 234, 0.3);
}

.template-card:hover {
    background: rgba(102, 126, 234, 0.15);
}

.caption-filter-card {
    background: rgba(32, 36, 50, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
}

.caption-filter-card code {
    font-size: 0.85rem;
}

[x-cloak] { display: none !important; }

.modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.65);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1050;
    padding: 1.5rem;
    pointer-events: none;
}

.modal-dialog {
    background: #1c1f2e;
    border-radius: 0.75rem;
    width: 100%;
    max-width: 520px;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.08);
    pointer-events: auto;
}

.modal-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    margin: 0;
    font-size: 1.1rem;
    display: flex;
    gap: 0.6rem;
    align-items: center;
}

.modal-body {
    padding: 1.25rem;
}

.modal-footer {
    padding: 1rem 1.25rem;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}

.btn-close {
    background: none;
    border: 0;
    color: rgba(255, 255, 255, 0.6);
    font-size: 1.1rem;
}

.btn-close:hover {
    color: #fff;
}
</style>
</style>
