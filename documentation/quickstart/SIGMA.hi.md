## PixArt Sigma рдХреНрд╡рд┐рдХрд╕реНрдЯрд╛рд░реНрдЯ

рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рд╣рдо SimpleTuner рдЯреВрд▓рдХрд┐рдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ PixArt Sigma рдореЙрдбрд▓ рдХреЛ рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдХрд░реЗрдВрдЧреЗ рдФрд░ `full` рдореЙрдбрд▓ рдЯрд╛рдЗрдк рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЫреЛрдЯрд╛ рдореЙрдбрд▓ рд╣реЛрдиреЗ рдХреЗ рдХрд╛рд░рдг VRAM рдореЗрдВ рдлрд┐рдЯ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

### рдкреВрд░реНрд╡рд╛рдкреЗрдХреНрд╖рд╛рдПрдБ

рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ Python рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реИ; SimpleTuner 3.10 рд╕реЗ 3.12 рдХреЗ рд╕рд╛рде рдЕрдЪреНрдЫрд╛ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред

рдЖрдк рдЗрд╕реЗ рдЪрд▓рд╛рдХрд░ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ:

```bash
python --version
```

рдпрджрд┐ рдЖрдкрдХреЗ Ubuntu рдкрд░ python 3.12 рдЗрдВрд╕реНрдЯреЙрд▓ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдк рдпрд╣ рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```bash
apt -y install python3.13 python3.13-venv
```

#### Container image dependencies

Vast, RunPod, рдФрд░ TensorDock (рдЖрджрд┐) рдХреЗ рд▓рд┐рдП, CUDA 12.2тАС12.8 рдЗрдореЗрдЬ рдкрд░ CUDA extensions рдХрдореНрдкрд╛рдЗрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рдХрд╛рдо рдХрд░реЗрдЧрд╛:

```bash
apt -y install nvidia-cuda-toolkit
```

### рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди

pip рдХреЗ рдЬрд░рд┐рдП SimpleTuner рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ:

```bash
pip install 'simpletuner[cuda]'

# CUDA 13 / Blackwell users (NVIDIA B-series GPUs)
pip install 'simpletuner[cuda13]'
```

рдореИрдиреБрдЕрд▓ рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди рдпрд╛ рдбреЗрд╡рд▓рдкрдореЗрдВрдЯ рд╕реЗрдЯрдЕрдк рдХреЗ рд▓рд┐рдП, [installation documentation](../INSTALL.md) рджреЗрдЦреЗрдВред

#### AMD ROCm follow-up steps

AMD MI300X рдХреЛ рдЙрдкрдпреЛрдЧреА рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрди рдЪрд▓рд╛рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ:

```bash
apt install amd-smi-lib
pushd /opt/rocm/share/amd_smi
python3 -m pip install --upgrade pip
python3 -m pip install .
popd
```

### рд╡рд╛рддрд╛рд╡рд░рдг рд╕реЗрдЯрдЕрдк

SimpleTuner рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдПрдХ configuration рдлрд╝рд╛рдЗрд▓, dataset рдФрд░ model directories, рддрдерд╛ рдПрдХ dataloader configuration рдлрд╝рд╛рдЗрд▓ рд╕реЗрдЯ рдХрд░рдиреА рд╣реЛрдЧреАред

#### Configuration file

рдПрдХ рдкреНрд░рдпреЛрдЧрд╛рддреНрдордХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ `configure.py` рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ stepтАСbyтАСstep рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рдЬрд░рд┐рдП рдЗрд╕ рд╕реЗрдХреНрд╢рди рдХреЛ рдкреВрд░реА рддрд░рд╣ рд╕реНрдХрд┐рдк рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░ рд╕рдХрддреА рд╣реИред рдЗрд╕рдореЗрдВ рдХреБрдЫ рд╕реБрд░рдХреНрд╖рд╛ рдлреАрдЪрд░реНрд╕ рд╣реИрдВ рдЬреЛ рд╕рд╛рдорд╛рдиреНрдп pitfalls рд╕реЗ рдмрдЪрд╛рддреЗ рд╣реИрдВред

**рдиреЛрдЯ:** рдпрд╣ рдЖрдкрдХреЗ dataloader рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рдХрд░рддрд╛ред рдЖрдкрдХреЛ рд╡рд╣ рдмрд╛рдж рдореЗрдВ рдореИрдиреБрдЕрд▓реА рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

рдЗрд╕реЗ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП:

```bash
simpletuner configure
```
> тЪая╕П рдЬрд┐рди рджреЗрд╢реЛрдВ рдореЗрдВ Hugging Face Hub рдЖрд╕рд╛рдиреА рд╕реЗ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИ, рд╡рд╣рд╛рдБ `HF_ENDPOINT=https://hf-mirror.com` рдХреЛ рдЕрдкрдиреЗ `~/.bashrc` рдпрд╛ `~/.zshrc` рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ, рдпрд╣ рдЖрдкрдХреЗ рд╕рд┐рд╕реНрдЯрдо рдХреЗ `$SHELL` рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред

рдпрджрд┐ рдЖрдк рдореИрдиреБрдЕрд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛ рдкрд╕рдВрдж рдХрд░рддреЗ рд╣реИрдВ:

`config/config.json.example` рдХреЛ `config/config.json` рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВ:

```bash
cp config/config.json.example config/config.json
```

рд╡рд╣рд╛рдБ рдЖрдкрдХреЛ рдирд┐рдореНрди рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдмрджрд▓рдиреЗ рд╣реЛрдВрдЧреЗ:

<details>
<summary>рдЙрджрд╛рд╣рд░рдг рдХреЙрдиреНрдлрд╝рд┐рдЧ рджреЗрдЦреЗрдВ</summary>

```json
{
  "model_type": "full",
  "use_bitfit": false,
  "pretrained_model_name_or_path": "pixart-alpha/pixart-sigma-xl-2-1024-ms",
  "model_family": "pixart_sigma",
  "output_dir": "/home/user/output/models",
  "validation_resolution": "1024x1024,1280x768",
  "validation_guidance": 3.5
}
```
</details>

- `pretrained_model_name_or_path` - рдЗрд╕реЗ `PixArt-alpha/PixArt-Sigma-XL-2-1024-MS` рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВред
- `MODEL_TYPE` - рдЗрд╕реЗ `full` рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВред
- `USE_BITFIT` - рдЗрд╕реЗ `false` рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВред
- `MODEL_FAMILY` - рдЗрд╕реЗ `pixart_sigma` рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВред
- `OUTPUT_DIR` - рдЗрд╕реЗ рдЙрд╕ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВ рдЬрд╣рд╛рдБ рдЖрдк рдЕрдкрдиреЗ checkpoints рдФрд░ validation images рд░рдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред рдпрд╣рд╛рдБ full path рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕рд▓рд╛рд╣ рд╣реИред
- `VALIDATION_RESOLUTION` - PixArt Sigma 1024px рдпрд╛ 2048px рдореЙрдбрд▓ рдлреЙрд░реНрдореИрдЯ рдореЗрдВ рдЖрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ рд╕рд╛рд╡рдзрд╛рдиреА рд╕реЗ `1024x1024` рд░рдЦреЗрдВред
  - рд╕рд╛рде рд╣реА, PixArt рдХреЛ multiтАСaspect buckets рдкрд░ fineтАСtune рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рдЕрдиреНрдп resolutions рдХреЛ рдХреЙрдорд╛ рд╕реЗ рдЕрд▓рдЧ рдХрд░ рдХреЗ рджрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: `1024x1024,1280x768`
- `VALIDATION_GUIDANCE` - PixArt рдХреЛ рдмрд╣реБрдд рдХрдо рдорд╛рди рд▓рд╛рдн рджреЗрддрд╛ рд╣реИред рдЗрд╕реЗ `3.6` рд╕реЗ `4.4` рдХреЗ рдмреАрдЪ рд╕реЗрдЯ рдХрд░реЗрдВред

Mac MтАСseries рдорд╢реАрди рдкрд░ рдХреБрдЫ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реЗрдЯрд┐рдВрдЧреНрд╕:

- `mixed_precision` рдХреЛ `no` рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВред

> ЁЯТб **рдЯрд┐рдк:** рдмрдбрд╝реЗ рдбреЗрдЯрд╛рд╕реЗрдЯреНрд╕ рдореЗрдВ рдЬрд╣рд╛рдБ рдбрд┐рд╕реНрдХ рд╕реНрдкреЗрд╕ рдЪрд┐рдВрддрд╛ рдХрд╛ рд╡рд┐рд╖рдп рд╣реЛ, рдЖрдк `--vae_cache_disable` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ VAE рдПрдиреНрдХреЛрдбрд┐рдВрдЧ рдСрдирд▓рд╛рдЗрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдбрд┐рд╕реНрдХ рдкрд░ рдХреИрд╢ рдирд╣реАрдВ рдмрдиреЗрдЧрд╛ред

#### Dataset considerations

рдЕрдкрдиреЗ рдореЙрдбрд▓ рдХреЛ рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдмрдбрд╝рд╛ рдбреЗрдЯрд╛рд╕реЗрдЯ рд╣реЛрдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред рдбреЗрдЯрд╛рд╕реЗрдЯ рдЖрдХрд╛рд░ рдкрд░ рд╕реАрдорд╛рдПрдБ рд╣реИрдВ, рдФрд░ рдЖрдкрдХреЛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдЖрдкрдХрд╛ рдбреЗрдЯрд╛рд╕реЗрдЯ рдкрд░реНрдпрд╛рдкреНрдд рдмрдбрд╝рд╛ рд╣реЛред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдиреНрдпреВрдирддрдо рдбреЗрдЯрд╛рд╕реЗрдЯ рдЖрдХрд╛рд░ `TRAIN_BATCH_SIZE * GRADIENT_ACCUMULATION_STEPS` рд╣реИред рдпрджрд┐ рдбреЗрдЯрд╛рд╕реЗрдЯ рдмрд╣реБрдд рдЫреЛрдЯрд╛ рд╣реИ рддреЛ рдЯреНрд░реЗрдирд░ рдЙрд╕реЗ discover рдирд╣реАрдВ рдХрд░ рдкрд╛рдПрдЧрд╛ред

рдЖрдкрдХреЗ рдбреЗрдЯрд╛рд╕реЗрдЯ рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдЖрдкрдХреЛ рдбреЗрдЯрд╛рд╕реЗрдЯ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдФрд░ dataloader configuration рдлрд╝рд╛рдЗрд▓ рдЕрд▓рдЧ рддрд░реАрдХреЗ рд╕реЗ рд╕реЗрдЯ рдХрд░рдиреА рд╣реЛрдЧреАред рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рд╣рдо [pseudo-camera-10k](https://huggingface.co/datasets/bghira/pseudo-camera-10k) рдбреЗрдЯрд╛рд╕реЗрдЯ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗред

рдЕрдкрдиреЗ `/home/user/simpletuner/config` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ, рдПрдХ multidatabackend.json рдмрдирд╛рдПрдБ:

<details>
<summary>рдЙрджрд╛рд╣рд░рдг рдХреЙрдиреНрдлрд╝рд┐рдЧ рджреЗрдЦреЗрдВ</summary>

```json
[
  {
    "id": "pseudo-camera-10k-pixart",
    "type": "local",
    "crop": true,
    "crop_aspect": "square",
    "crop_style": "random",
    "resolution": 1.0,
    "minimum_image_size": 0.25,
    "maximum_image_size": 1.0,
    "target_downsample_size": 1.0,
    "resolution_type": "area",
    "cache_dir_vae": "cache/vae/pixart/pseudo-camera-10k",
    "instance_data_dir": "/home/user/simpletuner/datasets/pseudo-camera-10k",
    "disabled": false,
    "skip_file_discovery": "",
    "caption_strategy": "filename",
    "metadata_backend": "discovery"
  },
  {
    "id": "text-embeds",
    "type": "local",
    "dataset_type": "text_embeds",
    "default": true,
    "cache_dir": "cache/text/pixart/pseudo-camera-10k",
    "disabled": false,
    "write_batch_size": 128
  }
]
```
</details>

> `caption_strategy` рд╡рд┐рдХрд▓реНрдк рдФрд░ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП [DATALOADER.md](../DATALOADER.md#caption_strategy) рджреЗрдЦреЗрдВред

рдлрд┐рд░, рдПрдХ `datasets` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдмрдирд╛рдПрдБ:

```bash
mkdir -p datasets
pushd datasets
    huggingface-cli download --repo-type=dataset bghira/pseudo-camera-10k --local-dir=pseudo-camera-10k
popd
```

рдпрд╣ рд▓рдЧрднрдЧ 10k рдлреЛрдЯреЛрдЧреНрд░рд╛рдл рд╕реИрдВрдкрд▓реНрд╕ рдХреЛ рдЖрдкрдХреА `datasets/pseudo-camera-10k` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдЧрд╛, рдЬреЛ рдЕрдкрдиреЗтАСрдЖрдк рдмрдирд╛ рджреА рдЬрд╛рдПрдЧреАред

#### WandB рдФрд░ Huggingface Hub рдореЗрдВ рд▓реЙрдЧтАСрдЗрди

рдкреНрд░рд╢рд┐рдХреНрд╖рдг рд╢реБрд░реВ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ WandB рдФрд░ HF Hub рдореЗрдВ рд▓реЙрдЧтАСрдЗрди рдХрд░рдирд╛ рдмреЗрд╣рддрд░ рд╣реИ, рдЦрд╛рд╕рдХрд░ рдЕрдЧрд░ рдЖрдк `push_to_hub: true` рдФрд░ `--report_to=wandb` рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВред

рдпрджрд┐ рдЖрдк Git LFS рд░рд┐рдкреЙрдЬрд╝рд┐рдЯрд░реА рдореЗрдВ рдореИрдиреНрдпреБрдЕрд▓реА рдЖрдЗрдЯрдореНрд╕ push рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВ, рддреЛ `git config --global credential.helper store` рднреА рдЪрд▓рд╛рдПрдБред

рдирд┐рдореНрди рдХрдорд╛рдВрдб рдЪрд▓рд╛рдПрдБ:

```bash
wandb login
```

рдФрд░

```bash
huggingface-cli login
```

рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдХреЗ рджреЛрдиреЛрдВ рд╕реЗрд╡рд╛рдУрдВ рдореЗрдВ рд▓реЙрдЧтАСрдЗрди рдХрд░реЗрдВред

### рдкреНрд░рд╢рд┐рдХреНрд╖рдг рд░рди рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛

SimpleTuner рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕реЗ, рдмрд╕ рдпрд╣ рдЪрд▓рд╛рдПрдБ:

```bash
bash train.sh
```

рдЗрд╕рд╕реЗ text embeds рдФрд░ VAE рдЖрдЙрдЯрдкреБрдЯ рдХреИрд╢рд┐рдВрдЧ рдбрд┐рд╕реНрдХ рдкрд░ рд╢реБрд░реВ рд╣реЛрдЧреАред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [dataloader](../DATALOADER.md) рдФрд░ [tutorial](../TUTORIAL.md) рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рджреЗрдЦреЗрдВред

### CLIP score рдЯреНрд░реИрдХрд┐рдВрдЧ

рдпрджрд┐ рдЖрдк рдореЙрдбрд▓ рдкреНрд░рджрд░реНрд╢рди рдХреЛ рд╕реНрдХреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП evaluations рд╕рдХреНрд╖рдо рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ CLIP scores рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдФрд░ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП [рдЗрд╕ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝](../evaluation/CLIP_SCORES.md) рдХреЛ рджреЗрдЦреЗрдВред
