## Lumina2 рдХреНрд╡рд┐рдХрд╕реНрдЯрд╛рд░реНрдЯ

рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рд╣рдо Lumina2 LoRA рдпрд╛ full model fineтАСtune рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХрд░реЗрдВрдЧреЗред

### рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ

Lumina2 рдПрдХ 2B рдкреИрд░рд╛рдореАрдЯрд░ рдореЙрдбрд▓ рд╣реИ, рдЬреЛ Flux рдпрд╛ SD3 рдЬреИрд╕реЗ рдмрдбрд╝реЗ рдореЙрдбрд▓реЛрдВ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХрд╛рдлреА рдЕрдзрд┐рдХ рд╕реБрд▓рдн рд╣реИред рдореЙрдбрд▓ рдХрд╛ рдЫреЛрдЯрд╛ рдЖрдХрд╛рд░ рдорддрд▓рдм:

rankтАС16 LoRA рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдкрд░ рдпрд╣ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ:
- рд▓рдЧрднрдЧ 12тАС14GB VRAM (LoRA рдкреНрд░рд╢рд┐рдХреНрд╖рдг)
- рд▓рдЧрднрдЧ 16тАС20GB VRAM (full fineтАСtuning)
- startup рдХреЗ рджреМрд░рд╛рди рд▓рдЧрднрдЧ 20тАС30GB рд╕рд┐рд╕реНрдЯрдо RAM

рдЖрдкрдХреЛ рдЪрд╛рд╣рд┐рдП:
- **рдиреНрдпреВрдирддрдо**: рдПрдХ RTX 3060 12GB рдпрд╛ RTX 4060 Ti 16GB
- **рдЕрдиреБрд╢рдВрд╕рд┐рдд**: рддреЗрдЬрд╝ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рд▓рд┐рдП RTX 3090, RTX 4090, рдпрд╛ A100
- **рд╕рд┐рд╕реНрдЯрдо RAM**: рдХрдо рд╕реЗ рдХрдо 32GB рдЕрдиреБрд╢рдВрд╕рд┐рдд

### рдкреВрд░реНрд╡рд╛рдкреЗрдХреНрд╖рд╛рдПрдБ

рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ Python рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реИ; SimpleTuner 3.10 рд╕реЗ 3.12 рдХреЗ рд╕рд╛рде рдЕрдЪреНрдЫрд╛ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред

рдЖрдк рдЗрд╕реЗ рдЪрд▓рд╛рдХрд░ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ:

```bash
python --version
```

рдпрджрд┐ рдЖрдкрдХреЗ Ubuntu рдкрд░ Python 3.12 рдЗрдВрд╕реНрдЯреЙрд▓ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЖрдк рдпрд╣ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

```bash
apt -y install python3.13 python3.13-venv
```

#### Container image dependencies

Vast, RunPod, рдФрд░ TensorDock (рдЖрджрд┐) рдХреЗ рд▓рд┐рдП, CUDA 12.2тАС12.8 рдЗрдореЗрдЬ рдкрд░ рдпрд╣ рдХрд╛рдо рдХрд░реЗрдЧрд╛:

```bash
apt -y install nvidia-cuda-toolkit
```

### рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди

pip рдХреЗ рдЬрд░рд┐рдП SimpleTuner рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдВ:

```bash
pip install 'simpletuner[cuda]'

# CUDA 13 / Blackwell users (NVIDIA B-series GPUs)
pip install 'simpletuner[cuda13]'
```

рдореИрдиреБрдЕрд▓ рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди рдпрд╛ рдбреЗрд╡рд▓рдкрдореЗрдВрдЯ рд╕реЗрдЯрдЕрдк рдХреЗ рд▓рд┐рдП, [installation documentation](../INSTALL.md) рджреЗрдЦреЗрдВред

### рд╡рд╛рддрд╛рд╡рд░рдг рд╕реЗрдЯрдЕрдк

SimpleTuner рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдПрдХ configuration рдлрд╝рд╛рдЗрд▓, dataset рдФрд░ model directories, рддрдерд╛ рдПрдХ dataloader configuration рдлрд╝рд╛рдЗрд▓ рд╕реЗрдЯ рдХрд░рдиреА рд╣реЛрдЧреАред

#### Configuration file

`config/config.json.example` рдХреЛ `config/config.json` рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВ:

```bash
cp config/config.json.example config/config.json
```

рд╡рд╣рд╛рдБ рдЖрдкрдХреЛ рдирд┐рдореНрди рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдмрджрд▓рдиреЗ рд╣реЛрдВрдЧреЗ:

- `model_type` - LoRA рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рд▓рд┐рдП `lora` рдпрд╛ full fineтАСtuning рдХреЗ рд▓рд┐рдП `full` рд╕реЗрдЯ рдХрд░реЗрдВред
- `model_family` - рдЗрд╕реЗ `lumina2` рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВред
- `output_dir` - рдЗрд╕реЗ рдЙрд╕ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВ рдЬрд╣рд╛рдБ рдЖрдк рдЕрдкрдиреЗ checkpoints рдФрд░ validation images рд░рдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред рдпрд╣рд╛рдБ full path рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕рд▓рд╛рд╣ рд╣реИред
- `train_batch_size` - рдЖрдкрдХреЗ GPU memory рдФрд░ dataset size рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реБрдП 1тАС4 рд╣реЛ рд╕рдХрддрд╛ рд╣реИред
- `validation_resolution` - Lumina2 рдХрдИ resolutions рд╕рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИред рд╕рд╛рдорд╛рдиреНрдп рд╡рд┐рдХрд▓реНрдк: `1024x1024`, `512x512`, `768x768`ред
- `validation_guidance` - Lumina2 classifierтАСfree guidance рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред 3.5тАС7.0 рдХреЗ рдорд╛рди рдЕрдЪреНрдЫреЗ рдЪрд▓рддреЗ рд╣реИрдВред
- `validation_num_inference_steps` - 20тАС30 рд╕реНрдЯреЗрдкреНрд╕ Lumina2 рдХреЗ рд▓рд┐рдП рдЕрдЪреНрдЫреЗ рд╣реИрдВред
- `gradient_accumulation_steps` - рдмрдбрд╝реЗ batch рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред 2тАС4 рдЕрдЪреНрдЫрд╛ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред
- `optimizer` - `adamw_bf16` рдЕрдиреБрд╢рдВрд╕рд┐рдд рд╣реИред `lion` рдФрд░ `optimi-stableadamw` рднреА рдЕрдЪреНрдЫреЗ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВред
- `mixed_precision` - рд╕рд░реНрд╡реЛрддреНрддрдо рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ `bf16` рд░рдЦреЗрдВред
- `gradient_checkpointing` - VRAM рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП `true` рд╕реЗрдЯ рдХрд░реЗрдВред
- `learning_rate` - LoRA рдХреЗ рд▓рд┐рдП: `1e-4` рд╕реЗ `5e-5`ред Full fineтАСtuning рдХреЗ рд▓рд┐рдП: `1e-5` рд╕реЗ `1e-6`ред

#### Lumina2 рдЙрджрд╛рд╣рд░рдг рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди

рдпрд╣ `config.json` рдореЗрдВ рдЬрд╛рддрд╛ рд╣реИ:

<details>
<summary>рдЙрджрд╛рд╣рд░рдг рдХреЙрдиреНрдлрд╝рд┐рдЧ рджреЗрдЦреЗрдВ</summary>

```json
{
    "base_model_precision": "int8-torchao",
    "checkpoint_step_interval": 50,
    "data_backend_config": "config/lumina2/multidatabackend.json",
    "disable_bucket_pruning": true,
    "eval_steps_interval": 50,
    "evaluation_type": "clip",
    "flow_schedule_auto_shift": true,
    "gradient_checkpointing": true,
    "hub_model_id": "lumina2-lora",
    "learning_rate": 1e-4,
    "lora_alpha": 16,
    "lora_rank": 16,
    "lora_type": "standard",
    "lr_scheduler": "constant",
    "max_train_steps": 400000,
    "model_family": "lumina2",
    "model_type": "lora",
    "num_train_epochs": 0,
    "optimizer": "adamw_bf16",
    "output_dir": "output/lumina2",
    "push_checkpoints_to_hub": true,
    "push_to_hub": true,
    "quantize_via": "cpu",
    "report_to": "wandb",
    "seed": 42,
    "tracker_project_name": "lumina2-training",
    "tracker_run_name": "lumina2-lora",
    "train_batch_size": 4,
    "use_ema": true,
    "vae_batch_size": 1,
    "validation_disable_unconditional": true,
    "validation_guidance": 4.0,
    "validation_guidance_rescale": 0.0,
    "validation_negative_prompt": "ugly, cropped, blurry, low-quality, mediocre average",
    "validation_num_inference_steps": 40,
    "validation_prompt": "A photo-realistic image of a cat",
    "validation_prompt_library": false,
    "validation_resolution": "1024x1024",
    "validation_seed": 42,
    "validation_step_interval": 50
}
```
</details>

Lycoris рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рд▓рд┐рдП, `lora_type` рдХреЛ `lycoris` рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░реЗрдВред

### рдЙрдиреНрдирдд рдкреНрд░рдпреЛрдЧрд╛рддреНрдордХ рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБ

<details>
<summary>рдЙрдиреНрдирдд рдкреНрд░рдпреЛрдЧрд╛рддреНрдордХ рд╡рд┐рд╡рд░рдг рджрд┐рдЦрд╛рдПрдБ</summary>


SimpleTuner рдореЗрдВ рдкреНрд░рдпреЛрдЧрд╛рддреНрдордХ рдлреАрдЪрд░реНрд╕ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ рдЬреЛ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреА рд╕реНрдерд┐рд░рддрд╛ рдФрд░ рдкреНрд░рджрд░реНрд╢рди рдХреЛ рдХрд╛рдлреА рдмреЗрд╣рддрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

*   **[Scheduled Sampling (Rollout)](../experimental/SCHEDULED_SAMPLING.md):** exposure bias рдХрдо рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЖрдЙрдЯрдкреБрдЯ рдЧреБрдгрд╡рддреНрддрд╛ рдмрдврд╝рд╛рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рджреМрд░рд╛рди рдореЙрдбрд▓ рдХреЛ рдЕрдкрдиреЗ рдЗрдирдкреБрдЯреНрд╕ рдЦреБрдж рдЬрдирд░реЗрдЯ рдХрд░рдиреЗ рджреЗрддрд╛ рд╣реИред

> тЪая╕П рдпреЗ рдлреАрдЪрд░реНрд╕ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХреЗ рдХрдВрдкреНрдпреВрдЯреЗрд╢рдирд▓ рдУрд╡рд░рд╣реЗрдб рдХреЛ рдмрдврд╝рд╛рддреЗ рд╣реИрдВред

#### рд╡реИрд▓рд┐рдбреЗрд╢рди рдкреНрд░реЙрдореНрдкреНрдЯреНрд╕

`config/config.json` рдХреЗ рдЕрдВрджрд░ "primary validation prompt" рд╣реЛрддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдПрдХ prompt library рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдПрдБ:

```json
{
  "portrait": "a high-quality portrait photograph with natural lighting",
  "landscape": "a breathtaking landscape photograph with dramatic lighting",
  "artistic": "an artistic rendering with vibrant colors and creative composition",
  "detailed": "a highly detailed image with sharp focus and rich textures",
  "stylized": "a stylized illustration with unique artistic flair"
}
```

рдЕрдкрдиреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ:
```json
{
  "--user_prompt_library": "config/user_prompt_library.json"
}
```

#### рдбреЗрдЯрд╛рд╕реЗрдЯ рд╡рд┐рдЪрд╛рд░

Lumina2 рдЙрдЪреНрдЪ рдЧреБрдгрд╡рддреНрддрд╛ рд╡рд╛рд▓реЗ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдбреЗрдЯрд╛ рд╕реЗ рд▓рд╛рдн рд▓реЗрддрд╛ рд╣реИред рдПрдХ `--data_backend_config` (`config/multidatabackend.json`) рдмрдирд╛рдПрдБ:

> ЁЯТб **рдЯрд┐рдк:** рдмрдбрд╝реЗ рдбреЗрдЯрд╛рд╕реЗрдЯреНрд╕ рдореЗрдВ рдЬрд╣рд╛рдБ рдбрд┐рд╕реНрдХ рд╕реНрдкреЗрд╕ рдЪрд┐рдВрддрд╛ рдХрд╛ рд╡рд┐рд╖рдп рд╣реЛ, рдЖрдк `--vae_cache_disable` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ VAE рдПрдиреНрдХреЛрдбрд┐рдВрдЧ рдСрдирд▓рд╛рдЗрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдкрд░рд┐рдгрд╛рдо рдбрд┐рд╕реНрдХ рдкрд░ рдХреИрд╢ рди рд╣реЛрдВред

```json
[
  {
    "id": "lumina2-training",
    "type": "local",
    "crop": true,
    "crop_aspect": "square",
    "crop_style": "center",
    "resolution": 1024,
    "minimum_image_size": 512,
    "maximum_image_size": 2048,
    "target_downsample_size": 1024,
    "resolution_type": "pixel_area",
    "cache_dir_vae": "cache/vae/lumina2/training",
    "instance_data_dir": "/datasets/training",
    "caption_strategy": "textfile",
    "metadata_backend": "discovery"
  },
  {
    "id": "text-embeds",
    "type": "local",
    "dataset_type": "text_embeds",
    "default": true,
    "cache_dir": "cache/text/lumina2",
    "disabled": false,
    "write_batch_size": 128
  }
]
```

> `caption_strategy` рд╡рд┐рдХрд▓реНрдк рдФрд░ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП [DATALOADER.md](../DATALOADER.md#caption_strategy) рджреЗрдЦреЗрдВред

рдЕрдкрдиреА dataset рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдмрдирд╛рдПрдБред рдЗрд╕ рдкрд╛рде рдХреЛ рдЕрдкрдиреЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕реНрдерд╛рди рд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВред

```bash
mkdir -p /datasets/training
</details>

# Place your images and caption files in /datasets/training/
```

Caption рдлрд╛рдЗрд▓реЛрдВ рдХрд╛ рдирд╛рдо рдЗрдореЗрдЬ рдХреЗ рд╕рдорд╛рди рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ `.txt` рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

#### WandB рдореЗрдВ рд▓реЙрдЧтАСрдЗрди

SimpleTuner рдореЗрдВ **рд╡реИрдХрд▓реНрдкрд┐рдХ** tracker рд╕рдкреЛрд░реНрдЯ рд╣реИ, рдореБрдЦреНрдпрддрдГ Weights & Biases рдкрд░ рдХреЗрдВрджреНрд░рд┐рддред рдЗрд╕реЗ `report_to=none` рд╕реЗ рдмрдВрдж рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

wandb рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

```bash
wandb login
```

#### Huggingface Hub рдореЗрдВ рд▓реЙрдЧтАСрдЗрди

Huggingface Hub рдкрд░ checkpoints push рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐:
```bash
huggingface-cli login
```

### рдкреНрд░рд╢рд┐рдХреНрд╖рдг рд░рди рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛

SimpleTuner рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕реЗ, рдкреНрд░рд╢рд┐рдХреНрд╖рдг рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрдИ рд╡рд┐рдХрд▓реНрдк рд╣реИрдВ:

**рд╡рд┐рдХрд▓реНрдк 1 (рдЕрдиреБрд╢рдВрд╕рд┐рдд - pip install):**
```bash
pip install 'simpletuner[cuda]'

# CUDA 13 / Blackwell users (NVIDIA B-series GPUs)
pip install 'simpletuner[cuda13]'
simpletuner train
```

**рд╡рд┐рдХрд▓реНрдк 2 (Git clone рд╡рд┐рдзрд┐):**
```bash
simpletuner train
```

**рд╡рд┐рдХрд▓реНрдк 3 (Legacy рд╡рд┐рдзрд┐ - рдЕрднреА рднреА рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ):**
```bash
./train.sh
```

рдЗрд╕рд╕реЗ text embed рдФрд░ VAE рдЖрдЙрдЯрдкреБрдЯ рдХреИрд╢рд┐рдВрдЧ рдбрд┐рд╕реНрдХ рдкрд░ рд╢реБрд░реВ рд╣реЛрдЧреАред

## Lumina2 рдХреЗ рд▓рд┐рдП рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдЯрд┐рдкреНрд╕

### Learning rates

#### LoRA Training
- `1e-4` рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВ рдФрд░ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░реЗрдВ
- Lumina2 рддреЗрдЬрд╝реА рд╕реЗ рдЯреНрд░реЗрди рд╣реЛрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╢реБрд░реБрдЖрддреА iterations рдХреЛ рдХрд╝рд░реАрдм рд╕реЗ рдореЙрдирд┐рдЯрд░ рдХрд░реЗрдВ
- рдЕрдзрд┐рдХрддрд░ рдЙрдкрдпреЛрдЧтАСрдорд╛рдорд▓реЛрдВ рдХреЗ рд▓рд┐рдП rank 8тАС32 рдЕрдЪреНрдЫрд╛ рд╣реИ; 64тАС128 рдХреЗ рд▓рд┐рдП рдХрд░реАрдмреА рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ рдЪрд╛рд╣рд┐рдП, рдФрд░ 256тАС512 рдирдП рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдореЙрдбрд▓ рдореЗрдВ рд╕рд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИ

#### Full FineтАСtuning
- рдХрдо learning rates рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ: `1e-5` рд╕реЗ `5e-6`
- рд╕реНрдерд┐рд░рддрд╛ рдХреЗ рд▓рд┐рдП EMA (Exponential Moving Average) рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ
- Gradient clipping (`max_grad_norm`) 1.0 рдЕрдиреБрд╢рдВрд╕рд┐рдд рд╣реИ

### Resolution considerations

Lumina2 flexible resolutions рд╕рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИ:
- 1024x1024 рдкрд░ training рд╕рдмрд╕реЗ рдЕрдЪреНрдЫреА рдЧреБрдгрд╡рддреНрддрд╛ рджреЗрддрд╛ рд╣реИ
- Mixed resolution training (512px, 768px, 1024px) рдХрд╛ рдЧреБрдгрд╡рддреНрддрд╛ рдкреНрд░рднрд╛рд╡ fieldтАСtested рдирд╣реАрдВ рд╣реИ
- Aspect ratio bucketing Lumina2 рдХреЗ рд╕рд╛рде рдЕрдЪреНрдЫрд╛ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ

### Training duration

Lumina2 рдХрд╛ 2B рдкреИрд░рд╛рдореАрдЯрд░ рдЖрдХрд╛рд░ рдЗрд╕реЗ рдХреБрд╢рд▓ рдмрдирд╛рддрд╛ рд╣реИ:
- LoRA training рдЕрдХреНрд╕рд░ 500тАС2000 steps рдореЗрдВ converge рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ
- Full fineтАСtuning рдХреЛ 2000тАС5000 steps рд▓рдЧ рд╕рдХрддреЗ рд╣реИрдВ
- рдореЙрдбрд▓ рддреЗрдЬрд╝реА рд╕реЗ рдЯреНрд░реЗрди рд╣реЛрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП validation images рдЕрдХреНрд╕рд░ рдореЙрдирд┐рдЯрд░ рдХрд░реЗрдВ

### рд╕рд╛рдорд╛рдиреНрдп рд╕рдорд╕реНрдпрд╛рдПрдБ рдФрд░ рд╕рдорд╛рдзрд╛рди

1. **рдореЙрдбрд▓ рдмрд╣реБрдд рдЬрд▓реНрджреА converge рд╣реЛрдирд╛**: learning rate рдШрдЯрд╛рдПрдБ, Lion optimiser рд╕реЗ AdamW рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░реЗрдВ
2. **рдЬрдирд░реЗрдЯреЗрдб рдЗрдореЗрдЬ рдореЗрдВ artifacts**: рдЙрдЪреНрдЪтАСрдЧреБрдгрд╡рддреНрддрд╛ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдбреЗрдЯрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдФрд░ learning rate рдШрдЯрд╛рдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ
3. **Out of memory**: gradient checkpointing рд╕рдХреНрд╖рдо рдХрд░реЗрдВ рдФрд░ batch size рдШрдЯрд╛рдПрдБ
4. **рдЖрд╕рд╛рдиреА рд╕реЗ overfitting**: regularisation datasets рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ

## Inference рдЯрд┐рдкреНрд╕

### рдЕрдкрдиреЗ рдкреНрд░рд╢рд┐рдХреНрд╖рд┐рдд рдореЙрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ

Lumina2 рдореЙрдбрд▓реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
- рд╕реАрдзреЗ Diffusers рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рд╕рд╛рде
- рдЙрдЪрд┐рдд nodes рдХреЗ рд╕рд╛рде ComfyUI рдореЗрдВ
- рдЕрдиреНрдп inference frameworks рдЬреЛ Gemma2тАСрдЖрдзрд╛рд░рд┐рдд рдореЙрдбрд▓реЛрдВ рдХреЛ рд╕рдкреЛрд░реНрдЯ рдХрд░рддреЗ рд╣реИрдВ

### Optimal inference settings

- Guidance scale: 4.0тАС6.0
- Inference steps: 20тАС50
- рд╕рд░реНрд╡реЛрддреНрддрдо рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЗ рд▓рд┐рдП рд╡рд╣реА resolution рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдЬрд┐рд╕ рдкрд░ рдЯреНрд░реЗрди рдХрд┐рдпрд╛ рдерд╛

## рдиреЛрдЯреНрд╕

### Lumina2 рдХреЗ рдлрд╛рдпрджреЗ

- 2B рдкреИрд░рд╛рдореАрдЯрд░ рдЖрдХрд╛рд░ рдХреЗ рдХрд╛рд░рдг рддреЗрдЬрд╝ рдкреНрд░рд╢рд┐рдХреНрд╖рдг
- рдЧреБрдгрд╡рддреНрддрд╛тАСtoтАСsize ratio рдЕрдЪреНрдЫрд╛
- рд╡рд┐рднрд┐рдиреНрди training modes рд╕рдкреЛрд░реНрдЯ (LoRA, LyCORIS, full)
- рдХреБрд╢рд▓ рдореЗрдореЛрд░реА рдЙрдкрдпреЛрдЧ

### рд╡рд░реНрддрдорд╛рди рд╕реАрдорд╛рдПрдБ

- рдЕрднреА ControlNet рд╕рдкреЛрд░реНрдЯ рдирд╣реАрдВ
- рдХреЗрд╡рд▓ textтАСtoтАСimage generation рддрдХ рд╕реАрдорд┐рдд
- рд╕рд░реНрд╡реЛрддреНрддрдо рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЗ рд▓рд┐рдП рдХреИрдкреНрд╢рди рдЧреБрдгрд╡рддреНрддрд╛ рдЙрдЪреНрдЪ рд╣реЛрдирд╛ рдЖрд╡рд╢реНрдпрдХ

### рдореЗрдореЛрд░реА optimization

рдмрдбрд╝реЗ рдореЙрдбрд▓реЛрдВ рдХреЗ рд╡рд┐рдкрд░реАрдд, Lumina2 рдЖрдорддреМрд░ рдкрд░ рдпрд╣ рдирд╣реАрдВ рдорд╛рдВрдЧрддрд╛:
- Model quantization
- рдЕрддреНрдпрдзрд┐рдХ memory optimization рддрдХрдиреАрдХреЗрдВ
- рдЬрдЯрд┐рд▓ mixed precision рд░рдгрдиреАрддрд┐рдпрд╛рдБ
