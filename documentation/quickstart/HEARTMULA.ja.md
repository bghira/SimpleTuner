# HeartMuLa ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

ã“ã®ä¾‹ã§ã¯ã€HeartMuLa oss 3B ã®éŸ³å£°ç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã‚’ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã—ã¾ã™ã€‚

## æ¦‚è¦

HeartMuLa ã¯ 3B ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è‡ªå·±å›å¸°ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã§ã€ã‚¿ã‚°ã¨æ­Œè©ã‹ã‚‰é›¢æ•£çš„ãªéŸ³å£°ãƒˆãƒ¼ã‚¯ãƒ³ã‚’äºˆæ¸¬ã—ã¾ã™ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ HeartCodec ã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦æ³¢å½¢ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

## ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢è¦ä»¶

HeartMuLa ã¯ 3B ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ¢ãƒ‡ãƒ«ã§ã€Flux ã®ã‚ˆã†ãªå¤§å‹ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã¨æ¯”ã¹ã‚‹ã¨æ¯”è¼ƒçš„è»½é‡ã§ã™ã€‚

- **æœ€å°:** 12GB ä»¥ä¸Šã® VRAM ã‚’æŒã¤ NVIDIA GPUï¼ˆä¾‹: 3060ã€4070ï¼‰ã€‚
- **æ¨å¥¨:** 24GB ä»¥ä¸Šã® VRAM ã‚’æŒã¤ NVIDIA GPUï¼ˆä¾‹: 3090ã€4090ã€A10Gï¼‰ã§å¤§ããªãƒãƒƒãƒã‚µã‚¤ã‚ºãŒå¯èƒ½ã€‚
- **Mac:** Apple Silicon ã® MPS ã§å¯¾å¿œï¼ˆçµ±åˆãƒ¡ãƒ¢ãƒª ~36GB ä»¥ä¸ŠãŒå¿…è¦ï¼‰ã€‚

### ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¦ä»¶

> âš ï¸ **ãƒˆãƒ¼ã‚¯ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®æ³¨æ„:** HeartMuLa ã¯äº‹å‰è¨ˆç®—ã•ã‚ŒãŸéŸ³å£°ãƒˆãƒ¼ã‚¯ãƒ³ã§å­¦ç¿’ã—ã¾ã™ã€‚SimpleTuner ã¯å­¦ç¿’ä¸­ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ãªã„ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå´ã§ `audio_tokens` ã¾ãŸã¯ `audio_tokens_path` ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤§ãããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

> ğŸ’¡ **ãƒ’ãƒ³ãƒˆ:** `int8-quanto` é‡å­åŒ–ã‚’ä½¿ã†ã¨ã€VRAM ã®å°‘ãªã„ GPUï¼ˆä¾‹: 12GBã€œ16GBï¼‰ã§ã‚‚å“è³ªä½ä¸‹ã‚’æœ€å°é™ã«æŠ‘ãˆã¦å­¦ç¿’ã§ãã¾ã™ã€‚

## å‰ææ¡ä»¶

Python 3.10+ ã®ç’°å¢ƒã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚

```bash
pip install simpletuner
```

## è¨­å®š

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯æ•´ç†ã—ã¦ãŠãã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚ã“ã®ãƒ‡ãƒ¢ç”¨ã«å°‚ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
mkdir -p config/heartmula-training-demo
```

### é‡è¦ãªè¨­å®š

`config/heartmula-training-demo/config.json` ã‚’ä»¥ä¸‹ã®å†…å®¹ã§ä½œæˆã—ã¾ã™:

<details>
<summary>è¨­å®šä¾‹ã‚’è¡¨ç¤º</summary>

```json
{
  "model_family": "heartmula",
  "model_type": "lora",
  "model_flavour": "3b",
  "pretrained_model_name_or_path": "HeartMuLa/HeartMuLa-oss-3B",
  "resolution": 0,
  "mixed_precision": "bf16",
  "base_model_precision": "int8-quanto",
  "data_backend_config": "config/heartmula-training-demo/multidatabackend.json"
}
```
</details>

### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š

é€²æ—ç¢ºèªã®ãŸã‚ã« `config.json` ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™:

- **`validation_prompt`**: ã‚¿ã‚°ã¾ãŸã¯éŸ³å£°ã®èª¬æ˜æ–‡ï¼ˆä¾‹: "æ˜ã‚‹ã„ã‚·ãƒ³ã‚»ã®ã‚¢ãƒƒãƒ—ãƒ“ãƒ¼ãƒˆãªãƒãƒƒãƒ—"ï¼‰ã€‚
- **`validation_lyrics`**: (ä»»æ„) ãƒ¢ãƒ‡ãƒ«ã«æ­Œã‚ã›ã‚‹æ­Œè©ã€‚ã‚¤ãƒ³ã‚¹ãƒˆã‚¥ãƒ«ãƒ¡ãƒ³ã‚¿ãƒ«ã¯ç©ºæ–‡å­—ã‚’ä½¿ç”¨ã€‚
- **`validation_audio_duration`**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒƒãƒ—ã®é•·ã•ï¼ˆç§’ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 30.0ï¼‰ã€‚
- **`validation_guidance`**: ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆ1.5 - 3.0 ä»˜è¿‘ã‹ã‚‰é–‹å§‹ï¼‰ã€‚
- **`validation_step_interval`**: ã‚µãƒ³ãƒ—ãƒ«ç”Ÿæˆã®é »åº¦ï¼ˆä¾‹: 100 ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ï¼‰ã€‚

### é«˜åº¦ãªå®Ÿé¨“æ©Ÿèƒ½

<details>
<summary>é«˜åº¦ãªå®Ÿé¨“å†…å®¹ã‚’è¡¨ç¤º</summary>


SimpleTuner ã«ã¯å­¦ç¿’ã®å®‰å®šæ€§ã¨æ€§èƒ½ã‚’å¤§ããæ”¹å–„ã§ãã‚‹å®Ÿé¨“æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚

*   **[Scheduled Sampling (Rollout)](../experimental/SCHEDULED_SAMPLING.md):** éœ²å‡ºãƒã‚¤ã‚¢ã‚¹ã‚’æ¸›ã‚‰ã—ã€å­¦ç¿’ä¸­ã«ãƒ¢ãƒ‡ãƒ«è‡ªèº«ã®å…¥åŠ›ç”Ÿæˆã‚’ä½¿ã†ã“ã¨ã§å‡ºåŠ›å“è³ªã‚’æ”¹å–„ã—ã¾ã™ã€‚

> âš ï¸ ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã¯å­¦ç¿’ã®è¨ˆç®—è² è·ã‚’å¢—ã‚„ã—ã¾ã™ã€‚

</details>

## ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆè¨­å®š

HeartMuLa ã¯äº‹å‰è¨ˆç®—æ¸ˆã¿ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚€ **éŸ³å£°å°‚ç”¨** ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒå¿…è¦ã§ã™ã€‚

å„ã‚µãƒ³ãƒ—ãƒ«ã«å¿…è¦ãªé …ç›®:

- `tags`ï¼ˆæ–‡å­—åˆ—ï¼‰
- `lyrics`ï¼ˆæ–‡å­—åˆ—ã€ç©ºã§ã‚‚å¯ï¼‰
- `audio_tokens` ã¾ãŸã¯ `audio_tokens_path`

ãƒˆãƒ¼ã‚¯ãƒ³é…åˆ—ã¯ 2D ã§ã€å½¢çŠ¶ã¯ `[frames, num_codebooks]` ã¾ãŸã¯ `[num_codebooks, frames]` ã§ã™ã€‚

> ğŸ’¡ **æ³¨æ„:** HeartMuLa ã¯ç‹¬ç«‹ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ã‚’ä½¿ã‚ãªã„ãŸã‚ã€text-embeds ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ä¸è¦ã§ã™ã€‚

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³ 1: Hugging Face ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼ˆåˆ—ã«ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰

`config/heartmula-training-demo/multidatabackend.json` ã‚’ä½œæˆã—ã¾ã™:

<details>
<summary>è¨­å®šä¾‹ã‚’è¡¨ç¤º</summary>

```json
[
  {
    "id": "heartmula-demo-data",
    "type": "huggingface",
    "dataset_type": "audio",
    "dataset_name": "your-org/heartmula-audio-tokens",
    "metadata_backend": "huggingface",
    "caption_strategy": "huggingface",
    "config": {
      "audio_caption_fields": ["tags"],
      "lyrics_column": "lyrics"
    }
  }
]
```
</details>

ãƒ†ã‚­ã‚¹ãƒˆåˆ—ã«åŠ ãˆã¦ `audio_tokens` ã¾ãŸã¯ `audio_tokens_path` åˆ—ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³ 2: ãƒ­ãƒ¼ã‚«ãƒ«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« + ãƒˆãƒ¼ã‚¯ãƒ³ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

`config/heartmula-training-demo/multidatabackend.json` ã‚’ä½œæˆã—ã¾ã™:

<details>
<summary>è¨­å®šä¾‹ã‚’è¡¨ç¤º</summary>

```json
[
  {
    "id": "my-audio-dataset",
    "type": "local",
    "dataset_type": "audio",
    "instance_data_dir": "datasets/my_audio_files",
    "caption_strategy": "textfile",
    "metadata_backend": "discovery",
    "disabled": false
  }
]
```
</details>

å„ã‚µãƒ³ãƒ—ãƒ«ã« `audio_tokens` ã¾ãŸã¯ `audio_tokens_path` ã‚’æä¾›ã§ãã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚

### ãƒ‡ãƒ¼ã‚¿æ§‹æˆ

éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `datasets/my_audio_files` ã«é…ç½®ã—ã¾ã™ã€‚SimpleTuner ã¯ä»¥ä¸‹ã®å½¢å¼ã«å¯¾å¿œã—ã¦ã„ã¾ã™:

- **ãƒ­ã‚¹ãƒ¬ã‚¹:** `.wav`, `.flac`, `.aiff`, `.alac`
- **ãƒ­ãƒƒã‚·ãƒ¼:** `.mp3`, `.ogg`, `.m4a`, `.aac`, `.wma`, `.opus`

> â„¹ï¸ **æ³¨æ„:** MP3ã€AACã€WMA ãªã©ã‚’ä½¿ã†ã«ã¯ **FFmpeg** ãŒå¿…è¦ã§ã™ã€‚

`caption_strategy: textfile` ã‚’ä½¿ã†å ´åˆã¯ã€ã‚¿ã‚°ã¨æ­Œè©ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒã˜å ´æ‰€ã«ç½®ã„ã¦ãã ã•ã„:

- **éŸ³å£°:** `track_01.wav`
- **ã‚¿ã‚° (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ):** `track_01.txt`ï¼ˆä¾‹: "ã‚†ã£ãŸã‚Šã—ãŸã‚¸ãƒ£ã‚ºãƒãƒ©ãƒ¼ãƒ‰"ï¼‰
- **æ­Œè© (ä»»æ„):** `track_01.lyrics`

ãƒˆãƒ¼ã‚¯ãƒ³é…åˆ—ã¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¸¡ã—ã¾ã™ï¼ˆä¾‹: `.npy` / `.npz` ã‚’æŒ‡ã™ `audio_tokens_path`ï¼‰ã€‚

<details>
<summary>ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ§‹æˆä¾‹</summary>

```text
datasets/my_audio_files/
â”œâ”€â”€ track_01.wav
â”œâ”€â”€ track_01.txt
â”œâ”€â”€ track_01.lyrics
â””â”€â”€ track_01.tokens.npy
```
</details>

> âš ï¸ **æ­Œè©ã®æ³¨æ„:** HeartMuLa ã¯å„ã‚µãƒ³ãƒ—ãƒ«ã«æ­Œè©æ–‡å­—åˆ—ã‚’è¦æ±‚ã—ã¾ã™ã€‚ã‚¤ãƒ³ã‚¹ãƒˆã‚¥ãƒ«ãƒ¡ãƒ³ã‚¿ãƒ«ã¯ç©ºæ–‡å­—ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚

## ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°

ç’°å¢ƒã‚’æŒ‡å®šã—ã¦ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™:

```bash
simpletuner train env=heartmula-training-demo
```

ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ `config/heartmula-training-demo/` å†…ã® `config.json` ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚

> ğŸ’¡ **ãƒ’ãƒ³ãƒˆ (å­¦ç¿’ã®ç¶™ç¶š):** æ—¢å­˜ã® LoRA ã‹ã‚‰å†é–‹ã™ã‚‹å ´åˆã¯ `--init_lora` ã‚’ä½¿ã„ã¾ã™:
> ```bash
> simpletuner train env=heartmula-training-demo --init_lora=/path/to/existing_lora.safetensors
> ```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

- **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:** `num_validation_images` > 1ï¼ˆéŸ³å£°ã§ã¯ãƒãƒƒãƒã‚µã‚¤ã‚ºã«ç›¸å½“ï¼‰ã‚„ã€CLIP ã‚¹ã‚³ã‚¢ãªã©ã®ç”»åƒå‘ã‘ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
- **ãƒ¡ãƒ¢ãƒªä¸è¶³:** OOM ã®å ´åˆã¯ `train_batch_size` ã‚’æ¸›ã‚‰ã™ã‹ `gradient_checkpointing` ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚
