# SimpleTuner v2.1 から v2.2 への移行ガイド

このガイドは SimpleTuner v2.1 から v2.2 への移行を支援します。v2.2 では、設定管理と学習ジョブ実行の一元的な入口となる新しい CLI が導入されています。

## v2.2 の新機能

- **pip でインストール可能**: SimpleTuner を Python パッケージとしてインストール可能
- **統一 CLI エントリポイント**: `simpletuner` コマンドが直接スクリプト実行を置き換え
  - `simpletuner examples` - サンプル設定の一覧とワークスペースへのコピー
  - `simpletuner configure` - 端末 UI で対話的に設定を作成/編集（Linux の `make menuconfig` に近い体験）
  - `simpletuner train` - 設定ファイルと CLI 上書きで学習を実行
- **コマンドライン引数の上書き**: 設定ファイルを編集せずに引数で素早く変更（例: `simpletuner train env=foo learning_rate=5e-5`）

### 互換性が維持されるもの

- 既存の `train.sh` ワークフローは継続して利用可能
  - 新しい `simpletuner/` サブディレクトリに `cd` するのを忘れないでください。
- 設定ファイル形式（JSON/TOML/ENV）は変更なし
- データセット設定は変更なし
- モデル学習パラメータは変更なし
- モデル実装は同一

## インストール方法

### v2.2（pip インストール） - 推奨

`pip` インストールがサポートされたため、SimpleTuner を新しいワークスペースへパッケージとしてインストールする方法が推奨です。学習プロジェクトと SimpleTuner 本体を分離でき、`pip install --upgrade simpletuner` による更新も容易になります。

```bash
# SimpleTuner パッケージをインストール
pip install 'simpletuner[cuda]' # または apple, rocm（CPU のみなら指定なし）

# 学習ワークスペース作成
mkdir my_training_project
cd my_training_project

# 設定構造を初期化
mkdir -p config/sdxl_example_project

# 対話的に設定を作成
simpletuner configure config/sdxl_example_project/config.json
## またはサンプルをコピー
# simpletuner examples list # 利用可能なサンプルを一覧表示
# simpletuner examples copy sdxl.lycoris-lokr config/sdxl_example_project
## コピー後にパスとパラメータを必ず更新してください

# 学習を実行
simpletuner env=sdxl_example_project
```

### Git Clone（旧方式）

以前のリリースでは、リポジトリをクローンして直接スクリプトを実行する方法が推奨されていました。この方法は v2.2 でも互換性のため引き続き利用できます。

**注:** `poetry` は使用しません。

```bash
# リポジトリをクローン
git clone --branch=release https://github.com/bghira/SimpleTuner.git
cd SimpleTuner

# Poetry ではなく pip で依存関係をインストール
pip install '.[cuda]'  # または .[apple], .[rocm]

# 学習を実行（今後も当面は利用可能）
ENV=my_config train.sh
## または train.py を直接実行（将来的にサポート外になる可能性あり）
#python train.py --model_family=flux --learning_rate=1e-4
```

## コマンドラインインターフェースの移行

### 設定の読み込み

#### v2.1 のワークフロー

```bash
# 環境変数を設定
export ENV=my_config

# config/my_config/config.json を読み込む
train.sh

# あるいはインライン指定
ENV=my_config train.sh
```

#### v2.2 のワークフロー

**オプション 1: 環境変数ベース（後方互換）**

```bash
# v2.1 と同じ環境変数
ENV=my_config train.sh
# 新しい CLI でも利用可
simpletuner train env=my_config
```

**オプション 2: 併用アプローチ**

```bash
# ベース設定を読み込み、特定パラメータを上書き
simpletuner train env=my_config learning_rate=5e-5 num_train_epochs=50
```

## 設定管理

### ディレクトリ構成

#### v2.1 の Git リポジトリ構成

```
SimpleTuner/
├── config/
│   ├── config.json          # デフォルト設定
│   ├── my_config/
│   │   ├── config.json      # カスタム設定
│   │   └── config.env
│   └── another_config/
│       └── config.toml
├── train.sh
└── train.py
```

#### v2.2 のワークスペース構成（pip インストール）

```
my_training_project/         # ワークスペース（git 管理も可能）
├── config/
│   ├── config.json          # デフォルト設定
│   ├── config.env           # env 未指定時のフォールバック
│   ├── my_config/
│   │   └── config.json      # カスタム設定
│   └── another_config/
│       └── config.toml
├── cache/                   # VAE/テキストエンコーダのキャッシュ
├── output/                  # 学習出力
└── datasets/                # 学習データ
```

### 設定読み込みの優先順位

#### v2.1

1. `ENV` 環境変数
2. `config/${ENV}/config.{json,toml,env}` を読み込み
3. `config/config.{json,toml,env}` にフォールバック

#### v2.2

1. コマンドライン引数（最優先）
2. `SIMPLETUNER_ENV` または `ENV`
3. 現在ディレクトリまたは `config` サブディレクトリから読み込み
4. env 未指定時は `config.env` を使用
5. CLI 引数の上書きを適用

### 環境変数

v2.2 では複数の環境変数名に対応しています：

```bash
# いずれも v2.2 で有効
SIMPLETUNER_ENV=my_config bash train.sh
SIMPLETUNER_ENVIRONMENT=my_config bash train.sh
ENV=my_config bash train.sh  # v2.1 互換

# 設定バックエンドの選択
SIMPLETUNER_CONFIG_BACKEND=json  # または toml, env
CONFIG_BACKEND=json               # v2.1 互換
CONFIG_TYPE=json                  # 旧互換
```

### Git リポジトリからワークスペースへ移行

v2.1 の git リポジトリ構成から v2.2 の pip ワークスペースに移行する手順：

```bash
# 1. 既存の SimpleTuner クローン
cd /path/to/SimpleTuner

# 2. 新しいワークスペースを作成
mkdir ~/training_workspace

# 3. 設定をコピー（環境別フォルダがある前提）
cp -r config/* ~/training_workspace/config/

# 4. データローダ設定のキャッシュパスを更新

# 5. データセットのパスを移動/リンク/更新

# 6. ワークスペースに Python 環境を作成
cd ~/training_workspace
python3.12 -m venv .venv # 必要に応じて新規 venv
pip install simpletuner  # v2.2 パッケージをインストール

# 7. 旧 SimpleTuner を削除（任意）
# rm -rf /path/to/SimpleTuner

# 8. ワークスペースから学習を実行
simpletuner train env=my_config learning_rate=5e-5
```

### マルチ GPU 学習

v2.1 と同じ方法でマルチ GPU 設定が可能です：

```bash
# Accelerate の設定（推奨）
accelerate config  # 対話形式で 1 回設定

# config.env に設定（simpletuner CLI が読み込みます）
echo "export TRAINING_NUM_PROCESSES=4" >> ~/my_workspace/config/config.env
```

### 短い実験の実行

**v2.1:** 実験ごとに新しい設定ディレクトリを作成し、設定値を編集する必要がありました。

**v2.2:** パラメータを即座に変えて実験できます：

```bash
simpletuner train learning_rate=1e-4 batch_size=1 tracker_run_name="training experiment 1"
simpletuner train learning_rate=5e-5 batch_size=2 tracker_run_name="training experiment 2"
simpletuner train learning_rate=1e-5 batch_size=4 tracker_run_name="training experiment 3"
```

## よくある問題と解決策

### 問題 1: 設定が見つからない

**問題:** `simpletuner env=my_config` で設定が見つからない
**解決:** `config/my_config/config.json` がカレントディレクトリに存在するか確認

### 問題 2: パス解決

**問題:** 絶対パスが移行後に壊れる
**解決:** ワークスペース基準の相対パスに更新

### 問題 3: 環境変数

**問題:** 古い ENV 変数が動作しない
**解決:** パスが正しいか、ファイルが参照できるか確認

### 問題 4: CLI コマンドが見つからない

**問題:** `simpletuner` コマンドが見つからない
**解決:** 仮想環境を有効化し、再試行するか pip で再インストール
