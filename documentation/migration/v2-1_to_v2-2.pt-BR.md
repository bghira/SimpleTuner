# Guia de migracao do SimpleTuner v2.1 para v2.2

Este guia ajuda a migrar do SimpleTuner v2.1 para v2.2, que introduz uma nova interface de linha de comando como ponto unico de entrada para gerenciamento de configuracoes e execucao de treinos.

## Novidades no v2.2

- **Pacote instalavel via pip**: O SimpleTuner agora pode ser instalado como um pacote Python
- **Ponto de entrada de CLI unificado**: o comando `simpletuner` substitui a execucao direta de scripts
  - `simpletuner examples` - lista configs de exemplo e permite copiar para um workspace
  - `simpletuner configure` - cria ou modifica configs de forma interativa via UI de terminal, semelhante ao `make menuconfig` do kernel Linux
  - `simpletuner train` - roda o treino com config e sobrescritas via CLI
- **Sobrescritas de argumentos na CLI**: passe argumentos direto sem editar arquivos de config para mudancas rapidas, ex.: `simpletuner train env=foo learning_rate=5e-5`

### O que permanece compativel

- O workflow existente com `train.sh` continua funcionando
  - Nao esqueça de dar `cd` para o novo subdiretorio `simpletuner/` primeiro.
- Formatos e conteudos de arquivos de config (JSON, TOML, ENV) inalterados
- Configuracoes de datasets permanecem as mesmas
- Parametros de treinamento do modelo inalterados
- Implementacoes do modelo identicas

## Metodos de instalacao

### v2.2 (metodo pip) - recomendacao moderna

Agora que a instalacao via `pip` e suportada, o metodo recomendado e simplesmente instalar o SimpleTuner como pacote em um novo workspace. Isso permite separar seus projetos de treinamento do codigo do SimpleTuner e facilita atualizacoes via `pip install --upgrade simpletuner`.

```bash
# Instale o pacote SimpleTuner
pip install 'simpletuner[cuda]' # ou cuda13 (Blackwell/B-series), apple, rocm (ou nada, para CPU)

# Crie o workspace de treinamento
mkdir my_training_project
cd my_training_project

# Inicialize a estrutura de config
mkdir -p config/sdxl_example_project

# Crie uma configuracao interativa
simpletuner configure config/sdxl_example_project/config.json
## OU - copie um exemplo
# simpletuner examples list # lista exemplos disponiveis
# simpletuner examples copy sdxl.lycoris-lokr config/sdxl_example_project
## Nao se esqueça de atualizar caminhos e parametros no arquivo copiado!

# Rode o treinamento
simpletuner env=sdxl_example_project
```

### Via Git clone (metodo legado)

Na release anterior, o metodo recomendado era clonar o repositorio e rodar scripts de treino diretamente. Esse era o unico metodo suportado e tinha varias desvantagens. No entanto, este fluxo segue totalmente suportado no v2.2 por compatibilidade.

**NOTA:** `poetry` nao e mais usado.

```bash
# Clone o repositorio
git clone --branch=release https://github.com/bghira/SimpleTuner.git
cd SimpleTuner

# Instale dependencias com Pip agora em vez de Poetry
pip install '.[cuda]'  # ou .[apple], ou .[rocm]

# Rode o treino - isso ainda funciona e continuara funcionando.
ENV=my_config train.sh
## Ou use o train.py diretamente, o que pode nao ser suportado para sempre:
#python train.py --model_family=flux --learning_rate=1e-4
```

## Migracao da interface de linha de comando

### Carregamento de configuracao

#### Workflow v2.1

```bash
# Defina variavel de ambiente
export ENV=my_config

# Config carregada de: config/my_config/config.json
train.sh

# Ou inline
ENV=my_config train.sh
```

#### Workflow v2.2

**Opcao 1: Config baseada em ambiente (compatibilidade retroativa)**

```bash
# Usando variavel de ambiente (igual v2.1)
ENV=my_config train.sh
# Ou com a nova CLI
simpletuner train env=my_config
```

**Opcao 2: Abordagem mista**

```bash
# Carregue o config base e sobrescreva parametros especificos
simpletuner train env=my_config learning_rate=5e-5 num_train_epochs=50
```

## Gerenciamento de configuracao

### Estrutura de diretorios

#### Estrutura do repo Git v2.1

```
SimpleTuner/
├── config/
│   ├── config.json          # Config padrao
│   ├── my_config/
│   │   ├── config.json      # Config custom
│   │   └── config.env
│   └── another_config/
│       └── config.toml
├── train.sh
└── train.py
```

#### Estrutura do workspace v2.2 (pip install)

```
my_training_project/         # Seu workspace (nao e um repo git, mas pode ser versionado se quiser)
├── config/
│   ├── config.json          # Config padrao
│   ├── config.env           # Fallback quando nenhum env e especificado
│   ├── my_config/
│   │   └── config.json      # Config custom
│   └── another_config/
│       └── config.toml
├── cache/                   # Caches de VAE/text encoder
├── output/                  # Saidas de treino
└── datasets/               # Seus dados de treino
```

### Prioridade de carregamento de config

#### v2.1

1. Verifica variavel `ENV`
2. Carrega `config/${ENV}/config.{json,toml,env}`
3. Fallback para `config/config.{json,toml,env}`

#### v2.2

1. Argumentos de linha de comando (maior prioridade)
2. Verifica `SIMPLETUNER_ENV` ou `ENV`
3. Carrega config do diretorio atual ou subdiretorio config
4. Usa `config.env` se nenhum env foi especificado
5. Aplica sobrescritas de argumentos da CLI

### Variaveis de ambiente

O v2.2 suporta multiplos nomes de variavel por compatibilidade:

```bash
# Todas funcionam no v2.2:
SIMPLETUNER_ENV=my_config bash train.sh
SIMPLETUNER_ENVIRONMENT=my_config bash train.sh
ENV=my_config bash train.sh  # compativel com v2.1

# Selecao do backend de config
SIMPLETUNER_CONFIG_BACKEND=json  # ou toml, env
CONFIG_BACKEND=json               # compativel com v2.1
CONFIG_TYPE=json                  # suporte legado
```

### Migrando de Git para workspace

Para migrar um setup de config baseado em repo git v2.1 para um workspace v2.2 via pip:

```bash
# 1. Seu clone existente do SimpleTuner
cd /path/to/SimpleTuner

# 2. Crie um novo workspace
mkdir ~/training_workspace

# 3. Copie configs - vamos assumir que voce tem envs de config em subpastas.
cp -r config/* ~/training_workspace/config/

# 4. Atualize caminhos nos locais de cache do config do dataloader

# 5. Relocalize, linke ou atualize caminhos para datasets

# 6. Configure o ambiente Python no workspace
cd ~/training_workspace
python3.13 -m venv .venv # Crie um novo venv para este workspace se desejar
pip install simpletuner  # Instale o novo pacote v2.2

# 7. Remova a instalacao antiga do SimpleTuner se desejar
# rm -rf /path/to/SimpleTuner

# 8. Rode o treino a partir do workspace
simpletuner train env=my_config learning_rate=5e-5
```

### Treinamento multi-GPU

Os mesmos metodos usados para configurar treino multi-gpu no v2.1 ainda se aplicam no v2.2:

```bash
# Config do Accelerate (recomendado)
accelerate config  # Rode uma vez para configurar, seguindo o menu interativo

# Defina em config.env que sera lido pela CLI do simpletuner
echo "export TRAINING_NUM_PROCESSES=4" >> ~/my_workspace/config/config.env
```

### Rodando experimentos rapidos

**v2.1:** exigia criar novos diretorios de config para cada experimento e atualizar caminhos e valores individualmente

**v2.2:** rode experimentos com parametros diferentes imediatamente:

```bash
simpletuner train learning_rate=1e-4 batch_size=1 tracker_run_name="training experiment 1"
simpletuner train learning_rate=5e-5 batch_size=2 tracker_run_name="training experiment 2"
simpletuner train learning_rate=1e-5 batch_size=4 tracker_run_name="training experiment 3"
```

## Problemas comuns e solucoes

### Problema 1: Config nao encontrada

**Problema:** `simpletuner env=my_config` nao encontra a configuracao
**Solucao:** Garanta que o config exista em `config/my_config/config.json` no diretorio atual

### Problema 2: Resolucao de caminhos

**Problema:** Caminhos absolutos em arquivos de config quebram apos a migracao
**Solucao:** Atualize para caminhos relativos a raiz do workspace

### Problema 3: Variaveis de ambiente

**Problema:** Variavel ENV antiga nao funciona
**Solucao:** Garanta que os caminhos estao corretos e que os arquivos podem ser encontrados

### Problema 4: Comando CLI ausente

**Problema:** comando `simpletuner` nao encontrado
**Solucao:** Ative o virtualenv e tente novamente, ou reinstale o SimpleTuner via pip
