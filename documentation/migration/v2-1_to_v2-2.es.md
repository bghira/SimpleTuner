# Guía de migración de SimpleTuner v2.1 a v2.2

Esta guía te ayuda a migrar de SimpleTuner v2.1 a v2.2, que introduce una nueva interfaz de línea de comandos como punto único de entrada para la gestión de configuración y la ejecución de trabajos de entrenamiento.

## Novedades en v2.2

- **Paquete instalable con pip**: SimpleTuner ahora puede instalarse como paquete Python
- **Punto de entrada CLI unificado**: el comando `simpletuner` reemplaza la ejecución directa de scripts
  - `simpletuner examples` - lista configs de ejemplo y permite copiarlas a un workspace
  - `simpletuner configure` - crea o modifica de forma interactiva archivos de configuración personalizados a través de una UI de terminal, similar al `make menuconfig` del kernel Linux
  - `simpletuner train` - ejecuta entrenamiento con configuración y overrides de CLI
- **Overrides de argumentos CLI**: pasa argumentos directamente sin editar archivos de configuración para cambios rápidos, p. ej., `simpletuner train env=foo learning_rate=5e-5`

### Qué sigue siendo compatible

- El workflow existente de `train.sh` sigue funcionando
  - No olvides hacer `cd` al nuevo subdirectorio `simpletuner/` primero.
- Formatos y contenido de archivos de configuración (JSON, TOML, ENV) sin cambios
- Las configuraciones de datasets se mantienen iguales
- Parámetros de entrenamiento de modelos sin cambios
- Implementaciones de modelos idénticas

## Métodos de instalación

### v2.2 (método pip) - recomendación moderna

Ahora que se soporta instalación vía `pip`, el método recomendado es instalar SimpleTuner como paquete en un nuevo workspace. Esto permite una separación más limpia entre tus proyectos de entrenamiento y el código de SimpleTuner, y habilita actualizaciones fáciles vía `pip install --upgrade simpletuner`.

```bash
# Install SimpleTuner package
pip install 'simpletuner[cuda]' # or cuda13 (Blackwell/B-series), apple, rocm (or nothing, for CPU)

# Create training workspace
mkdir my_training_project
cd my_training_project

# Initialize config structure
mkdir -p config/sdxl_example_project

# Interactively create a configuration
simpletuner configure config/sdxl_example_project/config.json
## OR - copy an example
# simpletuner examples list # list available examples to select from
# simpletuner examples copy sdxl.lycoris-lokr config/sdxl_example_project
## Be sure to update the paths and parameters in the copied config file!

# Run training
simpletuner env=sdxl_example_project
```

### Vía Git Clone (método legacy)

En la versión anterior, el método recomendado era clonar el repositorio y ejecutar scripts de entrenamiento directamente. Era el único método soportado y tenía varias desventajas. Sin embargo, este flujo sigue totalmente soportado en v2.2 por compatibilidad hacia atrás.

**NOTA:** `poetry` ya no se usa.

```bash
# Clone repository
git clone --branch=release https://github.com/bghira/SimpleTuner.git
cd SimpleTuner

# Install dependencies with Pip now instead of Poetry
pip install '.[cuda]'  # or .[apple], or .[rocm]

# Run training - this still works, and will for the foreseeable future.
ENV=my_config train.sh
## Or, use the train.py script directly, which might not be supported forever:
#python train.py --model_family=flux --learning_rate=1e-4
```

## Migración de la interfaz de línea de comandos

### Carga de configuración

#### Flujo v2.1

```bash
# Set environment variable
export ENV=my_config

# Config loaded from: config/my_config/config.json
train.sh

# Or inline
ENV=my_config train.sh
```

#### Flujo v2.2

**Opción 1: Config basada en entorno (compatible hacia atrás)**

```bash
# Using environment variable (same as v2.1)
ENV=my_config train.sh
# Or with new CLI
simpletuner train env=my_config
```

**Opción 2: Enfoque mixto**

```bash
# Load base config and override specific parameters
simpletuner train env=my_config learning_rate=5e-5 num_train_epochs=50
```

## Gestión de configuración

### Estructura de directorios

#### Estructura del repo git v2.1

```
SimpleTuner/
├── config/
│   ├── config.json          # Default config
│   ├── my_config/
│   │   ├── config.json      # Custom config
│   │   └── config.env
│   └── another_config/
│       └── config.toml
├── train.sh
└── train.py
```

#### Estructura de workspace v2.2 (pip install)

```
my_training_project/         # Your workspace (not a git repo, but it could be committed if desired for version control)
├── config/
│   ├── config.json          # Default config
│   ├── config.env           # Fallback when no env specified
│   ├── my_config/
│   │   └── config.json      # Custom config
│   └── another_config/
│       └── config.toml
├── cache/                   # VAE/text encoder caches
├── output/                  # Training outputs
└── datasets/               # Your training data
```

### Prioridad de carga de configuración

#### v2.1

1. Verificar variable de entorno `ENV`
2. Cargar `config/${ENV}/config.{json,toml,env}`
3. Fallback a `config/config.{json,toml,env}`

#### v2.2

1. Argumentos de línea de comandos (mayor prioridad)
2. Verificar variable `SIMPLETUNER_ENV` o `ENV`
3. Cargar config desde directorio actual o subdirectorio config
4. Usar `config.env` si no se especifica entorno
5. Aplicar overrides de CLI

### Variables de entorno

v2.2 soporta múltiples nombres de variables de entorno por compatibilidad:

```bash
# All of these work in v2.2:
SIMPLETUNER_ENV=my_config bash train.sh
SIMPLETUNER_ENVIRONMENT=my_config bash train.sh
ENV=my_config bash train.sh  # v2.1 compatible

# Config backend selection
SIMPLETUNER_CONFIG_BACKEND=json  # or toml, env
CONFIG_BACKEND=json               # v2.1 compatible
CONFIG_TYPE=json                  # legacy support
```

### Migrar de Git a Workspace

Para migrar una configuración de repo git v2.1 a un workspace v2.2 basado en pip:

```bash
# 1. Your existing SimpleTuner clone
cd /path/to/SimpleTuner

# 2. Create new workspace
mkdir ~/training_workspace

# 3. Copy configurations - we'll assume you have subfolder based config envs.
cp -r config/* ~/training_workspace/config/

# 4. Update paths in dataloader config cache locations

# 5. Relocate, link, or update paths to datasets

# 6. Set up python environment in workspace
cd ~/training_workspace
python3.13 -m venv .venv # Create a new venv for this workspace if desired
pip install simpletuner  # Install the new v2.2 package

# 7. Remove old SimpleTuner installation if desired
# rm -rf /path/to/SimpleTuner

# 8. Run training from workspace
simpletuner train env=my_config learning_rate=5e-5
```

### Entrenamiento multi-GPU

Los mismos métodos usados para configurar entrenamiento multi-gpu en v2.1 aplican en v2.2:

```bash
# Accelerate config (recommended)
accelerate config  # Run once to set up, following interactive menu

# Set in config.env which will be read by the simpletuner command-line tool
echo "export TRAINING_NUM_PROCESSES=4" >> ~/my_workspace/config/config.env
```

### Ejecutar experimentos rápidos

**v2.1:** Requería crear nuevos directorios de configuración para cada experimento y actualizar rutas y valores individualmente

**v2.2:** Ejecuta experimentos con distintos parámetros al instante:

```bash
simpletuner train learning_rate=1e-4 batch_size=1 tracker_run_name="training experiment 1"
simpletuner train learning_rate=5e-5 batch_size=2 tracker_run_name="training experiment 2"
simpletuner train learning_rate=1e-5 batch_size=4 tracker_run_name="training experiment 3"
```

## Problemas comunes y soluciones

### Problema 1: Config no encontrada

**Problema:** `simpletuner env=my_config` no encuentra la configuración
**Solución:** Asegúrate de que exista en `config/my_config/config.json` en el directorio actual

### Problema 2: Resolución de rutas

**Problema:** Rutas absolutas en config se rompen tras la migración
**Solución:** Actualiza a rutas relativas desde la raíz del workspace

### Problema 3: Variables de entorno

**Problema:** La variable ENV antigua no funciona
**Solución:** Asegúrate de que las rutas sean correctas y que los archivos puedan encontrarse

### Problema 4: Falta el comando CLI

**Problema:** `simpletuner` no se encuentra
**Solución:** Habilita el virtualenv e intenta de nuevo, o reinstala SimpleTuner vía pip
