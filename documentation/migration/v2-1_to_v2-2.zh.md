# SimpleTuner v2.1 到 v2.2 迁移指南

本指南帮助你从 SimpleTuner v2.1 迁移到 v2.2。v2.2 引入了新的命令行接口，作为配置管理与训练任务运行的一站式入口。

## v2.2 新特性

- **可通过 pip 安装**：SimpleTuner 现在可作为 Python 包安装
- **统一 CLI 入口**：`simpletuner` 命令替代直接执行脚本
  - `simpletuner examples` - 列出示例配置并复制到工作区
  - `simpletuner configure` - 在终端 UI 中交互式创建/修改配置（类似 Linux 的 `make menuconfig`）
  - `simpletuner train` - 使用配置文件与 CLI 覆盖运行训练
- **命令行参数覆盖**：无需编辑配置文件即可快速调整参数，例如 `simpletuner train env=foo learning_rate=5e-5`

### 仍保持兼容

- 现有 `train.sh` 工作流仍可使用
  - 不要忘记先 `cd` 到新的 `simpletuner/` 子目录。
- 配置文件格式（JSON/TOML/ENV）不变
- 数据集配置保持不变
- 训练参数保持不变
- 模型实现保持一致

## 安装方式

### v2.2（pip 安装）- 推荐

支持 `pip` 安装后，推荐在新工作区中将 SimpleTuner 作为包安装。这样可将训练项目与 SimpleTuner 代码库分离，并可通过 `pip install --upgrade simpletuner` 轻松更新。

```bash
# 安装 SimpleTuner 包
pip install 'simpletuner[cuda]' # 或 apple、rocm（或不指定，仅 CPU）

# 创建训练工作区
mkdir my_training_project
cd my_training_project

# 初始化配置结构
mkdir -p config/sdxl_example_project

# 交互式创建配置
simpletuner configure config/sdxl_example_project/config.json
## 或复制示例
# simpletuner examples list # 列出可用示例
# simpletuner examples copy sdxl.lycoris-lokr config/sdxl_example_project
## 复制后请更新路径与参数

# 运行训练
simpletuner env=sdxl_example_project
```

### Git Clone（旧方式）

在旧版本中，推荐克隆仓库并直接运行脚本。该方式在 v2.2 中仍可用以保持兼容。

**注意：** 不再使用 `poetry`。

```bash
# 克隆仓库
git clone --branch=release https://github.com/bghira/SimpleTuner.git
cd SimpleTuner

# 使用 pip 安装依赖（不再使用 Poetry）
pip install '.[cuda]'  # 或 .[apple]、.[rocm]

# 运行训练（仍然可用）
ENV=my_config train.sh
## 或直接运行 train.py（未来可能不再支持）
#python train.py --model_family=flux --learning_rate=1e-4
```

## CLI 迁移

### 配置加载

#### v2.1 工作流

```bash
# 设置环境变量
export ENV=my_config

# 从 config/my_config/config.json 加载
train.sh

# 或内联方式
ENV=my_config train.sh
```

#### v2.2 工作流

**选项 1：环境变量配置（向后兼容）**

```bash
# 使用环境变量（同 v2.1）
ENV=my_config train.sh
# 或使用新 CLI
simpletuner train env=my_config
```

**选项 2：混合方式**

```bash
# 加载基础配置并覆盖特定参数
simpletuner train env=my_config learning_rate=5e-5 num_train_epochs=50
```

## 配置管理

### 目录结构

#### v2.1 Git 仓库结构

```
SimpleTuner/
├── config/
│   ├── config.json          # 默认配置
│   ├── my_config/
│   │   ├── config.json      # 自定义配置
│   │   └── config.env
│   └── another_config/
│       └── config.toml
├── train.sh
└── train.py
```

#### v2.2 工作区结构（pip 安装）

```
my_training_project/         # 你的工作区（可提交版本控制）
├── config/
│   ├── config.json          # 默认配置
│   ├── config.env           # 未指定 env 时的兜底
│   ├── my_config/
│   │   └── config.json      # 自定义配置
│   └── another_config/
│       └── config.toml
├── cache/                   # VAE/文本编码器缓存
├── output/                  # 训练输出
└── datasets/               # 训练数据
```

### 配置加载优先级

#### v2.1

1. 检查 `ENV` 环境变量
2. 加载 `config/${ENV}/config.{json,toml,env}`
3. 回退到 `config/config.{json,toml,env}`

#### v2.2

1. 命令行参数（最高优先级）
2. 检查 `SIMPLETUNER_ENV` 或 `ENV`
3. 从当前目录或 `config` 子目录加载
4. 未指定环境时使用 `config.env`
5. 应用 CLI 参数覆盖

### 环境变量

v2.2 支持多个环境变量名称：

```bash
# 以下写法在 v2.2 均有效
SIMPLETUNER_ENV=my_config bash train.sh
SIMPLETUNER_ENVIRONMENT=my_config bash train.sh
ENV=my_config bash train.sh  # v2.1 兼容

# 配置后端选择
SIMPLETUNER_CONFIG_BACKEND=json  # 或 toml、env
CONFIG_BACKEND=json               # v2.1 兼容
CONFIG_TYPE=json                  # 旧版支持
```

### 从 Git 迁移到工作区

将 v2.1 Git 仓库配置迁移至 v2.2 pip 工作区：

```bash
# 1. 进入现有 SimpleTuner 克隆目录
cd /path/to/SimpleTuner

# 2. 创建新工作区
mkdir ~/training_workspace

# 3. 复制配置（假设使用子目录 env）
cp -r config/* ~/training_workspace/config/

# 4. 更新数据加载器配置中的缓存路径

# 5. 迁移/链接/更新数据集路径

# 6. 在工作区创建 Python 环境
cd ~/training_workspace
python3.12 -m venv .venv # 需要的话创建新的 venv
pip install simpletuner  # 安装 v2.2 包

# 7. 如有需要，移除旧的 SimpleTuner 安装
# rm -rf /path/to/SimpleTuner

# 8. 在工作区运行训练
simpletuner train env=my_config learning_rate=5e-5
```

### 多 GPU 训练

v2.2 继续使用 v2.1 的多 GPU 配置方式：

```bash
# Accelerate 配置（推荐）
accelerate config  # 跟随交互式菜单配置一次

# 写入 config.env（simpletuner CLI 会读取）
echo "export TRAINING_NUM_PROCESSES=4" >> ~/my_workspace/config/config.env
```

### 快速实验

**v2.1：** 需要为每次实验创建新的配置目录并逐项修改路径和参数

**v2.2：** 可直接通过参数快速运行实验：

```bash
simpletuner train learning_rate=1e-4 batch_size=1 tracker_run_name="training experiment 1"
simpletuner train learning_rate=5e-5 batch_size=2 tracker_run_name="training experiment 2"
simpletuner train learning_rate=1e-5 batch_size=4 tracker_run_name="training experiment 3"
```

## 常见问题与解决方案

### 问题 1：找不到配置

**问题：** `simpletuner env=my_config` 找不到配置
**解决：** 确认当前目录中存在 `config/my_config/config.json`

### 问题 2：路径解析

**问题：** 迁移后配置中的绝对路径失效
**解决：** 更新为相对于工作区根目录的路径

### 问题 3：环境变量

**问题：** 旧的 ENV 变量不生效
**解决：** 确认路径正确且文件可被读取

### 问题 4：CLI 命令缺失

**问题：** 找不到 `simpletuner` 命令
**解决：** 启用虚拟环境并重试，或重新通过 pip 安装 SimpleTuner
