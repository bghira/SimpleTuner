# Diff2Flow (Diffusion-to-Flow рдмреНрд░рд┐рдЬ)

## рдкреГрд╖реНрдарднреВрдорд┐

рдРрддрд┐рд╣рд╛рд╕рд┐рдХ рд░реВрдк рд╕реЗ, diffusion рдореЙрдбрд▓реНрд╕ рдХреЛ рдЙрдирдХреЗ prediction target рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╡рд░реНрдЧреАрдХреГрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
*   **Epsilon ($\epsilon$):** рдЗрдореЗрдЬ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рд╢реЛрд░ рдкреНрд░реЗрдбрд┐рдХреНрдЯ рдХрд░рдирд╛ (SD 1.5, SDXL)ред
*   **V-Prediction ($v$):** рд╢реЛрд░ рдФрд░ рдбреЗрдЯрд╛ рдХреЛ рдорд┐рд▓рд╛рдХрд░ velocity рдкреНрд░реЗрдбрд┐рдХреНрдЯ рдХрд░рдирд╛ (SD 2.0, SDXL Refiner)ред

Flux, Stable Diffusion 3, рдФрд░ AuraFlow рдЬреИрд╕реЗ рдирдП state-of-the-art рдореЙрдбрд▓ **Flow Matching** (рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ Rectified Flow) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред Flow Matching рдЬреЗрдирд░реЗрд╢рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдПрдХ Ordinary Differential Equation (ODE) рдХреЗ рд░реВрдк рдореЗрдВ рджреЗрдЦрддрд╛ рд╣реИ рдЬреЛ рдХрдгреЛрдВ рдХреЛ noise distribution рд╕реЗ data distribution рддрдХ рд╕реАрдзреА рд░реЗрдЦрд╛рдУрдВ рдХреЗ рд╕рд╛рде рд▓реЗ рдЬрд╛рддрд╛ рд╣реИред

рдпрд╣ straight-line trajectory рдЖрдорддреМрд░ рдкрд░ solvers рдХреЗ рд▓рд┐рдП рдЖрд╕рд╛рди рд╣реЛрддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХрдо рд╕реНрдЯреЗрдкреНрд╕ рдореЗрдВ рдЕрдзрд┐рдХ рд╕реНрдерд┐рд░ рдЬреЗрдирд░реЗрд╢рди рд╕рдВрднрд╡ рд╣реЛрддреА рд╣реИред

## рдмреНрд░рд┐рдЬ

**Diff2Flow** рдПрдХ рд╣рд▓реНрдХрд╛ adapter рд╣реИ рдЬреЛ "Legacy" рдореЙрдбрд▓реНрд╕ (Epsilon рдпрд╛ V-pred) рдХреЛ рдмрд┐рдирд╛ рдЙрдирдХреА рдореВрд▓ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдмрджрд▓реЗ Flow Matching рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд╕рд╛рде рдЯреНрд░реЗрди рдХрд░рдиреЗ рджреЗрддрд╛ рд╣реИред

рдпрд╣ рдореЙрдбрд▓ рдХреЗ native рдЖрдЙрдЯрдкреБрдЯ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП epsilon prediction) рдХреЛ рдЧрдгрд┐рддреАрдп рд░реВрдк рд╕реЗ flow vector field $u_t(x|1)$ рдореЗрдВ рдмрджрд▓рддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ flow target ($x_1 - x_0$, рдпрд╛ `noise - latents`) рдХреЗ рд╡рд┐рд░реБрджреНрдз loss рдЧрдгрдирд╛ рдХрд░рддрд╛ рд╣реИред

> ЁЯЯб **рдкреНрд░рдпреЛрдЧрд╛рддреНрдордХ рд╕реНрдерд┐рддрд┐:** рдпрд╣ рдлреАрдЪрд░ рдЙрд╕ loss landscape рдХреЛ рдмрджрд▓ рджреЗрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдореЙрдбрд▓ рджреЗрдЦрддрд╛ рд╣реИред рд╕реИрджреНрдзрд╛рдВрддрд┐рдХ рд░реВрдк рд╕реЗ рд╕рд╣реА рд╣реЛрдиреЗ рдХреЗ рдмрд╛рд╡рдЬреВрдж, рдпрд╣ рдЯреНрд░реЗрдирд┐рдВрдЧ dynamics рдХреЛ рдХрд╛рдлреА рдмрджрд▓ рджреЗрддрд╛ рд╣реИред рдпрд╣ рдореБрдЦреНрдпрддрдГ рд░рд┐рд╕рд░реНрдЪ рдФрд░ рдкреНрд░рдпреЛрдЧ рдХреЗ рд▓рд┐рдП рд╣реИред

## рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди

Diff2Flow рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ bridge рд╕рдХреНрд╖рдо рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ loss function рдмрджрд▓рдирд╛ рд╣реЛрдЧрд╛ред

### рдмреЗрд╕рд┐рдХ рд╕реЗрдЯрдЕрдк

рдЕрдкрдиреЗ `config.json` рдореЗрдВ рдпреЗ keys рдЬреЛрдбрд╝реЗрдВ:

```json
{
  "diff2flow_enabled": true,
  "diff2flow_loss": true
}
```

### рд╡рд┐рдХрд▓реНрдк рд╕рдВрджрд░реНрдн

#### `--diff2flow_enabled` (Boolean)
**рдбрд┐рдлрд╝реЙрд▓реНрдЯ:** `false`
рдпрд╣ рдЧрдгрд┐рддреАрдп рдмреНрд░рд┐рдЬ рдХреЛ initialize рдХрд░рддрд╛ рд╣реИред рдпрд╣ timestep рдЧрдгрдирд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдЫреЛрдЯрд╛ buffer рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдкрдиреЗ рдЖрдк рдЯреНрд░реЗрдирд┐рдВрдЧ рд╡реНрдпрд╡рд╣рд╛рд░ рдирд╣реАрдВ рдмрджрд▓рддрд╛ рдЬрдм рддрдХ `diff2flow_loss` рднреА рд╕реЗрдЯ рди рд╣реЛред
*   **рдЖрд╡рд╢реНрдпрдХ:** `diff2flow_loss` рдХреЗ рд▓рд┐рдПред
*   **рд╕рдорд░реНрдерд┐рдд рдореЙрдбрд▓реНрд╕:** рдХреЛрдИ рднреА рдореЙрдбрд▓ рдЬреЛ `epsilon` рдпрд╛ `v_prediction` рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ (SD1.5, SD2.x, SDXL, DeepFloyd IF, PixArt Alpha)ред

#### `--diff2flow_loss` (Boolean)
**рдбрд┐рдлрд╝реЙрд▓реНрдЯ:** `false`
рдЯреНрд░реЗрдирд┐рдВрдЧ рдЙрджреНрджреЗрд╢реНрдп рдмрджрд▓рддрд╛ рд╣реИред
*   **False:** рдореЙрдбрд▓ рдЕрдкрдиреА prediction рдФрд░ standard target рдХреЗ рдмреАрдЪ рддреНрд░реБрдЯрд┐ рдХрдо рдХрд░рддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг: `MSE(pred_noise, real_noise)`)ред
*   **True:** рдореЙрдбрд▓ *flow-converted* prediction рдФрд░ flow target (`noise - latents`) рдХреЗ рдмреАрдЪ рддреНрд░реБрдЯрд┐ рдХрдо рдХрд░рддрд╛ рд╣реИред

### Synergies

Diff2Flow, **Scheduled Sampling** рдХреЗ рд╕рд╛рде рдмреЗрд╣рдж рдЕрдЪреНрдЫреА рддрд░рд╣ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИред

рдЬрдм рдЖрдк рдпрд╣ рд╕рдВрдпреЛрдЬрди рдХрд░рддреЗ рд╣реИрдВ:
1.  **Diff2Flow** (рдЯреНрд░реИрдЬреЗрдХреНрдЯрд░реА рдХреЛ рд╕реАрдзрд╛ рдХрд░рдирд╛)
2.  **Scheduled Sampling** (self-generated rollouts рдкрд░ рдЯреНрд░реЗрдирд┐рдВрдЧ)

рддреЛ рдЖрдк рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ **Reflow** рдпрд╛ **Rectified Flow** рдореЙрдбрд▓реНрд╕ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдЯреНрд░реЗрдирд┐рдВрдЧ рд░реЗрд╕рд┐рдкреА рдХрд╛ рдЕрдиреБрдорд╛рди рд▓рдЧрд╛рддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ SDXL рдЬреИрд╕реА рдкреБрд░рд╛рдиреА рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░реНрд╕ рдореЗрдВ рдЖрдзреБрдирд┐рдХ рд╕реНрдерд┐рд░рддрд╛ рдФрд░ рдЧреБрдгрд╡рддреНрддрд╛ рдХреЗ рдЧреБрдг рдЖ рд╕рдХрддреЗ рд╣реИрдВред
