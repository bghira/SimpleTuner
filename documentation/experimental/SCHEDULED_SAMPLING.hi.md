# Scheduled Sampling (Rollout)

## рдкреГрд╖реНрдарднреВрдорд┐

рдорд╛рдирдХ diffusion рдЯреНрд░реЗрдирд┐рдВрдЧ "Teacher Forcing" рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИред рд╣рдо рдПрдХ рд╕рд╛рдл рдЗрдореЗрдЬ рд▓реЗрддреЗ рд╣реИрдВ, рдЙрд╕рдореЗрдВ рд╕рдЯреАрдХ рдорд╛рддреНрд░рд╛ рдореЗрдВ рд╢реЛрд░ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ, рдФрд░ рдореЙрдбрд▓ рд╕реЗ рдЙрд╕ рд╢реЛрд░ (рдпрд╛ velocity/original image) рдХреА рднрд╡рд┐рд╖реНрдпрд╡рд╛рдгреА рдХрд░рд╛рддреЗ рд╣реИрдВред рдореЙрдбрд▓ рдХреЛ рджрд┐рдпрд╛ рдЧрдпрд╛ рдЗрдирдкреБрдЯ рд╣рдореЗрд╢рд╛ "рдкрд░рдлрд╝реЗрдХреНрдЯ" рд╢реЛрд░ рд╡рд╛рд▓рд╛ рд╣реЛрддрд╛ рд╣реИтАФрдпрд╣ рдмрд┐рд▓реНрдХреБрд▓ рд╕реИрджреНрдзрд╛рдВрддрд┐рдХ noise schedule рдкрд░ рд╣реЛрддрд╛ рд╣реИред

рд▓реЗрдХрд┐рди inference (generation) рдХреЗ рджреМрд░рд╛рди, рдореЙрдбрд▓ рдЕрдкрдиреЗ рд╣реА рдЖрдЙрдЯрдкреБрдЯреНрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рд░рд╣рддрд╛ рд╣реИред рдпрджрд┐ рд╡рд╣ step $t$ рдкрд░ рдПрдХ рдЫреЛрдЯреА рдЧрд▓рддреА рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдЧрд▓рддреА step $t-1$ рдореЗрдВ рдЪрд▓реА рдЬрд╛рддреА рд╣реИред рдпреЗ рддреНрд░реБрдЯрд┐рдпрд╛рдБ рдЬрдорд╛ рд╣реЛрддреА рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдЬреЗрдирд░реЗрд╢рди рд╡реИрдз рдЗрдореЗрдЬ рдХреЗ manifold рд╕реЗ рднрдЯрдХ рд╕рдХрддреА рд╣реИред рдЯреНрд░реЗрдирд┐рдВрдЧ (рдкрд░рдлрд╝реЗрдХреНрдЯ рдЗрдирдкреБрдЯреНрд╕) рдФрд░ inference (рдЕрдкреВрд░реНрдг рдЗрдирдкреБрдЯреНрд╕) рдХреЗ рдмреАрдЪ рдЗрд╕ рдЕрдВрддрд░ рдХреЛ **Exposure Bias** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред

**Scheduled Sampling** (рдпрд╣рд╛рдБ рдЕрдХреНрд╕рд░ "Rollout" рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ) рдЗрд╕ рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдореЙрдбрд▓ рдХреЛ рдЙрд╕рдХреЗ рдЕрдкрдиреЗ рдЖрдЙрдЯрдкреБрдЯреНрд╕ рдкрд░ рдЯреНрд░реЗрди рдХрд░рддрд╛ рд╣реИред

## рдпрд╣ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ

рд╕рд┐рд░реНрдл рд╕рд╛рдл рдЗрдореЗрдЬ рдореЗрдВ рд╢реЛрд░ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдЯреНрд░реЗрдирд┐рдВрдЧ рд▓реВрдк рдХрднреА-рдХрднреА рдПрдХ рдЫреЛрдЯрд╛ inference session рдЪрд▓рд╛рддрд╛ рд╣реИ:

1.  **Target timestep** $t$ рдЪреБрдиреЗрдВ (рд╡рд╣реА step рдЬрд┐рд╕ рдкрд░ рд╣рдо рдЯреНрд░реЗрди рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ)ред
2.  **Source timestep** $t+k$ рдЪреБрдиреЗрдВ (schedule рдореЗрдВ рдкреАрдЫреЗ рдХреА рдУрд░ рдПрдХ рдЕрдзрд┐рдХ noisy step)ред
3.  рдореЙрдбрд▓ рдХреЗ *рд╡рд░реНрддрдорд╛рди* рд╡реЗрдЯреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ $t+k$ рд╕реЗ $t$ рддрдХ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЬреЗрдирд░реЗрдЯ (denoise) рдХрд░реЗрдВред
4.  step $t$ рдкрд░ рдЗрд╕ self-generated, рдереЛрдбрд╝рд╛ imperfect latent рдХреЛ рдЯреНрд░реЗрдирд┐рдВрдЧ рдкрд╛рд╕ рдХреЗ рд▓рд┐рдП рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред

рдРрд╕рд╛ рдХрд░рдиреЗ рд╕реЗ рдореЙрдбрд▓ рдЙрди artifacts рдФрд░ errors рд╡рд╛рд▓реЗ рдЗрдирдкреБрдЯреНрд╕ рджреЗрдЦрддрд╛ рд╣реИ рдЬреЛ рд╡рд╣ рд╕реНрд╡рдпрдВ рдкреИрджрд╛ рдХрд░рддрд╛ рд╣реИред рд╡рд╣ рд╕реАрдЦрддрд╛ рд╣реИ, "рдЕрдЪреНрдЫрд╛, рдореИрдВрдиреЗ рдпрд╣ рдЧрд▓рддреА рдХреА; рдЗрд╕реЗ рдРрд╕реЗ рд╕реБрдзрд╛рд░рддрд╛ рд╣реВрдБ," рдЬрд┐рд╕рд╕реЗ рдЬреЗрдирд░реЗрд╢рди рдлрд┐рд░ рд╕реЗ рд╡реИрдз рдкрде рдХреА рдУрд░ рд▓реМрдЯ рдЖрддреА рд╣реИред

## рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди

рдпрд╣ рдлреАрдЪрд░ рдкреНрд░рдпреЛрдЧрд╛рддреНрдордХ рд╣реИ рдФрд░ рдХрдореНрдкреНрдпреВрдЯреЗрд╢рдирд▓ рдУрд╡рд░рд╣реЗрдб рдЬреЛрдбрд╝рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ prompt adherence рдФрд░ рд╕рдВрд░рдЪрдирд╛рддреНрдордХ рд╕реНрдерд┐рд░рддрд╛ рдореЗрдВ рдХрд╛рдлреА рд╕реБрдзрд╛рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЦрд╛рд╕рдХрд░ рдЫреЛрдЯреЗ datasets (Dreambooth) рдкрд░ред

рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ non-zero `max_step_offset` рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

### рдмреЗрд╕рд┐рдХ рд╕реЗрдЯрдЕрдк

рдЕрдкрдиреЗ `config.json` рдореЗрдВ рдпрд╣ рдЬреЛрдбрд╝реЗрдВ:

```json
{
  "scheduled_sampling_max_step_offset": 10,
  "scheduled_sampling_probability": 1.0,
  "scheduled_sampling_sampler": "unipc"
}
```

### рд╡рд┐рдХрд▓реНрдк рд╕рдВрджрд░реНрдн

#### `scheduled_sampling_max_step_offset` (Integer)
**рдбрд┐рдлрд╝реЙрд▓реНрдЯ:** `0` (рдирд┐рд╖реНрдХреНрд░рд┐рдп)
рд░реЛрд▓рдЖрдЙрдЯ рдХреА рдЕрдзрд┐рдХрддрдо рд╕реНрдЯреЗрдк рд╕рдВрдЦреНрдпрд╛ред рдпрджрд┐ рдЗрд╕реЗ `10` рд╕реЗрдЯ рдХрд┐рдпрд╛ рд╣реИ, рддреЛ trainer рд╣рд░ рд╕реИрдВрдкрд▓ рдХреЗ рд▓рд┐рдП 0 рд╕реЗ 10 рдХреЗ рдмреАрдЪ рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд░реЛрд▓рдЖрдЙрдЯ рд▓рдВрдмрд╛рдИ рдЪреБрдиреЗрдЧрд╛ред
> ЁЯЯв **рд╕рд┐рдлрд╛рд░рд┐рд╢:** рдЫреЛрдЯрд╛ рд╢реБрд░реВ рдХрд░реЗрдВ (рдЬреИрд╕реЗ `5` рд╕реЗ `10`)ред рдЫреЛрдЯреЗ рд░реЛрд▓рдЖрдЙрдЯ рднреА рдореЙрдбрд▓ рдХреЛ рддреНрд░реБрдЯрд┐ рд╕реБрдзрд╛рд░ рд╕реАрдЦрдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддреЗ рд╣реИрдВ, рдмрд┐рдирд╛ рдЯреНрд░реЗрдирд┐рдВрдЧ рдХреЛ рдмрд╣реБрдд рдзреАрдорд╛ рдХрд┐рдПред

#### `scheduled_sampling_probability` (Float)
**рдбрд┐рдлрд╝реЙрд▓реНрдЯ:** `0.0`
рдХрд┐рд╕реА рднреА batch item рдХреЗ рд░реЛрд▓рдЖрдЙрдЯ рд╕реЗ рдЧреБрдЬрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ (0.0 рд╕реЗ 1.0)ред
*   `1.0`: рд╣рд░ рд╕реИрдВрдкрд▓ рд░реЛрд▓рдЖрдЙрдЯ рд╣реЛрддрд╛ рд╣реИ (рд╕рдмрд╕реЗ рдЕрдзрд┐рдХ compute)ред
*   `0.5`: 50% рд╕реИрдВрдкрд▓реНрд╕ рдорд╛рдирдХ рдЯреНрд░реЗрдирд┐рдВрдЧ, 50% рд░реЛрд▓рдЖрдЙрдЯред

#### `scheduled_sampling_ramp_steps` (Integer)
**рдбрд┐рдлрд╝реЙрд▓реНрдЯ:** `0`
рдпрджрд┐ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛, рддреЛ probability `scheduled_sampling_prob_start` (рдбрд┐рдлрд╝реЙрд▓реНрдЯ 0.0) рд╕реЗ `scheduled_sampling_prob_end` (рдбрд┐рдлрд╝реЙрд▓реНрдЯ 0.5) рддрдХ рдЗрддрдиреЗ global steps рдореЗрдВ linearly ramp рд╣реЛрдЧреАред
> ЁЯЯв **рдЯрд┐рдк:** рдпрд╣ рдПрдХ "warmup" рдХреА рддрд░рд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред рдЗрд╕рд╕реЗ рдореЙрдбрд▓ рдкрд╣рд▓реЗ basic denoising рд╕реАрдЦрддрд╛ рд╣реИ, рдлрд┐рд░ рдзреАрд░реЗ-рдзреАрд░реЗ рдЕрдкрдиреА рдЧрд▓рддрд┐рдпреЛрдВ рдХреЛ рдареАрдХ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдХрдард┐рди рдХрд╛рд░реНрдп рдЬреЛрдбрд╝рддрд╛ рд╣реИред

#### `scheduled_sampling_sampler` (String)
**рдбрд┐рдлрд╝реЙрд▓реНрдЯ:** `unipc`
рд░реЛрд▓рдЖрдЙрдЯ рдЬреЗрдирд░реЗрд╢рди рд╕реНрдЯреЗрдкреНрд╕ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ solverред
*   **рд╡рд┐рдХрд▓реНрдк:** `unipc` (рдЕрдиреБрд╢рдВрд╕рд┐рдд, рддреЗрдЬрд╝ рдФрд░ рд╕рдЯреАрдХ), `euler`, `dpm`, `rk4`ред
*   рдЗрди рдЫреЛрдЯреЗ sampling bursts рдХреЗ рд▓рд┐рдП `unipc` рдЖрдорддреМрд░ рдкрд░ рдЧрддрд┐ рдФрд░ рд╕рдЯреАрдХрддрд╛ рдХрд╛ рд╕рд░реНрд╡рд╢реНрд░реЗрд╖реНрда рд╕рдВрддреБрд▓рди рд╣реИред

### Flow Matching + ReflexFlow

Flow-matching рдореЙрдбрд▓реНрд╕ (`--prediction_type flow_matching`) рдХреЗ рд▓рд┐рдП scheduled sampling рдЕрдм ReflexFlow-style exposure bias mitigation рд╕рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИ:

*   `scheduled_sampling_reflexflow`: rollout рдХреЗ рджреМрд░рд╛рди ReflexFlow enhancements рд╕рдХреНрд╖рдо рдХрд░реЗрдВ (flow-matching рдореЙрдбрд▓реНрд╕ рдХреЗ рд▓рд┐рдП scheduled sampling рд╕рдХреНрд░рд┐рдп рд╣реЛрдиреЗ рдкрд░ рд╕реНрд╡рддрдГ рд╕рдХреНрд╖рдо; opt out рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `--scheduled_sampling_reflexflow=false` рджреЗрдВ)ред
*   `scheduled_sampling_reflexflow_alpha`: exposure-bias рдЖрдзрд╛рд░рд┐рдд loss weight рдХрд╛ рд╕реНрдХреЗрд▓ (frequency compensation)ред
*   `scheduled_sampling_reflexflow_beta1`: directional anti-drift regularizer рдХрд╛ рд╕реНрдХреЗрд▓ (рдкреЗрдкрд░ рдЬреИрд╕рд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ 10.0)ред
*   `scheduled_sampling_reflexflow_beta2`: frequency-compensated loss рдХрд╛ рд╕реНрдХреЗрд▓ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ 1.0)ред

рдпреЗ рдЖрдкрдХреЗ рдкрд╣рд▓реЗ рд╕реЗ рдЧрдгрдирд╛ рдХрд┐рдП рдЧрдП rollout predictions/latents рдХреЛ reuse рдХрд░рддреЗ рд╣реИрдВ, рдЕрддрд┐рд░рд┐рдХреНрдд gradient pass рд╕реЗ рдмрдЪрддреЗ рд╣реИрдВ, рдФрд░ biased rollouts рдХреЛ clean trajectory рдХреЗ рд╕рд╛рде align рд░рдЦрддреЗ рд╣реИрдВ рдЬрдмрдХрд┐ denoising рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ missing low-frequency components рдкрд░ рдЬреЛрд░ рджреЗрддреЗ рд╣реИрдВред

### рдкрд░рдлреЙрд░реНрдореЗрдВрд╕ рдкреНрд░рднрд╛рд╡

> тЪая╕П **рдЪреЗрддрд╛рд╡рдиреА:** рд░реЛрд▓рдЖрдЙрдЯ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдкрд░ рдЯреНрд░реЗрдирд┐рдВрдЧ рд▓реВрдк *рдХреЗ рдЕрдВрджрд░* рдореЙрдбрд▓ рдХреЛ inference рдореЛрдб рдореЗрдВ рдЪрд▓рд╛рдирд╛ рдкрдбрд╝рддрд╛ рд╣реИред
>
> рдпрджрд┐ рдЖрдк `max_step_offset=10` рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдореЙрдбрд▓ рдкреНрд░рддрд┐ рдЯреНрд░реЗрдирд┐рдВрдЧ рд╕реНрдЯреЗрдк рддрдХ 10 рдЕрддрд┐рд░рд┐рдХреНрдд forward passes рдЪрд▓рд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рд╕реЗ рдЖрдкрдХрд╛ `it/s` (iterations per second) рдШрдЯреЗрдЧрд╛ред рдЯреНрд░реЗрдирд┐рдВрдЧ рдЧрддрд┐ рдФрд░ рдЧреБрдгрд╡рддреНрддрд╛ рдХреЗ рдмреАрдЪ рд╕рдВрддреБрд▓рди рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП `scheduled_sampling_probability` рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░реЗрдВред
