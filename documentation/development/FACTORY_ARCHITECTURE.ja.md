# データバックエンド・ファクトリアーキテクチャ

## 概要

SimpleTuner の Data Backend Factory は、保守性・テスト性・性能のために SOLID 原則に従ったモジュール型アーキテクチャを実装しています。

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Factory Registry                                     │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐  │
│  │   Performance       │  │     Backend         │  │    Configuration    │  │
│  │    Tracking         │  │    Management       │  │     Loading         │  │
│  │                     │  │                     │  │                     │  │
│  │ • Memory usage      │  │ • text_embed_backends│ │ • JSON parsing      │  │
│  │ • Initialization    │  │ • image_embed_backends│ │ • Variable filling  │  │
│  │ • Build times       │  │ • data_backends     │  │ • Dependency sort   │  │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Configuration Classes                                  │
│                                                                              │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐  │
│  │  BaseBackendConfig  │  │  ImageBackendConfig │  │ TextEmbedBackendConfig│ │
│  │                     │  │                     │  │                     │  │
│  │ • Common fields     │  │ • Image datasets    │  │ • Text embedding    │  │
│  │ • Shared validation │  │ • Video datasets    │  │   datasets          │  │
│  │ • Base defaults     │  │ • Conditioning      │  │ • Simple validation │  │
│  │                     │  │ • Extensive config  │  │                     │  │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘  │
│                                       │                                      │
│                        ┌─────────────────────┐                             │
│                        │ImageEmbedBackendConfig│                             │
│                        │                     │                             │
│                        │ • Image embedding   │                             │
│                        │   datasets          │                             │
│                        │ • VAE cache config  │                             │
│                        └─────────────────────┘                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Builder Classes                                     │
│                                                                              │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐  │
│  │  BaseBackendBuilder │  │  LocalBackendBuilder│  │  AwsBackendBuilder  │  │
│  │                     │  │                     │  │                     │  │
│  │ • Metadata creation │  │ • LocalDataBackend  │  │ • S3DataBackend     │  │
│  │ • Cache management  │  │ • File system       │  │ • AWS S3 storage    │  │
│  │ • Common build flow │  │   operations        │  │ • Connection pools  │  │
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘  │
│                                                                              │
│  ┌─────────────────────┐  ┌─────────────────────┐                          │
│  │  CsvBackendBuilder  │  │HuggingfaceBackendBuilder│                        │
│  │                     │  │                     │                          │
│  │ • CSVDataBackend    │  │ • HuggingfaceDatasetsBackend│                    │
│  │ • CSV file handling │  │ • Streaming datasets│                          │
│  │ • URL downloads     │  │ • Filter functions  │                          │
│  └─────────────────────┘  └─────────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Runtime Components                                   │
│                                                                              │
│  ┌─────────────────────┐  ┌─────────────────────┐                          │
│  │   BatchFetcher      │  │ DataLoader Iterator │                          │
│  │                     │  │                     │                          │
│  │ • Background        │  │ • Multi-backend     │                          │
│  │   prefetching       │  │   sampling          │                          │
│  │ • Queue management  │  │ • Weighted selection│                          │
│  │ • Thread safety     │  │ • Exhaustion handling│                         │
│  └─────────────────────┘  └─────────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

## コンポーネントの説明

### 1. Factory Registry（`factory.py`）

すべてのバックエンド生成と管理を調整する中枢です。

**主な責務:**
- メモリや時間の指標を用いた性能トラッキング
- バックエンドのライフサイクル管理
- 設定処理と検証
- テキスト/画像埋め込みバックエンドの調整

**性能機能:**
- リアルタイムのメモリ使用量追跡
- ステージごとの計測
- ピークメモリ監視
- 解析用ログ

### 2. 設定クラス（`config/`）

継承を利用した dataclass による型安全な設定管理。

#### BaseBackendConfig（`config/base.py`）
- 共通フィールドと検証を持つ抽象ベース
- 共通の解像度・キャプション戦略・画像サイズ検証
- 特化設定のテンプレートを提供

#### ImageBackendConfig（`config/image.py`）
- 画像・動画・コンディショニング・評価データセット向け設定
- 複雑なクロップ、アスペクト比、バックエンド固有設定を扱う
- 全ユースケース向けの広範な検証

#### TextEmbedBackendConfig（`config/text_embed.py`）
- テキスト埋め込みデータセット向けの簡易設定
- キャッシュ管理とバックエンド接続に注力

#### ImageEmbedBackendConfig（`config/image_embed.py`）
- VAE 画像埋め込みデータセット向けの設定
- キャッシュディレクトリと処理パラメータを管理

### 3. Builder クラス（`builders/`）

バックエンド生成のためのファクトリパターン実装。

#### BaseBackendBuilder（`builders/base.py`）
- 共通のメタデータバックエンド作成ロジックを持つ抽象ビルダー
- キャッシュ管理と削除処理
- 一貫したビルドフローのテンプレートメソッド

#### 特化ビルダー
- **LocalBackendBuilder**: ファイルシステム用の `LocalDataBackend` を生成
- **AwsBackendBuilder**: コネクションプール付きの `S3DataBackend` を生成
- **CsvBackendBuilder**: CSV ベースの `CSVDataBackend` を生成
- **HuggingfaceBackendBuilder**: ストリーミング対応の `HuggingfaceDatasetsBackend` を生成

### 4. ランタイムコンポーネント（`runtime/`）

学習時の操作を最適化するコンポーネント。

#### BatchFetcher（`runtime/batch_fetcher.py`）
- 学習バッチのバックグラウンド事前取得
- スレッドセーフなキュー管理
- キューサイズと性能の監視

#### DataLoader Iterator（`runtime/dataloader_iterator.py`）
- 複数バックエンドでの重み付きサンプリング
- 自動枯渇処理とデータセット再開
- 均一/自動重み付けサンプリング戦略に対応

## データフロー

### 初期化フロー
```
1. Factory Registry の作成
   ├── 性能トラッキングの初期化
   ├── コンポーネントレジストリのセットアップ
   └── メモリ追跡開始

2. 設定の読み込み
   ├── JSON パースと検証
   ├── 変数置換
   └── 依存関係の並べ替え

3. バックエンド設定
   ├── テキスト埋め込みバックエンド
   ├── 画像埋め込みバックエンド
   └── メインのデータバックエンド

4. ランタイム準備
   ├── メタデータバックエンドの作成
   ├── データセットとサンプラのセットアップ
   └── キャッシュ初期化
```

### 学習フロー
```
1. バッチ要求
   ├── BatchFetcher の事前取得
   ├── 重み付きバックエンド選択
   └── キュー管理

2. データ読み込み
   ├── バックエンド固有のデータアクセス
   ├── メタデータ参照
   └── バッチ構成

3. 処理
   ├── テキスト埋め込み参照
   ├── VAE キャッシュ参照
   └── 最終バッチ準備
```

## 設計判断と理由

### 1. モジュール型アーキテクチャ
**判断**: モノリシックなファクトリを特化コンポーネントに分割
**理由**:
- 関心事を分離することでテスト性が向上
- 機能の独立開発が可能
- 特定機能に取り組む際の認知負荷を軽減
- 単一責任原則に準拠

### 2. 継承を用いた設定クラス
**判断**: 継承階層を持つ dataclass を使用
**理由**:
- 型安全性と IDE サポート
- 重複なしで共有検証ロジックを利用
- バックエンド種別間の明確な分離
- コンパイル時エラー検出

### 3. Builder におけるファクトリパターン
**判断**: バックエンド作成にファクトリパターンを採用
**理由**:
- 生成ロジックの一元化
- 新しいバックエンドタイプの拡張が容易
- 全バックエンドで一貫した生成フロー
- 設定とインスタンス生成の分離

### 4. パフォーマンス優先の設計
**判断**: 性能追跡と監視を組み込み
**理由**:
- 大規模学習のワークロードに不可欠
- 最適化ポイントの特定に有用
- 性能分析データを提供
- リアルタイム監視が可能

## 実現した性能改善

### メモリ最適化
- ピークメモリ使用量の最小化
- コンポーネントの遅延ロード
- 効率的なキャッシュ管理
- 最適化されたガベージコレクションパターン

### 初期化速度
- 高速なバックエンド初期化
- 並列な設定処理
- 最適化された依存解決
- 冗長操作の最小化

### コード保守性
- 低い関数複雑度
- 関数最大サイズ: 50 行
- 明確な関心事の分離
- 型カバレッジ

## 開発アプローチ

### 実装フェーズ
- **Phase 1**: コアアーキテクチャ設計とコンポーネント実装
- **Phase 2**: テストと検証
- **Phase 3**: 性能最適化と監視
- **Phase 4**: 本番展開と保守

### テスト戦略
- 実ワークロードによる E2E テスト
- 性能ベンチマークと監視
- エッジケース検証
- 継続的インテグレーションによるテスト

## コード品質指標

### ファイル構成
- 最大ファイルサイズ: 500 行
- 平均関数サイズ: 25 行
- 明確なモジュール境界
- 一貫した命名規則

### 型カバレッジ
- 公開 API は 100% 型ヒント
- ドキュメント文字列のカバレッジ
- 静的解析準拠
- IDE フレンドリーな設計

### テスト戦略
- 各コンポーネントのユニットテスト
- ワークフローの統合テスト
- 性能回帰テスト
- エッジケース検証

## 今後の強化

### 予定機能
1. **Async 対応**: ノンブロッキングなバックエンド操作
2. **プラグインアーキテクチャ**: サードパーティ製バックエンド拡張
3. **高度なキャッシュ**: マルチレベルキャッシュ階層
4. **監視ダッシュボード**: リアルタイム性能可視化

### 拡張ポイント
- Builder 登録による新しいバックエンド追加
- カスタム設定クラス
- 差し替え可能なサンプリング戦略
- カスタム性能指標

## 結論

Data Backend Factory は、SimpleTuner でスケーラブルかつ保守可能なデータバックエンド管理を実現する基盤です。このモジュール型アーキテクチャにより、将来の拡張に備えつつ、性能・コード品質・開発者体験を提供します。

複数のデータソースを扱う複雑さに対応しながら、堅牢な機能と拡張・カスタマイズのための明確なパターンを提供します。
