# Dreambooth (single-subject рдкреНрд░рд╢рд┐рдХреНрд╖рдг)

## рдкреГрд╖реНрдарднреВрдорд┐

Dreambooth рд╢рдмреНрдж Google рджреНрд╡рд╛рд░рд╛ рд╡рд┐рдХрд╕рд┐рдд рдПрдХ рддрдХрдиреАрдХ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдЙрдЪреНрдЪ рдЧреБрдгрд╡рддреНрддрд╛ рд╡рд╛рд▓реА рдХреБрдЫ рдЗрдореЗрдЬреЗрдЬрд╝ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рд╖рдпреЛрдВ рдХреЛ рдореЙрдбрд▓ рдореЗрдВ рдлрд╛рдЗрдирдЯреНрдпреВрди рдХрд░рдХреЗ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ ([рдкреЗрдкрд░](https://dreambooth.github.io))ред

рдлрд╛рдЗрдитАСрдЯреНрдпреВрдирд┐рдВрдЧ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ, Dreambooth рдореЙрдбрд▓ collapse (рдЬреИрд╕реЗ overfitting рдпрд╛ artifacts) рдХреЛ рд░реЛрдХрдиреЗ рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирдИ рддрдХрдиреАрдХреЗрдВ рдЬреЛрдбрд╝рддрд╛ рд╣реИред

### Regularisation images

Regularisation images рдЖрдорддреМрд░ рдкрд░ рдЙрд╕реА рдореЙрдбрд▓ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЬрд╛рддреА рд╣реИрдВ рдЬрд┐рд╕реЗ рдЖрдк рдЯреНрд░реЗрди рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдРрд╕реЗ token рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЬреЛ рдЖрдкрдХреЗ class рд╕реЗ рдорд┐рд▓рддрд╛тАСрдЬреБрд▓рддрд╛ рд╣реЛред

рдпреЗ **рдЬрд░реВрд░реА рдирд╣реАрдВ** рдХрд┐ рдореЙрдбрд▓ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЧрдИ synthetic рдЗрдореЗрдЬреЗрдЬрд╝ рд╣реЛрдВ, рд▓реЗрдХрд┐рди рдпрд╣ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдбреЗрдЯрд╛ (рдЬреИрд╕реЗ рдЕрд╕рд▓реА рд▓реЛрдЧреЛрдВ рдХреА рдлреЛрдЯреЛрдЬрд╝) рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдмреЗрд╣рддрд░ рдкреНрд░рджрд░реНрд╢рди рджреЗ рд╕рдХрддрд╛ рд╣реИред

рдЙрджрд╛рд╣рд░рдг: рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рдкреБрд░реБрд╖ рд╡рд┐рд╖рдп рдХреА рдЗрдореЗрдЬреЗрдЬрд╝ рдкрд░ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреА regularisation data рдореЗрдВ рдЕрдиреНрдп рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдкреБрд░реБрд╖реЛрдВ рдХреА рдлреЛрдЯреЛрдЬрд╝ рдпрд╛ synthetic samples рд╣реЛрдВрдЧреЗред

> ЁЯЯв Regularisation images рдХреЛ рдЕрд▓рдЧ dataset рдХреЗ рд░реВрдк рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╡реЗ рдЖрдкрдХреЗ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рд╕рдорд╛рди рд░реВрдк рд╕реЗ mix рд╣реЛрдВред

### Rare token training

рдореВрд▓ рдкреЗрдкрд░ рдХрд╛ рдПрдХ рд╕рдВрджрд┐рдЧреНрдз рдореВрд▓реНрдп рд╡рд╛рд▓рд╛ рд╡рд┐рдЪрд╛рд░ рдерд╛ рдореЙрдбрд▓ рдХреЗ tokenizer vocabulary рдореЗрдВ reverse search рдХрд░рдХреЗ рдПрдХ "rare" string рдвреВрдБрдврдирд╛, рдЬрд┐рд╕ рдкрд░ рдмрд╣реБрдд рдХрдо training рд╣реБрдИ рд╣реЛред

рдЙрд╕ рд╕рдордп рд╕реЗ рдпрд╣ рд╡рд┐рдЪрд╛рд░ рд╡рд┐рдХрд╕рд┐рдд рдФрд░ рдмрд╣рд╕ рдХрд╛ рд╡рд┐рд╖рдп рдмрдирд╛ рд╣реИ, рдФрд░ рдПрдХ рд╡рд┐рд░реЛрдзреА рдкрдХреНрд╖ рдХрд┐рд╕реА рд╕рдорд╛рди рджрд┐рдЦрдиреЗ рд╡рд╛рд▓реЗ celebrity рдирд╛рдо рдкрд░ рдЯреНрд░реЗрди рдХрд░рдиреЗ рдХреЛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рджреЗрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдореЗрдВ рдХрдо compute рд▓рдЧрддрд╛ рд╣реИред

> ЁЯЯб SimpleTuner рдореЗрдВ rare token training рд╕рдорд░реНрдерд┐рдд рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ рдвреВрдБрдврдиреЗ рдХрд╛ рдХреЛрдИ рдЯреВрд▓ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИред

### Prior preservation loss

рдореЙрдбрд▓ рдореЗрдВ рдПрдХ "prior" рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╕рд┐рджреНрдзрд╛рдВрддрддрдГ Dreambooth training рдХреЗ рджреМрд░рд╛рди рд╕рдВрд░рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд▓реЗрдХрд┐рди Stable Diffusion рдкреНрд░рдпреЛрдЧреЛрдВ рдореЗрдВ рдпрд╣ рдорджрджрдЧрд╛рд░ рдирд╣реАрдВ рд▓рдЧрд╛ тАФ рдореЙрдбрд▓ рдЕрдкрдиреА рд╣реА рдЬрд╛рдирдХрд╛рд░реА рдкрд░ overfit рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

> ЁЯЯв ([#1031](https://github.com/bghira/SimpleTuner/issues/1031)) SimpleTuner рдореЗрдВ LyCORIS adapters рдЯреНрд░реЗрди рдХрд░рддреЗ рд╕рдордп `is_regularisation_data` рд╕реЗрдЯ рдХрд░рдХреЗ prior preservation loss рд╕рдорд░реНрдерд┐рдд рд╣реИред

### Masked loss

рдЗрдореЗрдЬ masks рдХреЛ image рдбреЗрдЯрд╛ рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред mask рдХреЗ рдЧрд╣рд░реЗ рд╣рд┐рд╕реНрд╕реЗ loss calculations рдХреЛ рдЙрди рд╣рд┐рд╕реНрд╕реЛрдВ рдХреЛ рдЕрдирджреЗрдЦрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╛рдзреНрдп рдХрд░рддреЗ рд╣реИрдВред

рдПрдХ рдЙрджрд╛рд╣рд░рдг [script](/scripts/toolkit/datasets/masked_loss/generate_dataset_masks.py) рдЙрдкрд▓рдмреНрдз рд╣реИ, рдЬреЛ input_dir рдФрд░ output_dir рджрд┐рдП рдЬрд╛рдиреЗ рдкрд░ masks рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ:

```bash
python generate_dataset_masks.py --input_dir /images/input \
                      --output_dir /images/output \
                      --text_input "person"
```

рд╣рд╛рд▓рд╛рдБрдХрд┐, рдЗрд╕рдореЗрдВ mask padding blurring рдЬреИрд╕реА advanced functionality рдирд╣реАрдВ рд╣реИред

рдЕрдкрдиреЗ image mask dataset рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддреЗ рд╕рдордп:

- рд╣рд░ image рдХреЗ рд▓рд┐рдП mask рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рдпрджрд┐ mask рдирд╣реАрдВ рдЪрд╛рд╣рд┐рдП рддреЛ allтАСwhite image рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред
- conditioning (mask) data folder рдкрд░ `dataset_type=conditioning` рд╕реЗрдЯ рдХрд░реЗрдВ
- mask dataset рдкрд░ `conditioning_type=mask` рд╕реЗрдЯ рдХрд░реЗрдВ
- image dataset рдкрд░ `conditioning_data=` рдореЗрдВ рдЕрдкрдиреЗ conditioning dataset рдХрд╛ `id` рд╕реЗрдЯ рдХрд░реЗрдВ

```json
[
    {
        "id": "dreambooth-data",
        "type": "local",
        "dataset_type": "image",
        "conditioning_data": "dreambooth-conditioning",
        "instance_data_dir": "/training/datasets/test_datasets/dreambooth",
        "cache_dir_vae": "/training/cache/vae/sdxl/dreambooth-data",
        "caption_strategy": "instanceprompt",
        "instance_prompt": "an dreambooth",
        "metadata_backend": "discovery",
        "resolution": 1024,
        "minimum_image_size": 1024,
        "maximum_image_size": 1024,
        "target_downsample_size": 1024,
        "crop": true,
        "crop_aspect": "square",
        "crop_style": "center",
        "resolution_type": "pixel_area"
    },
    {
        "id": "dreambooth-conditioning",
        "type": "local",
        "dataset_type": "conditioning",
        "instance_data_dir": "/training/datasets/test_datasets/dreambooth_mask",
        "resolution": 1024,
        "minimum_image_size": 1024,
        "maximum_image_size": 1024,
        "target_downsample_size": 1024,
        "crop": true,
        "crop_aspect": "square",
        "crop_style": "center",
        "resolution_type": "pixel_area",
        "conditioning_type": "mask"
    },
    {
        "id": "an example backend for text embeds.",
        "dataset_type": "text_embeds",
        "default": true,
        "type": "local",
        "cache_dir": "/training/cache/text/sdxl-base/masked_loss"
    }
]
```

## рд╕реЗрдЯрдЕрдк

DreamboothтАСspecific рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкрд░ рдЬрд╛рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ [рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓](TUTORIAL.md) рдХрд╛ рдкрд╛рд▓рди рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред

DeepFloyd tuning рдХреЗ рд▓рд┐рдП, рдЙрд╕ рдореЙрдбрд▓ рдХреЗ setup рд╕рдВрдмрдВрдзреА рд╡рд┐рд╢реЗрд╖ рдЯрд┐рдкреНрд╕ рдХреЗ рд▓рд┐рдП [рдпрд╣ рдкреЗрдЬ](DEEPFLOYD.md) рджреЗрдЦреЗрдВред

### Quantised рдореЙрдбрд▓ рдкреНрд░рд╢рд┐рдХреНрд╖рдг (рдХреЗрд╡рд▓ LoRA/LyCORIS)

Apple рдФрд░ NVIDIA рд╕рд┐рд╕реНрдЯрдореНрд╕ рдкрд░ рдкрд░реАрдХреНрд╖рдг рдХрд┐рдП рдЧрдП Hugging Face Optimum-Quanto рд╕реЗ precision рдФрд░ VRAM рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ рдХрдо рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВред

рдЕрдкрдиреЗ SimpleTuner venv рдХреЗ рдЕрдВрджрд░:

```bash
pip install optimum-quanto
```

рдЙрдкрд▓рдмреНрдз precision рд╕реНрддрд░ рдЖрдкрдХреЗ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдФрд░ рдЙрд╕рдХреА рдХреНрд╖рдорддрд╛рдУрдВ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реИрдВред

- int2-quanto, int4-quanto, **int8-quanto** (рдЕрдиреБрд╢рдВрд╕рд┐рдд)
- fp8-quanto, fp8-torchao (рдХреЗрд╡рд▓ CUDA >= 8.9, рдЬреИрд╕реЗ 4090 рдпрд╛ H100)
- nf4-bnb (lowтАСVRAM рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ)

рдЕрдкрдиреЗ config.json рдореЗрдВ рдирд┐рдореНрди рдорд╛рди рдмрджрд▓реЗрдВ рдпрд╛ рдЬреЛрдбрд╝реЗрдВ:
```json
{
    "base_model_precision": "int8-quanto",
    "text_encoder_1_precision": "no_change",
    "text_encoder_2_precision": "no_change",
    "text_encoder_3_precision": "no_change"
}
```

рд╣рдорд╛рд░реА dataloader рдХреЙрдиреНрдлрд╝рд┐рдЧ `multidatabackend-dreambooth.json` рдореЗрдВ рдпрд╣ рдХреБрдЫ рдРрд╕рд╛ рджрд┐рдЦреЗрдЧрд╛:

```json
[
    {
        "id": "subjectname-data-512px",
        "type": "local",
        "instance_data_dir": "/training/datasets/subjectname",
        "caption_strategy": "instanceprompt",
        "instance_prompt": "subjectname",
        "cache_dir_vae": "/training/vae_cache/subjectname",
        "repeats": 100,
        "crop": false,
        "resolution": 512,
        "resolution_type": "pixel_area",
        "minimum_image_size": 192
    },
    {
        "id": "subjectname-data-1024px",
        "type": "local",
        "instance_data_dir": "/training/datasets/subjectname",
        "caption_strategy": "instanceprompt",
        "instance_prompt": "subjectname",
        "cache_dir_vae": "/training/vae_cache/subjectname-1024px",
        "repeats": 100,
        "crop": false,
        "resolution": 1024,
        "resolution_type": "pixel_area",
        "minimum_image_size": 768
    },
    {
        "id": "regularisation-data",
        "type": "local",
        "instance_data_dir": "/training/datasets/regularisation",
        "caption_strategy": "instanceprompt",
        "instance_prompt": "a picture of a man",
        "cache_dir_vae": "/training/vae_cache/regularisation",
        "repeats": 0,
        "resolution": 512,
        "resolution_type": "pixel_area",
        "minimum_image_size": 192,
        "is_regularisation_data": true
    },
    {
        "id": "regularisation-data-1024px",
        "type": "local",
        "instance_data_dir": "/training/datasets/regularisation",
        "caption_strategy": "instanceprompt",
        "instance_prompt": "a picture of a man",
        "cache_dir_vae": "/training/vae_cache/regularisation-1024px",
        "repeats": 0,
        "resolution": 1024,
        "resolution_type": "pixel_area",
        "minimum_image_size": 768,
        "is_regularisation_data": true
    },
    {
        "id": "textembeds",
        "type": "local",
        "dataset_type": "text_embeds",
        "default": true,
        "cache_dir": "/training/text_cache/sdxl_base"
    }
]
```

рдХреБрдЫ рдкреНрд░рдореБрдЦ рдорд╛рдиреЛрдВ рдХреЛ single subject рдЯреНрд░реЗрдирд┐рдВрдЧ рдЖрд╕рд╛рди рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдмрджрд▓рд╛ рдЧрдпрд╛ рд╣реИ:

- рдЕрдм рджреЛ datasets рдХреЛ рджреЛтАСрджреЛ рдмрд╛рд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдХреБрд▓ рдЪрд╛рд░ datasetsред Regularisation data рд╡реИрдХрд▓реНрдкрд┐рдХ рд╣реИ рдФрд░ рдмрд┐рдирд╛ рдЗрд╕рдХреЗ рднреА training рдмреЗрд╣рддрд░ рд╣реЛ рд╕рдХрддреА рд╣реИред рдЪрд╛рд╣реЗрдВ рддреЛ рдЗрд╕ dataset рдХреЛ рд╕реВрдЪреА рд╕реЗ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВред
- Resolution рдХреЛ 512px рдФрд░ 1024px mixed bucketing рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ training speed рдФрд░ convergence рдмреЗрд╣рддрд░ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ
- Minimum image size 192px рдпрд╛ 768px рд░рдЦреА рдЧрдИ рд╣реИ рддрд╛рдХрд┐ рдХреБрдЫ рдЫреЛрдЯреЗ рд▓реЗрдХрд┐рди рдорд╣рддреНрд╡рдкреВрд░реНрдг lowтАСresolution images рдХреЛ upsample рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдЬреЛ рдХреБрдЫ datasets рдореЗрдВ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред
- `caption_strategy` рдЕрдм `instanceprompt` рд╣реИ, рдпрд╛рдиреА dataset рдХреА рд╣рд░ image рдХреЗ рд▓рд┐рдП `instance_prompt` рдХреЛ caption рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред
  - **Note:** instance prompt рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ Dreambooth рдХрд╛ рдкрд╛рд░рдВрдкрд░рд┐рдХ рддрд░реАрдХрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЫреЛрдЯреЗ captions рдмреЗрд╣рддрд░ рдХрд╛рдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрджрд┐ рдореЙрдбрд▓ generalise рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛, рддреЛ captions рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред

### Regularisation dataset рд╡рд┐рдЪрд╛рд░

Regularisation dataset рдХреЗ рд▓рд┐рдП:

- рдЕрдкрдиреЗ Dreambooth subject рдкрд░ `repeats` рдмрд╣реБрдд рдКрдБрдЪрд╛ рд░рдЦреЗрдВ рддрд╛рдХрд┐ Dreambooth рдбреЗрдЯрд╛ рдХрд╛ image count `repeats` рдЧреБрдирд╛ рд╣реЛрдХрд░ regularisation set рд╕реЗ рдЕрдзрд┐рдХ рд╣реЛ рдЬрд╛рдП
  - рдпрджрд┐ Regularisation set рдореЗрдВ 1000 images рд╣реИрдВ рдФрд░ рдЖрдкрдХреЗ training set рдореЗрдВ 10 images рд╣реИрдВ, рддреЛ рддреЗрдЬрд╝ рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЗ рд▓рд┐рдП `repeats` рдХрдо рд╕реЗ рдХрдо 100 рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
- `minimum_image_size` рдмрдврд╝рд╛рдИ рдЧрдИ рд╣реИ рддрд╛рдХрд┐ рдмрд╣реБрдд рдЕрдзрд┐рдХ lowтАСquality artifacts рди рдЖрдПрдВ
- рдЗрд╕реА рддрд░рд╣, рдЕрдзрд┐рдХ descriptive captions рднреВрд▓рдиреЗ рд╕реЗ рдмрдЪрдиреЗ рдореЗрдВ рдорджрдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред `instanceprompt` рд╕реЗ `textfile` рдпрд╛ рдЕрдиреНрдп рд░рдгрдиреАрддрд┐рдпреЛрдВ рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рд░ image рдХреЗ рд▓рд┐рдП `.txt` рдлрд╛рдЗрд▓реЗрдВ рдмрдирд╛рдиреА рд╣реЛрдВрдЧреАред
- рдЬрдм `is_regularisation_data` (рдпрд╛ рдЕрдореЗрд░рд┐рдХреА users рдХреЗ рд▓рд┐рдП ЁЯЗ║ЁЯЗ╕ `is_regularization_data` with z) рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╕ set рдХрд╛ рдбреЗрдЯрд╛ base model рдореЗрдВ feed рд╣реЛрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдПрдХ prediction рдмрдиреЗ рдЬрд┐рд╕реЗ student LyCORIS рдореЙрдбрд▓ рдХреЗ рд▓рд┐рдП loss target рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
  - рдзреНрдпрд╛рди рджреЗрдВ, рдпрд╣ рдлрд┐рд▓рд╣рд╛рд▓ рдХреЗрд╡рд▓ LyCORIS adapter рдкрд░ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред

## Instance prompt рдЪреБрдирдирд╛

рдЬреИрд╕рд╛ рдкрд╣рд▓реЗ рдмрддрд╛рдпрд╛, Dreambooth рдХрд╛ рдореВрд▓ рдлреЛрдХрд╕ rare tokens рдЪреБрдирдиреЗ рдкрд░ рдерд╛ред

рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ, рдХреЛрдИ рдЕрдкрдиреЗ subject рдХрд╛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдирд╛рдо рдпрд╛ рдХрд┐рд╕реА "рдкрд░реНрдпрд╛рдкреНрдд рд╕рдорд╛рди" celebrity рдХрд╛ рдирд╛рдо рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдХрдИ рдкреНрд░рд╢рд┐рдХреНрд╖рдг рдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рдмрд╛рдж, рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ "рдкрд░реНрдпрд╛рдкреНрдд рд╕рдорд╛рди" celebrity рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рд╡рд┐рдХрд▓реНрдк рд╣реИ, рдЦрд╛рд╕рдХрд░ рдпрджрд┐ рдореЙрдбрд▓ рдХреЛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдирд╛рдо рд╕реЗ prompt рдХрд░рдиреЗ рдкрд░ рд╡рд╣ рдЕрд╕рдорд╛рди рджрд┐рдЦрддрд╛ рд╣реЛред

# Scheduled Sampling (Rollout)

Dreambooth рдЬреИрд╕реЗ рдЫреЛрдЯреЗ datasets рдкрд░ training рдХрд░рддреЗ рд╕рдордп, рдореЙрдбрд▓ рдЬрд▓реНрджреА "perfect" noise рдкрд░ overfit рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рд╕реЗ **exposure bias** рд╣реЛрддрд╛ рд╣реИ: рдореЙрдбрд▓ perfect inputs рдХреЛ denoise рдХрд░рдирд╛ рд╕реАрдЦрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди inference рдХреЗ рджреМрд░рд╛рди рдЕрдкрдиреЗ рд╣реА рдереЛрдбрд╝реЗтАСрд╕реЗ imperfect outputs рдХреЗ рд╕рд╛рдордиреЗ рдлреЗрд▓ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

**Scheduled Sampling (Rollout)** рдЗрд╕реЗ рдЗрд╕ рддрд░рд╣ рд╕рдВрдмреЛрдзрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ training loop рдХреЗ рджреМрд░рд╛рди рдХрднреАтАСрдХрднреА рдореЙрдбрд▓ рдХреЛ рдХреБрдЫ steps рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рд╣реА noisy latents generate рдХрд░рдиреЗ рджреЗрддрд╛ рд╣реИред pure Gaussian noise + signal рдкрд░ рдЯреНрд░реЗрди рдХрд░рдиреЗ рдХреЗ рдмрдЬрд╛рдп, рдпрд╣ "rollout" samples рдкрд░ рдЯреНрд░реЗрди рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рдирдореЗрдВ рдореЙрдбрд▓ рдХреА рдкрд┐рдЫрд▓реА рдЧрд▓рддрд┐рдпрд╛рдБ рд╢рд╛рдорд┐рд▓ рд╣реЛрддреА рд╣реИрдВред рдЗрд╕рд╕реЗ рдореЙрдбрд▓ рдЦреБрдж рдХреЛ рд╕реБрдзрд╛рд░рдирд╛ рд╕реАрдЦрддрд╛ рд╣реИ рдФрд░ subject generation рдЕрдзрд┐рдХ robust рдФрд░ stable рд╣реЛрддрд╛ рд╣реИред

> ЁЯЯв рдпрд╣ рдлреАрдЪрд░ рдкреНрд░рдпреЛрдЧрд╛рддреНрдордХ рд╣реИ рд▓реЗрдХрд┐рди рдЫреЛрдЯреЗ datasets рдХреЗ рд▓рд┐рдП рдЬрд╣рд╛рдБ overfitting рдпрд╛ "frying" рд╕рд╛рдорд╛рдиреНрдп рд╣реИ, рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрд╢рдВрд╕рд┐рдд рд╣реИред
> тЪая╕П rollout рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рд╕реЗ compute requirements рдмрдврд╝рддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ training loop рдореЗрдВ extra inference steps рдЪрд▓рд╛рдиреЗ рдкрдбрд╝рддреЗ рд╣реИрдВред

рдЗрд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ `config.json` рдореЗрдВ рдпреЗ keys рдЬреЛрдбрд╝реЗрдВ:

```json
{
  "scheduled_sampling_max_step_offset": 10,
  "scheduled_sampling_probability": 1.0,
  "scheduled_sampling_ramp_steps": 1000,
  "scheduled_sampling_sampler": "unipc"
}
```

*   `scheduled_sampling_max_step_offset`: рдХрд┐рддрдиреЗ steps generate рдХрд░рдиреЗ рд╣реИрдВред рдЫреЛрдЯрд╛ рдорд╛рди (рдЬреИрд╕реЗ 5тАС10) рдЕрдХреНрд╕рд░ рдкрд░реНрдпрд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИред
*   `scheduled_sampling_probability`: рдЗрд╕ рддрдХрдиреАрдХ рдХреЛ рдХрд┐рддрдиреА рдмрд╛рд░ рд▓рд╛рдЧреВ рдХрд░рдирд╛ рд╣реИ (0.0 рд╕реЗ 1.0)ред
*   `scheduled_sampling_ramp_steps`: рд╢реБрд░реБрдЖрддреА N steps рдореЗрдВ probability рдзреАрд░реЗтАСрдзреАрд░реЗ рдмрдврд╝рд╛рдПрдБ рддрд╛рдХрд┐ training destabilize рди рд╣реЛред

# Exponential moving average (EMA)

рдПрдХ рджреВрд╕рд░рд╛ рдореЙрдбрд▓ рдЖрдкрдХреЗ checkpoint рдХреЗ рд╕рд╛рде parallel рдореЗрдВ рд▓рдЧрднрдЧ рдореБрдлреНрдд рдореЗрдВ train рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ тАФ рдЗрд╕рдореЗрдВ рдХреЗрд╡рд▓ system memory (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ) рдЙрдкрдпреЛрдЧ рд╣реЛрддреА рд╣реИ, рдЕрдзрд┐рдХ VRAM рдирд╣реАрдВред

рдЕрдкрдиреЗ config file рдореЗрдВ `use_ema=true` рд╕реЗрдЯ рдХрд░рдХреЗ рдпрд╣ рдлреАрдЪрд░ рд╕рдХреНрд╖рдо рдХрд░реЗрдВред

# CLIP score tracking

рдпрджрд┐ рдЖрдк evaluations рд╕реЗ рдореЙрдбрд▓ рдкреНрд░рджрд░реНрд╢рди рд╕реНрдХреЛрд░ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ CLIP scores рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдФрд░ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП [рдпрд╣ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝](evaluation/CLIP_SCORES.md) рджреЗрдЦреЗрдВред

# рд╕реНрдерд┐рд░ evaluation loss

рдпрджрд┐ рдЖрдк рдореЙрдбрд▓ рдкреНрд░рджрд░реНрд╢рди рд╕реНрдХреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрдерд┐рд░ MSE loss рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ evaluation loss рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдФрд░ рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП [рдпрд╣ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝](evaluation/EVAL_LOSS.md) рджреЗрдЦреЗрдВред

# Validation previews

SimpleTuner Tiny AutoEncoder рдореЙрдбрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ generation рдХреЗ рджреМрд░рд╛рди intermediate validation previews streaming рд╕рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИред рдпрд╣ feature рдЖрдкрдХреЛ webhook callbacks рдХреЗ рдЬрд░рд┐рдП realтАСtime рдореЗрдВ validation images stepтАСbyтАСstep рджреЗрдЦрдиреЗ рджреЗрддрд╛ рд╣реИ, рдмрдЬрд╛рдп рдкреВрд░реА generation рдХреЗ рдЦрддреНрдо рд╣реЛрдиреЗ рдХрд╛ рдЗрдВрддрдЬрд╝рд╛рд░ рдХрд░рдиреЗ рдХреЗред

## Validation previews рд╕рдХреНрд╖рдо рдХрд░рдирд╛

Validation previews рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ `config.json` рдореЗрдВ рдирд┐рдореНрди рдЬреЛрдбрд╝реЗрдВ:

```json
{
  "validation_preview": true,
  "validation_preview_steps": 1
}
```

## рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ

- Tiny AutoEncoder рд╕рдорд░реНрдерди рд╡рд╛рд▓рд╛ model family (Flux, SDXL, SD3, рдЖрджрд┐)
- preview images рдкрд╛рдиреЗ рдХреЗ рд▓рд┐рдП webhook configuration
- validation рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (`validation_disable` true рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП)

## Configuration рд╡рд┐рдХрд▓реНрдк

- `--validation_preview`: preview рдлреАрдЪрд░ enable/disable (рдбрд┐рдлрд╝реЙрд▓реНрдЯ: false)
- `--validation_preview_steps`: sampling рдХреЗ рджреМрд░рд╛рди previews рдХрд┐рддрдиреА рдмрд╛рд░ decode рд╣реЛрдВ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ: 1)
  - 1 рд╕реЗрдЯ рдХрд░рдиреЗ рдкрд░ рд╣рд░ sampling step рдкрд░ preview рдорд┐рд▓реЗрдЧрд╛
  - higher values (рдЬреИрд╕реЗ 3 рдпрд╛ 5) рд╕реЗ Tiny AutoEncoder decoding рдХрд╛ overhead рдХрдо рд╣реЛрдЧрд╛

## рдЙрджрд╛рд╣рд░рдг

`validation_num_inference_steps=20` рдФрд░ `validation_preview_steps=5` рдХреЗ рд╕рд╛рде, рд╣рд░ validation generation рдХреЗ рджреМрд░рд╛рди steps 5, 10, 15, рдФрд░ 20 рдкрд░ preview images рдорд┐рд▓реЗрдВрдЧреАред

# Refiner tuning

рдпрджрд┐ рдЖрдк SDXL refiner рдкрд╕рдВрдж рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдЖрдкрдХреА Dreamboothed model outputs рдХреЛ "ruin" рдХрд░ рджреЗред

SimpleTuner SDXL refiner рдХреЛ LoRA рдФрд░ full rank рджреЛрдиреЛрдВ рд╕реЗ рдЯреНрд░реЗрди рдХрд░рдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред

рдЗрд╕рдореЗрдВ рдХреБрдЫ рд╡рд┐рдЪрд╛рд░ рдЖрд╡рд╢реНрдпрдХ рд╣реИрдВ:
- рдЗрдореЗрдЬреЗрд╕ рдкреВрд░реА рддрд░рд╣ рдЙрдЪреНрдЪтАСрдЧреБрдгрд╡рддреНрддрд╛ рд╡рд╛рд▓реА рд╣реЛрдВ
- text embeds рдХреЛ base model рдХреЗ рд╕рд╛рде share рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛
- VAE embeds **share** рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ

рдЕрдкрдиреА dataloader configuration `multidatabackend.json` рдореЗрдВ `cache_dir` рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ:

```json
[
    {
        "id": "textembeds",
        "type": "local",
        "dataset_type": "text_embeds",
        "default": true,
        "cache_dir": "/training/text_cache/sdxl_refiner"
    }
]
```

рдпрджрд┐ рдЖрдк рдЕрдкрдиреЗ рдбреЗрдЯрд╛ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢рд┐рд╖реНрдЯ aesthetic score рд▓рдХреНрд╖реНрдп рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ `config/config.json` рдореЗрдВ рдпрд╣ рдЬреЛрдбрд╝реЗрдВ:

```bash
"--data_aesthetic_score": 5.6,
```

**5.6** рдХреЛ рдЕрдкрдиреЗ рд▓рдХреНрд╖рд┐рдд score рд╕реЗ рдмрджрд▓реЗрдВред рдбрд┐рдлрд╝реЙрд▓реНрдЯ **7.0** рд╣реИред

> тЪая╕П SDXL refiner рдЯреНрд░реЗрди рдХрд░рддреЗ рд╕рдордп рдЖрдкрдХреЗ validation prompts рдЕрдирджреЗрдЦреЗ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рдЖрдкрдХреЗ datasets рд╕реЗ рд░реИрдВрдбрдо рдЗрдореЗрдЬреЗрд╕ refine рдХреА рдЬрд╛рдПрдВрдЧреАред
